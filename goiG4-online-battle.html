<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>èªã„ã‚¯ã‚¤ã‚º</title>
<style>
  :root {
    --bg1:#eef2ff;
    --bg2:#f3e8ff;
    --card:#ffffffcc;
    --ink:#111827;
    --ink-sub:#4b5563;
    --primary:#4f46e5;
    --primary-soft:#e0e7ff;
    --correct:#16a34a;
    --wrong:#dc2626;
    --border:#d1d5db;
  }
  * {
    box-sizing:border-box;
    -webkit-tap-highlight-color:transparent;
  }
  body {
    margin:0;
    min-height:100vh;
    padding:16px;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",
      "Hiragino Kaku Gothic ProN","ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN","Yu Gothic","ãƒ¡ã‚¤ãƒªã‚ª",sans-serif;
    background:linear-gradient(135deg,var(--bg1),var(--bg2));
    display:flex;
    justify-content:center;
    align-items:center;
  }
  .app {
    width:100%;
    max-width:700px;
    background:var(--card);
    border-radius:18px;
    padding:20px 18px 18px;
    box-shadow:0 20px 40px rgba(15,23,42,0.25);
  }
  .app-title {
    font-size:1.4rem;
    font-weight:700;
    text-align:center;
    margin-bottom:8px;
    color:var(--ink);
  }
  .status-row {
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-size:0.9rem;
    color:var(--ink-sub);
    margin-bottom:10px;
  }
  .badge {
    padding:2px 8px;
    border-radius:999px;
    background:var(--primary-soft);
    color:var(--primary);
    font-size:0.8rem;
    font-weight:600;
  }
  .progress-bar {
    width:100%;
    height:8px;
    background:#e5e7eb;
    border-radius:999px;
    overflow:hidden;
    margin-bottom:16px;
  }
  .progress-fill {
    height:100%;
    width:0%;
    background:var(--primary);
    transition:width 0.25s ease-out;
  }
  .card {
    background:white;
    border-radius:16px;
    border:1px solid var(--border);
    padding:16px;
  }
  .question-text {
    font-size:1.15rem;
    line-height:1.6;
    margin-bottom:14px;
    color:var(--ink);
  }
  .hint {
    font-size:0.85rem;
    color:var(--ink-sub);
    margin-bottom:10px;
  }
  .choices {
    display:flex;
    flex-direction:column;
    gap:8px;
    margin-bottom:10px;
  }
  .choice-btn {
    border:1px solid var(--border);
    border-radius:999px;
    padding:8px 14px;
    font-size:1rem;
    text-align:left;
    background:#f9fafb;
    cursor:pointer;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    transition:transform 0.05s ease, box-shadow 0.05s ease, background 0.15s;
  }
  .choice-btn span.label {
    flex:1;
  }
  .choice-btn span.mark {
    font-size:0.8rem;
    opacity:0.7;
  }
  .choice-btn:active {
    transform:scale(0.98);
    box-shadow:0 2px 4px rgba(15,23,42,0.12);
  }
  .choice-btn.disabled {
    cursor:default;
    opacity:0.85;
  }
  .choice-btn.correct {
    border-color:var(--correct);
    background:#ecfdf3;
    color:var(--correct);
    font-weight:600;
  }
  .choice-btn.wrong {
    border-color:var(--wrong);
    background:#fef2f2;
    color:var(--wrong);
    font-weight:600;
  }
  .feedback {
    min-height:1.6em;
    font-size:0.95rem;
    margin-top:4px;
  }
  .feedback.correct {
    color:var(--correct);
  }
  .feedback.wrong {
    color:var(--wrong);
  }
  .nav-row {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-top:12px;
    gap:8px;
  }
  .score-text {
    font-size:0.9rem;
    color:var(--ink-sub);
  }
  .next-btn {
    border:none;
    border-radius:999px;
    background:var(--primary);
    color:white;
    font-size:0.95rem;
    font-weight:600;
    padding:8px 18px;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:4px;
    box-shadow:0 6px 14px rgba(79,70,229,0.35);
    transition:transform 0.05s ease, box-shadow 0.05s ease, opacity 0.15s;
    white-space:nowrap;
  }
  .next-btn:active {
    transform:translateY(1px);
    box-shadow:0 3px 8px rgba(79,70,229,0.4);
  }
  .next-btn.disabled {
    opacity:0.4;
    cursor:default;
    box-shadow:none;
    transform:none;
  }

  .roulette {
    margin-top:14px;
    text-align:center;
  }
  .roulette-label {
    font-size:0.9rem;
    color:var(--ink-sub);
    margin-bottom:4px;
  }
  .roulette-wheel {
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:72px;
    height:72px;
    border-radius:999px;
    border:2px solid var(--primary);
    font-size:1.4rem;
    font-weight:700;
    background:#ffffff;
    box-shadow:0 6px 14px rgba(79,70,229,0.25);
    cursor:pointer;
  }
  .roulette-wheel.disabled {
    opacity:0.4;
    cursor:default;
  }

  .result {
    text-align:center;
    margin-top:8px;
    font-size:1rem;
  }
  .restart-btn {
    margin-top:10px;
    border-radius:999px;
    border:1px solid var(--primary);
    background:white;
    color:var(--primary);
    font-weight:600;
    font-size:0.95rem;
    padding:8px 16px;
    cursor:pointer;
  }

  /* =========================
     â˜…ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ç”¨ å³ã‚µã‚¤ãƒ‰UIï¼ˆæ—¢å­˜UIã‚’å´©ã•ãªã„ãŸã‚ fixed ã§è¿½åŠ ï¼‰
     ========================= */
  .online-panel{
    position:fixed;
    right:12px;
    top:12px;
    width:270px;
    max-width:calc(100vw - 24px);
    background:#ffffffee;
    border:1px solid var(--border);
    border-radius:14px;
    padding:10px;
    box-shadow:0 10px 24px rgba(15,23,42,0.18);
    color:var(--ink);
    font-size:12px;
    z-index:9999;
  }
  .online-panel .row{ display:flex; gap:6px; align-items:center; margin:6px 0; }
  .online-panel input{
    width:100%;
    padding:6px 8px;
    border:1px solid var(--border);
    border-radius:10px;
    font-size:12px;
  }
  .online-panel button{
    padding:6px 10px;
    border:1px solid var(--border);
    border-radius:10px;
    background:#f8fafc;
    cursor:pointer;
    font-size:12px;
    white-space:nowrap;
  }
  .online-panel button.primary{
    background:var(--primary);
    border-color:var(--primary);
    color:#fff;
  }
  .online-panel button:disabled{ opacity:.45; cursor:default; }
  .online-panel .label{ font-weight:700; }
  .online-panel .small{ font-size:11px; color:var(--ink-sub); }
  .online-panel .pill{
    display:inline-flex; align-items:center; gap:6px;
    padding:2px 8px; border-radius:999px;
    border:1px solid var(--border);
    background:#fff;
  }
  .online-panel .dot{
    width:8px; height:8px; border-radius:99px;
    background:#9ca3af;
  }
  .online-panel .dot.ok{ background:var(--correct); }
  .online-panel .dot.ng{ background:var(--wrong); }

  @media (max-width:480px) {
    .app {
      padding:16px 12px 14px;
    }
    .question-text {
      font-size:1.05rem;
    }
    .choice-btn {
      padding:8px 10px;
      font-size:0.95rem;
    }
    .roulette-wheel {
      width:64px;
      height:64px;
      font-size:1.2rem;
    }
    .online-panel{
      right:8px;
      left:8px;
      width:auto;
      top:auto;
      bottom:8px;
    }
  }
</style>
</head>
<body>
  <div class="app">
    <div class="app-title">
      <ruby>èª<rt>ã”</rt></ruby>ã„ã‚¯ã‚¤ã‚º
    </div>

    <div class="status-row">
      <div>ã‚‚ã‚“ã ã„ <span id="qNumber">1</span> / <span id="qTotal">0</span></div>
      <div class="badge" id="modeBadge">ã—ã‚‡ã†ï¼”ã‚€ã</div>
    </div>

    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>

    <div class="card">
      <div class="question-text" id="questionText"></div>
      <div class="hint" id="questionHint"></div>

      <div class="choices" id="choicesContainer"></div>

      <div class="feedback" id="feedback"></div>

      <div class="nav-row">
        <div class="score-text" id="scoreText">ã›ã„ã‹ã„ï¼š0 ã‚‚ã‚“</div>
        <button class="next-btn disabled" id="nextBtn" type="button">
          ã“ãŸãˆã‚’ ãˆã‚‰ã‚“ã§ã­
        </button>
      </div>
    </div>

    <div class="roulette">
      <div class="roulette-label">ã›ã„ã‹ã„ã—ãŸã‚‰ ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆï¼</div>
      <div class="roulette-wheel disabled" id="rouletteWheel">ï¼Ÿ</div>
    </div>

    <div class="result" id="resultArea"></div>
  </div>

  <!-- â˜…å³å´UIï¼ˆå¿…é ˆä»•æ§˜ 5ï¼‰ -->
  <div class="online-panel" id="onlinePanel" aria-label="ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦">
    <div class="row" style="justify-content:space-between;">
      <div class="label">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦</div>
      <div class="pill" title="æ¥ç¶šçŠ¶æ…‹">
        <span class="dot" id="connDot"></span>
        <span id="connText" class="small">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</span>
      </div>
    </div>
    <div class="small" id="roleText">ãƒ­ãƒ¼ã‚«ãƒ«å¯¾æˆ¦ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³æœªæ¥ç¶šï¼‰</div>

    <div class="row">
      <input id="roomInput" placeholder="éƒ¨å±‹ç•ªå·ï¼ˆä¾‹: class1ï¼‰" />
      <button id="makeRoomUrlBtn" class="primary" type="button">URLä½œæˆ</button>
    </div>

    <div class="small">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ç”¨ï¼š</div>
    <div class="row">
      <input id="urlP1" readonly />
    </div>
    <div class="small">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ç”¨ï¼š</div>
    <div class="row">
      <input id="urlP2" readonly />
    </div>

    <div class="row" style="margin-top:8px;">
      <button id="startBtn" class="primary" type="button">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      <button id="resetBtn" type="button">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
    <div class="small" id="turnHint"></div>
  </div>

  <script type="module">
    /*****************************************************************
     * Firebaseè¨­å®šï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã‚’ãã®ã¾ã¾åŸ‹ã‚è¾¼ã¿ï¼‰
     *****************************************************************/
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyBtKWi2tXanWuDf_Du5C9tr5ZwOAfNBRIs",
      authDomain: "goi-battle-g3.firebaseapp.com",
      projectId: "goi-battle-g3",
      storageBucket: "goi-battle-g3.firebasestorage.app",
      messagingSenderId: "1052102588017",
      appId: "1:1052102588017:web:e8a09649466f4504f08dd0",
      measurementId: "G-Y7TQVZ2R2V"
    };

    /*****************************************************************
     * â˜…ã‚ªãƒ³ãƒ©ã‚¤ãƒ³åŒæœŸï¼ˆFirestoreï¼‰
     * - databaseURL ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã€è¨­å®šä¸è¦ã§ä½¿ãˆã‚‹ Firestore ã‚’æ¡ç”¨
     * - ãƒ«ãƒ¼ãƒ«ï¼šrevï¼ˆæ•°å€¤ï¼‰ãŒæ–°ã—ã„æ–¹ã‚’æ¡ç”¨
     *****************************************************************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, doc, setDoc, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const appFb = initializeApp(firebaseConfig);
    const db = getFirestore(appFb);

    /*****************************************************************
     * æ—¢å­˜ï¼šã‚‚ã‚“ã ã„ãƒ‡ãƒ¼ã‚¿ï¼ˆã“ã“ã¯å…ƒã®ã¾ã¾ï¼‰
     *****************************************************************/
    const questions = [
      {
        type: "kanji2",
        text: "ã€Œ<ruby>ä½œ<rt>ã¤ã</rt></ruby>ã‚‹ã€ã‚’<ruby>æ¼¢<rt>ã‹ã‚“</rt></ruby><ruby>å­—<rt>ã˜</rt></ruby>ï¼’<ruby>å­—<rt>ã˜</rt></ruby>ã§<ruby>è¨€<rt>ã„</rt></ruby>ã†ã¨ï¼Ÿ",
        hint: "<ruby>ä½œ<rt>ã•ã</rt></ruby><ruby>å“<rt>ã²ã‚“</rt></ruby>ã‚’ã¤ãã‚‹ ã¨ããªã©ã«ã¤ã‹ã† <ruby>è¨€<rt>ã“ã¨</rt></ruby>ã°ã€‚",
        choices: [
          "<ruby>åˆ¶<rt>ã›ã„</rt></ruby><ruby>ä½œ<rt>ã•ã</rt></ruby>",
          "<ruby>èª­<rt>ã©ã</rt></ruby><ruby>æ›¸<rt>ã—ã‚‡</rt></ruby>",
          "<ruby>é‹<rt>ã†ã‚“</rt></ruby><ruby>å‹•<rt>ã©ã†</rt></ruby>"
        ],
        correctIndex: 0,
        explanation: "ãªã«ã‹ã‚’ã¤ãã‚‹ã“ã¨ã‚’ <ruby>æ¼¢<rt>ã‹ã‚“</rt></ruby><ruby>å­—<rt>ã˜</rt></ruby>ï¼’<ruby>å­—<rt>ã˜</rt></ruby>ã§ã€Œ<ruby>åˆ¶<rt>ã›ã„</rt></ruby><ruby>ä½œ<rt>ã•ã</rt></ruby>ã€ã¨<ruby>è¨€<rt>ã„</rt></ruby>ã„ã¾ã™ã€‚"
      },
      {
        type: "kanji2",
        text: "ã€ŒãŠã²ã‚‹ã”ã¯ã‚“ã€ã‚’<ruby>æ¼¢<rt>ã‹ã‚“</rt></ruby><ruby>å­—<rt>ã˜</rt></ruby>ï¼’<ruby>å­—<rt>ã˜</rt></ruby>ã§<ruby>è¨€<rt>ã„</rt></ruby>ã†ã¨ï¼Ÿ",
        hint: "<ruby>æœ<rt>ã¡ã‚‡ã†</rt></ruby><ruby>é£Ÿ<rt>ã—ã‚‡ã</rt></ruby>ãƒ»<ruby>å¤•<rt>ã‚†ã†</rt></ruby><ruby>é£Ÿ<rt>ã—ã‚‡ã</rt></ruby>ã¨ãªã‚‰ã¶ <ruby>è¨€<rt>ã“ã¨</rt></ruby>ã°ã€‚",
        choices: [
          "<ruby>æœ<rt>ã¡ã‚‡ã†</rt></ruby><ruby>é£Ÿ<rt>ã—ã‚‡ã</rt></ruby>",
          "<ruby>æ˜¼<rt>ã¡ã‚…ã†</rt></ruby><ruby>é£Ÿ<rt>ã—ã‚‡ã</rt></ruby>",
          "<ruby>å¤•<rt>ã‚†ã†</rt></ruby><ruby>é£Ÿ<rt>ã—ã‚‡ã</rt></ruby>"
        ],
        correctIndex: 1,
        explanation: "ãŠã²ã‚‹ã”ã¯ã‚“ã¯ <ruby>æ¼¢<rt>ã‹ã‚“</rt></ruby><ruby>å­—<rt>ã˜</rt></ruby>ï¼’<ruby>å­—<rt>ã˜</rt></ruby>ã§ã€Œ<ruby>æ˜¼<rt>ã¡ã‚…ã†</rt></ruby><ruby>é£Ÿ<rt>ã—ã‚‡ã</rt></ruby>ã€ã¨<ruby>æ›¸<rt>ã‹</rt></ruby>ãã¾ã™ã€‚"
      },
      {
        type: "kanji2",
        text: "ã€Œãµãˆã‚‹ã€ã‚’<ruby>æ¼¢<rt>ã‹ã‚“</rt></ruby><ruby>å­—<rt>ã˜</rt></ruby>ï¼’<ruby>å­—<rt>ã˜</rt></ruby>ã§<ruby>è¨€<rt>ã„</rt></ruby>ã†ã¨ï¼Ÿ",
        hint: "<ruby>æ•°<rt>ã‹ãš</rt></ruby>ã‚„<ruby>é‡<rt>ã‚Šã‚‡ã†</rt></ruby>ãŒãŠãŠããªã‚‹ã“ã¨ã€‚",
        choices: [
          "<ruby>å¢—<rt>ãã†</rt></ruby><ruby>åŠ <rt>ã‹</rt></ruby>",
          "<ruby>é£²<rt>ã„ã‚“</rt></ruby><ruby>é£Ÿ<rt>ã—ã‚‡ã</rt></ruby>",
          "<ruby>æ‹¡<rt>ã‹ã</rt></ruby><ruby>å¤§<rt>ã ã„</rt></ruby>"
        ],
        correctIndex: 0,
        explanation: "<ruby>æ•°<rt>ã‹ãš</rt></ruby>ã‚„<ruby>é‡<rt>ã‚Šã‚‡ã†</rt></ruby>ãŒãµãˆã‚‹ã“ã¨ã‚’ã€Œ<ruby>å¢—<rt>ãã†</rt></ruby><ruby>åŠ <rt>ã‹</rt></ruby>ã€ã¨<ruby>è¨€<rt>ã„</rt></ruby>ã„ã¾ã™ã€‚"
      }
      /* çœç•¥ï¼šã“ã“ã‹ã‚‰ä¸‹ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè²¼ã£ã¦ãã‚ŒãŸ questions ã‚’ãã®ã¾ã¾ç¶šã‘ã¦ãã ã•ã„ */
    ];

    /*****************************************************************
     * DOMå‚ç…§ï¼ˆæ—¢å­˜IDã®ã¾ã¾ï¼‰
     *****************************************************************/
    const qTextEl = document.getElementById("questionText");
    const qHintEl = document.getElementById("questionHint");
    const choicesEl = document.getElementById("choicesContainer");
    const feedbackEl = document.getElementById("feedback");
    const qNumberEl = document.getElementById("qNumber");
    const qTotalEl = document.getElementById("qTotal");
    const progressFillEl = document.getElementById("progressFill");
    const scoreTextEl = document.getElementById("scoreText");
    const nextBtn = document.getElementById("nextBtn");
    const resultArea = document.getElementById("resultArea");
    const rouletteWheelEl = document.getElementById("rouletteWheel");
    const modeBadgeEl = document.getElementById("modeBadge");

    // å³å´UI
    const roomInput = document.getElementById("roomInput");
    const makeRoomUrlBtn = document.getElementById("makeRoomUrlBtn");
    const urlP1 = document.getElementById("urlP1");
    const urlP2 = document.getElementById("urlP2");
    const startBtn = document.getElementById("startBtn");
    const resetBtn = document.getElementById("resetBtn");
    const connDot = document.getElementById("connDot");
    const connText = document.getElementById("connText");
    const roleText = document.getElementById("roleText");
    const turnHint = document.getElementById("turnHint");

    /*****************************************************************
     * çŠ¶æ…‹ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«/ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å…±é€šï¼‰
     *****************************************************************/
    let currentIndex = 0;
    let score = 0;
    let answeredCurrent = false;

    let quizOrder = [];
    let currentChoiceOrder = [0,1,2];
    let currentCorrectIndex = 0;
    let selectedButtonIndex = -1;

    let rouletteInterval = null;
    let rouletteCurrent = 1;
    let rouletteSpinning = false;
    let rouletteEnabled = false;
    let rouletteStartedAt = 0;

    let turn = 1;

    /*****************************************************************
     * ONLINEåˆ¶å¾¡
     *****************************************************************/
    const ONLINE = {
      enabled: false,
      roomId: "",
      role: 0,
      suppress: false,
      lastRev: 0,
      unsub: null
    };

    function parseOnlineParams(){
      const url = new URL(location.href);
      const room = url.searchParams.get("room") || "";
      const p = parseInt(url.searchParams.get("p") || "0", 10);
      if(room && (p === 1 || p === 2)){
        ONLINE.enabled = true;
        ONLINE.roomId = room.trim();
        ONLINE.role = p;
      } else {
        ONLINE.enabled = false;
        ONLINE.roomId = "";
        ONLINE.role = 0;
      }
    }

    function roomDocRef(){
      return doc(db, "rooms", ONLINE.roomId);
    }

    function setConn(ok){
      connDot.classList.remove("ok","ng");
      connDot.classList.add(ok ? "ok":"ng");
      connText.textContent = ok ? "ã‚ªãƒ³ãƒ©ã‚¤ãƒ³" : "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³";
    }

    function canOperateNow(){
      if(!ONLINE.enabled) return true;
      return ONLINE.role === turn;
    }

    function canStartOrReset(){
      if(!ONLINE.enabled) return true;
      return ONLINE.role === 1;
    }

    function updateRightPanelTexts(){
      if(!ONLINE.enabled){
        roleText.textContent = "ãƒ­ãƒ¼ã‚«ãƒ«å¯¾æˆ¦ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³æœªæ¥ç¶šï¼‰";
        modeBadgeEl.textContent = "ã—ã‚‡ã†ï¼”ã‚€ã";
        turnHint.textContent = "";
        startBtn.disabled = false;
        resetBtn.disabled = false;
        return;
      }
      modeBadgeEl.textContent = `ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ P${ONLINE.role}`;
      roleText.textContent = `éƒ¨å±‹ï¼š${ONLINE.roomId} / ã‚ãªãŸï¼šP${ONLINE.role}`;
      const youTurn = (ONLINE.role === turn);
      turnHint.textContent = youTurn ? "ã‚ãªãŸã® ã°ã‚“ã§ã™ï¼ˆæ“ä½œã§ãã¾ã™ï¼‰" : "ã‚ã„ã¦ã® ã°ã‚“ã§ã™ï¼ˆæ“ä½œã§ãã¾ã›ã‚“ï¼‰";
      startBtn.disabled = !canStartOrReset();
      resetBtn.disabled = !canStartOrReset();
    }

    async function pushStateToCloud(){
      if(!ONLINE.enabled) return;
      if(ONLINE.suppress) return;
      const rev = Date.now();
      ONLINE.lastRev = rev;
      const payload = {
        meta: { rev, updatedAt: serverTimestamp() },
        state: exportState()
      };
      try{
        await setDoc(roomDocRef(), payload, { merge: true });
        setConn(true);
      }catch(e){
        console.warn("pushStateToCloud failed", e);
        setConn(false);
      }
    }

    function listenCloud(){
      if(!ONLINE.enabled) return;
      if(ONLINE.unsub) ONLINE.unsub();
      setConn(false);
      ONLINE.unsub = onSnapshot(roomDocRef(), (snap)=>{
        if(!snap.exists()){
          setConn(false);
          return;
        }
        const data = snap.data() || {};
        const meta = data.meta || {};
        const rev = typeof meta.rev === "number" ? meta.rev : 0;
        const remote = data.state || null;
        if(!remote) return;
        if(rev <= ONLINE.lastRev) return;

        ONLINE.lastRev = rev;
        ONLINE.suppress = true;
        try{
          importState(remote);
        } finally {
          ONLINE.suppress = false;
        }
        setConn(true);
      }, (err)=>{
        console.warn("onSnapshot error", err);
        setConn(false);
      });
    }

    /*****************************************************************
     * é…åˆ—ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆãƒ•ã‚£ãƒƒã‚·ãƒ£ãƒ¼â€“ã‚¤ã‚§ãƒ¼ãƒ„ï¼‰
     *****************************************************************/
    function shuffle(array) {
      const arr = array.slice();
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    /*****************************************************************
     * ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆï¼ˆåŒæœŸå¯¾å¿œï¼‰
     *****************************************************************/
    function clearRouletteTimer(){
      if (rouletteInterval) {
        clearInterval(rouletteInterval);
        rouletteInterval = null;
      }
    }
    function resetRoulette() {
      clearRouletteTimer();
      rouletteSpinning = false;
      rouletteEnabled = false;
      rouletteCurrent = 1;
      rouletteStartedAt = 0;
      rouletteWheelEl.textContent = "ï¼Ÿ";
      rouletteWheelEl.classList.add("disabled");
    }
    function enableRouletteAfterCorrect() {
      rouletteEnabled = true;
      rouletteWheelEl.classList.remove("disabled");
      rouletteWheelEl.textContent = "â–¶";
    }
    function rouletteValueFromTime(startMs, nowMs){
      const dt = Math.max(0, nowMs - startMs);
      const step = Math.floor(dt / 80);
      const v = (step % 10) + 1;
      return v;
    }
    function startRoulette(){
      clearRouletteTimer();
      rouletteSpinning = true;
      rouletteStartedAt = Date.now();
      rouletteCurrent = 1;
      rouletteWheelEl.textContent = rouletteCurrent;
      rouletteInterval = setInterval(()=>{
        rouletteCurrent = rouletteValueFromTime(rouletteStartedAt, Date.now());
        rouletteWheelEl.textContent = rouletteCurrent;
      }, 80);
    }
    function stopRoulette(){
      clearRouletteTimer();
      rouletteSpinning = false;
      rouletteCurrent = rouletteValueFromTime(rouletteStartedAt, Date.now());
      rouletteWheelEl.textContent = rouletteCurrent;
      rouletteEnabled = false;
      rouletteWheelEl.classList.add("disabled");
    }

    rouletteWheelEl.addEventListener("click", async () => {
      if (!rouletteEnabled) return;
      if (!canOperateNow()) return;
      if (!rouletteSpinning) startRoulette();
      else stopRoulette();
      await pushStateToCloud();
    });

    /*****************************************************************
     * é€²æ—ãƒ»æç”»
     *****************************************************************/
    function updateProgress() {
      const total = quizOrder.length || questions.length;
      const percent = (currentIndex / total) * 100;
      progressFillEl.style.width = percent + "%";
    }
    function computeCorrectIndexForOrder(qIdx, order){
      const q = questions[qIdx];
      let correctBtnIdx = 0;
      order.forEach((choiceIdx, buttonIdx)=>{
        if(choiceIdx === q.correctIndex) correctBtnIdx = buttonIdx;
      });
      return correctBtnIdx;
    }
    function renderQuestion() {
      const qIdx = quizOrder[currentIndex];
      const q = questions[qIdx];

      qNumberEl.textContent = (currentIndex + 1).toString();
      qTotalEl.textContent = quizOrder.length.toString();
      updateProgress();

      qTextEl.innerHTML = q.text;
      qHintEl.innerHTML = q.hint || "";
      feedbackEl.innerHTML = "";
      feedbackEl.className = "feedback";
      resultArea.innerHTML = "";

      resetRoulette();

      choicesEl.innerHTML = "";
      currentCorrectIndex = computeCorrectIndexForOrder(qIdx, currentChoiceOrder);

      currentChoiceOrder.forEach((choiceIdx, buttonIdx) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "choice-btn";

        const labelSpan = document.createElement("span");
        labelSpan.className = "label";
        labelSpan.innerHTML = q.choices[choiceIdx];

        const markSpan = document.createElement("span");
        markSpan.className = "mark";
        markSpan.textContent = String.fromCharCode(65 + buttonIdx);

        btn.appendChild(labelSpan);
        btn.appendChild(markSpan);

        btn.addEventListener("click", async () => {
          await handleChoice(buttonIdx);
        });
        choicesEl.appendChild(btn);
      });

      nextBtn.textContent =
        currentIndex === quizOrder.length - 1
          ? "ã•ã„ã”ã® ã‘ã£ã‹ ã‚’ ã¿ã‚‹"
          : "ãˆã‚‰ã‚“ã ã‚‰ ã¤ãã¸ âœ";
      nextBtn.classList.add("disabled");

      answeredCurrent = false;
      selectedButtonIndex = -1;

      updateInteractivityByTurn();
    }

    function updateInteractivityByTurn(){
      const buttons = Array.from(choicesEl.getElementsByClassName("choice-btn"));
      const allow = canOperateNow();
      const lock = ONLINE.enabled && !allow;

      if(answeredCurrent){
        buttons.forEach(btn => btn.classList.add("disabled"));
      } else {
        if(lock) buttons.forEach(btn => btn.classList.add("disabled"));
        else buttons.forEach(btn => btn.classList.remove("disabled"));
      }

      if(lock) nextBtn.classList.add("disabled");
      updateRightPanelTexts();
    }

    async function handleChoice(buttonIndex) {
      if (answeredCurrent) return;
      if (!canOperateNow()) return;

      const qIdx = quizOrder[currentIndex];
      const q = questions[qIdx];
      const buttons = Array.from(choicesEl.getElementsByClassName("choice-btn"));
      answeredCurrent = true;
      selectedButtonIndex = buttonIndex;

      buttons.forEach(btn => btn.classList.add("disabled"));

      if (buttonIndex === currentCorrectIndex) {
        score++;
        scoreTextEl.textContent = `ã›ã„ã‹ã„ï¼š${score} ã‚‚ã‚“`;
        feedbackEl.innerHTML = "â­• <ruby>æ­£<rt>ã›ã„</rt></ruby><ruby>è§£<rt>ã‹ã„</rt></ruby>ï¼ã€€" + (q.explanation || "");
        feedbackEl.className = "feedback correct";
        buttons[buttonIndex].classList.add("correct");
        enableRouletteAfterCorrect();
      } else {
        feedbackEl.innerHTML = "âŒ ã–ã‚“ã­ã‚“ã€‚ã€€" + (q.explanation || "");
        feedbackEl.className = "feedback wrong";
        buttons[buttonIndex].classList.add("wrong");
        const correctBtn = buttons[currentCorrectIndex];
        if (correctBtn) correctBtn.classList.add("correct");
        resetRoulette();
      }

      nextBtn.classList.remove("disabled");
      updateInteractivityByTurn();
      await pushStateToCloud();
    }

    nextBtn.addEventListener("click", async () => {
      if (nextBtn.classList.contains("disabled")) return;
      if (!canOperateNow()) return;

      if (currentIndex < quizOrder.length - 1) {
        currentIndex++;
        currentChoiceOrder = shuffle([0,1,2]);
        renderQuestion();
      } else {
        showResult();
      }

      if(ONLINE.enabled){
        turn = (turn === 1) ? 2 : 1;
        updateInteractivityByTurn();
      }
      await pushStateToCloud();
    });

    function showResult() {
      const total = quizOrder.length;
      const percent = Math.round((score / total) * 100);
      let message = "";

      if (percent === 100) message = "ğŸ’® ã™ã°ã‚‰ã—ã„ï¼ ãœã‚“ã¶ <ruby>æ­£<rt>ã›ã„</rt></ruby><ruby>è§£<rt>ã‹ã„</rt></ruby>ã§ã™ã€‚ã”ã„ã‚Šã‚‡ã ã°ã£ã¡ã‚Šï¼";
      else if (percent >= 70) message = "âœ¨ ã‚ˆãã§ãã¾ã—ãŸï¼ ã‚ã¨ã™ã“ã—ã§ ã¾ã‚“ã¦ã‚“ã§ã™ã€‚";
      else if (percent >= 50) message = "â—¯ ãŒã‚“ã°ã‚Šã¾ã—ãŸã€‚ ã‚‚ã†ã„ã¡ã© ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ã¿ã‚ˆã†ã€‚";
      else message = "ğŸ“˜ ã“ã‚Œã‹ã‚‰ ã©ã‚“ã©ã‚“ <ruby>èª<rt>ã”</rt></ruby>ã„ã‚’ ãµã‚„ã—ã¦ã„ã“ã†ã€‚";

      resultArea.innerHTML = `ã‘ã£ã‹ï¼š${score} / ${total} ã‚‚ã‚“ <br>${message}`;

      const restart = document.createElement("button");
      restart.type = "button";
      restart.textContent = "ã‚‚ã†ã„ã¡ã© ãƒãƒ£ãƒ¬ãƒ³ã‚¸";
      restart.className = "restart-btn";
      restart.addEventListener("click", async () => {
        if(ONLINE.enabled && ONLINE.role !== 1) return;
        await doResetFromP1();
      });
      resultArea.appendChild(restart);

      updateInteractivityByTurn();
    }

    function buildNewGameState(){
      const orderIdx = shuffle([...Array(questions.length).keys()]);
      return {
        currentIndex: 0,
        score: 0,
        answeredCurrent: false,
        selectedButtonIndex: -1,
        quizOrder: orderIdx,
        currentChoiceOrder: shuffle([0,1,2]),
        turn: 1,
        rouletteCurrent: 1,
        rouletteEnabled: false,
        rouletteSpinning: false,
        rouletteStartedAt: 0
      };
    }

    async function doResetFromP1(){
      const ns = buildNewGameState();
      importState(ns);
      await pushStateToCloud();
    }

    function exportState(){
      return {
        currentIndex,
        score,
        answeredCurrent,
        selectedButtonIndex,
        quizOrder,
        currentChoiceOrder: currentChoiceOrder.slice(),
        turn,
        rouletteCurrent,
        rouletteEnabled,
        rouletteSpinning,
        rouletteStartedAt
      };
    }

    function importState(s){
      if(!s || typeof s !== "object") return;

      currentIndex = Number(s.currentIndex ?? currentIndex);
      score = Number(s.score ?? score);
      answeredCurrent = !!s.answeredCurrent;
      selectedButtonIndex = Number(s.selectedButtonIndex ?? -1);

      quizOrder = Array.isArray(s.quizOrder) ? s.quizOrder.slice() : quizOrder;
      currentChoiceOrder = Array.isArray(s.currentChoiceOrder) ? s.currentChoiceOrder.slice() : currentChoiceOrder;

      turn = Number(s.turn ?? turn);
      rouletteCurrent = Number(s.rouletteCurrent ?? rouletteCurrent);
      rouletteEnabled = !!s.rouletteEnabled;
      rouletteSpinning = !!s.rouletteSpinning;
      rouletteStartedAt = Number(s.rouletteStartedAt ?? rouletteStartedAt);

      scoreTextEl.textContent = `ã›ã„ã‹ã„ï¼š${score} ã‚‚ã‚“`;

      renderQuestion();
      updateInteractivityByTurn();
    }

    /*****************************************************************
     * å³å´UIï¼ˆéƒ¨å±‹URLä½œæˆï¼‰
     *****************************************************************/
    function makeRoomUrls(roomId){
      const base = location.origin + location.pathname;
      const p1url = `${base}?room=${encodeURIComponent(roomId)}&p=1`;
      const p2url = `${base}?room=${encodeURIComponent(roomId)}&p=2`;
      urlP1.value = p1url;
      urlP2.value = p2url;
      urlP1.select();
    }

    makeRoomUrlBtn.addEventListener("click", ()=>{
      const roomId = (roomInput.value || "").trim();
      if(!roomId) return;
      makeRoomUrls(roomId);
    });

    urlP1.addEventListener("click", ()=> urlP1.select());
    urlP2.addEventListener("click", ()=> urlP2.select());

    startBtn.addEventListener("click", async ()=>{
      if(!canStartOrReset()) return;
      await doResetFromP1();
    });

    resetBtn.addEventListener("click", async ()=>{
      if(!canStartOrReset()) return;
      await doResetFromP1();
    });

    function initOffline(){
      const ns = buildNewGameState();
      importState(ns);
      setConn(false);
      connText.textContent = "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³";
      updateRightPanelTexts();
    }

    async function initOnline(){
      listenCloud();
      updateRightPanelTexts();
      setTimeout(()=>{
        if(ONLINE.enabled){
          const ns = buildNewGameState();
          importState(ns);
          updateRightPanelTexts();
        }
      }, 10);
    }

    parseOnlineParams();
    if(ONLINE.enabled){
      setConn(false);
      updateRightPanelTexts();
      await initOnline();
    } else {
      initOffline();
    }
  </script>
</body>
</html>
