<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>æ¼¢å­—ã®èª­ã¿æ–¹å…¥åŠ›ã‚¢ãƒ—ãƒª</title>
<style>
  :root{
    --bg:#f6f7fb;
    --card:#ffffff;
    --ink:#111827;
    --sub:#6b7280;
    --border:#e5e7eb;
    --primary:#2563eb;
    --primary2:#1d4ed8;
    --ok:#16a34a;
    --ng:#dc2626;
    --shadow:0 10px 24px rgba(0,0,0,.08);
    --radius:18px;
    --keyH:48px;
    --gap:10px;
  }
  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", sans-serif;
    background:var(--bg);
    color:var(--ink);
  }
  .wrap{
    max-width: 980px;
    margin: 0 auto;
    padding: 16px 14px 24px;
  }
  .top{
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
    margin-bottom:12px;
    flex-wrap:wrap;
  }
  .badge{
    background:#eef2ff;
    border:1px solid #e0e7ff;
    color:#3730a3;
    padding:8px 12px;
    border-radius:999px;
    font-weight:900;
    font-size:14px;
    white-space:nowrap;
  }

  /* â˜…å·¦ä¸Šã«ç½®ãï¼šçµ‚äº†ã—ã¦æœ€åˆã‹ã‚‰ï¼‹ä¿å­˜ï¼‹è¨˜éŒ²ã‚’è¦‹ã‚‹ï¼‹ã—ã‹ã‘å¾—ç‚¹ï¼ˆé…ç½®ã ã‘ï¼‰ */
  .topLeftTools{
    display:flex;
    align-items:center;
    justify-content:flex-start;
    gap:10px;
    flex-wrap:wrap;
  }
  .rewardPtsBadge{
    border:1px solid var(--border);
    background:#f9fafb;
    border-radius:999px;
    padding:10px 12px;
    font-weight:900;
    font-size:14px;
    color:#374151;
    box-shadow: 0 6px 16px rgba(0,0,0,.06);
    white-space:nowrap;
  }

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:16px;
  }
  .qtitle{
    font-size:14px;
    color:var(--sub);
    font-weight:900;
    letter-spacing:.02em;
    margin-bottom:10px;
  }
  .kanji{
    font-size: clamp(34px, 5vw, 56px);
    font-weight: 900;
    line-height: 1.05;
    padding: 10px 12px;
    border-radius:14px;
    background:#f9fafb;
    border:1px solid var(--border);
    text-align:center;
  }

  .inputBox{
    margin-top:12px;
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    flex-wrap:wrap;
  }
  .answer{
    flex: 1 1 280px;
    min-height:56px;
    border:2px solid var(--border);
    border-radius:14px;
    padding:10px 12px;
    font-size:26px;
    font-weight:900;
    background:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    letter-spacing:.05em;
  }
  .answer.ok{ border-color: rgba(22,163,74,.45); background: rgba(22,163,74,.06); }
  .answer.ng{ border-color: rgba(220,38,38,.45); background: rgba(220,38,38,.06); }

  .btns{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  button{
    appearance:none;
    border:none;
    border-radius:14px;
    padding:12px 14px;
    font-weight:900;
    font-size:16px;
    cursor:pointer;
    box-shadow: 0 6px 16px rgba(0,0,0,.08);
    transition: transform .05s ease;
    touch-action: manipulation;
  }
  button:active{ transform: translateY(1px); }
  .primary{ background:var(--primary); color:#fff; }
  .primary:hover{ background:var(--primary2); }
  .ghost{ background:#f3f4f6; color:#111827; }
  .danger{ background:#fee2e2; color:#7f1d1d; }
  .muted{ background:#e5e7eb; color:#374151; }
  button[disabled]{ opacity:.5; cursor:not-allowed; box-shadow:none; }

  .msg{
    margin-top:10px;
    font-size:22px;
    font-weight:900;
    text-align:center;
    min-height: 1.6em;
  }
  .msg.ok{ color:var(--ok); }
  .msg.ng{ color:var(--ng); }
  .hintLine{
    margin-top:6px;
    text-align:center;
    color:var(--sub);
    font-weight:900;
    font-size:16px;
    min-height: 1.4em;
  }

  .underInputRow{
    margin-top:10px;
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap:10px;
  }

  /* ===== ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ ===== */
  .kbd{
    margin-top:14px;
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:12px;
  }
  .kbdTitle{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:10px;
  }
  .kbdTitle .t{ font-weight:900; color:#374151; }
  .kbdTitle .s{ font-size:13px; color:var(--sub); font-weight:900; }

  .baseGrid{
    display:grid;
    grid-template-columns: repeat(11, minmax(0, 1fr));
    gap: var(--gap);
    align-items:stretch;
  }
  .key{
    height: var(--keyH);
    border-radius:10px;
    border:1px solid var(--border);
    background:#fff;
    font-size:18px;
    font-weight:900;
    display:flex;
    align-items:center;
    justify-content:center;
    user-select:none;
    cursor:pointer;
    box-shadow: 0 3px 10px rgba(0,0,0,.06);
    touch-action: manipulation;
    color: var(--ink);
  }
  .key:active{ transform: translateY(1px); }
  .key.empty{
    background: transparent;
    border: none;
    box-shadow:none;
    cursor: default;
  }

  .panelBar{
    margin-top:12px;
    background:#eef2ff;
    border:1px solid #e0e7ff;
    border-radius:12px;
    padding:8px 10px;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:12px;
    font-weight:900;
    color:#374151;
  }
  .pill{
    padding:6px 10px;
    border-radius:999px;
    background:#22c55e;
    color:#fff;
    font-size:13px;
    cursor:pointer;
    user-select:none;
    box-shadow: 0 6px 14px rgba(0,0,0,.10);
  }
  .pill.off{
    background:#9ca3af;
  }

  .dakutenGrid{
    margin-top:10px;
    display:grid;
    grid-template-columns: repeat(5, minmax(0, 1fr));
    gap: var(--gap);
  }
  .youonGrid{
    margin-top:10px;
    display:grid;
    grid-template-columns: repeat(11, minmax(0, 1fr));
    gap: var(--gap);
  }

  .bottomRow{
    margin-top:12px;
    display:grid;
    grid-template-columns: repeat(8, minmax(0, 1fr));
    gap: var(--gap);
    align-items:stretch;
  }
  .key.blue{
    border-color:#bfdbfe;
    background:#eff6ff;
  }
  .key.primary{
    border-color:#93c5fd;
    background:#dbeafe;
  }

  /* ===== ã”ã»ã†ã³ ===== */
  .rewardWrap{
    margin-top:14px;
    border:1px solid var(--border);
    border-radius:16px;
    background:#ffffff;
    box-shadow: 0 8px 18px rgba(0,0,0,.06);
    padding:12px;
    text-align:center;
  }
  .rewardTitle{
    font-weight:900;
    color:#374151;
    font-size:14px;
    margin-bottom:6px;
  }
  .rewardSub{
    color:var(--sub);
    font-weight:900;
    font-size:13px;
    margin-bottom:10px;
  }

  /* â˜…éŠã¶ä»•æ›ã‘ã‚’ã€Œã”ã»ã†ã³ã€ã®ä¸‹ã®çœŸã‚“ä¸­ã¸ï¼ˆé…ç½®ã ã‘ï¼‰ */
  .rewardRow{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    flex-wrap:wrap;
    margin-top:4px;
  }

  .rewardWheel{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:78px;
    height:78px;
    border-radius:999px;
    border:2px solid var(--primary);
    background:#fff;
    box-shadow:0 6px 14px rgba(37,99,235,0.18);
    font-size:22px;
    font-weight:900;
    cursor:pointer;
    user-select:none;
  }
  .rewardWheel.disabled{
    opacity:.45;
    cursor:default;
  }
  .rewardHint{
    margin-top:8px;
    min-height:1.4em;
    font-weight:900;
    color:#374151;
  }

  .rewardCardContainer{
    margin-top:10px;
    display:none;
    justify-content:center;
    gap:10px;
  }
  .rewardCard{
    width:60px;
    height:80px;
    border-radius:10px;
    border:2px solid var(--primary);
    background:linear-gradient(135deg,#e5e7eb,#d1d5db);
    box-shadow:0 4px 8px rgba(15,23,42,0.15);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:22px;
    font-weight:900;
    cursor:pointer;
    user-select:none;
    transition:transform 0.1s ease, box-shadow 0.1s ease, background 0.15s, border-color 0.15s;
  }
  .rewardCard:active{
    transform:translateY(1px);
    box-shadow:0 2px 4px rgba(15,23,42,0.2);
  }
  .rewardCard.disabled{
    opacity:0.6;
    cursor:default;
    box-shadow:none;
  }
  .rewardCard.selected{
    background:#ffffff;
    border-color: var(--ok);
  }

  /* ===== ã‚¹ãƒ­ãƒƒãƒˆï¼ˆ3ãƒªãƒ¼ãƒ«ãƒ»1æšãšã¤æ­¢ã‚ã‚‹ï¼‰ ===== */
  .slot-area{
    display:flex;
    justify-content:center;
    gap:10px;
  }
  .slot-box{
    width:70px;
    height:90px;
    border-radius:14px;
    background:#111827;
    box-shadow:0 8px 16px rgba(0,0,0,.35) inset;
    display:flex;
    justify-content:center;
    align-items:center;
    cursor:pointer;
    position:relative;
    overflow:hidden;
    touch-action:manipulation;
  }
  .slot-num{
    font-size:44px;
    color:#f9fafb;
    font-weight:700;
    text-shadow:0 0 8px rgba(15,23,42,.8);
    transition:transform .12s ease-out, opacity .12s ease-out;
  }
  .slot-box.spinning .slot-num{
    opacity:.85;
    transform:translateY(2px);
  }
  .slot-box.stopped{
    box-shadow:0 0 0 rgba(0,0,0,0) inset;
  }

  /* â˜…30ç‚¹ã§ ãã™ç‰ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ */
  .kusudamaOverlay{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:rgba(17,24,39,.35);
    z-index:9999;
    padding:20px;
  }
  .kusudamaCard{
    width:min(520px, 92vw);
    background:#fff;
    border:1px solid var(--border);
    border-radius:20px;
    box-shadow:0 20px 60px rgba(0,0,0,.22);
    padding:18px 16px 14px;
    text-align:center;
  }
  .kusudamaTitle{
    font-weight:900;
    font-size:18px;
    margin-bottom:6px;
  }
  .kusudamaEmoji{
    font-size:64px;
    line-height:1;
    margin:10px 0 6px;
    display:inline-block;
    transform-origin: 50% 0%;
    animation: kusuSwing .9s ease-in-out infinite alternate;
  }
  @keyframes kusuSwing{
    from{ transform: rotate(-6deg); }
    to{ transform: rotate(6deg); }
  }
  .confettiLine{
    font-weight:900;
    color:#374151;
    margin-top:6px;
  }
  .kusudamaNote{
    color:var(--sub);
    font-weight:900;
    font-size:13px;
    margin-top:10px;
  }

  /* â˜…å­¦ç¿’ãƒ­ã‚°ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ */
  .logOverlay{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:rgba(17,24,39,.35);
    z-index:10000;
    padding:20px;
  }
  .logCard{
    width:min(920px, 96vw);
    max-height: 88vh;
    overflow:auto;
    background:#fff;
    border:1px solid var(--border);
    border-radius:20px;
    box-shadow:0 20px 60px rgba(0,0,0,.22);
    padding:14px;
  }
  .logHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:10px;
  }
  .logTitle{
    font-weight:900;
    font-size:16px;
    color:#111827;
  }
  .logActions{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .logTabs{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin: 6px 0 10px;
  }
  .logTabBtn{
    border:1px solid var(--border);
    background:#f3f4f6;
    color:#111827;
    border-radius:999px;
    padding:8px 12px;
    font-weight:900;
    font-size:13px;
    cursor:pointer;
    user-select:none;
    box-shadow: 0 6px 16px rgba(0,0,0,.06);
  }
  .logTabBtn.active{
    background:#eef2ff;
    border-color:#e0e7ff;
    color:#3730a3;
  }
  .logTable{
    width:100%;
    border-collapse:collapse;
    font-size:14px;
  }
  .logTable th, .logTable td{
    border:1px solid var(--border);
    padding:10px 10px;
    text-align:left;
    vertical-align:top;
    white-space:nowrap;
    font-weight:900;
  }
  .logTable th{
    background:#f9fafb;
    color:#374151;
  }
  .logTable td{
    color:#111827;
    font-weight:800;
  }
  .logEmpty{
    color:var(--sub);
    font-weight:900;
    padding:12px 4px 4px;
  }
/* ===============================
   â˜…è¿½åŠ ï¼š30ã®å€æ•°ã§èµ·å‹•ã™ã‚‹ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰
   ç½®ãå ´æ‰€ï¼šã‚ãªãŸã® <style> ã®ä¸€ç•ªä¸‹ã«ã€ãã®ã¾ã¾è¿½åŠ 
   ï¼ˆæ—¢å­˜CSSã¯å‰Šé™¤ãƒ»å¤‰æ›´ãªã—ï¼‰
=============================== */
.shooterOverlay{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(17,24,39,.55);
  z-index:11000;
  padding:18px;
}
.shooterCard{
  width:min(760px, 96vw);
  background:#0b1220;
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  box-shadow:0 22px 70px rgba(0,0,0,.35);
  overflow:hidden;
}
.shooterTopbar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  background:rgba(255,255,255,.06);
}
.shooterTopbar .ttl{
  color:#e5e7eb;
  font-weight:900;
  font-size:14px;
  letter-spacing:.02em;
}
.shooterTopbar .stat{
  display:flex;
  align-items:center;
  gap:10px;
  color:#e5e7eb;
  font-weight:900;
  font-size:14px;
  flex-wrap:wrap;
  justify-content:flex-end;
}
.shooterTopbar .chip{
  padding:6px 10px;
  border-radius:999px;
  background:rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.12);
}
.shooterCanvasWrap{
  padding:10px 10px 12px;
}
canvas#shooterCanvas{
  width:100%;
  height:420px;
  display:block;
  background:linear-gradient(180deg, rgba(17,24,39,.9), rgba(17,24,39,.6));
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  touch-action:manipulation;
}
.shooterControls{
  display:flex;
  gap:10px;
  padding:12px;
  background:rgba(255,255,255,.04);
  justify-content:center;
  flex-wrap:wrap;
}
.shooterBtn{
  min-width:140px;
  border-radius:14px;
  padding:12px 14px;
  font-weight:900;
  font-size:16px;
  cursor:pointer;
  box-shadow:0 10px 20px rgba(0,0,0,.22);
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.10);
  color:#f9fafb;
}
.shooterBtn:active{ transform: translateY(1px); }
/* â˜…è¿½åŠ ï¼šã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°çµ‚äº†çµæœ */
.shooterCard{
  position:relative; /* çµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®åŸºæº– */
}

.shooterResult{
  position:absolute;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,.55);
  padding:16px;
}

.shooterResultInner{
  width:min(520px, 92vw);
  background:#0b1220;
  border:1px solid rgba(255,255,255,.14);
  border-radius:18px;
  box-shadow:0 22px 70px rgba(0,0,0,.45);
  padding:16px 14px;
  text-align:center;
}

.shooterResultTitle{
  color:#e5e7eb;
  font-weight:900;
  font-size:18px;
  margin-bottom:8px;
}

.shooterResultText{
  color:#f9fafb;
  font-weight:900;
  font-size:20px;
  margin-bottom:12px;
  letter-spacing:.02em;
}
/* ===============================
   â˜…è¿½åŠ ï¼šå•é¡Œç®¡ç†ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰
   ç½®ãå ´æ‰€ï¼š<style> ã®ä¸€ç•ªä¸‹
=============================== */
.manageOverlay{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(17,24,39,.45);
  z-index:12000;
  padding:18px;
}
.manageCard{
  width:min(920px, 96vw);
  max-height: 90vh;
  overflow:auto;
  background:#fff;
  border:1px solid var(--border);
  border-radius:20px;
  box-shadow:0 20px 60px rgba(0,0,0,.22);
}
.manageHeader{
  padding:14px 14px 8px;
  border-bottom:1px solid var(--border);
}
.manageTitle{
  font-weight:900;
  font-size:18px;
  color:#111827;
}
.manageSub{
  margin-top:4px;
  font-weight:900;
  font-size:13px;
  color:var(--sub);
}
.manageBody{
  padding:12px 14px 10px;
  display:grid;
  gap:14px;
}
.manageSection{
  border:1px solid var(--border);
  border-radius:16px;
  padding:12px;
  background:#fafafa;
}
.manageLabel{
  font-weight:900;
  color:#374151;
  margin-bottom:8px;
}
.manageTextarea{
  width:100%;
  border:2px solid var(--border);
  border-radius:14px;
  padding:10px 12px;
  font-weight:900;
  font-size:16px;
  resize:vertical;
  background:#fff;
}
.manageBtns{
  margin-top:10px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.manageNote{
  margin-top:10px;
  font-weight:900;
  color:#374151;
  min-height:1.4em;
}
.manageListTools{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:10px;
}
.manageList{
  display:grid;
  gap:8px;
}
.manageRow{
  display:flex;
  gap:10px;
  align-items:flex-start;
  background:#fff;
  border:1px solid var(--border);
  border-radius:14px;
  padding:10px 10px;
}
.manageRow input[type="checkbox"]{
  width:22px;
  height:22px;
  margin-top:2px;
}
.manageRowMain{
  flex:1;
  min-width:0;
}
.manageRowPrompt{
  font-weight:900;
  font-size:16px;
  color:#111827;
}
.manageRowAns{
  margin-top:2px;
  font-weight:900;
  font-size:13px;
  color:#6b7280;
  word-break:break-word;
}
.manageFooter{
  padding:10px 14px 14px;
  border-top:1px solid var(--border);
  display:flex;
  justify-content:flex-end;
}
/* ===============================
   â˜…è¿½åŠ ï¼šã‚¹ãƒãƒ›ã®ãƒ•ãƒªãƒƒã‚¯å…¥åŠ›ç”¨ï¼ˆãƒã‚¤ãƒ†ã‚£ãƒ–å…¥åŠ›ï¼‰
=============================== */
.nativeInput{
  position:absolute;
  left:-9999px;
  top:auto;
  width:1px;
  height:1px;
  opacity:0.01;
  pointer-events:none;
}

</style>

</style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <!-- â˜…å·¦ä¸Šï¼šçµ‚äº†ã—ã¦æœ€åˆã‹ã‚‰ï¼‹ä¿å­˜ï¼‹è¨˜éŒ²ã‚’è¦‹ã‚‹ï¼‹ã—ã‹ã‘å¾—ç‚¹ -->
    <div class="topLeftTools">
      <button class="ghost" id="restartBtn" type="button">ã‚„ã‚ŠãªãŠã—</button>
      <button class="ghost" id="saveProgressBtn" type="button">ã»ãã‚“</button>
      <button class="ghost" id="openLogBtn" type="button">ãã‚ãã‚’è¦‹ã‚‹</button>
      <button class="ghost" id="manageBtn" type="button">å•é¡Œç®¡ç†</button>
      <div class="rewardPtsBadge" id="rewardPtsBadge">ã—ã‹ã‘å¾—ç‚¹ï¼š0</div>
    </div>

    <div class="badge" id="progressBadge">ã‚‚ã‚“ã ã„ 1 / 1</div>
    <div class="badge" id="scoreBadge">ã›ã„ã‹ã„ 0</div>
  </div>

  <div class="card">
    <div class="qtitle">æ¼¢å­—ã®ã€Œã‚ˆã¿ã€ã‚’ ã²ã‚‰ãŒãªã§ ã„ã‚Œã¦ã­</div>
    <div class="kanji" id="prompt">â€”</div>

  <div class="inputBox">
  <div class="answer" id="answerView" aria-label="å…¥åŠ›æ¬„"></div>

  <input id="nativeInput" class="nativeInput" type="text"
         inputmode="kana" autocomplete="off"
         autocapitalize="off" spellcheck="false">
</div>

      <div class="btns">
        <button class="ghost" id="hintBtn">ãƒ’ãƒ³ãƒˆ</button>
        <!-- â˜…ã€Œã›ã„ã‹ã„ã‚’è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³å‰Šé™¤ -->
        <button class="primary" id="checkBtn">ã§ããŸ</button>
        <button class="ghost" id="nextBtn" disabled>ã¤ãã¸</button>
      </div>
    </div>

    <div class="underInputRow">
      <button class="ghost" id="readBtn">ã‚ˆã¿ã‚ã’ã‚‹</button>
      <button class="ghost" id="backBtn">1ã¤ã‘ã™</button>
      <button class="danger" id="clearBtn">ãœã‚“ã¶ã‘ã™</button>
    </div>

    <div class="msg" id="msg"></div>
    <div class="hintLine" id="hintLine"></div>
  </div>

  <div class="kbd" aria-label="ã‹ãªã‚­ãƒ¼ãƒœãƒ¼ãƒ‰">
    <div class="kbdTitle">
      <div class="t">50ãŠã‚“ ã‹ãªã‚­ãƒ¼ãƒœãƒ¼ãƒ‰</div>
      <div class="s">ã‚¿ãƒƒãƒ—ã§ ã«ã‚…ã†ã‚Šã‚‡ã</div>
    </div>

    <div class="baseGrid" id="baseGrid"></div>

    <div class="panelBar">
      <div>ã ããŠã‚“ãƒ»ã¯ã‚“ã ããŠã‚“</div>
      <div class="pill" id="dakutenToggle">ã¿ãˆãªã„</div>
    </div>
    <div class="dakutenGrid" id="dakutenGrid"></div>

    <div class="panelBar">
      <div>ã‚ˆã†ãŠã‚“</div>
      <div class="pill" id="youonToggle">ã¿ãˆãªã„</div>
    </div>
    <div class="youonGrid" id="youonGrid"></div>

    <div class="bottomRow">
      <div class="key blue" id="smallKey">å°</div>
      <div class="key primary" id="dakutenKey">ã‚›</div>
      <div class="key primary" id="handakutenKey">ã‚œ</div>
      <div class="key" data-ch="ã‚ƒ">ã‚ƒ</div>
      <div class="key" data-ch="ã‚…">ã‚…</div>
      <div class="key" data-ch="ã‚‡">ã‚‡</div>
      <div class="key" data-ch="ã£">ã£</div>
      <div class="key" data-ch="ãƒ¼">ãƒ¼</div>
    </div>
  </div>

  <div class="rewardWrap" aria-label="ã”ã»ã†ã³">
    <div class="rewardTitle">ã”ã»ã†ã³</div>
    <div class="rewardSub" id="rewardSub">ã‚ã¨ 5 ã‹ã„ ã›ã„ã‹ã„ã§ ã‚ãã¹ã‚‹ã‚ˆ</div>

    <!-- â˜…éŠã¶ä»•æ›ã‘ï¼šã”ã»ã†ã³ã®ä¸‹ã®çœŸã‚“ä¸­ -->
    <div class="rewardRow">
      <div class="rewardWheel disabled" id="rewardWheel">ğŸ”’</div>

      <!-- â˜…ã‚¹ãƒ­ãƒƒãƒˆï¼ˆ3ãƒªãƒ¼ãƒ«ï¼‰ -->
      <div id="rewardSlot" style="display:none;">
        <div class="slot-area">
          <div class="slot-box stopped" data-slot="0"><div class="slot-num">7</div></div>
          <div class="slot-box stopped" data-slot="1"><div class="slot-num">7</div></div>
          <div class="slot-box stopped" data-slot="2"><div class="slot-num">7</div></div>
        </div>
      </div>
    </div>

    <div class="rewardCardContainer" id="rewardCardContainer"></div>
    <div class="rewardHint" id="rewardHint"></div>
  </div>
</div>

<div class="kusudamaOverlay" id="kusudamaOverlay" role="dialog" aria-modal="true">
  <div class="kusudamaCard">
    <div class="kusudamaTitle">30ã¦ã‚“ ãŸã£ã›ã„ï¼</div>
    <div class="kusudamaEmoji">ğŸŠ</div>
    <div class="confettiLine">ãŠã‚ã§ã¨ã†ï¼</div>
    <div class="kusudamaNote">ï¼ˆã‚¿ãƒƒãƒ—ã§ ã¨ã˜ã‚‹ï¼‰</div>
  </div>
</div>

<!-- â˜…å­¦ç¿’ãƒ­ã‚°ï¼šè¨˜éŒ²ã‚’è¦‹ã‚‹ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ -->
<div class="logOverlay" id="logOverlay" role="dialog" aria-modal="true">
  <div class="logCard">
    <div class="logHeader">
      <div class="logTitle">å­¦ç¿’ã®ãã‚ã</div>
      <div class="logActions">
        <button class="ghost" id="logCloseBtn" type="button">ã¨ã˜ã‚‹</button>
        <button class="danger" id="logClearBtn" type="button">æ¶ˆå»</button>
        <button class="ghost" id="logCsvBtn" type="button">CSV</button>
      </div>
    </div>

    <div class="logTabs">
      <div class="logTabBtn active" id="tabProgress" data-tab="progress">é€²æ—</div>
      <div class="logTabBtn" id="tabHints" data-tab="hints">ãƒ’ãƒ³ãƒˆ</div>
      <div class="logTabBtn" id="tabWrongs" data-tab="wrongs">é–“é•ã„</div>
    </div>

    <div id="logBody"></div>
  </div>
</div>
<!-- â˜…å•é¡Œç®¡ç†ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼šãƒšãƒ¼ã‚¸é·ç§»ãªã—ï¼‰ -->
<div class="manageOverlay" id="manageOverlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="manageCard">
    <div class="manageHeader">
      <div class="manageTitle">å•é¡Œç®¡ç†</div>
      <div class="manageSub">1è¡Œï¼1å•ï¼ˆä¾‹ï¼š æ¼¢å­— ã‚ˆã¿1 ã‚ˆã¿2ï¼‰</div>
    </div>

    <div class="manageBody">
      <div class="manageSection">
        <div class="manageLabel">ã¾ã¨ã‚ã¦è¿½åŠ </div>
        <textarea id="manageInput" class="manageTextarea" rows="6" placeholder="ä¾‹ï¼š
é›¨å¤© ã†ã¦ã‚“
æ™´ã‚Œã‚‹ ã¯
å¤©æ°— ã¦ã‚“ã"></textarea>

        <div class="manageBtns">
          <button class="primary" id="manageAddBtn" type="button">è¿½åŠ ã™ã‚‹</button>
          <button class="muted" id="manageClearInputBtn" type="button">å…¥åŠ›ã‚’æ¶ˆã™</button>
        </div>

        <div class="manageNote" id="manageNote"></div>
      </div>

      <div class="manageSection">
        <div class="manageLabel">ã„ã¾å…¥ã£ã¦ã„ã‚‹å•é¡Œ</div>

        <div class="manageListTools">
          <button class="ghost" id="manageCheckAllBtn" type="button">å…¨ã¦ã«ãƒã‚§ãƒƒã‚¯</button>
          <button class="danger" id="manageDeleteBtn" type="button">ãƒã‚§ãƒƒã‚¯ã—ãŸå•é¡Œã‚’å‰Šé™¤</button>
        </div>

        <div class="manageList" id="manageList"></div>
      </div>
    </div>

    <div class="manageFooter">
      <button class="ghost" id="manageBackBtn" type="button">ã‚‚ã©ã‚‹</button>
    </div>
  </div>
</div>


<script>
/* ğŸ”½ ç½®ãæ›ãˆï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå•é¡Œï¼ˆåˆæœŸå€¤ï¼‰ */
const WORDS_TEXT_DEFAULT = `
é¡”ã€€ã‹ãŠ
æ¯æ—¥ã€€ã¾ã„ã«ã¡
å½“ãŸã‚‹ã€€ã‚
é›»è©±ã€€ã§ã‚“ã‚
æ¥½ã—ã„ã€€ãŸã®
ç§‹ã€€ã‚ã
åˆ†ã‘ã‚‹ã€€ã‚
æ±äº¬ã€€ã¨ã†ãã‚‡ã†
é›†åˆã€€ã—ã‚…ã†ã”ã†
åˆè¨ˆã€€ã”ã†ã‘ã„
ç´°ã¼ã†ã€€ã•ã„
åŠåˆ†ã€€ã¯ã‚“ã¶ã‚“
é–‹ãã€€ã²ã‚‰ã€€ã‚
é–‹ç™ºã€€ã‹ã„ã¯ã¤
å®¶æ—ã€€ã‹ãã
è‘‰ã£ã±ã€€ã¯
ç›¸æ‰‹ã€€ã‚ã„ã¦
è©©äººã€€ã—ã˜ã‚“
ç¿’ã†ã€€ãªã‚‰
å‹•ãã€€ã†ã”
`;

/* ========= WORDS_TEXT â†’ ITEMS ã«å¤‰æ›ï¼ˆä»–ã¯å¤‰ãˆãªã„ï¼‰ ========= */
function parseWordsText(text){
  const lines = String(text ?? "").split(/\r?\n/);
  const items = [];
  for(const raw of lines){
    const line = raw.trim();
    if(!line) continue;

   const parts = line.split(/[,\t \u3000]+/).filter(Boolean);
    if(parts.length < 2) continue;

    const prompt = parts[0];
    const answers = parts.slice(1); // â˜…è¤‡æ•°èª­ã¿ã¯ã€Œåˆ¥è§£ã€ã¨ã—ã¦ä¿æŒ

    items.push({ prompt, answers });
  }
  return items;
}

/* ğŸ”½ ç½®ãæ›ãˆï¼šITEMSã¯ç®¡ç†ç”»é¢ã§å·®ã—æ›¿ãˆã‚‹ã®ã§ let ã«ã™ã‚‹ */
let ITEMS = parseWordsText(WORDS_TEXT_DEFAULT);

/* ========= ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ========= */
const BASE_LAYOUT = [
  ["ã‚“","ã‚","ã‚‰","ã‚„","ã¾","ã¯","ãª","ãŸ","ã•","ã‹","ã‚"],
  ["","","ã‚Š","","ã¿","ã²","ã«","ã¡","ã—","ã","ã„"],
  ["","","ã‚‹","ã‚†","ã‚€","ãµ","ã¬","ã¤","ã™","ã","ã†"],
  ["","","ã‚Œ","","ã‚","ã¸","ã­","ã¦","ã›","ã‘","ãˆ"],
  ["","ã‚’","ã‚","ã‚ˆ","ã‚‚","ã»","ã®","ã¨","ã","ã“","ãŠ"],
];
const DAKUTEN_LAYOUT = [
  ["ã±","ã°","ã ","ã–","ãŒ"],
  ["ã´","ã³","ã¢","ã˜","ã"],
  ["ã·","ã¶","ã¥","ãš","ã"],
  ["ãº","ã¹","ã§","ãœ","ã’"],
  ["ã½","ã¼","ã©","ã","ã”"],
];
const YOUON_LAYOUT = [
  ["ã´ã‚ƒ","ã³ã‚ƒ","ã˜ã‚ƒ","ãã‚ƒ","ã‚Šã‚ƒ","ã¿ã‚ƒ","ã²ã‚ƒ","ã«ã‚ƒ","ã¡ã‚ƒ","ã—ã‚ƒ","ãã‚ƒ"],
  ["ã´ã‚…","ã³ã‚…","ã˜ã‚…","ãã‚…","ã‚Šã‚…","ã¿ã‚…","ã²ã‚…","ã«ã‚…","ã¡ã‚…","ã—ã‚…","ãã‚…"],
  ["ã´ã‚‡","ã³ã‚‡","ã˜ã‚‡","ãã‚‡","ã‚Šã‚‡","ã¿ã‚‡","ã²ã‚‡","ã«ã‚‡","ã¡ã‚‡","ã—ã‚‡","ãã‚‡"],
];

function el(tag, cls, text){
  const d = document.createElement(tag);
  if(cls) d.className = cls;
  if(text != null) d.textContent = text;
  return d;
}

/* ========= çŠ¶æ…‹ ========= */
let order = [];
let idx = 0;
let typed = "";
let hintCount = 0;
let score = 0;
/* â˜…showAnswerå‰Šé™¤ã®ãŸã‚ï¼šæ¦‚å¿µã¯æ®‹ã™ãŒå¸¸ã« falseï¼ˆç‚¹æ•°ãƒ«ãƒ¼ãƒ«ã®ä»–ã¸ã®å½±éŸ¿ã‚’é¿ã‘ã‚‹ï¼‰ */
let revealedAnswer = false;

/* ===== ã”ã»ã†ã³çŠ¶æ…‹ï¼ˆ5å›æ­£è§£ã§1å›ï¼‰ ===== */
let rewardCounter = 0;
let rewardReady = false;
let rewardType = null;          // "slot" | "roulette" | "dice" | "treasure" | "card"
let rewardInterval = null;
let rewardSpinning = false;
let rewardPlayedThisCharge = false;

/* â˜…ã“ã®å•é¡Œã§æ­£è§£æ¸ˆã¿ã‹ï¼ˆã”ã»ã†ã³ãƒ­ãƒƒã‚¯è§£é™¤ã®ãŸã‚ï¼‰ */
let answeredCorrectThisQ = false;

/* â˜…30ç‚¹ãã™ç‰ã¯1å›ã ã‘ */
let kusudamaShown = false;

/* â˜…è¿½åŠ ï¼šã—ã‹ã‘å¾—ç‚¹ï¼ˆç´¯è¨ˆï¼‰ */
let rewardPoints = 0;

/* ========= ãƒ­ã‚°ï¼ˆæœ€å°é™3ç¨®ï¼‰ ========= */
const LS_PROGRESS = "kanji_progress_v1";
const LS_HINTS = "kanji_hints_v1";
const LS_WRONGS = "kanji_wrongs_v1";

/* æ¯å•ãƒªã‚»ãƒƒãƒˆã™ã‚‹ãƒ•ãƒ©ã‚°ï¼ˆå¿…é ˆï¼‰ */
let hintedThisQ = false;
let hintLoggedThisQ = false;
let wrongLoggedThisQ = false;
/* ========= æ­£è¦åŒ– ========= */
function toHiragana(s){
  return s.replace(/[\u30A1-\u30F6]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0x60));
}
function normalize(s){
  let x = String(s ?? "");
  x = x.replace(/\s+/g, "");
  x = x.replace(/[ã€€]/g, "");
  x = toHiragana(x);
  x = x.replace(/ãƒ»/g, "");
  return x;
}

/* ========= ãƒ­ã‚°ï¼šãƒ˜ãƒ«ãƒ‘ ========= */
function todayYYYYMMDD(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${dd}`;
}
function lsGetArray(key){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return [];
    const v = JSON.parse(raw);
    return Array.isArray(v) ? v : [];
  }catch(e){
    return [];
  }
}
function lsSetArray(key, arr){
  try{
    localStorage.setItem(key, JSON.stringify(arr ?? []));
  }catch(e){}
}
function currentPromptWord(){
  const item = ITEMS[order[idx]] || {prompt:"â€”"};
  return String(item.prompt ?? "â€”");
}
function logProgressOnce(){
  const row = { date: todayYYYYMMDD(), progress: `${score}/${ITEMS.length}` };
  const arr = lsGetArray(LS_PROGRESS);
  arr.push(row);
  lsSetArray(LS_PROGRESS, arr);
}
function logHintOnce(){
  const row = { date: todayYYYYMMDD(), hintedWord: currentPromptWord() };
  const arr = lsGetArray(LS_HINTS);
  arr.push(row);
  lsSetArray(LS_HINTS, arr);
}
function logWrongOnce(){
  const row = { date: todayYYYYMMDD(), wrongWord: currentPromptWord(), typed: normalize(typed) };
  const arr = lsGetArray(LS_WRONGS);
  arr.push(row);
  lsSetArray(LS_WRONGS, arr);
}

/* ========= ãƒ­ã‚°ï¼šUI ========= */
const saveProgressBtn = document.getElementById("saveProgressBtn");
const openLogBtn = document.getElementById("openLogBtn");
const logOverlayEl = document.getElementById("logOverlay");
const logCloseBtn = document.getElementById("logCloseBtn");
const logClearBtn = document.getElementById("logClearBtn");
const logCsvBtn = document.getElementById("logCsvBtn");
const logBodyEl = document.getElementById("logBody");
const tabProgressEl = document.getElementById("tabProgress");
const tabHintsEl = document.getElementById("tabHints");
const tabWrongsEl = document.getElementById("tabWrongs");
let logTab = "progress"; // "progress" | "hints" | "wrongs"

function setActiveTab(tab){
  logTab = tab;
  if(tabProgressEl) tabProgressEl.classList.toggle("active", tab==="progress");
  if(tabHintsEl) tabHintsEl.classList.toggle("active", tab==="hints");
  if(tabWrongsEl) tabWrongsEl.classList.toggle("active", tab==="wrongs");
  renderLogTable();
}
function renderTable(headers, rows){
  const wrap = document.createElement("div");
  if(!rows || rows.length===0){
    const p = document.createElement("div");
    p.className = "logEmpty";
    p.textContent = "è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“";
    wrap.appendChild(p);
    return wrap;
  }
  const table = document.createElement("table");
  table.className = "logTable";
  const thead = document.createElement("thead");
  const trh = document.createElement("tr");
  headers.forEach(h=>{
    const th = document.createElement("th");
    th.textContent = h;
    trh.appendChild(th);
  });
  thead.appendChild(trh);
  table.appendChild(thead);

  const tbody = document.createElement("tbody");
  rows.forEach(r=>{
    const tr = document.createElement("tr");
    r.forEach(cell=>{
      const td = document.createElement("td");
      td.textContent = String(cell ?? "");
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  wrap.appendChild(table);
  return wrap;
}
function renderLogTable(){
  if(!logBodyEl) return;
  logBodyEl.innerHTML = "";

  if(logTab === "progress"){
    const arr = lsGetArray(LS_PROGRESS);
    const rows = arr.map(x => [x.date, x.progress]);
    logBodyEl.appendChild(renderTable(["date","progress"], rows));
    return;
  }
  if(logTab === "hints"){
    const arr = lsGetArray(LS_HINTS);
    const rows = arr.map(x => [x.date, x.hintedWord]);
    logBodyEl.appendChild(renderTable(["date","hintedWord"], rows));
    return;
  }
  if(logTab === "wrongs"){
    const arr = lsGetArray(LS_WRONGS);
    const rows = arr.map(x => [x.date, x.wrongWord, x.typed]);
    logBodyEl.appendChild(renderTable(["date","wrongWord","typed"], rows));
    return;
  }
}
function openLog(){
  if(!logOverlayEl) return;
  setActiveTab(logTab);
  logOverlayEl.style.display = "flex";
}
function closeLog(){
  if(!logOverlayEl) return;
  logOverlayEl.style.display = "none";
}
function clearAllLogs(){
  try{
    localStorage.removeItem(LS_PROGRESS);
    localStorage.removeItem(LS_HINTS);
    localStorage.removeItem(LS_WRONGS);
  }catch(e){}
  renderLogTable();
}
function downloadCsvForCurrentTab(){
  let filename = "kanji_log.csv";
  let headers = [];
  let rows = [];

  if(logTab === "progress"){
    filename = "kanji_progress_v1.csv";
    headers = ["date","progress"];
    const arr = lsGetArray(LS_PROGRESS);
    rows = arr.map(x => [x.date, x.progress]);
  }else if(logTab === "hints"){
    filename = "kanji_hints_v1.csv";
    headers = ["date","hintedWord"];
    const arr = lsGetArray(LS_HINTS);
    rows = arr.map(x => [x.date, x.hintedWord]);
  }else if(logTab === "wrongs"){
    filename = "kanji_wrongs_v1.csv";
    headers = ["date","wrongWord","typed"];
    const arr = lsGetArray(LS_WRONGS);
    rows = arr.map(x => [x.date, x.wrongWord, x.typed]);
  }

  const esc = (v) => {
    const s = String(v ?? "");
    if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  };
  const csv = [
    headers.map(esc).join(","),
    ...rows.map(r => r.map(esc).join(","))
  ].join("\n");

  try{
    /* ===== ã“ã“ã ã‘å·®ã—æ›¿ãˆï¼ˆUTF-8 with BOMï¼‰ ===== */
    const bom = "\uFEFF";
    const blob = new Blob([bom + csv], {type:"text/csv;charset=utf-8"});
    /* ===== ã“ã“ã¾ã§ ===== */

    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }catch(e){}
}

/* ========= UI ========= */
const promptEl = document.getElementById("prompt");
const answerView = document.getElementById("answerView");
const msgEl = document.getElementById("msg");
const hintLineEl = document.getElementById("hintLine");
const progressBadge = document.getElementById("progressBadge");
const scoreBadge = document.getElementById("scoreBadge");

const hintBtn = document.getElementById("hintBtn");
/* â˜…showAnswerBtnå‰Šé™¤ */
const checkBtn = document.getElementById("checkBtn");
const nextBtn = document.getElementById("nextBtn");

const baseGrid = document.getElementById("baseGrid");
const dakutenGrid = document.getElementById("dakutenGrid");
const youonGrid = document.getElementById("youonGrid");

const dakutenToggle = document.getElementById("dakutenToggle");
const youonToggle = document.getElementById("youonToggle");

const smallKey = document.getElementById("smallKey");
const dakutenKey = document.getElementById("dakutenKey");
const handakutenKey = document.getElementById("handakutenKey");

const readBtn = document.getElementById("readBtn");
const backBtn = document.getElementById("backBtn");
const clearBtn = document.getElementById("clearBtn");
const nativeInput = document.getElementById("nativeInput");


/* ã”ã»ã†ã³UI */
const rewardWheelEl = document.getElementById("rewardWheel");
const rewardSubEl = document.getElementById("rewardSub");
const rewardHintEl = document.getElementById("rewardHint");
const rewardCardContainerEl = document.getElementById("rewardCardContainer");

/* â˜…ã‚¹ãƒ­ãƒƒãƒˆUI */
const rewardSlotEl = document.getElementById("rewardSlot");
const slotBoxes = document.querySelectorAll("#rewardSlot .slot-box");

/* â˜…å·¦ä¸ŠUI */
const restartBtn = document.getElementById("restartBtn");
const rewardPtsBadgeEl = document.getElementById("rewardPtsBadge");

/* â˜…ãã™ç‰UI */
const kusudamaOverlayEl = document.getElementById("kusudamaOverlay");

/* ========= ã‚­ãƒ¼å…¥åŠ› ========= */
function appendChar(ch){
  if(nextBtn.disabled === false) return;
  typed += ch;
  renderAnswer();
}
function onBackspace(){
  if(nextBtn.disabled === false) return;
  typed = typed.slice(0, -1);
  renderAnswer();
}
function onClear(){
  if(nextBtn.disabled === false) return;
  typed = "";
  renderAnswer();
}
function toggleSmallMode(){
  if(!typed) return;
  const map = {
    "ã‚„":"ã‚ƒ","ã‚†":"ã‚…","ã‚ˆ":"ã‚‡","ã¤":"ã£",
    "ã‚ƒ":"ã‚„","ã‚…":"ã‚†","ã‚‡":"ã‚ˆ","ã£":"ã¤"
  };
  const last = typed.slice(-1);
  if(map[last]){
    typed = typed.slice(0,-1) + map[last];
    renderAnswer();
  }
}
function addDakuten(){
  if(!typed) return;
  const map = {
    "ã‹":"ãŒ","ã":"ã","ã":"ã","ã‘":"ã’","ã“":"ã”",
    "ã•":"ã–","ã—":"ã˜","ã™":"ãš","ã›":"ãœ","ã":"ã",
    "ãŸ":"ã ","ã¡":"ã¢","ã¤":"ã¥","ã¦":"ã§","ã¨":"ã©",
    "ã¯":"ã°","ã²":"ã³","ãµ":"ã¶","ã¸":"ã¹","ã»":"ã¼",
    "ã†":"ã‚”"
  };
  const last = typed.slice(-1);
  if(map[last]){
    typed = typed.slice(0,-1) + map[last];
    renderAnswer();
  }
}
function addHandakuten(){
  if(!typed) return;
  const map = { "ã¯":"ã±","ã²":"ã´","ãµ":"ã·","ã¸":"ãº","ã»":"ã½" };
  const last = typed.slice(-1);
  if(map[last]){
    typed = typed.slice(0,-1) + map[last];
    renderAnswer();
  }
}

/* ===== èª­ã¿ä¸Šã’ ===== */
function speak(text){
  const t = normalize(text);
  if(!t) return;
  try{
    if(!("speechSynthesis" in window)) return;
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(t);
    u.lang = "ja-JP";
    u.rate = 1.0;
    u.pitch = 1.0;
    window.speechSynthesis.speak(u);
  }catch(e){}
}

/* ========= ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æç”» ========= */
function makeKey(ch){
  const k = el("div","key",ch);
  k.addEventListener("click", () => appendChar(ch));
  return k;
}
function makeEmpty(){
  return el("div","key empty","");
}
function buildBase(){
  baseGrid.innerHTML = "";
  for(const row of BASE_LAYOUT){
    for(const ch of row){
      baseGrid.appendChild(ch === "" ? makeEmpty() : makeKey(ch));
    }
  }
}
function buildDakuten(){
  dakutenGrid.innerHTML = "";
  for(const row of DAKUTEN_LAYOUT){
    for(const ch of row){
      dakutenGrid.appendChild(makeKey(ch));
    }
  }
}
function buildYouon(){
  youonGrid.innerHTML = "";
  for(const row of YOUON_LAYOUT){
    for(const ch of row){
      youonGrid.appendChild(makeKey(ch));
    }
  }
}

/* ========= å‡ºé¡Œ/åˆ¤å®š ========= */
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
function start(){
  order = shuffle([...Array(ITEMS.length).keys()]);
  idx = 0;
  score = 0;

  rewardCounter = 0;
  rewardReady = false;
  rewardPlayedThisCharge = false;
  resetRewardGimmick(false);

  kusudamaShown = false;

  rewardPoints = 0;
  updateRewardPointsUI();

  updateBadges();
  updateRewardUI();
  loadQuestion();
}
function loadQuestion(){
  typed = "";
  hintCount = 0;
  revealedAnswer = false;
  answeredCorrectThisQ = false;

  /* â˜…ãƒ­ã‚°ç”¨ï¼šæ¯å•ãƒªã‚»ãƒƒãƒˆï¼ˆå¿…é ˆï¼‰ */
  hintedThisQ = false;
  hintLoggedThisQ = false;
  wrongLoggedThisQ = false;

  const item = ITEMS[order[idx]] || {prompt:"â€”",answers:[""]};
  promptEl.textContent = item.prompt;

  msgEl.textContent = "";
  msgEl.className = "msg";
  hintLineEl.textContent = "";
  answerView.className = "answer";

  nextBtn.disabled = true;
  checkBtn.disabled = false;

  updateBadges();
  renderAnswer();
}
function updateBadges(){
  progressBadge.textContent = `ã‚‚ã‚“ã ã„ ${idx+1} / ${ITEMS.length}`;
  scoreBadge.textContent = `ã›ã„ã‹ã„ ${score}`;
}
function renderAnswer(){
  answerView.textContent = normalize(typed);
  if(nativeInput) nativeInput.value = normalize(typed);
}
function isCorrectFlexible(inputNorm, ansNorm){
  // â˜…å®Œå…¨ä¸€è‡´ã ã‘OKï¼ˆã€Œã¾ã€ã ã‘ã§ã¯é€šã‚‰ãªã„ï¼‰
  return inputNorm === ansNorm;
}

function currentAnswers(){
  const item = ITEMS[order[idx]] || {answers:[""]};
  return (item.answers || []).map(a => normalize(a));
}

/* â˜…30ç‚¹ãã™ç‰ï¼ˆã—ã‹ã‘å¾—ç‚¹ã§åˆ¤å®šï¼‰ */
/* â˜…30ã®å€æ•°ã‚’è¶…ãˆãŸã‚‰ï¼šãã™ç‰ â†’ï¼ˆé–‰ã˜ãŸã‚‰ï¼‰ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚° */
const kusudamaPlayedAt = new Set(); // 30,60,90â€¦ã‚’1å›ãšã¤

function showKusudamaIfNeeded(){
  if(!Number.isFinite(rewardPoints)) return;

  const milestones = [30, 60, 90, 120, 150];

  for(const m of milestones){
    if(rewardPoints >= m && !kusudamaPlayedAt.has(m)){
      kusudamaPlayedAt.add(m);

      // â‘  ã¾ãšãã™ç‰
      if(kusudamaOverlayEl){
        kusudamaOverlayEl.style.display = "flex";
      }

      // â‘¡ é–‰ã˜ãŸã‚‰ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’å§‹ã‚ã‚‹æº–å‚™
      pendingShooterStart = true;
      break;
    }
  }
}

/* â˜…ã—ã‹ã‘å¾—ç‚¹UIæ›´æ–° */
function updateRewardPointsUI(){
  if(rewardPtsBadgeEl){
    rewardPtsBadgeEl.textContent = `ã—ã‹ã‘å¾—ç‚¹ï¼š${rewardPoints}`;
  }
}

/* â˜…ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®é–¢æ•°ã«å·®ã—æ›¿ãˆï¼ˆã“ã“ã ã‘å¤‰æ›´ï¼‰ */
function addRewardPointsFromText(t){
  // â˜…è¿½åŠ ï¼šã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ä¸­ï¼ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°çµæœè¡¨ç¤ºä¸­ã¯ã€Œã—ã‹ã‘å¾—ç‚¹ã€ã«çµ¶å¯¾åŠ ç®—ã—ãªã„
  try{
    const ov = document.getElementById("shooterOverlay");
    const rs = document.getElementById("shooterResult"); // ã‚ãªãŸãŒè¿½åŠ ã™ã‚‹çµæœç”»é¢ID
    const shooterOpen = ov && ov.style.display === "flex";
    const resultOpen  = rs && rs.style.display === "flex";
    if(shooterOpen || resultOpen) return;
  }catch(e){}

  const m = String(t ?? "").match(/(\d+)/g);
  if(!m || m.length === 0) return;
  const v = parseInt(m[m.length - 1], 10);
  if(!Number.isFinite(v)) return;
  rewardPoints += v;
  updateRewardPointsUI();

  showKusudamaIfNeeded();
}

function check(){
  const input = normalize(typed);
  const ansList = currentAnswers();

  if(!input){
    msgEl.textContent = "ã«ã‚…ã†ã‚Šã‚‡ãã—ã¦ã­";
    msgEl.className = "msg ng";
    answerView.classList.remove("ok");
    answerView.classList.add("ng");
    return;
  }

  const ok = ansList.some(ans => isCorrectFlexible(input, ans));

  if(ok){
    score += (revealedAnswer ? 0 : 1);
    answeredCorrectThisQ = true;

    showKusudamaIfNeeded();

    rewardCounter = Math.min(5, rewardCounter + 1);
    if(rewardCounter >= 5){
      rewardReady = true;
      rewardPlayedThisCharge = false;
      enableRewardGimmick();
    }
    updateRewardUI();

    msgEl.textContent = "ã›ã„ã‹ã„ï¼";
    msgEl.className = "msg ok";
    answerView.classList.remove("ng");
    answerView.classList.add("ok");

    nextBtn.disabled = rewardReady ? true : false;

    checkBtn.disabled = true;
    updateBadges();
  }else{
    /* â˜…é–“é•ã„ãƒ­ã‚°ï¼š1å•ã«ã¤ã1å›ã ã‘ */
    if(!wrongLoggedThisQ){
      logWrongOnce();
      wrongLoggedThisQ = true;
    }

    msgEl.textContent = "ã¡ãŒã†ã‚ˆ";
    msgEl.className = "msg ng";
    answerView.classList.remove("ok");
    answerView.classList.add("ng");
  }
}
function next(){
  if(rewardReady && !rewardPlayedThisCharge){
    msgEl.textContent = "ã”ã»ã†ã³ã§ ã‚ãã‚“ã§ã‹ã‚‰ ã¤ãã¸ï¼";
    msgEl.className = "msg ng";
    return;
  }

  if(rewardPlayedThisCharge){
    resetRewardGimmick(true);
    updateRewardUI();
  }else{
    resetRewardGimmick(false);
    updateRewardUI();
  }

  if(idx < ITEMS.length-1){
    idx++;
    loadQuestion();
  }else{
    promptEl.textContent = "ãŠã‚ã‚Š";
    msgEl.textContent = `ãŠã¤ã‹ã‚Œã•ã¾ï¼ ã›ã„ã‹ã„ã¯ ${score} ã“`;
    msgEl.className = "msg ok";
    hintLineEl.textContent = "";
    answerView.textContent = "";
    nextBtn.disabled = true;
    checkBtn.disabled = true;
  }
}

/* ========= ãƒ’ãƒ³ãƒˆ ========= */
function showHint(){
  /* â˜…ãƒ’ãƒ³ãƒˆãƒ­ã‚°ï¼šæœ€åˆã®1å›ã ã‘ï¼ˆè¡¨ç¤ºä»•æ§˜ã¯å¤‰æ›´ã—ãªã„ï¼‰ */
  hintedThisQ = true;
  if(!hintLoggedThisQ){
    logHintOnce();
    hintLoggedThisQ = true;
  }

  const ans = currentAnswers()[0] ?? "";
  if(!ans){
    hintLineEl.textContent = "ãƒ’ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“";
    return;
  }
  hintCount++;
  const n = Math.min(hintCount, ans.length);
  hintLineEl.textContent = `ãƒ’ãƒ³ãƒˆï¼š ${ans.slice(0, n)}â€¦`;
}

/* ========= ãƒ‘ãƒãƒ«è¡¨ç¤ºåˆ‡æ›¿ ========= */
let dakutenVisible = true;
let youonVisible = true;

function setToggle(elm, visible){
  elm.textContent = visible ? "ã¿ãˆãªã„" : "ã¿ãˆã‚‹";
  elm.classList.toggle("off", !visible);
}
function applyPanelVisibility(){
  dakutenGrid.style.display = dakutenVisible ? "grid" : "none";
  youonGrid.style.display = youonVisible ? "grid" : "none";
  setToggle(dakutenToggle, dakutenVisible);
  setToggle(youonToggle, youonVisible);
}

/* ========= ã”ã»ã†ã³ ========= */
const REWARD_TYPES = ["slot","treasure","roulette","dice","card"];

/* ===== ã‚¹ãƒ­ãƒƒãƒˆï¼ˆ3ãƒªãƒ¼ãƒ«ãƒ»1æšãšã¤æ­¢ã‚ã‚‹ï¼‰ ===== */
let slotValues = [7,7,7];
let slotTimers = [null,null,null];
let slotSpinning = [false,false,false];
let slotGameRunning = false;
const MIN_NUM = 1;
const MAX_NUM = 7;

function slotNextValue(v){
  let n = v + 1;
  if (n > MAX_NUM) n = MIN_NUM;
  return n;
}
function slotUpdateView(idx){
  const numEl = slotBoxes[idx].querySelector(".slot-num");
  numEl.textContent = slotValues[idx];
}
function slotStartReel(idx){
  slotSpinning[idx] = true;
  slotBoxes[idx].classList.remove("stopped");
  slotBoxes[idx].classList.add("spinning");
  slotTimers[idx] = setInterval(()=>{
    slotValues[idx] = slotNextValue(slotValues[idx]);
    slotUpdateView(idx);
  }, 360);
}
function slotStopReel(idx){
  if (!slotSpinning[idx]) return;
  slotSpinning[idx] = false;
  clearInterval(slotTimers[idx]);
  slotTimers[idx] = null;
  slotBoxes[idx].classList.remove("spinning");
  slotBoxes[idx].classList.add("stopped");
  if (!slotSpinning[0] && !slotSpinning[1] && !slotSpinning[2]) {
    slotFinish();
  }
}
function slotClearAll(){
  for (let i=0;i<3;i++){
    if (slotTimers[i]) clearInterval(slotTimers[i]);
    slotTimers[i] = null;
    slotSpinning[i] = false;
  }
  slotGameRunning = false;
}
function slotResetView(){
  slotValues = [7,7,7];
  for(let i=0;i<3;i++){
    slotBoxes[i].classList.remove("spinning");
    slotBoxes[i].classList.add("stopped");
    slotUpdateView(i);
  }
}
function slotStartGame(){
  slotClearAll();
  slotValues = [
    Math.floor(Math.random()*(MAX_NUM - MIN_NUM + 1)) + MIN_NUM,
    Math.floor(Math.random()*(MAX_NUM - MIN_NUM + 1)) + MIN_NUM,
    Math.floor(Math.random()*(MAX_NUM - MIN_NUM + 1)) + MIN_NUM
  ];
  for (let i=0;i<3;i++){
    slotUpdateView(i);
    slotStartReel(i);
  }
  slotGameRunning = true;
  if(rewardHintEl) rewardHintEl.textContent = "æ­¢ã‚ãŸã„ã¨ã“ã‚ã§ ãã‚Œãã‚Œã‚¿ãƒƒãƒ—ã—ã¦ã­ã€‚";
}
function slotFinish(){
  slotGameRunning = false;
  const [a,b,c] = slotValues;
  const allEqual = (a===b && b===c);
  let points = 0;
  if(allEqual){
    points = a + b + c;
    if(rewardHintEl) rewardHintEl.textContent = `ã‚¹ãƒ­ãƒƒãƒˆ ã‘ã£ã‹ï¼š${slotValues.join("ãƒ»")} â†’ ${points} ç‚¹ï¼`;
  }else{
    if(rewardHintEl) rewardHintEl.textContent = `ã‚¹ãƒ­ãƒƒãƒˆ ã‘ã£ã‹ï¼š${slotValues.join("ãƒ»")} â†’ 0 ç‚¹`;
  }

  addRewardPointsFromText(String(points));

  rewardCounter = 0;
  rewardReady = false;
  rewardPlayedThisCharge = true;

  if(rewardWheelEl){
    rewardWheelEl.classList.add("disabled");
  }
  updateRewardUI();

  if(rewardSlotEl){
    rewardSlotEl.style.display = "none";
  }
  if(rewardWheelEl){
    rewardWheelEl.style.display = "inline-flex";
    rewardWheelEl.textContent = "ğŸ”’";
    rewardWheelEl.classList.add("disabled");
  }

  if(answeredCorrectThisQ){
    nextBtn.disabled = false;
  }
}

slotBoxes.forEach(elm=>{
  const sidx = Number(elm.dataset.slot);
  elm.addEventListener("click", ()=>{
    if(!rewardReady) return;
    if(rewardType !== "slot") return;

    // ã¾ã å›ã£ã¦ãªã„ãªã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
    if(!slotGameRunning){
      slotStartGame();
      return;
    }
    // å›ã£ã¦ã‚‹ãªã‚‰ãã®ãƒªãƒ¼ãƒ«ã‚’æ­¢ã‚ã‚‹
    if(slotSpinning[sidx]){
      slotStopReel(sidx);
    }
  });
});

function resetRewardGimmick(forceLock){
  if(rewardInterval){
    clearInterval(rewardInterval);
    rewardInterval = null;
  }
  rewardSpinning = false;

  // ã‚¹ãƒ­ãƒƒãƒˆåœæ­¢ï¼†éè¡¨ç¤º
  slotClearAll();
  slotResetView();
  if(rewardSlotEl) rewardSlotEl.style.display = "none";
  if(rewardWheelEl) rewardWheelEl.style.display = "inline-flex";

  if(rewardCardContainerEl){
    rewardCardContainerEl.innerHTML = "";
    rewardCardContainerEl.style.display = "none";
  }
  if(rewardWheelEl){
    rewardWheelEl.style.display = "inline-flex";
  }

  if(forceLock){
    if(rewardWheelEl){
      rewardWheelEl.textContent = "ğŸ”’";
      rewardWheelEl.classList.add("disabled");
    }
    if(rewardHintEl) rewardHintEl.textContent = "";
    rewardType = null;
    return;
  }

  if(!rewardReady){
    if(rewardWheelEl){
      rewardWheelEl.textContent = "ğŸ”’";
      rewardWheelEl.classList.add("disabled");
    }
    if(!rewardPlayedThisCharge){
      if(rewardHintEl) rewardHintEl.textContent = "";
    }
    rewardType = null;
  }else{
    if(rewardWheelEl){
      rewardWheelEl.classList.remove("disabled");
    }
  }
}

function updateRewardUI(){
  const left = Math.max(0, 5 - rewardCounter);
  if(rewardSubEl){
    rewardSubEl.textContent = rewardReady
      ? "ã‚ãã¹ã‚‹ã‚ˆï¼ ã‚«ãƒ¼ãƒ‰ã‚’ ã‚¿ãƒƒãƒ—ï¼"
      : `ã‚ã¨ ${left} ã‹ã„ ã›ã„ã‹ã„ã§ ã‚ãã¹ã‚‹ã‚ˆ`;
  }
  if(rewardWheelEl){
    rewardWheelEl.classList.toggle("disabled", !rewardReady);
    if(!rewardReady && !rewardPlayedThisCharge){
      rewardWheelEl.textContent = "ğŸ”’";
    }
  }
}

function rewardTypeLabel(t){
  switch(t){
    case "roulette": return "ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ";
    case "dice": return "ã‚µã‚¤ã‚³ãƒ­";
    case "treasure": return "ãŸã‹ã‚‰ã°ã“";
    case "slot": return "ã‚¹ãƒ­ãƒƒãƒˆ";
    case "card": return "ã‚«ãƒ¼ãƒ‰";
    default: return "";
  }
}

function enableRewardGimmick(){
  rewardType = REWARD_TYPES[Math.floor(Math.random()*REWARD_TYPES.length)];
  rewardSpinning = false;
  if(!rewardWheelEl) return;

  // ã„ã£ãŸã‚“éè¡¨ç¤ºç‰©ã‚’æˆ»ã™
  if(rewardSlotEl) rewardSlotEl.style.display = "none";
  rewardWheelEl.style.display = "inline-flex";

  if(rewardType === "card"){
    rewardWheelEl.classList.add("disabled");
    rewardWheelEl.style.display = "none";
    if(rewardHintEl) rewardHintEl.textContent = `${rewardTypeLabel(rewardType)}ï¼ 1ã¾ã„ ãˆã‚‰ã‚“ã§ã­`;
    setupRewardCardGimmick();
    return;
  }

  switch(rewardType){
    case "roulette":
      rewardWheelEl.textContent = "â–¶";
      if(rewardHintEl) rewardHintEl.textContent = `${rewardTypeLabel(rewardType)}ï¼ ã‚¿ãƒƒãƒ—ã§ ã¾ã‚ã™ï¼ã‚‚ã†ã„ã¡ã©ã§ ã¨ã‚ã‚‹`;
      break;
    case "dice":
      rewardWheelEl.textContent = "ğŸ²";
      if(rewardHintEl) rewardHintEl.textContent = `${rewardTypeLabel(rewardType)}ï¼ ã‚¿ãƒƒãƒ—ã§ ãµã‚‹ï¼ã‚‚ã†ã„ã¡ã©ã§ ã¨ã‚ã‚‹`;
      break;
    case "treasure":
      rewardWheelEl.textContent = "ğŸ“¦";
      if(rewardHintEl) rewardHintEl.textContent = `${rewardTypeLabel(rewardType)}ï¼ ã‚¿ãƒƒãƒ—ã§ ã‚ã‘ã‚‹ï¼ˆ1ã‹ã„ï¼‰`;
      break;
    case "slot":
      // â˜…å·®ã—æ›¿ãˆï¼š3ãƒªãƒ¼ãƒ«ï¼ˆ1æšãšã¤æ­¢ã‚ã‚‹ï¼‰
      rewardWheelEl.style.display = "none";
      if(rewardSlotEl) rewardSlotEl.style.display = "";
      slotClearAll();
      slotResetView();
      if(rewardHintEl) rewardHintEl.textContent = `${rewardTypeLabel(rewardType)}ï¼ ã‚¹ãƒ­ãƒƒãƒˆã‚’ ã‚¿ãƒƒãƒ—ã§ ã‚¹ã‚¿ãƒ¼ãƒˆï¼å›ã£ãŸã‚‰ 1ã¾ã„ãšã¤ ã¨ã‚ã¦ã­`;
      break;
  }
  rewardWheelEl.classList.remove("disabled");
}

function setupRewardCardGimmick(){
  if(!rewardCardContainerEl) return;

  rewardCardContainerEl.style.display = "flex";
  rewardCardContainerEl.innerHTML = "";

  const nums = [];
  while(nums.length < 3){
    const n = Math.floor(Math.random()*10) + 1;
    if(!nums.includes(n)) nums.push(n);
  }

  let chosen = false;

  nums.forEach(num => {
    const c = document.createElement("div");
    c.className = "rewardCard";
    c.textContent = "ï¼Ÿ";
    c.dataset.value = String(num);

    c.addEventListener("click", () => {
      if(!rewardReady) return;
      if(chosen) return;

      chosen = true;

      const all = Array.from(rewardCardContainerEl.getElementsByClassName("rewardCard"));
      all.forEach(x => x.classList.add("disabled"));

      c.classList.add("selected");
      c.style.transform = "scale(0.9)";
      setTimeout(() => {
        c.textContent = c.dataset.value;
        c.style.transform = "scale(1)";
      }, 120);

      const v = c.dataset.value;
      if(rewardHintEl) rewardHintEl.textContent = `${rewardTypeLabel("card")} ã‘ã£ã‹ï¼š${v} ç‚¹`;

      addRewardPointsFromText(v);

      rewardCounter = 0;
      rewardReady = false;
      rewardPlayedThisCharge = true;

      updateRewardUI();

      if(answeredCorrectThisQ){
        nextBtn.disabled = false;
      }
    });

    rewardCardContainerEl.appendChild(c);
  });
}

function startRewardSpin(){
  if(!rewardWheelEl || !rewardType) return;
  if(rewardInterval){
    clearInterval(rewardInterval);
    rewardInterval = null;
  }
  rewardSpinning = true;

  let rouletteValue = 1;
  let diceValue = 1;
  let s1=0,s2=0,s3=0;

  rewardInterval = setInterval(()=>{
    switch(rewardType){
      case "roulette":
        rouletteValue++;
        if(rouletteValue>10) rouletteValue=1;
        rewardWheelEl.textContent = String(rouletteValue);
        break;
      case "dice":
        diceValue = Math.floor(Math.random()*6)+1;
        rewardWheelEl.textContent = "ğŸ² "+diceValue;
        break;
      case "slot":
        // ï¼ˆã“ã“ã¯ä½¿ã‚ãªã„ãŒã€ä»•æ§˜ã¯æ®‹ã™ï¼‰
        s1 = (s1+1)%10;
        s2 = (s2+2)%10;
        s3 = (s3+3)%10;
        rewardWheelEl.textContent = `${s1}${s2}${s3}`;
        break;
    }
  },80);
}

function stopRewardSpinAndHoldResult(){
  if(rewardInterval){
    clearInterval(rewardInterval);
    rewardInterval = null;
  }
  rewardSpinning = false;

  let resultText = "";
  const shown = String(rewardWheelEl.textContent ?? "");

  switch(rewardType){
    case "roulette":
      resultText = `${rewardTypeLabel(rewardType)} ã‘ã£ã‹ï¼š${shown} ç‚¹`;
      break;
    case "dice":{
      const m = shown.match(/(\d+)/);
      const v = m ? m[1] : shown;
      resultText = `${rewardTypeLabel(rewardType)} ã‘ã£ã‹ï¼š${v} ç‚¹`;
      break;
    }
    case "slot":
      resultText = `${rewardTypeLabel(rewardType)} ã‘ã£ã‹ï¼š${shown} ç‚¹`;
      break;
  }

  if(rewardHintEl) rewardHintEl.textContent = resultText;

  addRewardPointsFromText(shown);

  rewardCounter = 0;
  rewardReady = false;
  rewardPlayedThisCharge = true;

  rewardWheelEl.classList.add("disabled");
  updateRewardUI();

  if(answeredCorrectThisQ){
    nextBtn.disabled = false;
  }
}

function revealTreasureAndHoldResult(){
  if(!rewardWheelEl) return;
  const num = Math.floor(Math.random()*10)+1;
  rewardWheelEl.textContent = "ğŸ“¦â†’"+num;
  if(rewardHintEl) rewardHintEl.textContent = `${rewardTypeLabel("treasure")} ã‘ã£ã‹ï¼š${num} ç‚¹`;

  addRewardPointsFromText(String(num));

  rewardCounter = 0;
  rewardReady = false;
  rewardPlayedThisCharge = true;

  rewardWheelEl.classList.add("disabled");
  updateRewardUI();

  if(answeredCorrectThisQ){
    nextBtn.disabled = false;
  }
}
/* ========= ã‚¤ãƒ™ãƒ³ãƒˆ ========= */
hintBtn.addEventListener("click", showHint);
/* â˜…showAnswerBtnå‰Šé™¤ï¼šã‚¤ãƒ™ãƒ³ãƒˆã‚‚å‰Šé™¤ */
checkBtn.addEventListener("click", check);
nextBtn.addEventListener("click", next);

smallKey.addEventListener("click", toggleSmallMode);
dakutenKey.addEventListener("click", addDakuten);
handakutenKey.addEventListener("click", addHandakuten);

readBtn.addEventListener("click", () => speak(typed));
backBtn.addEventListener("click", onBackspace);
clearBtn.addEventListener("click", onClear);
/* â˜…è¿½åŠ ï¼šã‚¹ãƒãƒ›ã®ãƒ•ãƒªãƒƒã‚¯å…¥åŠ›ï¼ˆãƒã‚¤ãƒ†ã‚£ãƒ–å…¥åŠ›ï¼‰ */
if(nativeInput){
  // å…¥åŠ›ãŒå¤‰ã‚ã£ãŸã‚‰ typed ã«åæ˜ 
  nativeInput.addEventListener("input", () => {
    if(nextBtn.disabled === false) return; // ã™ã§ã«åˆ¤å®šå¾Œãªã‚‰å…¥åŠ›ã•ã›ãªã„
    typed = nativeInput.value || "";
    renderAnswer();
  });

  // ç”»é¢ã®å…¥åŠ›æ¬„ï¼ˆanswerViewï¼‰ã‚’ã‚¿ãƒƒãƒ—ã—ãŸã‚‰ãƒ•ãƒªãƒƒã‚¯å…¥åŠ›ã‚’å‡ºã™
  answerView.addEventListener("click", () => {
    try{ nativeInput.focus(); }catch(e){}
  });
}


document.querySelectorAll(".bottomRow .key[data-ch]").forEach(k=>{
  k.addEventListener("click", () => appendChar(k.getAttribute("data-ch")));
});

dakutenToggle.addEventListener("click", () => {
  dakutenVisible = !dakutenVisible;
  applyPanelVisibility();
});
youonToggle.addEventListener("click", () => {
  youonVisible = !youonVisible;
  applyPanelVisibility();
});

/* â˜…ã”ã»ã†ã³ã‚¯ãƒªãƒƒã‚¯ */
if(rewardWheelEl){
  rewardWheelEl.addEventListener("click", () => {
    if(!rewardReady) return;
    if(!rewardType) enableRewardGimmick();
    if(rewardWheelEl.classList.contains("disabled")) return;

    if(rewardType === "treasure"){
      revealTreasureAndHoldResult();
      return;
    }

    // slot ã¯ 3ãƒªãƒ¼ãƒ«å´ã§å‡¦ç†ï¼ˆwheel ã¯éè¡¨ç¤ºï¼‰
    if(rewardType === "slot"){
      return;
    }

    if(!rewardSpinning){
      startRewardSpin();
    }else{
      stopRewardSpinAndHoldResult();
    }
  });
}

/* â˜…ãã™ç‰ã¯ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹ â†’ é–‰ã˜ãŸã‚‰ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°é–‹å§‹ï¼ˆå¾…æ©ŸãŒã‚ã‚Œã°ï¼‰ */
let pendingShooterStart = false;

if(kusudamaOverlayEl){
  kusudamaOverlayEl.addEventListener("click", () => {
    kusudamaOverlayEl.style.display = "none";

    // â˜…ãã™ç‰ã‚’é–‰ã˜ãŸç›´å¾Œã«ã€ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°é–‹å§‹
    if(pendingShooterStart){
      pendingShooterStart = false;
      try{ openShooterOverlay(); }catch(e){}
    }
  });
}

/* â˜…çµ‚äº†ã—ã¦æœ€åˆã‹ã‚‰ */
if(restartBtn){
  restartBtn.addEventListener("click", () => {
    try{ window.speechSynthesis && window.speechSynthesis.cancel(); }catch(e){}
    if(kusudamaOverlayEl) kusudamaOverlayEl.style.display = "none";
    start();
  });
}

/* â˜…ãƒ­ã‚°ï¼šå·¦ä¸Šãƒœã‚¿ãƒ³ */
if(saveProgressBtn){
  saveProgressBtn.addEventListener("click", () => {
    logProgressOnce();
  });
}
if(openLogBtn){
  openLogBtn.addEventListener("click", () => {
    openLog();
  });
}
if(logCloseBtn){
  logCloseBtn.addEventListener("click", () => closeLog());
}
if(logOverlayEl){
  // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹ï¼ˆã‚«ãƒ¼ãƒ‰å†…ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡è¦–ï¼‰
  logOverlayEl.addEventListener("click", (e) => {
    if(e.target === logOverlayEl) closeLog();
  });
}
if(logClearBtn){
  logClearBtn.addEventListener("click", () => {
    clearAllLogs();
  });
}
if(logCsvBtn){
  logCsvBtn.addEventListener("click", () => {
    downloadCsvForCurrentTab();
  });
}
if(tabProgressEl){
  tabProgressEl.addEventListener("click", () => setActiveTab("progress"));
}
if(tabHintsEl){
  tabHintsEl.addEventListener("click", () => setActiveTab("hints"));
}
if(tabWrongsEl){
  tabWrongsEl.addEventListener("click", () => setActiveTab("wrongs"));
}

/* ========= åˆæœŸåŒ– ========= */
buildBase();
buildDakuten();
buildYouon();
applyPanelVisibility();
updateRewardPointsUI();
/* ===============================
   â˜…è¿½åŠ ï¼š30ç‚¹ã”ã¨ã«èµ·å‹•ã™ã‚‹ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆãƒˆãƒªã‚¬ãƒ¼ï¼‰
   â˜…é‡è¦ï¼šã‚³ãƒ¡ãƒ³ãƒˆé–‰ã˜å¿˜ã‚Œé˜²æ­¢æ¸ˆã¿
=============================== */


/* â˜…addRewardPointsFromText ã‚’å®‰å…¨ã«ãƒ•ãƒƒã‚¯ï¼ˆä¸­èº«ã¯ãã®ã¾ã¾å‘¼ã¶ï¼‰ */

/* â˜…è§¦ã‚‰ãšã«æ¸ˆã¾ã›ã‚‹ç‰ˆï¼šrewardPtsBadgeã®è¡¨ç¤ºãŒå¤‰ã‚ã£ãŸã‚‰ãƒã‚§ãƒƒã‚¯ï¼ˆå®‰å…¨ãƒ»å‰¯ä½œç”¨ãªã—ï¼‰ */
/* ===============================
   â˜…è¿½åŠ ï¼šã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æœ¬ä½“ï¼ˆ3ãƒ¬ãƒ¼ãƒ³ï¼å·¦å³ç§»å‹•ã®ã¿ï¼ã‚ªãƒ¼ãƒˆé€£å°„ï¼åˆ¶é™æ™‚é–“ï¼‰
   ãƒ»æ•µã‚’å€’ã™ã¨ã‚³ã‚¤ãƒ³ãŒå¢—ãˆã‚‹ï¼ˆã—ã‹ã‘å¾—ç‚¹ã«ã¯åŠ ç®—ã—ãªã„ï¼‰
   ãƒ»ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å†…ã ã‘ã§å®Œçµ
   ç½®ãå ´æ‰€ï¼šJSãƒ‘ãƒƒãƒâ‘ ã®ã€Œä¸‹ã€ã«ãã®ã¾ã¾è¿½åŠ 
=============================== */

/* ===== ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼šè¦ç´ ã¯æ¯å›DOMã‹ã‚‰å–å¾—ï¼ˆæœªå®šç¾©ã‚¨ãƒ©ãƒ¼ã‚’æ ¹çµ¶ï¼‰ ===== */
let shooterControlsBound = false;

function getShooterEls(){
  const overlay = document.getElementById("shooterOverlay");
  const canvas  = document.getElementById("shooterCanvas");
  const leftBtn = document.getElementById("shooterLeftBtn");
  const rightBtn= document.getElementById("shooterRightBtn");
  const closeBtn= document.getElementById("shooterCloseBtn");
  const timeChip= document.getElementById("shooterTimeChip");
  const coinChip= document.getElementById("shooterCoinChip");
  const resultEl= document.getElementById("shooterResult");
  const resultText = document.getElementById("shooterResultText");
  const resultClose= document.getElementById("shooterResultCloseBtn");
  return { overlay, canvas, leftBtn, rightBtn, closeBtn, timeChip, coinChip, resultEl, resultText, resultClose };
}

function bindShooterControlsOnce(){
  if(shooterControlsBound) return;

  const els = getShooterEls();
  if(!els.overlay || !els.canvas) return; // ã¾ã DOMã«ãªã„ãªã‚‰ä½•ã‚‚ã—ãªã„

  // ãƒœã‚¿ãƒ³
  els.leftBtn && els.leftBtn.addEventListener("click", ()=> moveLane(-1));
  els.rightBtn && els.rightBtn.addEventListener("click", ()=> moveLane(+1));
  els.closeBtn && els.closeBtn.addEventListener("click", ()=>{
    shooterRunning = false;
    stopShooterGame();
    showShooterResult();
  });

  // çµæœã®ã€Œã¨ã˜ã‚‹ã€
  els.resultClose && els.resultClose.addEventListener("click", ()=>{
    const e2 = getShooterEls();
    if(e2.resultEl){
      e2.resultEl.style.display = "none";
      e2.resultEl.setAttribute("aria-hidden","true");
    }
    closeShooterOverlay();
  });

  // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¿ãƒƒãƒ—ï¼ˆå·¦å³ï¼‰
  els.canvas.addEventListener("click", (e)=>{
    const rect = els.canvas.getBoundingClientRect();
    const x = (e.clientX - rect.left) / rect.width; // 0..1
    if(x < 0.5) moveLane(-1);
    else moveLane(+1);
  });

  // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ï¼ˆPCï¼‰
  window.addEventListener("keydown", (e)=>{
    const ov = document.getElementById("shooterOverlay");
    if(!ov || ov.style.display !== "flex") return;
    if(e.key === "ArrowLeft") moveLane(-1);
    if(e.key === "ArrowRight") moveLane(+1);
    if(e.key === "Escape") closeShooterOverlay();
  });

  shooterControlsBound = true;
}

function openShooterOverlay(){
  const els = getShooterEls();
  if(!els.overlay || !els.canvas) return;

  // ã“ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãªã‚‰DOMãŒæƒã£ã¦ã„ã‚‹
  bindShooterControlsOnce();

  els.overlay.style.display = "flex";
  initShooterGame();
  startShooterGame();
}

function closeShooterOverlay(){
  stopShooterGame();
  const els = getShooterEls();
  if(els.overlay) els.overlay.style.display = "none";
}

/* ãƒãƒƒãƒ—æ›´æ–°ã¯ getShooterEls() ã‚’ä½¿ã†ã‚ˆã†ã«ã™ã‚‹ */
function updateShooterChips(){
  const els = getShooterEls();
  if(els.timeChip){
    els.timeChip.textContent = `ã®ã“ã‚Šï¼š${Math.max(0, Math.ceil(shooterTimeLeft/1000))}s`;
  }
  if(els.coinChip){
    els.coinChip.textContent = `ã‚³ã‚¤ãƒ³ï¼š${shooterCoins}`;
  }
}

/* Canvaså‚ç…§ã‚‚ getShooterEls() ã‹ã‚‰å–ã‚‹ */
function shooterLoop(ts){
  if(!shooterRunning) return;

  const dt = Math.min(0.033, (ts - shooterLastTs)/1000);
  shooterLastTs = ts;

  shooterTimeLeft -= dt*1000;
  if(shooterTimeLeft <= 0){
    shooterTimeLeft = 0;
    updateShooterChips();
    shooterRunning = false;
    stopShooterGame();
    showShooterResult();
    return;
  }

  shooterSpawnAcc += dt;
  while(shooterSpawnAcc >= 0.55){
    shooterSpawnAcc -= 0.55;
    spawnEnemy();
  }

  for(const e of shooterEnemies) e.y += e.vy * dt;
  for(const b of shooterBullets) b.y -= b.vy * dt;

  for(const b of shooterBullets){
    for(const e of shooterEnemies){
      if(e.hp<=0) continue;
      if(hitCircle(b, e)){
        e.hp = 0;
        b.y = -9999;
        shooterCoins += 1;
      }
    }
  }

  shooterEnemies = shooterEnemies.filter(e => e.hp>0 && e.y < SH_H + 30);
  shooterBullets = shooterBullets.filter(b => b.y > -30);

  updateShooterChips();

  const els = getShooterEls();
  if(els.canvas){
    const ctx = els.canvas.getContext("2d");
    drawShooter(ctx);
  }

  shooterAnimId = requestAnimationFrame(shooterLoop);
}

/* çµæœè¡¨ç¤ºã‚‚ getShooterEls() ã§å®‰å…¨ã« */
function showShooterResult(){
  const els = getShooterEls();
  if(!els.resultEl || !els.resultText) return;
  els.resultText.textContent = `ã‚³ã‚¤ãƒ³ ${shooterCoins} ã¾ã„ ã‚²ãƒƒãƒˆï¼`;
  els.resultEl.style.display = "flex";
  els.resultEl.setAttribute("aria-hidden", "false");
}
/* ===============================
   â˜…ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æœ¬ä½“ï¼ˆä¸è¶³ã—ã¦ã„ãŸã€Œã‚¨ãƒ³ã‚¸ãƒ³éƒ¨åˆ†ã€ï¼‰
   è²¼ã‚‹å ´æ‰€ï¼š<script> ã®ä¸€ç•ªä¸‹ã€start(); ã®ç›´å‰
   ã“ã‚Œã‚’å…¥ã‚Œã‚‹ã¨ shooterRunning ç­‰ãŒå®šç¾©ã•ã‚Œã€ã‚²ãƒ¼ãƒ ãŒå›ºã¾ã‚‰ãªããªã‚‹
=============================== */

/* ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼šçŠ¶æ…‹ */
let shooterRunning = false;
let shooterCoins = 0;

let shooterLane = 1;           // 0,1,2
let shooterTimeLeft = 0;       // ms
let shooterLastTs = 0;

let shooterEnemies = [];
let shooterBullets = [];
let shooterSpawnAcc = 0;

let shooterAnimId = null;
let shooterFireTimer = null;

/* Canvaså†…éƒ¨ã‚µã‚¤ã‚ºï¼ˆå±æ€§width/heightã«åˆã‚ã›ã‚‹ï¼‰ */
const SH_W = 720;
const SH_H = 420;

/* 3ãƒ¬ãƒ¼ãƒ³ã®ä¸­å¿ƒX */
function laneX(lane){
  const centers = [SH_W*0.25, SH_W*0.50, SH_W*0.75];
  return centers[Math.max(0, Math.min(2, lane))];
}

function moveLane(delta){
  shooterLane = Math.max(0, Math.min(2, shooterLane + delta));
}

function spawnEnemy(){
  const lane = Math.floor(Math.random()*3);
  shooterEnemies.push({
    lane,
    x: laneX(lane),
    y: -20,
    r: 16,
    hp: 1,
    vy: 80 + Math.random()*60, // px/s
  });
}

function fireBullet(){
  shooterBullets.push({
    lane: shooterLane,
    x: laneX(shooterLane),
    y: SH_H - 40,
    r: 5,
    vy: 260, // px/s
  });
}

function hitCircle(a, b){
  const dx = a.x - b.x;
  const dy = a.y - b.y;
  const rr = (a.r + b.r);
  return (dx*dx + dy*dy) <= rr*rr;
}

/* åˆæœŸåŒ– */
function initShooterGame(){
  shooterRunning = false;
  shooterCoins = 0;
  shooterLane = 1;
  shooterTimeLeft = 15_000; // 15ç§’
  shooterLastTs = 0;
  shooterEnemies = [];
  shooterBullets = [];
  shooterSpawnAcc = 0;

  // â€»ã‚ãªãŸã®å¾Œç¶šã‚³ãƒ¼ãƒ‰å´ã§ updateShooterChips() ã‚’å†å®šç¾©ã—ã¦ã„ã‚‹ã®ã§ãã‚Œã‚’ä½¿ã†
  if(typeof updateShooterChips === "function") updateShooterChips();
}

/* ã‚ªãƒ¼ãƒˆé€£å°„ */
function shooterAutoFireStart(){
  shooterAutoFireStop();
  shooterFireTimer = setInterval(()=>{
    if(!shooterRunning) return;
    fireBullet();
  }, 180);
}
function shooterAutoFireStop(){
  if(shooterFireTimer){
    clearInterval(shooterFireTimer);
    shooterFireTimer = null;
  }
}

/* é–‹å§‹ï¼åœæ­¢ */
function startShooterGame(){
  if(shooterRunning) return;
  shooterRunning = true;
  shooterLastTs = performance.now();
  shooterAutoFireStart();

  // â€»ã‚ãªãŸã®å¾Œç¶šã‚³ãƒ¼ãƒ‰å´ã§ shooterLoop(ts) ã‚’å†å®šç¾©ã—ã¦ã„ã‚‹ã®ã§ãã‚Œã‚’ä½¿ã†
  shooterAnimId = requestAnimationFrame(shooterLoop);
}

function stopShooterGame(){
  shooterRunning = false;
  shooterAutoFireStop();
  if(shooterAnimId){
    cancelAnimationFrame(shooterAnimId);
    shooterAnimId = null;
  }
}

/* æç”»ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹ï¼‰ */
function drawShooter(ctx){
  if(!ctx) return;

  ctx.clearRect(0,0,SH_W,SH_H);

  // ãƒ¬ãƒ¼ãƒ³ç·š
  ctx.globalAlpha = 0.35;
  ctx.strokeStyle = "#ffffff";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(SH_W/3, 0); ctx.lineTo(SH_W/3, SH_H);
  ctx.moveTo(2*SH_W/3, 0); ctx.lineTo(2*SH_W/3, SH_H);
  ctx.stroke();
  ctx.globalAlpha = 1;

  // è‡ªæ©Ÿ
  const px = laneX(shooterLane);
  const py = SH_H - 26;
  ctx.fillStyle = "#60a5fa";
  ctx.beginPath();
  ctx.arc(px, py, 16, 0, Math.PI*2);
  ctx.fill();

  // å¼¾
  ctx.fillStyle = "#f9fafb";
  for(const b of shooterBullets){
    ctx.beginPath();
    ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
    ctx.fill();
  }

  // æ•µ
  ctx.fillStyle = "#f87171";
  for(const e of shooterEnemies){
    ctx.beginPath();
    ctx.arc(e.x, e.y, e.r, 0, Math.PI*2);
    ctx.fill();
  }
}
/* ===== ã“ã“ã¾ã§è²¼ã‚‹ ===== */
/* ===============================
   â˜…è¿½åŠ ï¼šå•é¡Œç®¡ç†ï¼ˆlocalStorageã§å³ä¿å­˜ï¼†å³åæ˜ ï¼‰
   è²¼ã‚‹å ´æ‰€ï¼š<script> ã®ä¸€ç•ªä¸‹ã€start(); ã®ç›´å‰
=============================== */
const LS_WORDS_TEXT = "kanji_words_text_v1";

/* ITEMS â‡„ ãƒ†ã‚­ã‚¹ãƒˆ å¤‰æ›ï¼ˆä¿å­˜ç”¨ï¼‰ */
function itemsToWordsText(items){
  const lines = [];
  for(const it of (items || [])){
    const p = String(it.prompt ?? "").trim();
    const a = (it.answers || []).map(x => String(x ?? "").trim()).filter(Boolean);
    if(!p || a.length===0) continue;
    lines.push([p, ...a].join(" "));
  }
  return lines.join("\n");
}

/* localStorage â†’ ITEMS ã‚’èª­ã¿è¾¼ã¿ */
function loadWordsFromLocalStorage(){
  try{
    const saved = localStorage.getItem(LS_WORDS_TEXT);
    if(saved && String(saved).trim()){
      ITEMS = parseWordsText(saved);
      return;
    }
  }catch(e){}
  // ä¿å­˜ãŒç„¡ã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ï¼ˆITEMSã¯æ—¢ã«DEFAULTã‹ã‚‰ä½œã£ã¦ã‚ã‚‹å‰æï¼‰
}

/* ITEMS â†’ localStorage ä¿å­˜ */
function saveWordsToLocalStorage(){
  try{
    const text = itemsToWordsText(ITEMS);
    localStorage.setItem(LS_WORDS_TEXT, text);
  }catch(e){}
}

/* ç®¡ç†ç”»é¢UI */
const manageBtn = document.getElementById("manageBtn");
const manageOverlayEl = document.getElementById("manageOverlay");
const manageInputEl = document.getElementById("manageInput");
const manageAddBtn = document.getElementById("manageAddBtn");
const manageClearInputBtn = document.getElementById("manageClearInputBtn");
const manageListEl = document.getElementById("manageList");
const manageCheckAllBtn = document.getElementById("manageCheckAllBtn");
const manageDeleteBtn = document.getElementById("manageDeleteBtn");
const manageBackBtn = document.getElementById("manageBackBtn");
const manageNoteEl = document.getElementById("manageNote");

function openManage(){
  if(!manageOverlayEl) return;
  renderManageList();
  if(manageNoteEl) manageNoteEl.textContent = "";
  manageOverlayEl.style.display = "flex";
  manageOverlayEl.setAttribute("aria-hidden","false");
}
function closeManage(){
  if(!manageOverlayEl) return;
  manageOverlayEl.style.display = "none";
  manageOverlayEl.setAttribute("aria-hidden","true");
}

/* ä¸€è¦§æç”»ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ä»˜ãï¼‰ */
function renderManageList(){
  if(!manageListEl) return;
  manageListEl.innerHTML = "";

  if(!ITEMS || ITEMS.length===0){
    const d = document.createElement("div");
    d.className = "logEmpty";
    d.textContent = "å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“";
    manageListEl.appendChild(d);
    return;
  }

  ITEMS.forEach((it, i)=>{
    const row = document.createElement("div");
    row.className = "manageRow";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.className = "manageChk";
    cb.dataset.idx = String(i);

    const main = document.createElement("div");
    main.className = "manageRowMain";

    const p = document.createElement("div");
    p.className = "manageRowPrompt";
    p.textContent = String(it.prompt ?? "");

    const a = document.createElement("div");
    a.className = "manageRowAns";
    a.textContent = "ã‚ˆã¿ï¼š " + (it.answers || []).join(" / ");

    main.appendChild(p);
    main.appendChild(a);

    row.appendChild(cb);
    row.appendChild(main);

    manageListEl.appendChild(row);
  });
}

/* è¿½åŠ ï¼ˆè¤‡æ•°è¡Œï¼‰ */
/* è¿½åŠ ï¼ˆè¤‡æ•°è¡Œï¼‰â˜…ã“ã“ã‚’ä¸¸ã”ã¨å·®ã—æ›¿ãˆ */
function addFromManageInput(){
  if(!manageInputEl) return;
  const raw = String(manageInputEl.value ?? "").trim();
  if(!raw){
    if(manageNoteEl) manageNoteEl.textContent = "å…¥åŠ›ãŒç©ºã§ã™";
    return;
  }

  const newItems = parseWordsText(raw);
  if(newItems.length===0){
    if(manageNoteEl) manageNoteEl.textContent = "è¿½åŠ ã§ãã‚‹è¡ŒãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆä¾‹ï¼š æ¼¢å­— ã‚ˆã¿ï¼‰";
    return;
  }

  // æœ«å°¾ã«è¿½åŠ ï¼ˆé‡è¤‡æ’é™¤ã¯ã—ãªã„ä»•æ§˜ï¼‰
  ITEMS = (ITEMS || []).concat(newItems);

  // ä¿å­˜ï¼ˆlocalStorageï¼‰
  saveWordsToLocalStorage();

  // âœ… è¿½åŠ å¾Œã™ãã€Œã„ã¾å…¥ã£ã¦ã„ã‚‹å•é¡Œã€ã‚’æç”»ã—ç›´ã™ï¼ˆç¢ºå®Ÿã«åæ˜ ï¼‰
  renderManageList();
  // ã¾ã‚Œã«æç”»ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒã‚ºãƒ¬ã‚‹ç’°å¢ƒå¯¾ç­–ï¼ˆãƒ¡ãƒ¢å¸³ï¼‹ç›´é–‹ãå¯¾ç­–ï¼‰
  setTimeout(()=>{ try{ renderManageList(); }catch(e){} }, 0);

  // âœ… è¿½åŠ ã—ãŸå†…å®¹ã®ç¢ºèªãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºï¼ˆæœ€å¾Œã«ä¸€è¦§ãŒå‡ºã¦ã»ã—ã„è¦æœ›å¯¾å¿œï¼‰
  showAddedPreview(newItems);

  // å…¥åŠ›æ¬„ã¯ç©ºã«
  manageInputEl.value = "";

  // å­¦ç¿’å´ã‚‚å³åæ˜ ï¼šç¢ºå®Ÿã«åæ˜ ã•ã›ã‚‹ãŸã‚ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
  try{ start(); }catch(e){}
}
/* âœ… è¿½åŠ ã—ãŸå†…å®¹ã‚’ã€Œç¢ºèªãƒªã‚¹ãƒˆã€ã¨ã—ã¦è¡¨ç¤º */
function showAddedPreview(addedItems){
  if(!manageNoteEl) return;

  // ã„ã£ãŸã‚“ä¸­èº«ã‚’ä½œã‚Šç›´ã™ï¼ˆè¦‹ã‚„ã™ã„ã‚ˆã†ã«ï¼‰
  manageNoteEl.innerHTML = "";

  const title = document.createElement("div");
  title.style.fontWeight = "900";
  title.style.marginBottom = "6px";
  title.textContent = `${addedItems.length}å• è¿½åŠ ã—ã¾ã—ãŸï¼ˆä¿å­˜ã—ã¾ã—ãŸï¼‰`;
  manageNoteEl.appendChild(title);

  const box = document.createElement("div");
  box.style.border = "1px solid var(--border)";
  box.style.borderRadius = "12px";
  box.style.padding = "10px";
  box.style.background = "#f9fafb";
  box.style.maxHeight = "180px";
  box.style.overflow = "auto";
  box.style.fontWeight = "800";
  box.style.whiteSpace = "pre-wrap";

  const lines = (addedItems || []).map(it=>{
    const p = String(it.prompt ?? "");
    const a = (it.answers || []).join(" / ");
    return `${p}ã€€â†’ã€€${a}`;
  }).join("\n");

  box.textContent = lines;
  manageNoteEl.appendChild(box);

  // ä¸€è¦§å´ãŒä¸‹ã«ã‚ã‚‹ã®ã§ã€ç¢ºèªãŒè¦‹ãˆã‚‹ã‚ˆã†ã«å°‘ã—ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  try{ manageNoteEl.scrollIntoView({behavior:"smooth", block:"start"}); }catch(e){}
}
/* å…¨ã¦ã«ãƒã‚§ãƒƒã‚¯ */
function checkAllManage(){
  if(!manageListEl) return;
  manageListEl
    .querySelectorAll("input.manageChk[type='checkbox']")
    .forEach(cb => cb.checked = true);

  if(manageNoteEl) manageNoteEl.textContent = "å…¨ã¦ã«ãƒã‚§ãƒƒã‚¯ã—ã¾ã—ãŸ";
}

/* ãƒã‚§ãƒƒã‚¯ã—ãŸã‚‚ã®ã‚’å‰Šé™¤ */
function deleteCheckedManage(){
  if(!manageListEl) return;

  const checked = Array.from(manageListEl.querySelectorAll("input.manageChk[type='checkbox']:checked"))
    .map(cb => Number(cb.dataset.idx))
    .filter(n => Number.isFinite(n))
    .sort((a,b)=>b-a); // å¾Œã‚ã‹ã‚‰æ¶ˆã™

  if(checked.length===0){
    if(manageNoteEl) manageNoteEl.textContent = "å‰Šé™¤ã™ã‚‹å•é¡ŒãŒé¸ã°ã‚Œã¦ã„ã¾ã›ã‚“";
    return;
  }

  // å‰Šé™¤
  for(const i of checked){
    if(i>=0 && i<ITEMS.length) ITEMS.splice(i,1);
  }

  saveWordsToLocalStorage();
  renderManageList();

  if(manageNoteEl) manageNoteEl.textContent = `${checked.length}å• å‰Šé™¤ã—ã¾ã—ãŸï¼ˆä¿å­˜ã—ã¾ã—ãŸï¼‰`;

  // å­¦ç¿’å´ã‚‚å³åæ˜ ï¼šå…¨ä½“ã‚’ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
  try{ start(); }catch(e){}
}

/* ã‚¤ãƒ™ãƒ³ãƒˆ */
if(manageBtn){
  manageBtn.addEventListener("click", ()=> openManage());
}
if(manageBackBtn){
  manageBackBtn.addEventListener("click", ()=> closeManage());
}
if(manageOverlayEl){
  // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹ï¼ˆã‚«ãƒ¼ãƒ‰å†…ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡è¦–ï¼‰
  manageOverlayEl.addEventListener("click", (e)=>{
    if(e.target === manageOverlayEl) closeManage();
  });
}
if(manageAddBtn){
  manageAddBtn.addEventListener("click", ()=> addFromManageInput());
}
if(manageClearInputBtn){
  manageClearInputBtn.addEventListener("click", ()=>{
    if(manageInputEl) manageInputEl.value = "";
    if(manageNoteEl) manageNoteEl.textContent = "";
  });
}

if(manageCheckAllBtn){
  manageCheckAllBtn.addEventListener("click", ()=> checkAllManage());
}
if(manageDeleteBtn){
  manageDeleteBtn.addEventListener("click", ()=> deleteCheckedManage());
}

/* åˆå›ï¼šä¿å­˜ãŒã‚ã‚Œã°èª­ã¿è¾¼ã‚€ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä¸Šæ›¸ãï¼‰ */
loadWordsFromLocalStorage();

start();
</script>
<!-- â˜…è¿½åŠ ï¼š30ã®å€æ•°ã§èµ·å‹•ã™ã‚‹ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰
     ç½®ãå ´æ‰€ï¼šã‚ãªãŸã®HTMLã®ã€Œ</script>ã€ã®å¾Œã€œã€Œ</body>ã€ã®ç›´å‰ã«ã€ãã®ã¾ã¾è²¼ã‚‹ -->
<div class="shooterOverlay" id="shooterOverlay" role="dialog" aria-modal="true">
  <div class="shooterCard">
    <div class="shooterTopbar">
      <div class="ttl">30ã¦ã‚“ ã”ã»ã†ã³ã‚²ãƒ¼ãƒ ï¼ˆ3ãƒ¬ãƒ¼ãƒ³ãƒ»å·¦å³ã„ã©ã†ï¼ã‚ªãƒ¼ãƒˆã‚Œã‚“ã—ã‚ƒï¼‰</div>
      <div class="stat">
        <div class="chip" id="shooterTimeChip">ã®ã“ã‚Šï¼šâ€”</div>
        <div class="chip" id="shooterCoinChip">ã‚³ã‚¤ãƒ³ï¼š0</div>
      </div>
    </div>

    <div class="shooterCanvasWrap">
      <canvas id="shooterCanvas" width="720" height="420"></canvas>
    </div>

<!-- â˜…è¿½åŠ ï¼šã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°çµ‚äº†çµæœï¼ˆã—ã‹ã‘å¾—ç‚¹ã«ã¯åŠ ç®—ã—ãªã„ï¼‰ -->
<div class="shooterResult" id="shooterResult" aria-hidden="true">
  <div class="shooterResultInner">
    <div class="shooterResultTitle">ãŠã‚ã§ã¨ã†ï¼</div>
    <div class="shooterResultText" id="shooterResultText">
      ã‚³ã‚¤ãƒ³ 0 ã¾ã„ ã‚²ãƒƒãƒˆï¼
    </div>
    <button class="shooterBtn" id="shooterResultCloseBtn" type="button">
      ã¨ã˜ã‚‹
    </button>
  </div>
</div>

    <div class="shooterControls">
      <button class="shooterBtn" id="shooterLeftBtn" type="button">â† ã²ã ã‚Š</button>
      <button class="shooterBtn" id="shooterRightBtn" type="button">ã¿ã â†’</button>
      <button class="shooterBtn" id="shooterCloseBtn" type="button">ãŠã‚ã‚‹</button>
    </div>
  </div>
</div>

</body>
</html>



