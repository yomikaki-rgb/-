<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>CSV→A4分割 PowerPoint 生成（6/8切替）</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --ink:#111827; --sub:#6b7280; --border:#e5e7eb;
    --primary:#2563eb; --primary2:#1d4ed8; --danger:#dc2626; --shadow:0 10px 24px rgba(0,0,0,.08);
    --radius:16px; --gap:12px;
  }
  *{ box-sizing:border-box; }
  body{ margin:0; background:var(--bg); color:var(--ink); font-family: system-ui, -apple-system, "Segoe UI", "Noto Sans JP", sans-serif; }
  header{ padding:16px 16px 8px; max-width:1100px; margin:0 auto; }
  h1{ margin:0 0 6px; font-size:18px; }
  .sub{ color:var(--sub); font-size:13px; line-height:1.5; }
  main{ max-width:1100px; margin:0 auto; padding:8px 16px 24px; display:grid; gap:var(--gap); }
  .grid{ display:grid; grid-template-columns: 1.1fr .9fr; gap:var(--gap); }
  @media (max-width: 920px){ .grid{ grid-template-columns: 1fr; } }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  label{ font-size:12px; color:var(--sub); display:block; margin-bottom:4px; }
  input[type="text"], input[type="number"], select, textarea{
    width:100%; border:1px solid var(--border); border-radius:12px; padding:10px 12px; font-size:14px; outline:none; background:#fff;
  }
  textarea{ min-height:240px; resize:vertical; }
  .field{ flex:1; min-width:180px; }
  .btn{
    appearance:none; border:0; border-radius:14px; padding:10px 14px; font-weight:700; cursor:pointer;
    background:var(--primary); color:#fff;
  }
  .btn:hover{ background:var(--primary2); }
  .btn.secondary{ background:#111827; }
  .btn.ghost{ background:#fff; color:var(--ink); border:1px solid var(--border); }
  .btn.danger{ background:var(--danger); }
  .hint{ font-size:12px; color:var(--sub); line-height:1.6; }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12px; }
  .err{ color:var(--danger); font-weight:700; }
  .ok{ color:#16a34a; font-weight:700; }
  .small{ font-size:12px; color:var(--sub); }
  .hr{ height:1px; background:var(--border); margin:10px 0; }
  .kpi{ display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:10px; }
  .kpi .box{ border:1px solid var(--border); border-radius:14px; padding:10px 12px; background:#fff; }
  .kpi .num{ font-size:18px; font-weight:800; }
  .kpi .lbl{ font-size:12px; color:var(--sub); }

  .preview{ border:1px dashed var(--border); border-radius:14px; padding:12px; background:#fff; }
  .sheet{
    width:100%;
    aspect-ratio: 210 / 297;
    border:1px solid var(--border);
    border-radius:14px;
    overflow:hidden;
    background:#fff;
    position:relative;
  }
  .cell{
    position:absolute;
    border:1px solid #000;
    display:flex;
    align-items:center;
    justify-content:center;
    font-family: "UD デジタル 教科書体 NK-R", "UD Digi Kyokasho NK-R", system-ui, sans-serif;
    color:#000;
  }
  .cell .num{
    position:absolute;
    top:4px; left:6px;
    font-size:12px;
    line-height:1;
  }
  .cell .kanji{
    font-size:140px;
    line-height:1;
  }
</style>
</head>
<body>
<header>
  <h1>CSV → A4分割 PowerPoint 生成（6/8切替）</h1>
  <div class="sub">
    CSVから「番号（列B）」と「漢字（列C）」を取り込み、A4縦の1枚を 6分割（2×3）または 8分割（2×4）して、PPTXを生成します。<br>
    ※オフラインで使う場合は、このHTMLと同じ場所に <span class="mono">pptxgen.bundle.js</span> を置いてください（自動でローカルを優先します）。
  </div>
</header>

<main class="grid">
  <section class="card">
    <div class="row" style="justify-content:space-between;">
      <div style="font-weight:800;">① CSV入力</div>
      <div class="row">
        <button class="btn ghost" id="btnSample">サンプル</button>
        <button class="btn danger" id="btnClear">クリア</button>
      </div>
    </div>
    <div class="hr"></div>

    <div class="row">
      <div class="field" style="min-width:260px;">
        <label>CSVファイルを選択</label>
        <input type="file" id="fileCsv" accept=".csv,text/csv" />
        <div class="hint">※ファイルを選ばない場合は下のテキスト欄に貼り付けでもOK</div>
      </div>
      <div class="field">
        <label>区切り（自動推定）</label>
        <select id="delimiter">
          <option value="auto" selected>自動（推奨）</option>
          <option value=",">カンマ（,）</option>
          <option value="\t">タブ</option>
          <option value=";">セミコロン（;）</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:6px;">
      <div class="field">
        <label>番号の列（0始まり）</label>
        <input type="number" id="colNum" min="0" step="1" value="1" />
        <div class="hint">既定：列B → 1</div>
      </div>
      <div class="field">
        <label>漢字の列（0始まり）</label>
        <input type="number" id="colKanji" min="0" step="1" value="2" />
        <div class="hint">既定：列C → 2</div>
      </div>
    </div>

    <div style="margin-top:10px;">
      <label>CSVテキスト（貼り付けOK）</label>
      <textarea id="csvText" placeholder="例：&#10;A,B,C&#10;1,雨天,雨&#10;2,火曜日,火&#10;..."></textarea>
      <div class="hint">
        ・空行は無視します<br>
        ・「、」が混ざっていても可能な範囲で掃除します<br>
      </div>
    </div>

    <div style="margin-top:12px;" class="row">
      <button class="btn secondary" id="btnParse">② 取り込み（プレビュー更新）</button>
      <div id="status" class="small"></div>
    </div>

    <div style="margin-top:12px;" class="kpi">
      <div class="box">
        <div class="num" id="kpiCount">0</div>
        <div class="lbl">レコード数</div>
      </div>
      <div class="box">
        <div class="num" id="kpiPerSlide">8</div>
        <div class="lbl">1枚あたり</div>
      </div>
      <div class="box">
        <div class="num" id="kpiSlides">0</div>
        <div class="lbl">スライド数</div>
      </div>
    </div>
  </section>

  <section class="card">
    <div style="font-weight:800;">③ 出力設定</div>
    <div class="hr"></div>

    <div class="row">
      <div class="field" style="max-width:220px;">
        <label>分割数</label>
        <select id="split">
          <option value="8" selected>8分割（2×4）</option>
          <option value="6">6分割（2×3）</option>
        </select>
        <div class="hint">← 分割は切り替え可能</div>
      </div>
      <div class="field" style="max-width:220px;">
        <label>枠線</label>
        <select id="border">
          <option value="on" selected>あり（黒）</option>
          <option value="off">なし</option>
        </select>
      </div>
      <div class="field">
        <label>フォント名（PPTXに指定する名前）</label>
        <input type="text" id="fontName" value="UD デジタル 教科書体 NK-R" />
      </div>
    </div>

    <div class="row" style="margin-top:6px;">
      <div class="field" style="max-width:220px;">
        <label>漢字サイズ（pt）</label>
        <input type="number" id="kanjiSize" min="10" max="240" step="1" value="140" />
        <div class="hint">← 自分で設定OK</div>
      </div>
      <div class="field" style="max-width:220px;">
        <label>番号サイズ（pt）</label>
        <input type="number" id="numSize" min="6" max="72" step="1" value="12" />
      </div>
      <div class="field" style="max-width:220px;">
        <label>文字色</label>
        <select id="fg">
          <option value="000000" selected>黒</option>
        </select>
      </div>
      <div class="field" style="max-width:220px;">
        <label>背景</label>
        <select id="bg">
          <option value="FFFFFF" selected>白</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:6px;">
      <div class="field">
        <label>出力ファイル名（.pptx）</label>
        <input type="text" id="outName" value="kanji_grid_A4.pptx" />
      </div>
    </div>

    <div style="margin-top:12px;">
      <div style="font-weight:800;">プレビュー（1枚目）</div>
      <div class="preview">
        <div class="sheet" id="sheetPreview"></div>
        <div class="hint" style="margin-top:8px;">
          A4縦の比率で簡易プレビューしています（実際のPPTXはA4縦サイズで出力）。
        </div>
      </div>
    </div>

    <div style="margin-top:12px;" class="row">
      <button class="btn" id="btnBuild">④ PPTXを生成して保存</button>
      <div class="small"><span class="mono">※ブラウザ内で生成します（サーバー不要）</span></div>
    </div>
    <div id="buildLog" class="small" style="margin-top:10px;"></div>
  </section>
</main>

<script>
(function loadPptxGen(){
  const tryLocal = document.createElement("script");
  tryLocal.src = "./pptxgen.bundle.js";
  tryLocal.onload = ()=>console.log("PptxGenJS: local loaded");
  tryLocal.onerror = ()=>{
    const cdn = document.createElement("script");
    cdn.src = "https://unpkg.com/pptxgenjs@3.12.0/dist/pptxgen.bundle.js";
    cdn.onload = ()=>console.log("PptxGenJS: CDN loaded");
    cdn.onerror = ()=>console.error("PptxGenJS load failed");
    document.body.appendChild(cdn);
  };
  document.body.appendChild(tryLocal);
})();
</script>

<script>
const $ = (id)=>document.getElementById(id);
let records = [];

function setStatus(msg, ok=true){
  const el = $("status");
  el.textContent = msg;
  el.className = ok ? "small ok" : "small err";
}

function normalizeCell(s){
  if(s == null) return "";
  let t = String(s).replace(/\u3000/g, " ").trim();
  t = t.replace(/[、,，。．]+$/g, "").trim();
  t = t.replace(/^[、,，。．]+/g, "").trim();
  return t;
}

function guessDelimiter(text){
  const sample = text.slice(0, 4000);
  const counts = [
    {d:"\t", c:(sample.match(/\t/g)||[]).length},
    {d:",",  c:(sample.match(/,/g)||[]).length},
    {d:";",  c:(sample.match(/;/g)||[]).length},
  ].sort((a,b)=>b.c-a.c);
  return counts[0].c > 0 ? counts[0].d : ",";
}

function parseCSVLoose(text, delimiter){
  const dlm = (delimiter === "auto") ? guessDelimiter(text) : delimiter;
  const lines = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n").split("\n");
  const out = [];
  for(const line0 of lines){
    const line = line0.trim();
    if(!line) continue;
    const unified = line.replace(/、/g, ",");
    const cells = unified.split(dlm).map(normalizeCell);
    if(cells.length === 0) continue;
    out.push(cells);
  }
  return out;
}

function computeSlidesCount(n, perSlide){
  return Math.ceil(n / perSlide);
}

function refreshKPIs(){
  const perSlide = Number($("split").value) || 8;
  $("kpiCount").textContent = String(records.length);
  $("kpiPerSlide").textContent = String(perSlide);
  $("kpiSlides").textContent = String(computeSlidesCount(records.length, perSlide));
}

function refreshPreview(){
  const wrap = $("sheetPreview");
  wrap.innerHTML = "";

  const split = Number($("split").value) || 8;
  const cols = 2;
  const rows = (split === 6) ? 3 : 4;

  const kanjiSize = Number($("kanjiSize").value) || 140;
  const numSize = Number($("numSize").value) || 12;

  const page = records.slice(0, split);

  for(let i=0;i<split;i++){
    const r = Math.floor(i / cols);
    const c = i % cols;

    const left = (c * 50);
    const top  = (r * (100/rows));
    const w    = 50;
    const h    = (100/rows);

    const cell = document.createElement("div");
    cell.className = "cell";
    cell.style.left = left + "%";
    cell.style.top  = top + "%";
    cell.style.width = w + "%";
    cell.style.height = h + "%";

    if($("border").value === "off"){
      cell.style.border = "0";
    }

    const rec = page[i] || {num:"", kanji:""};

    const n = document.createElement("div");
    n.className = "num";
    n.style.fontSize = numSize + "px";
    n.textContent = rec.num;

    const k = document.createElement("div");
    k.className = "kanji";
    k.style.fontSize = kanjiSize + "px";
    k.textContent = rec.kanji;

    cell.appendChild(n);
    cell.appendChild(k);
    wrap.appendChild(cell);
  }
}

async function readFileAsText(file){
  return new Promise((resolve, reject)=>{
    const fr = new FileReader();
    fr.onload = ()=>resolve(fr.result);
    fr.onerror = ()=>reject(fr.error);
    fr.readAsText(file);
  });
}

function parseAndUpdate(){
  const text = $("csvText").value || "";
  const delimiter = $("delimiter").value;
  const colNum = Math.max(0, Number($("colNum").value)||0);
  const colKanji = Math.max(0, Number($("colKanji").value)||0);

  const rows = parseCSVLoose(text, delimiter);

  const out = [];
  for(const cells of rows){
    const num = normalizeCell(cells[colNum] ?? "");
    const kanji = normalizeCell(cells[colKanji] ?? "");
    if(!num && !kanji) continue;
    out.push({num, kanji});
  }

  records = out;
  refreshKPIs();
  refreshPreview();

  if(out.length === 0){
    setStatus("レコードが見つかりませんでした（列番号/区切り/内容を確認してください）", false);
  }else{
    setStatus(`取り込みOK：${out.length}件`, true);
  }
}

async function buildPPTX(){
  if(!window.PptxGenJS) throw new Error("PptxGenJS が読み込めませんでした。オフラインの場合は pptxgen.bundle.js を同じフォルダに置いてください。");

  const split = Number($("split").value) || 8;
  const cols = 2;
  const rows = (split === 6) ? 3 : 4;

  const fontFace = ($("fontName").value || "UD デジタル 教科書体 NK-R").trim();
  const kanjiSize = Math.max(10, Math.min(240, Number($("kanjiSize").value)||140));
  const numSize = Math.max(6, Math.min(72, Number($("numSize").value)||12));
  const bg = $("bg").value;
  const fg = $("fg").value;
  const borderOn = ($("border").value === "on");

  const pptx = new PptxGenJS();

  const layoutName = "LAYOUT_A4P_827x1169";
  pptx.defineLayout({ name: layoutName, width: 8.27, height: 11.69 });
  pptx.layout = layoutName;

  const slideW = 8.27;
  const slideH = 11.69;

  const cellW = slideW / cols;
  const cellH = slideH / rows;

  const padX = 0.12;
  const padY = 0.12;

  for(let base=0; base<records.length; base += split){
    const page = records.slice(base, base+split);
    const slide = pptx.addSlide();
    slide.background = { color: bg };

    for(let i=0; i<split; i++){
      const rr = Math.floor(i / cols);
      const cc = i % cols;

      const x = cc * cellW;
      const y = rr * cellH;

      if(borderOn){
        slide.addShape(pptx.ShapeType.rect, {
          x, y, w: cellW, h: cellH,
          line: { color: "000000", width: 1 },
          fill: { color: bg, transparency: 100 }
        });
      }

      const rec = page[i] || {num:"", kanji:""};

      slide.addText(String(rec.num || ""), {
        x: x + padX,
        y: y + padY,
        w: Math.max(0.2, cellW - padX*2),
        h: 0.3,
        fontFace,
        fontSize: numSize,
        color: fg,
        align: "left",
        valign: "top",
      });

      slide.addText(String(rec.kanji || ""), {
        x, y, w: cellW, h: cellH,
        fontFace,
        fontSize: kanjiSize,
        color: fg,
        align: "center",
        valign: "mid",
      });
    }
  }

  const outNameRaw = ($("outName").value || "kanji_grid_A4.pptx").trim();
  const outName = outNameRaw.endsWith(".pptx") ? outNameRaw : (outNameRaw + ".pptx");

  await pptx.writeFile({ fileName: outName });
}

$("btnParse").addEventListener("click", parseAndUpdate);

$("btnClear").addEventListener("click", ()=>{
  $("csvText").value = "";
  records = [];
  refreshKPIs();
  refreshPreview();
  setStatus("クリアしました", true);
  $("buildLog").textContent = "";
});

$("btnSample").addEventListener("click", ()=>{
  $("csvText").value =
`A,B,C
1,雨天,雨
2,火曜日,火
3,休日,休
4,金よう日,金
5,空気,空
6,月よう日,月
7,手がみ,手
8,出じょう,出
9,森林,森`;
  parseAndUpdate();
});

$("fileCsv").addEventListener("change", async (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  try{
    const t = await readFileAsText(f);
    $("csvText").value = t;
    parseAndUpdate();
    setStatus(`ファイル読込OK：${f.name}`, true);
  }catch(err){
    console.error(err);
    setStatus("ファイルの読み込みに失敗しました", false);
  }
});

["split","border","fontName","kanjiSize","numSize"].forEach(id=>{
  $(id).addEventListener("input", ()=>{
    refreshKPIs();
    refreshPreview();
  });
});

$("btnBuild").addEventListener("click", async ()=>{
  $("buildLog").textContent = "";
  try{
    if(!records || records.length === 0){
      parseAndUpdate();
    }
    if(!records || records.length === 0){
      $("buildLog").innerHTML = `<span class="err">レコードが0件です。先に取り込みしてください。</span>`;
      return;
    }
    $("buildLog").innerHTML = `<span class="mono">PPTX生成中…</span>`;
    await buildPPTX();
    $("buildLog").innerHTML = `<span class="ok">保存が始まりました（ブラウザのダウンロードを確認してください）</span>`;
  }catch(err){
    console.error(err);
    $("buildLog").innerHTML = `<span class="err">生成に失敗しました：</span> <span class="mono">${String(err.message||err)}</span>`;
  }
});

refreshKPIs();
refreshPreview();
</script>
</body>
</html>
