<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç†Ÿèªã¥ãã‚Šã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼‰</title>
<style>
  :root{
    --bg1:#eef2ff; --bg2:#f3e8ff;
    --card:#ffffffd9;
    --ink:#111827; --sub:#4b5563;
    --primary:#4f46e5; --primarySoft:#e0e7ff;
    --ok:#16a34a; --ng:#dc2626;
    --border:#d1d5db;
    --shadow:0 10px 25px rgba(0,0,0,.08);
    --radius:18px;
    --sameTileSize: 110px;
  }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  body{
    margin:0; min-height:100vh; padding:16px;
    display:flex; justify-content:center; align-items:center;
    background:linear-gradient(135deg,var(--bg1),var(--bg2));
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Hiragino Kaku Gothic ProN","Yu Gothic","Meiryo",sans-serif;
    color:var(--ink);
  }
  .app{
    width:min(1080px,100%);
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
    position:relative;
  }
  header{
    padding:16px 18px;
    border-bottom:1px solid var(--border);
    display:flex; gap:12px; align-items:center; justify-content:space-between;
    background:linear-gradient(180deg,#ffffffcc,#ffffff99);
  }
  header h1{ margin:0; font-size:18px; letter-spacing:.02em; }
  .pill{
    font-size:12px; color:var(--sub);
    background:var(--primarySoft);
    border:1px solid #c7d2fe;
    padding:6px 10px;
    border-radius:999px;
    display:inline-flex; gap:8px; align-items:center;
    white-space:nowrap;
  }
  .wrap{ padding:16px 18px 18px; display:grid; gap:14px; }

  .grid{
    display:grid;
    grid-template-columns: 1.75fr .25fr;
    gap:14px;
  }
  @media (max-width:980px){
    .grid{ grid-template-columns:1fr; }
  }

  .card{
    background:#fff;
    border:1px solid var(--border);
    border-radius:16px;
    padding:14px;
  }
  .card h2{
    margin:0 0 10px 0;
    font-size:14px;
    color:var(--sub);
    font-weight:700;
    letter-spacing:.02em;
  }

  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .row > *{ flex:0 0 auto; }

  button{
    border:1px solid var(--border);
    background:#fff;
    color:var(--ink);
    border-radius:14px;
    padding:10px 12px;
    font-weight:700;
    cursor:pointer;
    box-shadow:0 6px 16px rgba(0,0,0,.06);
  }
  button.primary{
    background:var(--primary);
    border-color:var(--primary);
    color:#fff;
  }
  button.warn{
    background:#fff7ed;
    border-color:#fed7aa;
  }
  button:disabled{ opacity:.5; cursor:not-allowed; box-shadow:none; }
  select, input{
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px 12px;
    font-weight:700;
    background:#fff;
    color:var(--ink);
  }
  input{ width:110px; }

  .sectionTitle{
    margin:14px 0 8px 0;
    font-size:15px;
    font-weight:900;
    color:var(--ink);
  }

  .tiles{
    display:grid;
    grid-template-columns: repeat(7, minmax(0, 1fr));
    gap:10px;
  }
  @media (max-width:520px){ .tiles{ grid-template-columns: repeat(3, minmax(0, 1fr)); } }

  .tile{
    user-select:none;
    border:1px solid var(--border);
    border-radius:18px;
    background:#fff;
    padding:18px 0px;
    text-align:center;
    font-size:44px;
    font-weight:900;
    line-height:1;
    box-shadow:0 10px 22px rgba(0,0,0,.07);
    cursor:pointer;
    overflow:hidden;
  }

  .msg{
    margin-top:10px;
    padding:12px 14px;
    border-radius:16px;
    font-weight:900;
    font-size:16px;
    border:1px solid var(--border);
    background:#fff;
    color:var(--sub);
  }
  .msg.ok{ border-color:#bbf7d0; background:#ecfdf5; color:#166534; }
  .msg.ng{ border-color:#fecaca; background:#fff1f2; color:#991b1b; }

  .scoreboard{
    display:flex;
    gap:8px;
    flex-wrap:nowrap;
    align-items:stretch;
  }
  .pRow{
    flex:1 1 0;
    min-width:0;
    display:flex; gap:8px; align-items:flex-start; justify-content:space-between;
    padding:6px 10px;
    border:1px solid var(--border);
    border-radius:14px; background:#fff;
  }
  .pRow .left{
    display:flex; gap:8px; align-items:center; font-weight:900;
    min-width:0;
  }
  .pRow .left span:last-child{
    font-size:12px;
    white-space:nowrap;
  }
  .pRow .pts{
    font-weight:900; color:var(--ink);
    display:flex; gap:8px; align-items:center;
    white-space:nowrap;
    font-size:12px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .pRow .ptVal{ color:var(--ng); }
  .statusTag{
    display:block;
    margin-top:2px;
    font-size:11px;
    font-weight:900;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid #fecaca;
    background:#fff1f2;
    color:#991b1b;
    white-space:nowrap;
    flex: 1 0 100%;
    text-align:right;
  }
  .statusTag.miss{
    border-color:#fed7aa;
    background:#fff7ed;
    color:#9a3412;
  }

  .dot{ width:10px; height:10px; border-radius:999px; background:#cbd5e1; }
  .pRow.active{
    border-color:#a5b4fc;
    background:#eef2ff;
    animation:activePulse 980ms ease-in-out infinite;
  }
  .pRow.active .dot{
    background:#4f46e5;
    animation:dotPulse 980ms ease-in-out infinite;
  }
  @keyframes activePulse{
    0%{ box-shadow:0 0 0 rgba(79,70,229,.0); transform:translateY(0); }
    50%{ box-shadow:0 0 0 6px rgba(79,70,229,.14); transform:translateY(-1px); }
    100%{ box-shadow:0 0 0 rgba(79,70,229,.0); transform:translateY(0); }
  }
  @keyframes dotPulse{
    0%{ transform:scale(1); opacity:.75; }
    50%{ transform:scale(1.25); opacity:1; }
    100%{ transform:scale(1); opacity:.75; }
  }

  details{ border:1px solid var(--border); border-radius:14px; overflow:hidden; background:#fff; }
  summary{
    cursor:pointer; padding:10px 12px; font-weight:900; color:var(--sub);
    list-style:none;
  }
  summary::-webkit-details-marker{ display:none; }
  .list{ padding:0 12px 12px; display:flex; gap:8px; flex-wrap:wrap; }
  .tag{
    font-size:14px;
    font-weight:900;
    color:var(--ink);
    background:#f1f5e9;
    border:1px solid #e2e8f0;
    padding:8px 12px;
    border-radius:999px;
  }
  .muted{ color:var(--sub); }

  /* å³å´è¨­å®šï¼šæ”¹è¡Œã—ãªã„ */
  #rightSide .settingRow{ flex-wrap:nowrap; align-items:center; }
  #rightSide .settingRow label{ white-space:nowrap; flex:0 0 auto; }
  #rightSide .settingRow select,
  #rightSide .settingRow input{
    white-space:nowrap; flex:1 1 auto; min-width:0;
  }

  .drawPickGrid{
    display:grid;
    grid-template-columns: minmax(240px, 0.70fr) minmax(0, 1.30fr);
    gap:4px;
    align-items:start;
    margin-top:6px;
  }
  .drawPickCol{ min-width:0; }
  .drawPickCol .sectionTitle{ margin-top:0; }

  .pickPanel{
    display:flex; gap:12px; align-items:center;
    flex-wrap:nowrap;
    overflow:visible;
    background:#fff; border:1px solid var(--border);
    border-radius:18px; padding:14px;
    box-shadow:0 10px 22px rgba(0,0,0,.07);
    min-width:0;
  }

  .slotWrap{ display:flex; gap:8px; align-items:center; min-width:0; }
  .slotLabel{ font-size:14px; color:var(--sub); font-weight:900; }

  .slot{
    width:var(--sameTileSize); height:var(--sameTileSize);
    border-radius:18px;
    border:1px solid var(--border);
    background:#f8fafc;
    display:grid; place-items:center;
    font-size:44px; font-weight:900;
    cursor:pointer;
    user-select:none;
    overflow:hidden;
    flex:0 0 auto;
  }
  .slot.filled{ background:#fff; }

  .eq{ font-weight:900; color:var(--sub); font-size:20px; flex:0 0 auto; }

  .wordBox{
    min-width:120px;
    padding:14px 16px;
    border-radius:18px;
    border:1px solid var(--border);
    background:#fff;
    font-weight:900;
    font-size:28px;
    text-align:center;
    flex:1 1 auto;
    white-space:nowrap;
  }

  .chip{
    border:1px solid var(--border);
    background:#fff;
    border-radius:999px;
    padding:10px 14px;
    font-weight:900;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:10px;
    box-shadow:0 6px 16px rgba(0,0,0,.06);
  }
  .chip .mini{
    width:var(--sameTileSize); height:var(--sameTileSize);
    display:grid; place-items:center;
    border-radius:18px;
    border:1px solid var(--border);
    font-size:44px;
    font-weight:900;
    background:#f8fafc;
    line-height:1;
    overflow:hidden;
  }
  .chip:disabled{ opacity:.5; cursor:not-allowed; box-shadow:none; }

  .ansSpeakWrap{
    margin-top:10px;
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }
  .ansSpeakBtn{
    display:none;
    align-items:center;
    gap:8px;
    font-weight:900;
    border-color:#c7d2fe;
    background:#eef2ff;
  }
  .ansInfo{
    display:none;
    width:100%;
    padding:12px 14px;
    border-radius:16px;
    border:1px solid #c7d2fe;
    background:#eef2ff;
    font-weight:900;
    color:#111827;
    line-height:1.6;
  }
  .ansInfo .sub{ color:var(--sub); font-weight:900; }

  ruby rt{ font-size:10px; color:var(--sub); font-weight:900; }

  .settings{ display:grid; gap:10px; margin-bottom:10px; }
  .settingRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .settingRow label{ font-weight:900; }

  /* â˜…ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ¥ç¶šã‚«ãƒ¼ãƒ‰ */
  .onlineCard{
    border:1px dashed #c7d2fe;
    background:#eef2ff;
    border-radius:16px;
    padding:12px;
    display:grid;
    gap:8px;
  }
  .onlineRow{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .onlineRow input{ width:160px; }
  .tiny{ font-size:12px; color:var(--sub); font-weight:900; }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

  /* â˜…èª­ã¿ä¸Šã’ãƒœã‚¿ãƒ³ç¾¤ï¼ˆå³å´ï¼‰ */
  .ttsRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
  .ttsRow button{ font-size:12px; padding:10px 12px; }

  /* â˜…æ¼¢å­—ã‚¿ã‚¤ãƒ«å†…ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆèª­ã¿è¡¨ç¤ºONï¼‰ */
  .kWrap{ display:grid; gap:4px; align-items:center; justify-items:center; }
  .kOn,.kKun{ font-size:11px; font-weight:900; color:var(--sub); line-height:1.1; }
  .kCore{ font-size:44px; font-weight:900; line-height:1; }

  /* â˜…ãã™ç‰ */
  .kusudamaOverlay{
    position:absolute; inset:0;
    display:none;
    place-items:center;
    background:rgba(15,23,42,.38);
    z-index:9999;
  }
  .kusudamaBox{
    width:min(520px,92%);
    background:#fff;
    border:1px solid var(--border);
    border-radius:22px;
    box-shadow:0 20px 60px rgba(0,0,0,.25);
    padding:18px 16px;
    text-align:center;
    position:relative;
    overflow:hidden;
  }
  .kusudama{
    width:220px; height:120px;
    margin:8px auto 10px;
    position:relative;
  }
  .ball{
    position:absolute; top:0; width:110px; height:110px;
    border-radius:999px;
    border:2px solid #c7d2fe;
    background:linear-gradient(180deg,#eef2ff,#ffffff);
  }
  .ball.left{ left:0; transform-origin:right center; }
  .ball.right{ right:0; transform-origin:left center; }
  .kusudama.burst .ball.left{ animation:openL 450ms ease-out forwards; }
  .kusudama.burst .ball.right{ animation:openR 450ms ease-out forwards; }
  @keyframes openL{ to{ transform:rotate(-28deg) translateX(-10px); opacity:.96; } }
  @keyframes openR{ to{ transform:rotate(28deg) translateX(10px); opacity:.96; } }

  .banner{
    font-weight:1000;
    font-size:20px;
    padding:10px 12px;
    border-radius:16px;
    border:1px solid #c7d2fe;
    background:#eef2ff;
    display:inline-block;
  }
  .streamers{
    position:absolute; inset:0;
    pointer-events:none;
  }
  .streamer{
    position:absolute; top:-10px; left:50%;
    width:10px; height:140px;
    background:linear-gradient(180deg,#a5b4fc,#ffffff00);
    border-radius:999px;
    transform:translateX(-50%) rotate(var(--r)) translateX(var(--x));
    animation:fall 1200ms ease-out forwards;
    opacity:.9;
  }
  @keyframes fall{
    to{ transform:translateX(-50%) rotate(var(--r)) translateX(var(--x)) translateY(260px); opacity:0; }
  }
</style>
</head>

<body>
<div class="app" id="app">
  <header>
    <h1>ç†Ÿèªã¥ãã‚Šã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼‰</h1>
    <div class="pill" id="topPill">æœªæ¥ç¶š</div>
  </header>

  <div class="wrap">
    <div class="grid">

      <div class="card" id="leftPlay">
        <div class="scoreboard" id="scoreboard"></div>
        <div class="msg ok" id="winMsg" style="display:none;"></div>

        <div class="row" style="margin-bottom:12px; margin-top:12px;">
          <button class="primary" id="drawBtn">ï¼‘ã¾ã„å¼•ã</button>
          <button id="checkBtn">ã§ããŸï¼</button>
          <button id="endBtn"><ruby>ç•ª<rt>ã°ã‚“</rt></ruby>ã‚’<ruby>çµ‚<rt>ãŠ</rt></ruby>ãˆã‚‹</button>
          <button class="warn" id="skipNextBtn" style="display:none;">ã¤ãã¸</button>
          <button id="addFieldBtn" class="warn" style="display:none;">
            <ruby>å ´æœ­<rt>ã°ãµã </rt></ruby>ã‚’<ruby>è¿½åŠ <rt>ã¤ã„ã‹</rt></ruby>ã™ã‚‹
          </button>
        </div>

        <div class="sectionTitle"><ruby>å ´æœ­<rt>ã°ãµã </rt></ruby></div>
        <div class="tiles" id="field"></div>

        <div class="drawPickGrid">
          <div class="drawPickCol">
            <div class="sectionTitle"><ruby>å¼•<rt>ã²</rt></ruby>ã„ãŸ<ruby>æœ­<rt>ãµã </rt></ruby>ï¼ˆã‚¿ãƒƒãƒ—ã§â‘ â‘¡ã¸ï¼‰</div>
            <div class="row" style="gap:10px; margin-bottom:10px;">
              <button class="chip" id="drawChip" type="button" disabled>
                <span class="muted"><ruby>å¼•æœ­<rt>ã²ããµã </rt></ruby></span>
                <span class="mini" id="drawMini">â€”</span>
                <span class="muted">â†’â‘ â‘¡</span>
              </button>
            </div>
          </div>

          <div class="drawPickCol">
            <div class="sectionTitle"><ruby>é †ç•ª<rt>ã˜ã‚…ã‚“ã°ã‚“</rt></ruby>ã‚’<ruby>æ±º<rt>ã</rt></ruby>ã‚ã¦<ruby>ä½œ<rt>ã¤ã</rt></ruby>ã‚‹</div>
            <div class="pickPanel">
              <div class="slotWrap">
                <div class="slotLabel">â‘ </div>
                <div class="slot" id="slot1" title="ã‚¿ãƒƒãƒ—ã§æ¶ˆã™">â€”</div>
              </div>
              <div class="eq">â†’</div>
              <div class="slotWrap">
                <div class="slotLabel">â‘¡</div>
                <div class="slot" id="slot2" title="ã‚¿ãƒƒãƒ—ã§æ¶ˆã™">â€”</div>
              </div>
              <div class="eq">=</div>
              <div class="wordBox" id="wordBox">â€”</div>
            </div>
          </div>
        </div>

        <div class="msg" id="msg">å³ã®ã€Œãƒ«ãƒ¼ãƒ ä½œæˆ / å‚åŠ ã€ã§ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ¥ç¶šã—ã¦ã­ã€‚</div>

        <div class="ansSpeakWrap" id="ansSpeakWrap">
          <button class="ansSpeakBtn" id="ansSpeakBtn" type="button" aria-label="æ­£ç­”ã®èª­ã¿ã¨æ„å‘³ã‚’ã‚ˆã¿ã‚ã’">
            ğŸ”Š ã‚ˆã¿ãƒ»ã„ã¿ãƒ»ã‚Œã„ã¶ã‚“
          </button>
          <div class="ansInfo" id="ansInfo" aria-live="polite"></div>
        </div>

        <details style="margin-top:12px;" open>
          <summary><ruby>ã§ããŸ</ruby>ã˜ã‚…ã<ruby>èª<rt>ã”</rt></ruby>ï¼ˆ<ruby>åŒ<rt>ãŠãª</rt></ruby>ã˜<ruby>ç†Ÿèª<rt>ã˜ã‚…ãã”</rt></ruby>ã¯1<ruby>å›<rt>ã‹ã„</rt></ruby>ã¾ã§ï¼‰</summary>
          <div class="list" id="madeList"></div>
        </details>
      </div>

      <div class="card" id="rightSide">

        <!-- â˜…ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ¥ç¶š -->
        <div class="onlineCard">
          <div class="onlineRow">
            <button class="primary" id="createRoomBtn" type="button">ãƒ«ãƒ¼ãƒ ä½œæˆ</button>
            <input id="roomIdInput" class="mono" placeholder="ãƒ«ãƒ¼ãƒ ID" />
            <button id="joinRoomBtn" type="button">å‚åŠ </button>
          </div>
          <div class="tiny">
            ã‚ãªãŸã®IDï¼š<span id="myIdText" class="mono">---</span><br>
            ãƒ«ãƒ¼ãƒ ï¼š<span id="roomText" class="mono">æœªæ¥ç¶š</span> ï¼ åº§å¸­ï¼š<span id="seatText" class="mono">---</span>
          </div>
          <div class="tiny" id="onlineHint">
            â€» ãƒ«ãƒ¼ãƒ«ï¼š<b>è‡ªåˆ†ã®ç•ªã®äººã ã‘</b>æ“ä½œã§ãã¾ã™ï¼ˆç›¸æ‰‹ã¯ç”»é¢ãŒåŒæœŸã•ã‚Œã‚‹ã ã‘ï¼‰ã€‚
          </div>
        </div>

        <div class="settings" style="margin-top:10px;">
          <div class="settingRow">
            <label class="muted">å‡ºé¡Œ</label>
            <select id="gradeSelect" title="å‡ºé¡Œã™ã‚‹æ¼¢å­—">
              <option value="g1">1å¹´ã®æ¼¢å­—</option>
              <option value="g2">2å¹´ã®æ¼¢å­—</option>
              <option value="g12">1ï¼Œ2å¹´ã®æ¼¢å­—</option>
              <option value="g3">3å¹´ã®æ¼¢å­—</option>
              <option value="g123">1ãƒ»2ãƒ»3å¹´ã®æ¼¢å­—</option>
            </select>
          </div>

          <div class="settingRow">
            <label class="muted">èª­ã¿è¡¨ç¤º</label>
            <select id="readingToggle" title="éŸ³èª­ã¿ãƒ»è¨“èª­ã¿ã®è¡¨ç¤º">
              <option value="on" selected>ã‚ã‚‹</option>
              <option value="off">ãªã—</option>
            </select>
          </div>

          <div class="settingRow">
            <label class="muted">å‹åˆ©ãƒã‚¤ãƒ³ãƒˆ</label>
            <input id="targetPoints" type="number" min="1" step="1" value="5"/>
          </div>

          <div class="settingRow">
            <label class="muted">ãƒŸã‚¹ã§ä¼‘ã¿</label>
            <select id="missLimit" title="ã“ã®å›æ•°ã€Œãã®è¨€è‘‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€ã§1å›ä¼‘ã¿">
              <option value="2">2å›</option>
              <option value="3" selected>3å›</option>
              <option value="4">4å›</option>
              <option value="5">5å›</option>
              <option value="6">6å›</option>
              <option value="7">7å›</option>
              <option value="8">8å›</option>
            </select>
          </div>

          <div class="settingRow" style="flex-direction:column; align-items:flex-start;">
            <button class="primary" id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            <button id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
        </div>

        <details id="rules" style="margin-top:12px;">
          <summary><ruby>éŠã³æ–¹<rt>ã‚ãã³ã‹ãŸ</rt></ruby></summary>
          <div id="ruleText" style="padding:10px 12px 12px; color:var(--sub); font-weight:800; line-height:1.75;">
            <div>ãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼šåŒã˜ãƒ«ãƒ¼ãƒ IDã«å…¥ã£ãŸ2äººã§å¯¾æˆ¦ã—ã¾ã™ã€‚</div>
            <div>ãƒ»è‡ªåˆ†ã®ç•ªã®äººã ã‘æ“ä½œã§ãã¾ã™ï¼ˆç›¸æ‰‹ã¯åŒæœŸè¡¨ç¤ºï¼‰ã€‚</div>
            <div>ãƒ»ã‚¹ã‚¿ãƒ¼ãƒˆã¯ãƒ«ãƒ¼ãƒ å†…ã§ã©ã¡ã‚‰ã‹ãŒæŠ¼ã›ã¾ã™ï¼ˆè¨­å®šã¯æŠ¼ã—ãŸäººã®ã‚‚ã®ãŒåæ˜ ï¼‰ã€‚</div>

            <!-- â˜…èª­ã¿ä¸Šã’ãƒœã‚¿ãƒ³ï¼ˆä¸è¶³ã—ã¦ãŸã®ã§è¿½åŠ ï¼‰ -->
            <div class="ttsRow">
              <button id="speakBtn" type="button">ğŸ”Š éŠã³æ–¹ã‚’ã‚ˆã‚€</button>
              <button id="stopSpeakBtn" type="button">â¹ ã¨ã‚ã‚‹</button>
            </div>
          </div>
        </details>

      </div>
    </div>
  </div>

  <!-- â˜…ãã™ç‰ï¼ˆä¸è¶³ã—ã¦ãŸã®ã§è¿½åŠ ï¼‰ -->
  <div class="kusudamaOverlay" id="kusudamaOverlay" aria-hidden="true">
    <div class="kusudamaBox">
      <div class="banner" id="kusudamaBanner">å‹ã¡ï¼</div>
      <div class="kusudama" id="kusudama">
        <div class="ball left"></div>
        <div class="ball right"></div>
      </div>
      <div class="streamers" id="streamers"></div>
      <div style="font-weight:900; color:var(--sub); font-size:12px;">ï¼ˆè‡ªå‹•ã§é–‰ã˜ã¾ã™ï¼‰</div>
    </div>
  </div>
</div>

<script type="module">
/* ===============================
   Firebaseï¼ˆv9 modular / CDNï¼‰
=============================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import {
  getDatabase, ref, set, get, onValue,
  runTransaction, serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

/* â˜…ã‚ãªãŸã®Firebaseè¨­å®šï¼ˆãã®ã¾ã¾åæ˜ ï¼‰ */
const firebaseConfig = {
  apiKey: "AIzaSyDGyfFnmlFjJNyj8gyHcNje0SowgtTjDyU",
  authDomain: "jyukugo-battle.firebaseapp.com",
  databaseURL: "https://jyukugo-battle-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "jyukugo-battle",
  storageBucket: "jyukugo-battle.firebasestorage.app",
  messagingSenderId: "15379559721",
  appId: "1:15379559721:web:9776dfdf39b4a38a047338"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ===============================
   DOM
=============================== */
const el = (id)=>document.getElementById(id);
const topPill = el("topPill");
const msgEl = el("msg");

const createRoomBtn = el("createRoomBtn");
const joinRoomBtn = el("joinRoomBtn");
const roomIdInput = el("roomIdInput");
const myIdText = el("myIdText");
const roomText = el("roomText");
const seatText = el("seatText");

const drawBtn = el("drawBtn");
const checkBtn = el("checkBtn");
const endBtn = el("endBtn");
const skipNextBtn = el("skipNextBtn");
const addFieldBtn = el("addFieldBtn");

const gradeSelect = el("gradeSelect");
const readingToggle = el("readingToggle");
const targetPointsInp = el("targetPoints");
const missLimitSel = el("missLimit");
const startBtn = el("startBtn");
const resetBtn = el("resetBtn");

const fieldEl = el("field");
const scoreboardEl = el("scoreboard");
const madeListEl = el("madeList");
const winMsgEl = el("winMsg");

const drawChip = el("drawChip");
const drawMini = el("drawMini");
const slot1El = el("slot1");
const slot2El = el("slot2");
const wordBox = el("wordBox");

const ansSpeakBtn = el("ansSpeakBtn");
const ansInfo = el("ansInfo");

const speakBtn = el("speakBtn");
const stopSpeakBtn = el("stopSpeakBtn");

const kusudamaOverlay = el("kusudamaOverlay");
const kusudama = el("kusudama");
const streamers = el("streamers");
const kusudamaBanner = el("kusudamaBanner");

function setMsg(text, kind=""){
  msgEl.classList.remove("ok","ng");
  if(kind) msgEl.classList.add(kind);
  msgEl.textContent = text;
}
function setTop(text){ topPill.textContent = text; }

/* ===============================
   ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼šã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDï¼ˆAuthãªã—ï¼‰
=============================== */
function getOrMakeClientId(){
  const k="jyukugo_clientId_v1";
  let v = localStorage.getItem(k);
  if(!v){
    v = "c_" + Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(-4);
    localStorage.setItem(k, v);
  }
  return v;
}
const myId = getOrMakeClientId();
myIdText.textContent = myId;

/* ===============================
   ãƒ«ãƒ¼ãƒ çŠ¶æ…‹
=============================== */
let roomId = null;
let seatIndex = -1;     // 0 or 1
let unsub = null;

function roomRef(id){ return ref(db, `rooms/${id}`); }
function stateRef(id){ return ref(db, `rooms/${id}/state`); }

/* â˜…åˆæœŸState */
function makeInitialState(){
  return {
    ver: 1,
    createdAt: serverTimestamp(),
    settings: {
      gradeKey: gradeSelect.value,
      showReadings: (readingToggle.value === "on"),
      targetPoints: Math.max(1, Number(targetPointsInp.value)||5),
      missLimit: Number(missLimitSel.value)||3
    },
    players: [
      { seat:0, clientId:null, points:0, skipNext:false },
      { seat:1, clientId:null, points:0, skipNext:false }
    ],
    started: false,
    current: 0,
    deck: [],
    field: [],
    drewThisTurn: false,
    drawnKanji: null,
    missThisTurn: 0,
    slot1: null,
    slot2: null,
    made: [],
    holdAdvance: false,
    lastMsg: "ãƒ«ãƒ¼ãƒ ã«å‚åŠ ã—ã¾ã—ãŸã€‚ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã™ã¨é–‹å§‹ã—ã¾ã™ã€‚"
  };
}

/* ===============================
   ãƒ«ãƒ¼ãƒ ä½œæˆ / å‚åŠ 
=============================== */
function makeRoomId(){
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let s="";
  for(let i=0;i<6;i++) s += chars[Math.floor(Math.random()*chars.length)];
  return s;
}

async function createRoom(){
  const id = makeRoomId();
  const st = makeInitialState();
  st.players[0].clientId = myId;

  await set(roomRef(id), {
    createdAt: serverTimestamp(),
    state: st
  });

  await connectRoom(id);
}

async function joinRoom(id){
  const snap = await get(roomRef(id));
  if(!snap.exists()){
    setMsg("ãã®ãƒ«ãƒ¼ãƒ IDã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚","ng");
    return;
  }
  await connectRoom(id);
}

async function connectRoom(id){
  roomId = id;
  roomText.textContent = id;
  setTop("æ¥ç¶šä¸­â€¦");

  const stRef = stateRef(id);
  const result = await runTransaction(stRef, (cur)=>{
    if(!cur) return cur;

    const alreadySeat = (cur.players||[]).findIndex(p=>p && p.clientId === myId);
    if(alreadySeat >= 0) return cur;

    const players = cur.players || [];
    const empty = players.findIndex(p=>p && !p.clientId);
    if(empty < 0) return cur;

    players[empty] = { ...(players[empty]||{}), seat: empty, clientId: myId, points: players[empty]?.points||0, skipNext: !!players[empty]?.skipNext };
    cur.players = players;
    cur.lastMsg = "ç›¸æ‰‹ã®å‚åŠ ã‚’å¾…ã£ã¦ã„ã¾ã™â€¦";
    return cur;
  });

  const val = result.snapshot.val();
  if(!val){
    setMsg("æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚","ng");
    setTop("æœªæ¥ç¶š");
    return;
  }

  const idx = (val.players||[]).findIndex(p=>p && p.clientId === myId);
  if(idx < 0){
    setMsg("æº€å“¡ã§ã™ï¼ˆ2äººã¾ã§ï¼‰ã€‚åˆ¥ã®ãƒ«ãƒ¼ãƒ ã‚’ä½œã£ã¦ãã ã•ã„ã€‚","ng");
    setTop("æº€å“¡");
    seatIndex = -1;
    seatText.textContent = "---";
    return;
  }

  seatIndex = idx;
  seatText.textContent = String(seatIndex+1);
  setTop("æ¥ç¶šOK");

  if(unsub) unsub();
  unsub = onValue(stRef, (snap2)=>{
    const st = snap2.val();
    if(!st) return;
    applyRemoteState(st);
  });

  setMsg("æ¥ç¶šã—ã¾ã—ãŸã€‚ç›¸æ‰‹ã«ã‚‚åŒã˜ãƒ«ãƒ¼ãƒ IDã‚’ä¼ãˆã¦å‚åŠ ã—ã¦ã‚‚ã‚‰ã£ã¦ã­ã€‚","ok");
}

/* ===============================
   å…±é€š
=============================== */
let remoteState = null;

function isMyTurn(st){
  const cur = st?.current ?? 0;
  const p = (st.players||[])[cur];
  return !!(p && p.clientId === myId);
}
function bothJoined(st){
  const ps = st.players||[];
  return ps.length>=2 && ps[0]?.clientId && ps[1]?.clientId;
}
function canActNow(st){
  return !!(roomId && st && st.started && bothJoined(st) && isMyTurn(st) && !st.holdAdvance);
}

/* ===============================
   ãƒ‡ãƒ¼ã‚¿
=============================== */
const KANJI_READINGS = {
  "éŸ³": { on:"ã‚ªãƒ³", kun:"ãŠã¨ãƒ»ã­" },
  "ä¸‹": { on:"ã‚«ãƒ»ã‚²", kun:"ã—ãŸãƒ»ã—ã‚‚ãƒ»ã•ï¼ˆã’ã‚‹ï¼‰ãƒ»ãã ï¼ˆã‚‹ï¼‰ãƒ»ãŠï¼ˆã‚Šã‚‹ï¼‰" },
  "ç«": { on:"ã‚«", kun:"ã²" },
  "å­¦": { on:"ã‚¬ã‚¯", kun:"ã¾ãªï¼ˆã¶ï¼‰" },
  "æ°—": { on:"ã‚­ãƒ»ã‚±", kun:"" },
  "é‡‘": { on:"ã‚­ãƒ³ãƒ»ã‚³ãƒ³", kun:"ã‹ã­ãƒ»ã‹ãª" },
  "ç©º": { on:"ã‚¯ã‚¦", kun:"ãã‚‰ãƒ»ã‚ï¼ˆãï¼‰ãƒ»ã‹ã‚‰" },
  "æœˆ": { on:"ã‚²ãƒ„ãƒ»ã‚¬ãƒ„", kun:"ã¤ã" },
  "è¦‹": { on:"ã‚±ãƒ³", kun:"ã¿ï¼ˆã‚‹ï¼‰" },
  "å£": { on:"ã‚³ã‚¦ãƒ»ã‚¯", kun:"ãã¡" },
  "å±±": { on:"ã‚µãƒ³", kun:"ã‚„ã¾" },
  "è»Š": { on:"ã‚·ãƒ£", kun:"ãã‚‹ã¾" },
  "æ‰‹": { on:"ã‚·ãƒ¥", kun:"ã¦" },
  "å‡º": { on:"ã‚·ãƒ¥ãƒ„", kun:"ã§ï¼ˆã‚‹ï¼‰ãƒ»ã ï¼ˆã™ï¼‰" },
  "å°": { on:"ã‚·ãƒ§ã‚¦", kun:"ã¡ã„ï¼ˆã•ã„ï¼‰ãƒ»ã“ãƒ»ãŠ" },
  "ä¸Š": { on:"ã‚¸ãƒ§ã‚¦", kun:"ã†ãˆãƒ»ã†ã‚ãƒ»ã‹ã¿ãƒ»ã‚ï¼ˆã’ã‚‹ï¼‰ãƒ»ã®ã¼ï¼ˆã‚‹ï¼‰" },
  "äºº": { on:"ã‚¸ãƒ³ãƒ»ãƒ‹ãƒ³", kun:"ã²ã¨" },
  "æ°´": { on:"ã‚¹ã‚¤", kun:"ã¿ãš" },
  "ç”Ÿ": { on:"ã‚»ã‚¤ãƒ»ã‚·ãƒ§ã‚¦", kun:"ã„ï¼ˆãã‚‹ï¼‰ãƒ»ã†ï¼ˆã‚€ï¼‰ãƒ»ã¯ï¼ˆãˆã‚‹ï¼‰ãƒ»ãªã¾" },
  "å…ˆ": { on:"ã‚»ãƒ³", kun:"ã•ã" },
  "è¶³": { on:"ã‚½ã‚¯", kun:"ã‚ã—ãƒ»ãŸï¼ˆã™ï¼‰" },
  "å¤§": { on:"ãƒ€ã‚¤ãƒ»ã‚¿ã‚¤", kun:"ãŠãŠï¼ˆãã„ï¼‰" },
  "ä¸­": { on:"ãƒãƒ¥ã‚¦ãƒ»ã‚¸ãƒ¥ã‚¦", kun:"ãªã‹" },
  "å¤©": { on:"ãƒ†ãƒ³", kun:"ã‚ã¾" },
  "æ—¥": { on:"ãƒ‹ãƒãƒ»ã‚¸ãƒ„", kun:"ã²ãƒ»ã‹" },
  "å…¥": { on:"ãƒ‹ãƒ¥ã‚¦", kun:"ã„ï¼ˆã‚Œã‚‹ï¼‰ãƒ»ã¯ã„ï¼ˆã‚‹ï¼‰" },
  "å¹´": { on:"ãƒãƒ³", kun:"ã¨ã—" },
  "æ–‡": { on:"ãƒ–ãƒ³ãƒ»ãƒ¢ãƒ³", kun:"ãµã¿" },
  "æœ¬": { on:"ãƒ›ãƒ³", kun:"ã‚‚ã¨" },
  "å": { on:"ãƒ¡ã‚¤ãƒ»ãƒŸãƒ§ã‚¦", kun:"ãª" },
  "ç›®": { on:"ãƒ¢ã‚¯", kun:"ã‚" },
  "åŠ›": { on:"ãƒªãƒ§ã‚¯ãƒ»ãƒªã‚­", kun:"ã¡ã‹ã‚‰" }
};

const KANJI_BY_GRADE = {
  g1: ["éŸ³","ä¸‹","ç«","å­¦","æ°—","é‡‘","ç©º","æœˆ","è¦‹","å£","å±±","è»Š","æ‰‹","å‡º","å°","ä¸Š","äºº","æ°´","ç”Ÿ","å…ˆ","è¶³","å¤§","ä¸­","å¤©","æ—¥","å…¥","å¹´","æ–‡","æœ¬","å","ç›®","åŠ›"],
  g2: ["å®¶","ä¼š","æµ·","å¤–","å…ƒ","è¨€","åŸ","å¾Œ","è¡Œ","å›½","ä½œ","æ›¸","å ´","é£Ÿ","å¿ƒ","æ–°","æ•°","å‰","ä½“","åœ°","é•·","ç›´","é€š","å½“","é ­","é“","å†…","é¢¨","åˆ†","æ–¹","é–€","å¤œ","é‡","ç”¨","æ¥"],
  g3: ["æ‚ª","æ„","é‹","åŒ–","é–‹","æ„Ÿ","æœŸ","æ¥­","å±€","äº‹","å®Ÿ","æ‰€","èº«","é€²","å…¨","ä»£","ç€","å®š","è»¢","å‹•","é…","ç™º","ç­†","å“","éƒ¨","ç‰©","å¹³","å‘½","é¢","æ´‹","æµ","è·¯","å’Œ"]
};
KANJI_BY_GRADE.g12 = [...KANJI_BY_GRADE.g1, ...KANJI_BY_GRADE.g2];
KANJI_BY_GRADE.g123 = [...KANJI_BY_GRADE.g1, ...KANJI_BY_GRADE.g2, ...KANJI_BY_GRADE.g3];

/* ===== ç†ŸèªDB ===== */
const JUKUGO_TSV = `
éŸ³æ„Ÿ	ãŠã‚“ã‹ã‚“	éŸ³ã®é«˜ã„ãƒ»ä½ã„ãªã©ã®ã¡ãŒã„ã‚’èãåˆ†ã‘ã‚‹åŠ›	éŸ³æ„ŸãŒã‚ˆã„äººã¯éŸ³ã®ã¡ãŒã„ã«ã™ãæ°—ã¥ãã¾ã™
éŸ³é ­	ãŠã‚“ã©	ã¿ã‚“ãªã§æ­Œã£ãŸã‚ŠãŠã©ã£ãŸã‚Šã™ã‚‹ã¨ãã®æ­Œã‚„èª¿å­	å…ˆç”ŸãŒéŸ³é ­ã‚’ã¨ã£ã¦ã¿ã‚“ãªã§æ‰‹ã‚’ãŸãŸãã¾ã—ãŸ
è¶³éŸ³	ã‚ã—ãŠã¨	äººã‚„å‹•ç‰©ãŒæ­©ã„ãŸã¨ãã«å‡ºã‚‹éŸ³	ã‚ã†ä¸‹ã§è¶³éŸ³ãŒã—ã¦ã ã‚Œã‹æ¥ãŸã¨åˆ†ã‹ã‚Šã¾ã—ãŸ
å¿ƒéŸ³	ã—ã‚“ãŠã‚“	å¿ƒãã†ãŒå‹•ãã¨ãã«å‡ºã‚‹éŸ³	ç—…é™¢ã§å¿ƒéŸ³ã‚’èã„ã¦ã‚‚ã‚‰ã„ã¾ã—ãŸ
å…¨éŸ³	ãœã‚“ãŠã‚“	éŸ³ã¨éŸ³ã®é–“ãŒã€ŒåŠéŸ³2ã¤åˆ†ã€ã‚ã„ã¦ã„ã‚‹ã“ã¨ï¼ˆéŸ³ã®é–“ã®åºƒã•ï¼‰	ãƒ”ã‚¢ãƒã§ãƒ‰ã‹ã‚‰ãƒ¬ã¯å…¨éŸ³ã§ã™ã€‚
é•·éŸ³	ã¡ã‚‡ã†ãŠã‚“	å£°ã‚„éŸ³ã‚’é•·ãã®ã°ã—ã¦å‡ºã™éŸ³	ãŠçˆ¶ã•ã‚“ã®ã€Œã¨ã†ã€ã¯é•·éŸ³ã§ã™
ç™ºéŸ³	ã¯ã¤ãŠã‚“	è¨€è‘‰ã®éŸ³ã‚’å£°ã«å‡ºã™ã“ã¨	è‹±èªã®ç™ºéŸ³ã‚’ã‚Œã‚“ã—ã‚…ã†ã—ã¾ã™
æœ¬éŸ³	ã»ã‚“ã­	å¿ƒã®ä¸­ã§æœ¬å½“ã«æ€ã£ã¦ã„ã‚‹ã“ã¨	æœ¬éŸ³ã‚’è¨€ã†ã¨ã€å®¿é¡Œã¯ã‚„ã‚ŠãŸããªã„ã§ã™ã€‚
ç‰©éŸ³	ã‚‚ã®ãŠã¨	ç‰©ãŒå‹•ã„ãŸã‚Šå½“ãŸã£ãŸã‚Šã—ã¦å‡ºã‚‹éŸ³	å¤œã«ç‰©éŸ³ãŒã—ã¦ç›®ãŒã•ã‚ã¾ã—ãŸ
å’ŒéŸ³	ã‚ãŠã‚“	ã„ãã¤ã‹ã®éŸ³ã‚’åŒæ™‚ã«é³´ã‚‰ã—ãŸéŸ³	ãƒ”ã‚¢ãƒã§å’ŒéŸ³ã‚’ã²ãã¨ãã‚Œã„ã«ã²ã³ãã¾ã™
ä¸‹éƒ¨	ã‹ã¶	å…¨ä½“ã®ä¸­ã§ä¸‹ã®ã»ã†ã®éƒ¨åˆ†	é»’æ¿ã®ä¸‹éƒ¨ã«ä»Šæ—¥ã®å®¿é¡Œã‚’æ›¸ãã¾ã—ãŸ
ä¸‹æµ	ã‹ã‚Šã‚…ã†	å·ã®æµã‚Œã§ä¸‹ã®ã»ã†ï¼ˆæµ·ã«è¿‘ã„ã»ã†ï¼‰	å·ã®ä¸‹æµã«ã¯åºƒã„å·åŸãŒã‚ã‚Šã¾ã™
ä¸‹å±±	ã’ã–ã‚“	å±±ã‹ã‚‰ä¸‹ã‚Šã‚‹ã“ã¨	æš—ããªã‚‹å‰ã«ä¸‹å±±ã—ã¾ã—ãŸ
ä¸‹è»Š	ã’ã—ã‚ƒ	æ¬¡ã®ãˆãã§é›»è»Šã‚„ãƒã‚¹ã‹ã‚‰ãŠã‚Šã‚‹ã“ã¨	æ¬¡ã®é§…ã§ä¸‹è»Šã—ã¦ãã ã•ã„
`.trim();

function buildJukugoDB(tsv){
  const db = Object.create(null);
  const lines = String(tsv||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  for(const line of lines){
    const parts = line.split("\t");
    if(parts.length < 2) continue;
    const k = (parts[0]||"").trim();
    const y = (parts[1]||"").trim();
    const imi = (parts[2]||"").trim();
    const rei = (parts[3]||"").trim();
    if(!k) continue;
    if(!db[k]) db[k] = { yomi:y, imi:imi, reibun:rei };
  }
  return db;
}
const JUKUGO_DB = buildJukugoDB(JUKUGO_TSV);
const ANSWER_SET = new Set(Object.keys(JUKUGO_DB));

/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (c)=>( {
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c] ));
}
function formatReadingLines(s){
  const t = String(s || "").trim();
  if(!t) return "";
  const parts = t.split("ãƒ»").map(x=>x.trim()).filter(Boolean);
  if(parts.length <= 1) return escapeHtml(t);
  return parts.map(escapeHtml).join("ãƒ»<br>");
}
function kanjiHtml(k, showReadings){
  if(!showReadings) return escapeHtml(k);
  const r = KANJI_READINGS[k] || { on:"", kun:"" };
  const on = r.on ? formatReadingLines(r.on) : "";
  const kun = r.kun ? formatReadingLines(r.kun) : "";
  return (
    `<div class="kWrap">` +
      `<div class="kOn">${on}</div>` +
      `<div class="kCore">${escapeHtml(k)}</div>` +
      `<div class="kKun">${kun}</div>` +
    `</div>`
  );
}
async function txUpdate(updater){
  if(!roomId) return;
  const stRef = stateRef(roomId);
  return runTransaction(stRef, (cur)=>{
    if(!cur) return cur;
    return updater(cur) || cur;
  });
}
function firstEmptySlot(st){
  if(!st.slot1) return 1;
  if(!st.slot2) return 2;
  return 0;
}
function buildDeckForGrade(gradeKey){
  const pool = KANJI_BY_GRADE[gradeKey] || KANJI_BY_GRADE.g1;
  return shuffle([...pool]);
}

/* ===============================
   UIæç”»
=============================== */
function renderScoreboardFromState(st){
  scoreboardEl.innerHTML = "";
  const ps = st.players || [];
  for(let i=0;i<2;i++){
    const p = ps[i] || { points:0, skipNext:false, clientId:null };
    const row = document.createElement("div");
    row.className = "pRow" + ((st.started && (st.current===i)) ? " active":"");

    const left = document.createElement("div");
    left.className = "left";
    const dot = document.createElement("span"); dot.className="dot";
    const name = document.createElement("span");
    name.textContent = `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i+1}`;
    left.appendChild(dot);
    left.appendChild(name);

    const pts = document.createElement("div");
    pts.className="pts";
    const pt = document.createElement("span");
    pt.className="ptVal";
    pt.textContent = `${p.points||0} pt`;
    pts.appendChild(pt);

    if(!p.clientId){
      const stg = document.createElement("span");
      stg.className="statusTag miss";
      stg.textContent = "æœªå‚åŠ ";
      pts.appendChild(stg);
    }else if(p.clientId===myId){
      const stg = document.createElement("span");
      stg.className="statusTag miss";
      stg.textContent = "ã‚ãªãŸ";
      pts.appendChild(stg);
    }
    if(!!p.skipNext){
      const stg2 = document.createElement("span");
      stg2.className="statusTag";
      stg2.textContent = "æ¬¡ä¼‘ã¿";
      pts.appendChild(stg2);
    }

    row.appendChild(left);
    row.appendChild(pts);
    scoreboardEl.appendChild(row);
  }
}

function renderBoardFromState(st){
  const showReadings = !!st.settings?.showReadings;

  fieldEl.innerHTML = "";
  (st.field||[]).forEach((k, idx)=>{
    const d = document.createElement("div");
    d.className = "tile";
    d.dataset.idx = String(idx);
    d.innerHTML = kanjiHtml(k, showReadings);
    d.onclick = ()=> onPickFieldOnline(idx);
    fieldEl.appendChild(d);
  });

  if(st.drawnKanji){
    drawMini.innerHTML = kanjiHtml(st.drawnKanji, showReadings);
    drawChip.disabled = !canActNow(st);
  }else{
    drawMini.textContent = "â€”";
    drawChip.disabled = true;
  }

  if(st.slot1){ slot1El.innerHTML = kanjiHtml(st.slot1.value, showReadings); }
  else{ slot1El.textContent = "â€”"; }
  if(st.slot2){ slot2El.innerHTML = kanjiHtml(st.slot2.value, showReadings); }
  else{ slot2El.textContent = "â€”"; }

  slot1El.classList.toggle("filled", !!st.slot1);
  slot2El.classList.toggle("filled", !!st.slot2);
  wordBox.textContent = (st.slot1 && st.slot2) ? (st.slot1.value + st.slot2.value) : "â€”";

  madeListEl.innerHTML = "";
  (st.made||[]).forEach(w=>{
    const s = document.createElement("span");
    s.className = "tag";
    s.textContent = w;
    madeListEl.appendChild(s);
  });
}

/* ===============================
   applyRemoteState
=============================== */
function applyRemoteState(st){
  remoteState = st;

  if(!roomId){
    setTop("æœªæ¥ç¶š");
  }else if(!bothJoined(st)){
    setTop("å¾…æ©Ÿä¸­");
  }else if(st.started){
    setTop(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${(st.current??0)+1}ã®ç•ªï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼‰`);
  }else{
    setTop("æº–å‚™ä¸­ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼‰");
  }

  if(st.lastMsg) setMsg(st.lastMsg);

  renderScoreboardFromState(st);
  renderBoardFromState(st);

  const canAct = canActNow(st);
  drawBtn.disabled = !canAct || !!st.drewThisTurn;
  checkBtn.disabled = !canAct || !st.drewThisTurn;
  endBtn.disabled = !canAct;

  if(st.holdAdvance){
    skipNextBtn.style.display = "inline-flex";
    skipNextBtn.disabled = !isMyTurn(st);
    drawBtn.disabled = true;
    checkBtn.disabled = true;
    endBtn.disabled = true;
  }else{
    skipNextBtn.style.display = "none";
    skipNextBtn.disabled = true;
  }

  if(st.started && (st.field||[]).length <= 3){
    addFieldBtn.style.display = "inline-flex";
    addFieldBtn.disabled = !canAct;
  }else{
    addFieldBtn.style.display = "none";
    addFieldBtn.disabled = true;
  }

  if(typeof st.winner === "number"){
    winMsgEl.style.display = "block";
    winMsgEl.textContent = `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${st.winner+1}ã®å‹ã¡ï¼`;
  }else{
    winMsgEl.style.display = "none";
  }
}

/* ===============================
   ç›¤é¢ã‚¯ãƒªãƒƒã‚¯ï¼ˆåŒæœŸï¼‰
=============================== */
async function onPickFieldOnline(idx){
  const st = remoteState;
  if(!st) return;
  if(!canActNow(st)){
    if(st.started && bothJoined(st) && !isMyTurn(st)) setMsg("ç›¸æ‰‹ã®ç•ªã§ã™ï¼ˆã‚ãªãŸã¯æ“ä½œã§ãã¾ã›ã‚“ï¼‰ã€‚","ng");
    return;
  }
  if(!st.drewThisTurn){
    setMsg("å…ˆã«ã€Œï¼‘ã¾ã„å¼•ãã€ã‚’æŠ¼ã—ã¦ã­ã€‚","ng");
    return;
  }

  await txUpdate((cur)=>{
    if(!cur.started || !bothJoined(cur) || !isMyTurn(cur) || cur.holdAdvance) return cur;
    if(!cur.drewThisTurn) return cur;

    const f = cur.field || [];
    if(idx<0 || idx>=f.length) return cur;

    const already =
      (cur.slot1?.src==="field" && cur.slot1.index===idx) ||
      (cur.slot2?.src==="field" && cur.slot2.index===idx);
    if(already) return cur;

    const n = firstEmptySlot(cur);
    if(n===0) return cur;

    const obj = { src:"field", value: f[idx], index: idx };
    if(n===1) cur.slot1 = obj;
    if(n===2) cur.slot2 = obj;

    cur.lastMsg = "â‘ â‘¡ã‚’ã†ã‚ã¦ã€ç†Ÿèªã‚’ä½œã£ã¦ã­ã€‚";
    return cur;
  });
}

drawChip.onclick = async ()=>{
  const st = remoteState;
  if(!st) return;
  if(!canActNow(st)) return;
  if(!st.drewThisTurn){
    setMsg("å…ˆã«ã€Œï¼‘ã¾ã„å¼•ãã€ã‚’æŠ¼ã—ã¦ã­ã€‚","ng");
    return;
  }
  if(!st.drawnKanji) return;

  await txUpdate((cur)=>{
    if(!cur.started || !bothJoined(cur) || !isMyTurn(cur) || cur.holdAdvance) return cur;
    if(!cur.drewThisTurn || !cur.drawnKanji) return cur;

    const already = (cur.slot1?.src==="draw") || (cur.slot2?.src==="draw");
    if(already) return cur;

    const n = firstEmptySlot(cur);
    if(n===0) return cur;

    const obj = { src:"draw", value: cur.drawnKanji };
    if(n===1) cur.slot1 = obj;
    if(n===2) cur.slot2 = obj;
    cur.lastMsg = "â‘ â‘¡ã‚’ã†ã‚ã¦ã€ç†Ÿèªã‚’ä½œã£ã¦ã­ã€‚";
    return cur;
  });
};

slot1El.onclick = async ()=>{
  await txUpdate((cur)=>{
    if(!cur || !cur.started) return cur;
    if(!bothJoined(cur) || !isMyTurn(cur) || cur.holdAdvance) return cur;
    cur.slot1 = null;
    cur.lastMsg = "â‘ ã‚’æ¶ˆã—ã¾ã—ãŸã€‚";
    return cur;
  });
};
slot2El.onclick = async ()=>{
  await txUpdate((cur)=>{
    if(!cur || !cur.started) return cur;
    if(!bothJoined(cur) || !isMyTurn(cur) || cur.holdAdvance) return cur;
    cur.slot2 = null;
    cur.lastMsg = "â‘¡ã‚’æ¶ˆã—ã¾ã—ãŸã€‚";
    return cur;
  });
};

/* ===============================
   ã‚¿ãƒ¼ãƒ³é€²è¡Œ
=============================== */
function nextPlayerInState(cur){
  cur.holdAdvance = false;
  cur.current = ((cur.current ?? 0) + 1) % 2;
  cur.drewThisTurn = false;
  cur.drawnKanji = null;
  cur.missThisTurn = 0;
  cur.slot1 = null;
  cur.slot2 = null;

  const p = cur.players?.[cur.current];
  if(p?.skipNext){
    cur.lastMsg = `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${cur.current+1}ã¯ä¼‘ã¿ã§ã™ã€‚ã€Œã¤ãã¸ã€ã§é€²ã‚ã¾ã™ã€‚`;
  }else{
    cur.lastMsg = `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${cur.current+1}ã®ç•ªã§ã™ã€‚ã€Œï¼‘ã¾ã„å¼•ãã€ã‹ã‚‰å§‹ã‚ã¾ã™ã€‚`;
  }
  return cur;
}
function consumeUsedTilesInState(cur){
  const usedIdx = [];
  if(cur.slot1?.src==="field") usedIdx.push(cur.slot1.index);
  if(cur.slot2?.src==="field") usedIdx.push(cur.slot2.index);

  usedIdx.sort((a,b)=>b-a).forEach(i=>{
    if(typeof i==="number" && i>=0 && i<(cur.field||[]).length){
      cur.field.splice(i,1);
    }
  });

  if(cur.slot1?.src==="draw" || cur.slot2?.src==="draw"){
    cur.drawnKanji = null;
  }
  cur.slot1 = null;
  cur.slot2 = null;
  return cur;
}
function checkWinInState(cur){
  const target = Math.max(1, Number(cur.settings?.targetPoints)||5);
  const winner = (cur.players||[]).findIndex(p => (p.points||0) >= target);
  if(winner >= 0){
    cur.winner = winner;
    cur.started = false;
    cur.holdAdvance = false;
    cur.lastMsg = `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${winner+1}ã®å‹ã¡ï¼`;
    return true;
  }
  return false;
}

/* ===============================
   ãƒœã‚¿ãƒ³æ“ä½œ
=============================== */
startBtn.onclick = async ()=>{
  if(!roomId){ setMsg("å…ˆã«ãƒ«ãƒ¼ãƒ ä½œæˆ/å‚åŠ ã‚’ã—ã¦ãã ã•ã„ã€‚","ng"); return; }
  if(!remoteState){ setMsg("æ¥ç¶šçŠ¶æ…‹ã‚’å¾…ã£ã¦ã„ã¾ã™â€¦","ng"); return; }

  await txUpdate((cur)=>{
    if(!bothJoined(cur)){
      cur.lastMsg = "ç›¸æ‰‹ã®å‚åŠ ã‚’å¾…ã£ã¦ã„ã¾ã™â€¦";
      return cur;
    }
    cur.settings = {
      gradeKey: gradeSelect.value,
      showReadings: (readingToggle.value === "on"),
      targetPoints: Math.max(1, Number(targetPointsInp.value)||5),
      missLimit: Number(missLimitSel.value)||3
    };
    if(cur.started){
      cur.lastMsg = "ã™ã§ã«é–‹å§‹ã—ã¦ã„ã¾ã™ã€‚";
      return cur;
    }
    delete cur.winner;

    cur.players = (cur.players||[]).slice(0,2).map((p,i)=>({
      seat:i,
      clientId: p?.clientId || null,
      points: 0,
      skipNext: false
    }));

    const deck = buildDeckForGrade(cur.settings.gradeKey);
    cur.deck = deck;
    cur.field = cur.deck.splice(0,6);
    cur.started = true;
    cur.current = 0;

    cur.drewThisTurn = false;
    cur.drawnKanji = null;
    cur.missThisTurn = 0;
    cur.slot1 = null;
    cur.slot2 = null;
    cur.made = [];
    cur.holdAdvance = false;

    cur.lastMsg = "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®ç•ªã§ã™ã€‚ã€Œï¼‘ã¾ã„å¼•ãã€ã‹ã‚‰å§‹ã‚ã¾ã™ã€‚";
    return cur;
  });
};

resetBtn.onclick = async ()=>{
  if(!roomId){ setMsg("å…ˆã«ãƒ«ãƒ¼ãƒ ä½œæˆ/å‚åŠ ã‚’ã—ã¦ãã ã•ã„ã€‚","ng"); return; }

  await txUpdate((cur)=>{
    delete cur.winner;
    cur.started = false;
    cur.deck = [];
    cur.field = [];
    cur.drewThisTurn = false;
    cur.drawnKanji = null;
    cur.missThisTurn = 0;
    cur.slot1 = null;
    cur.slot2 = null;
    cur.made = [];
    cur.holdAdvance = false;
    cur.current = 0;

    cur.players = (cur.players||[]).slice(0,2).map((p,i)=>({
      seat:i,
      clientId: p?.clientId || null,
      points: 0,
      skipNext: false
    }));

    cur.lastMsg = "ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã™ã¨é–‹å§‹ã—ã¾ã™ã€‚";
    return cur;
  });
};

drawBtn.onclick = async ()=>{
  const st = remoteState;
  if(!st) return;
  if(!canActNow(st)){
    if(st.started && bothJoined(st) && !isMyTurn(st)) setMsg("ç›¸æ‰‹ã®ç•ªã§ã™ï¼ˆã‚ãªãŸã¯æ“ä½œã§ãã¾ã›ã‚“ï¼‰ã€‚","ng");
    return;
  }
  if(st.drewThisTurn) return;

  await txUpdate((cur)=>{
    if(!cur.started || !bothJoined(cur) || !isMyTurn(cur) || cur.holdAdvance) return cur;
    if(cur.drewThisTurn) return cur;
    if((cur.deck||[]).length === 0){
      cur.lastMsg = "å±±æœ­ãŒãªããªã‚Šã¾ã—ãŸã€‚ã‚‚ã†å¼•ã‘ã¾ã›ã‚“ï¼ˆãƒªã‚»ãƒƒãƒˆã—ã¦ã­ï¼‰ã€‚";
      return cur;
    }
    cur.drawnKanji = cur.deck.pop();
    cur.drewThisTurn = true;
    cur.lastMsg = "å¼•ã„ãŸæœ­ã‚’â‘ â‘¡ã«å…¥ã‚Œã¦ã€ç†Ÿèªã‚’ä½œã£ã¦ã­ã€‚";
    return cur;
  });
};

checkBtn.onclick = async ()=>{
  const st = remoteState;
  if(!st) return;
  if(!canActNow(st)){
    if(st.started && bothJoined(st) && !isMyTurn(st)) setMsg("ç›¸æ‰‹ã®ç•ªã§ã™ï¼ˆã‚ãªãŸã¯æ“ä½œã§ãã¾ã›ã‚“ï¼‰ã€‚","ng");
    return;
  }
  if(!st.drewThisTurn){
    setMsg("å…ˆã«ã€Œï¼‘ã¾ã„å¼•ãã€ã‚’æŠ¼ã—ã¦ã­ã€‚","ng");
    return;
  }

  await txUpdate((cur)=>{
    if(!cur.started || !bothJoined(cur) || !isMyTurn(cur) || cur.holdAdvance) return cur;
    if(!cur.drewThisTurn) return cur;
    if(!cur.slot1 || !cur.slot2){
      cur.lastMsg = "â‘ â‘¡ã‚’ã†ã‚ã¦ã‹ã‚‰ã€Œã§ããŸï¼ã€ã‚’æŠ¼ã—ã¦ã­ã€‚";
      return cur;
    }

    const word = cur.slot1.value + cur.slot2.value;
    const missLimit = Number(cur.settings?.missLimit)||3;

    if(!ANSWER_SET.has(word)){
      cur.missThisTurn = (cur.missThisTurn||0) + 1;

      if(cur.missThisTurn >= missLimit){
        const p = cur.players[cur.current];
        if(p) p.skipNext = true;

        if(cur.drawnKanji){ cur.field.push(cur.drawnKanji); }
        cur.drawnKanji = null;
        cur.slot1 = null;
        cur.slot2 = null;

        cur.holdAdvance = true;
        cur.lastMsg = "ãã®è¨€è‘‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãƒŸã‚¹ãŒãŸã¾ã£ãŸã®ã§ã€æ¬¡ã®è‡ªåˆ†ã®ç•ªã¯ä¼‘ã¿ã§ã™ã€‚ã€Œã¤ãã¸ã€ã§é€²ã‚ã¾ã™ã€‚";
        return cur;
      }

      cur.lastMsg = "ãã®è¨€è‘‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
      return cur;
    }

    const madeArr = cur.made || [];
    if(madeArr.includes(word)){
      cur.lastMsg = "ãã®ç†Ÿèªã¯ã€ã‚‚ã†ã§ãã¦ã„ã¾ã™ï¼ˆåŒã˜ç†Ÿèªã¯1å›ã¾ã§ï¼‰ã€‚";
      return cur;
    }

    madeArr.push(word);
    cur.made = madeArr;

    const p = cur.players[cur.current];
    if(p) p.points = (p.points||0) + 1;

    consumeUsedTilesInState(cur);

    cur.lastMsg = "æ­£ç­”ï¼ 1ãƒã‚¤ãƒ³ãƒˆï¼ ã¤ã¥ã‘ã¦ä½œã‚Œã¾ã™ã€‚";

    checkWinInState(cur);
    return cur;
  });
};

endBtn.onclick = async ()=>{
  const st = remoteState;
  if(!st) return;
  if(!canActNow(st)){
    if(st.started && bothJoined(st) && !isMyTurn(st)) setMsg("ç›¸æ‰‹ã®ç•ªã§ã™ï¼ˆã‚ãªãŸã¯æ“ä½œã§ãã¾ã›ã‚“ï¼‰ã€‚","ng");
    return;
  }

  await txUpdate((cur)=>{
    if(!cur.started || !bothJoined(cur) || !isMyTurn(cur) || cur.holdAdvance) return cur;

    if(cur.drawnKanji){
      cur.field.push(cur.drawnKanji);
      cur.drawnKanji = null;
    }
    cur.slot1 = null;
    cur.slot2 = null;

    nextPlayerInState(cur);
    return cur;
  });
};

skipNextBtn.onclick = async ()=>{
  const st = remoteState;
  if(!st || !roomId || !bothJoined(st) || !isMyTurn(st)) return;

  await txUpdate((cur)=>{
    if(!cur.started || !bothJoined(cur) || !isMyTurn(cur)) return cur;

    if(cur.holdAdvance){
      nextPlayerInState(cur);
      return cur;
    }

    const p = cur.players?.[cur.current];
    if(p?.skipNext){
      p.skipNext = false;
      nextPlayerInState(cur);
      return cur;
    }

    cur.lastMsg = "ã„ã¾ã¯ã€Œã¤ãã¸ã€ã¯ä½¿ãˆã¾ã›ã‚“ã€‚";
    return cur;
  });
};

addFieldBtn.onclick = async ()=>{
  const st = remoteState;
  if(!st || !canActNow(st)) return;

  await txUpdate((cur)=>{
    if(!cur.started || !bothJoined(cur) || !isMyTurn(cur) || cur.holdAdvance) return cur;
    if((cur.deck||[]).length === 0){
      cur.lastMsg = "å±±æœ­ãŒãªããªã‚Šã¾ã—ãŸã€‚å ´æœ­ã‚’è¿½åŠ ã§ãã¾ã›ã‚“ã€‚";
      return cur;
    }
    const n = Math.min(3, cur.deck.length);
    for(let i=0;i<n;i++) cur.field.push(cur.deck.pop());
    cur.lastMsg = `å ´æœ­ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆ${n}æšï¼‰ã€‚`;
    return cur;
  });
};

/* ===============================
   èª­ã¿è¡¨ç¤ºãƒˆã‚°ãƒ«ï¼ˆè¡¨ç¤ºã ã‘ï¼‰
=============================== */
readingToggle.onchange = ()=>{
  if(!remoteState) return;
  const tmp = JSON.parse(JSON.stringify(remoteState));
  tmp.settings = tmp.settings || {};
  tmp.settings.showReadings = (readingToggle.value === "on");
  renderBoardFromState(tmp);
};

/* ===============================
   ã‚¯ãƒªãƒƒã‚¯ï¼šãƒ«ãƒ¼ãƒ ä½œæˆ/å‚åŠ 
=============================== */
createRoomBtn.addEventListener("click", async ()=>{
  try{
    setMsg("ãƒ«ãƒ¼ãƒ ä½œæˆä¸­â€¦");
    await createRoom();
    setMsg("ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã—ãŸã€‚ç›¸æ‰‹ã«ãƒ«ãƒ¼ãƒ IDã‚’ä¼ãˆã¦å‚åŠ ã—ã¦ã‚‚ã‚‰ã£ã¦ã­ã€‚","ok");
  }catch(e){
    console.error(e);
    setMsg("ãƒ«ãƒ¼ãƒ ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆFirebaseè¨­å®š/ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªï¼‰ã€‚","ng");
  }
});
joinRoomBtn.addEventListener("click", async ()=>{
  const id = (roomIdInput.value||"").trim().toUpperCase();
  if(!id){ setMsg("ãƒ«ãƒ¼ãƒ IDã‚’å…¥ã‚Œã¦ã­ã€‚","ng"); return; }
  try{
    setMsg("å‚åŠ ä¸­â€¦");
    await joinRoom(id);
  }catch(e){
    console.error(e);
    setMsg("å‚åŠ ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆFirebaseè¨­å®š/ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªï¼‰ã€‚","ng");
  }
});

/* ===============================
   TTSï¼ˆéŠã³æ–¹ / æ­£ç­”ã®ã‚ˆã¿ãƒ»ã„ã¿ãƒ»ã‚Œã„ã¶ã‚“ï¼‰
=============================== */
const HAS_SPEECH = ("speechSynthesis" in window) && ("SpeechSynthesisUtterance" in window);
const TTS_DICT = [
  // è¿½åŠ ã—ãŸã‘ã‚Œã°ã“ã“ã¸ ä¾‹ï¼š["æ¶ˆé˜²è»Š","ã—ã‚‡ã†ã¼ã†ã—ã‚ƒ"]
];
function safeCancelSpeech(){
  if(!HAS_SPEECH) return;
  try{ window.speechSynthesis.cancel(); }catch(_){}
}
function ttsNormalize(text){
  let out = String(text ?? "");
  for(const [k, v] of TTS_DICT){ out = out.split(k).join(v); }
  return out;
}
let cachedVoices = [];
function refreshVoices(){
  if(!HAS_SPEECH) return;
  try{ cachedVoices = window.speechSynthesis.getVoices() || []; }catch(_){ cachedVoices = []; }
}
refreshVoices();
if(HAS_SPEECH){
  window.speechSynthesis.onvoiceschanged = refreshVoices;
}
function pickJaVoice(){
  if(!HAS_SPEECH) return null;
  const voices = cachedVoices.length ? cachedVoices : (window.speechSynthesis.getVoices?.() || []);
  return voices.find(v => /ja|JP/i.test(v.lang)) || voices[0] || null;
}
function speakText(text, onEnd){
  if(!HAS_SPEECH){ onEnd && onEnd(); return null; }
  try{
    safeCancelSpeech();
    const u = new SpeechSynthesisUtterance(ttsNormalize(text));
    const v = pickJaVoice();
    if(v) u.voice = v;
    u.lang = "ja-JP";
    u.rate = 1.0;
    u.pitch = 1.0;
    u.onend = ()=>{ onEnd && onEnd(); };
    u.onerror = ()=>{ onEnd && onEnd(); };
    window.speechSynthesis.speak(u);
    return u;
  }catch(e){
    onEnd && onEnd();
    return null;
  }
}

if(!HAS_SPEECH){
  speakBtn.onclick = ()=> setMsg("ã“ã®ç’°å¢ƒã§ã¯éŸ³å£°èª­ã¿ä¸Šã’ãŒä½¿ãˆã¾ã›ã‚“ã€‚","ng");
  stopSpeakBtn.onclick = ()=> setMsg("ã“ã®ç’°å¢ƒã§ã¯éŸ³å£°èª­ã¿ä¸Šã’ãŒä½¿ãˆã¾ã›ã‚“ã€‚","ng");
  ansSpeakBtn.onclick = ()=> setMsg("ã“ã®ç’°å¢ƒã§ã¯éŸ³å£°èª­ã¿ä¸Šã’ãŒä½¿ãˆã¾ã›ã‚“ã€‚","ng");
}else{
  speakBtn.onclick = ()=>{
    const text = [
      "æœ€åˆã« ã°ãµã  ãŒ6æšå‡ºã¾ã™ã€‚",
      "è‡ªåˆ†ã® ã°ã‚“ ã§ã¯ã€å¿…ãš ã‚„ã¾ãµã  ã‹ã‚‰1æšå¼•ãã¾ã™ã€‚1å›ã ã‘ã€‚",
      "ï¼‘ã€ï¼’ã®ã‚ãã«ã€ã°ãµã  ã©ã†ã—ã€ã¾ãŸã¯ ã²ããµã  ã¨ ã°ãµã  ã‚’ã€ã‚¿ãƒƒãƒ—ã—ã¦ã„ã‚Œã¾ã™ã€‚",
      "ã§ããŸã‚‰ã€ã§ããŸï¼ ã‚’ã‚¿ãƒƒãƒ—ã—ã¾ã™ã€‚æ­£ç­”ãªã‚‰1ãƒã‚¤ãƒ³ãƒˆã€‚",
      "ä½œã‚Œãªã‹ã£ãŸã¨ãã¯ã€å¼•ã„ãŸ ãµã  ã¯ ã°ãµã  ã«ä¸¦ã³ã€ã°ãµã  ãŒã©ã‚“ã©ã‚“å¢—ãˆã¾ã™ã€‚",
      "ã°ãµã  ãŒ3æšä»¥ä¸‹ã«ãªã£ãŸã‚‰ã€ã°ãµã  ã‚’è¿½åŠ ã™ã‚‹ ã®ãƒœã‚¿ãƒ³ã§ã€ãµã  ã‚’è¿½åŠ ã§ãã¾ã™ã€‚",
      "ã°ã‚“ ã‚’çµ‚ãˆã‚‹ã¨ãã€æ‰‹å…ƒã«æ®‹ã£ãŸ ã²ããµã  ã‚‚ ã°ãµã  ã¸è¿½åŠ ã•ã‚Œã¾ã™ã€‚",
      "ç›®æ¨™ãƒã‚¤ãƒ³ãƒˆã«é”ã—ãŸäººãŒå‹ã¡ã€‚è¨­å®šã§å¤‰æ›´ã§ãã¾ã™ã€‚",
      "1ã‚¿ãƒ¼ãƒ³ã§ã€ãã®è¨€è‘‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€ãŒè¨­å®šå›æ•°å‡ºãŸã‚‰ã€æ¬¡ã®è‡ªåˆ†ã® ã°ã‚“ ã¯1å›ä¼‘ã¿ã§ã™ã€‚ã¤ãã¸ã€ã§é€²ã¿ã¾ã™ã€‚"
    ].join(" ");
    speakText(text);
  };
  stopSpeakBtn.onclick = ()=> safeCancelSpeech();
}

/* æ­£ç­”ã®ã€Œã‚ˆã¿ãƒ»ã„ã¿ãƒ»ã‚Œã„ã¶ã‚“ã€ */
let lastCorrectWord = null;
ansSpeakBtn.onclick = ()=>{
  if(!lastCorrectWord) return;
  const info = JUKUGO_DB[lastCorrectWord];
  if(!info) return;

  ansInfo.innerHTML =
    `<div>ã€${escapeHtml(lastCorrectWord)}ã€‘</div>` +
    `<div class="sub">ã‚ˆã¿ï¼š${escapeHtml(info.yomi || "")}</div>` +
    `<div class="sub">ã„ã¿ï¼š${escapeHtml(info.imi || "")}</div>` +
    `<div class="sub">ã‚Œã„ã¶ã‚“ï¼š${escapeHtml(info.reibun || "")}</div>`;
  ansInfo.style.display = "block";

  const yomi = info.yomi || "";
  const reibunRaw = info.reibun || "";
  const reibunSpeak = (reibunRaw && lastCorrectWord && yomi)
    ? (reibunRaw.split(lastCorrectWord).join(yomi))
    : reibunRaw;

  const speakStr = `ã‚ˆã¿ã€${yomi}ã€‚ã„ã¿ã€${info.imi || ""}ã€‚ã‚Œã„ã¶ã‚“ã€${reibunSpeak}`;
  speakText(speakStr, ()=>{
    ansInfo.style.display = "none";
    ansInfo.innerHTML = "";
  });
};

/* ===============================
   ãã™ç‰
=============================== */
let lastWinnerShown = null;
function burstKusudama(winnerIndex){
  kusudamaOverlay.style.display = "grid";
  kusudamaOverlay.setAttribute("aria-hidden","false");
  kusudama.classList.remove("burst");
  streamers.innerHTML = "";
  kusudamaBanner.textContent = `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${winnerIndex+1}ã®å‹ã¡ï¼`;

  requestAnimationFrame(()=>{
    kusudama.classList.add("burst");
    for(let i=0;i<18;i++){
      const s = document.createElement("div");
      s.className = "streamer";
      const r = (Math.random()*120 - 60).toFixed(1) + "deg";
      const x = (Math.random()*340 - 170).toFixed(1) + "px";
      s.style.setProperty("--r", r);
      s.style.setProperty("--x", x);
      streamers.appendChild(s);
    }
    setTimeout(()=>{
      kusudamaOverlay.style.display = "none";
      kusudamaOverlay.setAttribute("aria-hidden","true");
    }, 1400);
  });
}

/* applyRemoteState ã«ã€Œå¾Œå‡¦ç†ã€ã‚’è¿½åŠ  */
const _applyRemoteState_base = applyRemoteState;
applyRemoteState = function(st){
  _applyRemoteState_base(st);

  const madeArr = st?.made || [];
  const newest = madeArr.length ? madeArr[madeArr.length - 1] : null;
  if(newest && newest !== lastCorrectWord){
    lastCorrectWord = newest;
    ansSpeakBtn.style.display = "inline-flex";
    ansInfo.style.display = "none";
    ansInfo.innerHTML = "";
  }
  if(!newest){
    lastCorrectWord = null;
    ansSpeakBtn.style.display = "none";
    ansInfo.style.display = "none";
    ansInfo.innerHTML = "";
  }

  if(typeof st?.winner === "number"){
    if(lastWinnerShown !== st.winner){
      lastWinnerShown = st.winner;
      burstKusudama(st.winner);
      safeCancelSpeech();
    }
  }else{
    lastWinnerShown = null;
  }

  if(st?.started && bothJoined(st)){
    const cur = st.current ?? 0;
    const p = (st.players||[])[cur];
    if(p?.skipNext && isMyTurn(st)){
      setMsg(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${cur+1}ã¯ä¼‘ã¿ã§ã™ã€‚ã€Œã¤ãã¸ã€ã§é€²ã‚ã¾ã™ã€‚`);
    }
  }
};

/* åˆæœŸï¼šæ­£ç­”èª­ã¿ä¸Šã’UIã¯éš ã™ */
ansSpeakBtn.style.display = "none";
ansInfo.style.display = "none";
</script>
</body>
</html>
