<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>カルタ読み上げ（音読み／訓読み）</title>
<style>
  :root{
    --bg1:#eef2ff; --bg2:#f3e8ff;
    --card:#ffffffd9;
    --ink:#111827; --sub:#4b5563;
    --primary:#4f46e5; --primarySoft:#e0e7ff;
    --border:#d1d5db;
    --shadow:0 10px 25px rgba(0,0,0,.08);
    --radius:18px;
  }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  body{
    margin:0; min-height:100vh; padding:16px;
    display:flex; justify-content:center; align-items:flex-start;
    background:linear-gradient(135deg,var(--bg1),var(--bg2));
    color:var(--ink);
    font-family: system-ui, -apple-system, "Segoe UI", "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
  }
  .wrap{ width:min(980px, 100%); }
  .card{
    background:var(--card);
    border:1px solid #ffffff80;
    box-shadow:var(--shadow);
    border-radius:var(--radius);
    padding:14px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  .top{
    display:flex; gap:12px; flex-wrap:wrap;
    align-items:stretch;
  }
  .big{
    flex:1 1 520px;
    min-height:190px;
    display:flex; flex-direction:column; justify-content:space-between;
  }
  .titleRow{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .title{ font-weight:800; letter-spacing:.02em; }
  .pill{
    display:inline-flex; align-items:center; gap:6px;
    border:1px solid var(--border);
    background:#fff;
    border-radius:999px;
    padding:6px 10px;
    font-size:12px;
    color:var(--sub);
    white-space:nowrap;
  }
  .display{
    margin-top:8px;
    border:1px dashed #c7d2fe;
    border-radius:16px;
    background:#ffffffc0;
    padding:14px;
    min-height:120px;
    display:flex; align-items:center; justify-content:center;
    text-align:center;
    line-height:1.2;
    user-select:none;
    word-break:break-word;
  }
  .displayText{
    font-weight:800;
    font-size: var(--fontSize, 84px);
  }
  .controls{
    margin-top:10px;
    display:flex; gap:8px; flex-wrap:wrap;
    align-items:center;
  }
  button{
    border:1px solid var(--border);
    background:#fff;
    border-radius:12px;
    padding:10px 12px;
    font-weight:700;
    color:var(--ink);
    cursor:pointer;
  }
  button.primary{
    background:var(--primary);
    border-color:var(--primary);
    color:#fff;
  }
  button.ghost{
    background:transparent;
  }
  button:disabled{ opacity:.55; cursor:not-allowed; }
  .settings{
    flex:1 1 360px;
    min-width:320px;
  }
  .grid{
    display:grid;
    grid-template-columns:1fr;
    gap:12px;
  }
  .row{
    display:flex; gap:10px; flex-wrap:wrap;
    align-items:center;
  }
  label.small{ font-size:12px; color:var(--sub); font-weight:700; }
  input[type="file"]{ width:100%; }
  select, input[type="range"]{
    border:1px solid var(--border);
    border-radius:10px;
    padding:10px 10px;
    background:#fff;
    font-weight:700;
  }
  .checks{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(84px, 1fr));
    gap:6px;
    padding:10px;
    border:1px solid var(--border);
    border-radius:12px;
    background:#fff;
    max-height:180px;
    overflow:auto;
  }
  .chk{
    display:flex; align-items:center; gap:6px;
    font-size:13px;
    padding:6px 8px;
    border-radius:10px;
    border:1px solid #f3f4f6;
    background:#fafafa;
  }
  .msg{
    margin-top:10px;
    font-size:13px;
    color:var(--sub);
  }
  .sep{ height:10px; }
  .footerNote{
    margin-top:10px;
    font-size:12px;
    color:var(--sub);
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <!-- Big / main -->
    <div class="card big">
      <div class="titleRow">
        <div class="title">カルタ読み上げ</div>
        <div class="pill" id="statusPill">未読込</div>
      </div>

      <div class="display" aria-live="polite">
        <div class="displayText" id="displayText">CSVを読み込んでください</div>
      </div>

      <div class="controls">
        <button class="primary" id="nextBtn" disabled>つぎ</button>
        <button id="speakBtn" disabled>読み上げ</button>
        <button id="hintBtn" disabled>ヒント</button>
        <button class="ghost" id="stopBtn" disabled>停止</button>
      </div>

      <div class="msg" id="msgLine">（手順）CSV読み込み → 学年/番号を選択 → モード選択 → 山札作成</div>
    </div>

    <!-- Settings -->
    <div class="card settings">
      <div class="grid">

        <div class="row">
          <div style="flex:1 1 180px;">
            <label class="small">読み上げモード</label><br>
            <select id="modeSel" style="width:100%;" disabled>
              <option value="on">（音読み）</option>
              <option value="kun">（訓読み）</option>
            </select>
          </div>
          <div style="flex:1 1 140px;">
            <label class="small">読み札の表示</label><br>
            <select id="showSel" style="width:100%;" disabled>
              <option value="on">表示する</option>
              <option value="off">表示しない（番号）</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div style="flex:1 1 160px;">
            <label class="small">文字サイズ</label><br>
            <input id="fontSize" type="range" min="40" max="140" value="84" disabled style="width:100%;">
          </div>
          <div class="pill" id="fontPill">84pt</div>
        </div>

        <div>
          <div class="row" style="justify-content:space-between;">
            <label class="small">学年（列A）</label>
            <div class="row">
              <button id="gradeAllBtn" disabled>全部ON</button>
              <button id="gradeNoneBtn" disabled>全部OFF</button>
            </div>
          </div>
          <div class="checks" id="gradeChecks"></div>
        </div>

        <div>
          <div class="row" style="justify-content:space-between;">
            <label class="small">番号（列B）</label>
            <div class="row">
              <button id="noAllBtn" disabled>全部ON</button>
              <button id="noNoneBtn" disabled>全部OFF</button>
            </div>
          </div>
          <div class="checks" id="noChecks"></div>
        </div>

        <div class="row">
          <button class="primary" id="buildBtn" disabled>山札を作る（重複なし）</button>
          <button id="resetBtn" disabled>リセット</button>
          <div class="pill" id="remainPill">残り：0</div>
        </div>

        <div class="footerNote">
          ヒントは<strong>表示しません</strong>（読み上げのみ）。ヒントが空のときは<strong>無音</strong>です。
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // =========================
  // Embedded data
  // =========================
  const EMBEDDED_ROWS = [{"grade": "G1", "no": "1", "onCard": "雨天のう", "onSpeak": "うてんのう", "kunCard": "雨ふりのあめ", "kunSpeak": "あめふりのあめ"}, {"grade": "G1", "no": "1", "onCard": "火曜日のか", "onSpeak": "かようびのか", "kunCard": "火花のひ", "kunSpeak": "ひばなのひ"}, {"grade": "G1", "no": "1", "onCard": "休日のきゅう", "onSpeak": "きゅうじつのきゅう", "kunCard": "やす‐む", "kunSpeak": "やすむ"}, {"grade": "G1", "no": "1", "onCard": "金よう日のきん", "onSpeak": "きんようびのきん", "kunCard": "かね", "kunSpeak": "かね"}, {"grade": "G1", "no": "1", "onCard": "空気のくう", "onSpeak": "くうきのくう", "kunCard": "そら", "kunSpeak": "そら"}, {"grade": "G1", "no": "1", "onCard": "月よう日のげつ", "onSpeak": "げつようひのげつ", "kunCard": "正月のがつ", "kunSpeak": "しょうがつのがつ"}, {"grade": "G1", "no": "1", "onCard": "手がみのて", "onSpeak": "てがみのて", "kunCard": "はく手のしゅ", "kunSpeak": "はくしゅのしゅ"}, {"grade": "G1", "no": "1", "onCard": "出じょうのしゅつ", "onSpeak": "しゅつじょうのしゅつ", "kunCard": "で‐る", "kunSpeak": "でる"}, {"grade": "G1", "no": "1", "onCard": "森林のしん", "onSpeak": "しんりんのしん", "kunCard": "もり", "kunSpeak": "もり"}, {"grade": "G1", "no": "1", "onCard": "正ほうけいのせい", "onSpeak": "せいほうけいのせい", "kunCard": "正月のしょう", "kunSpeak": "しょうがつのしょう"}, {"grade": "G1", "no": "1", "onCard": "千円さつのせん", "onSpeak": "せんえんさつのせん", "kunCard": "ちよがみのち", "kunSpeak": "ちよがみのち"}, {"grade": "G1", "no": "1", "onCard": "天気のてん", "onSpeak": "てんきのてん", "kunCard": "天の川のあま", "kunSpeak": "あまのがわのあま"}, {"grade": "G1", "no": "1", "onCard": "作文のぶん", "onSpeak": "さくぶんのぶん", "kunCard": "文くのもん", "kunSpeak": "もんくのもん"}, {"grade": "G1", "no": "2", "onCard": "百円のえん", "onSpeak": "ひゃくえんのえん", "kunCard": "まる‐い", "kunSpeak": "まるい"}, {"grade": "G1", "no": "2", "onCard": "ちかてつのか", "onSpeak": "ちかてつのか", "kunCard": "上下のげ", "kunSpeak": "じょうげのげ"}, {"grade": "G1", "no": "2", "onCard": "小学生のがく", "onSpeak": "しょうがくせいのがく", "kunCard": "まな‐ぶ", "kunSpeak": "まなぶ"}, {"grade": "G1", "no": "2", "onCard": "見学のけん", "onSpeak": "けんがくのけん", "kunCard": "み‐る", "kunSpeak": "みる"}, {"grade": "G1", "no": "2", "onCard": "男女のじょ", "onSpeak": "だんじょのじょ", "kunCard": "おんな", "kunSpeak": "おんな"}, {"grade": "G1", "no": "2", "onCard": "日本人のじん", "onSpeak": "にほんじんのじん", "kunCard": "人間のにん", "kunSpeak": "にんげんのにん"}, {"grade": "G1", "no": "2", "onCard": "水よう日のすい", "onSpeak": "すいようびのすい", "kunCard": "みず", "kunSpeak": "みず"}, {"grade": "G1", "no": "2", "onCard": "中学校のちゅう", "onSpeak": "ちゅうがっこうのちゅう", "kunCard": "なか", "kunSpeak": "なか"}, {"grade": "G1", "no": "2", "onCard": "町ないかいのちょう", "onSpeak": "ちょうないかいのちょう", "kunCard": "まち", "kunSpeak": "まち"}, {"grade": "G1", "no": "2", "onCard": "田んぼのた", "onSpeak": "たんぼのた", "kunCard": "水田のでん", "kunSpeak": "すいでんのでん"}, {"grade": "G1", "no": "2", "onCard": "土よう日のど", "onSpeak": "どようびのど", "kunCard": "つち", "kunSpeak": "つち"}, {"grade": "G1", "no": "2", "onCard": "百円玉のひゃく", "onSpeak": "ひゃくえんだまのひゃく", "kunCard": "", "kunSpeak": ""}, {"grade": "G1", "no": "2", "onCard": "目てきのもく", "onSpeak": "もくてきのもく", "kunCard": "め", "kunSpeak": "め"}, {"grade": "G1", "no": "3", "onCard": "花ふんのか", "onSpeak": "かふんのか", "kunCard": "花たばのはな", "kunSpeak": "はなたばのはな"}, {"grade": "G1", "no": "3", "onCard": "川あそびのかわ", "onSpeak": "がわあそびのかわ", "kunCard": "", "kunSpeak": ""}, {"grade": "G1", "no": "3", "onCard": "空気のき", "onSpeak": "くうきのき", "kunCard": "気はいのけ", "kunSpeak": "けはいのけ"}, {"grade": "G1", "no": "3", "onCard": "ふじ山のさん", "onSpeak": "ふじやまのさん", "kunCard": "やま", "kunSpeak": "やま"}, {"grade": "G1", "no": "3", "onCard": "文字のじ", "onSpeak": "もじのじ", "kunCard": "", "kunSpeak": ""}, {"grade": "G1", "no": "3", "onCard": "おく上のじょう", "onSpeak": "おくじょうのじょう", "kunCard": "うえ", "kunSpeak": "うえ"}, {"grade": "G1", "no": "3", "onCard": "青しゅんのせい", "onSpeak": "せいしゅんのせい", "kunCard": "青空のあお‐い", "kunSpeak": "あおぞらのあおい"}, {"grade": "G1", "no": "3", "onCard": "男女のだん", "onSpeak": "だんじょのだん", "kunCard": "おとこ", "kunSpeak": "おとこ"}, {"grade": "G1", "no": "3", "onCard": "まい日のにち", "onSpeak": "まいにちのにち", "kunCard": "日のまるのひ", "kunSpeak": "ひのまるのひ"}, {"grade": "G1", "no": "3", "onCard": "入学のにゅう", "onSpeak": "にゅうがくのにゅう", "kunCard": "い‐れる", "kunSpeak": "いれる"}, {"grade": "G1", "no": "3", "onCard": "本もののほん", "onSpeak": "ほんもののほん", "kunCard": "もと", "kunSpeak": "もと"}, {"grade": "G1", "no": "3", "onCard": "名人のめい", "onSpeak": "めいじんのめい", "kunCard": "名まえのな", "kunSpeak": "なまえのな"}, {"grade": "G1", "no": "3", "onCard": "夕がたのゆう", "onSpeak": "ゆうがたのゆう", "kunCard": "", "kunSpeak": ""}, {"grade": "G1", "no": "4", "onCard": "先生のせん", "onSpeak": "せんせいのせん", "kunCard": "さき", "kunSpeak": "さき"}, {"grade": "G1", "no": "4", "onCard": "学校のこう", "onSpeak": "がっこうのこう", "kunCard": "", "kunSpeak": ""}, {"grade": "G1", "no": "4", "onCard": "貝がらのかい", "onSpeak": "かいがらのかい", "kunCard": "", "kunSpeak": ""}, {"grade": "G1", "no": "4", "onCard": "水玉のたま", "onSpeak": "みずたまのたま", "kunCard": "玉ろのぎょく", "kunSpeak": "ぎょくろのぎょく"}, {"grade": "G1", "no": "4", "onCard": "あい犬のけん", "onSpeak": "あいけんのけん", "kunCard": "子犬のいぬ", "kunSpeak": "こいぬのいぬ"}, {"grade": "G1", "no": "4", "onCard": "男子のし", "onSpeak": "だんしのし", "kunCard": "子どものこ", "kunSpeak": "こどものこ"}, {"grade": "G1", "no": "4", "onCard": "ざっ草のそう", "onSpeak": "ざっそうのそう", "kunCard": "くさ", "kunSpeak": "くさ"}, {"grade": "G1", "no": "4", "onCard": "えん足のそく", "onSpeak": "えんそくのそく", "kunCard": "あし", "kunSpeak": "あし"}, {"grade": "G1", "no": "4", "onCard": "し町村のそん", "onSpeak": "しちょうそんのそん", "kunCard": "むら", "kunSpeak": "むら"}, {"grade": "G1", "no": "4", "onCard": "こん虫のちゅう", "onSpeak": "こんちゅうのちゅう", "kunCard": "むし", "kunSpeak": "むし"}, {"grade": "G1", "no": "4", "onCard": "らい年のねん", "onSpeak": "らいねんのねん", "kunCard": "とし", "kunSpeak": "とし"}, {"grade": "G1", "no": "4", "onCard": "き立のりつ", "onSpeak": "きりつのりつ", "kunCard": "た‐つ", "kunSpeak": "たつ"}, {"grade": "G1", "no": "4", "onCard": "ど力のりょく", "onSpeak": "どりょくのりょく", "kunCard": "ちから", "kunSpeak": "ちから"}, {"grade": "G1", "no": "5", "onCard": "一年生のいち", "onSpeak": "いちねんせいのいち", "kunCard": "ひと‐つ", "kunSpeak": "ひとつ"}, {"grade": "G1", "no": "5", "onCard": "右せつのう", "onSpeak": "うせつのう", "kunCard": "左右のゆう", "kunSpeak": "さゆうのゆう"}, {"grade": "G1", "no": "5", "onCard": "九このきゅう", "onSpeak": "きゅうこのきゅう", "kunCard": "九月のく", "kunSpeak": "くがつのく"}, {"grade": "G1", "no": "5", "onCard": "五円玉のご", "onSpeak": "ごえんだまのご", "kunCard": "いつ‐つ", "kunSpeak": "いつつ"}, {"grade": "G1", "no": "5", "onCard": "三月のさん", "onSpeak": "さんがつのさん", "kunCard": "みっ‐つ", "kunSpeak": "みっつ"}, {"grade": "G1", "no": "5", "onCard": "四月のし", "onSpeak": "しがつのし", "kunCard": "よっ‐つ", "kunSpeak": "よっつ"}, {"grade": "G1", "no": "5", "onCard": "七月のしち", "onSpeak": "しちがつのしち", "kunCard": "なな‐つ", "kunSpeak": "ななつ"}, {"grade": "G1", "no": "5", "onCard": "十月のじゅう", "onSpeak": "じゅうがつのじゅう", "kunCard": "とお", "kunSpeak": "とお"}, {"grade": "G1", "no": "5", "onCard": "早ちょうのそう", "onSpeak": "そうちょうのそう", "kunCard": "はや‐い", "kunSpeak": "はやい"}, {"grade": "G1", "no": "5", "onCard": "大学のだい", "onSpeak": "だいがくのだい", "kunCard": "大切のたい", "kunSpeak": "たいせつのたい"}, {"grade": "G1", "no": "5", "onCard": "二月のに", "onSpeak": "にがつのに", "kunCard": "ふた‐つ", "kunSpeak": "ふたつ"}, {"grade": "G1", "no": "5", "onCard": "白いのはく", "onSpeak": "はくいのはく", "kunCard": "しろ‐い", "kunSpeak": "しろい"}, {"grade": "G1", "no": "5", "onCard": "八月のはち", "onSpeak": "はちがつのはち", "kunCard": "やっ‐つ", "kunSpeak": "やっつ"}, {"grade": "G1", "no": "5", "onCard": "六月のろく", "onSpeak": "ろくがつのろく", "kunCard": "むっ‐つ", "kunSpeak": "むっつ"}, {"grade": "G1", "no": "6", "onCard": "王さまのおう", "onSpeak": "おうさまのおう", "kunCard": "", "kunSpeak": ""}, {"grade": "G1", "no": "6", "onCard": "音がくのおん", "onSpeak": "おんがくのおん", "kunCard": "おと", "kunSpeak": "おと"}, {"grade": "G1", "no": "6", "onCard": "人口のこう", "onSpeak": "じんこうのこう", "kunCard": "口ちょうのく", "kunSpeak": "くちょうのく"}, {"grade": "G1", "no": "6", "onCard": "左右のさ", "onSpeak": "さゆうのさ", "kunCard": "左手のひだり", "kunSpeak": "ひだりてのひだり"}, {"grade": "G1", "no": "6", "onCard": "け糸のいと", "onSpeak": "けいとのいと", "kunCard": "めん糸のし", "kunSpeak": "めんしのし"}, {"grade": "G1", "no": "6", "onCard": "でん車のしゃ", "onSpeak": "でんしゃのしゃ", "kunCard": "くるま", "kunSpeak": "くるま"}, {"grade": "G1", "no": "6", "onCard": "小学校のしょう", "onSpeak": "しょうがっこうのしょう", "kunCard": "ちい‐さい", "kunSpeak": "ちいさい"}, {"grade": "G1", "no": "6", "onCard": "生かつのせい", "onSpeak": "せいかつのせい", "kunCard": "い‐きる", "kunSpeak": "いきる"}, {"grade": "G1", "no": "6", "onCard": "赤はんのせき", "onSpeak": "せきはんのせき", "kunCard": "あか‐い", "kunSpeak": "あかい"}, {"grade": "G1", "no": "6", "onCard": "ほう石のせき", "onSpeak": "ほうせきのせき", "kunCard": "いし　じ石のしゃく", "kunSpeak": "いしじしゃくのしゃく"}, {"grade": "G1", "no": "6", "onCard": "竹林のちく", "onSpeak": "ちくりんのちく", "kunCard": "竹馬のたけ", "kunSpeak": "たけうまのたけ"}, {"grade": "G1", "no": "6", "onCard": "耳たぶのみみ", "onSpeak": "みみたぶのみみ", "kunCard": "", "kunSpeak": ""}, {"grade": "G1", "no": "6", "onCard": "木よう日のもく", "onSpeak": "もくようびのもく", "kunCard": "き", "kunSpeak": "き"}, {"grade": "G1", "no": "6", "onCard": "森林のりん", "onSpeak": "しんりんのしん", "kunCard": "はやし", "kunSpeak": "はやし"}, {"grade": "G2", "no": "1", "onCard": "あね", "onSpeak": "あね", "kunCard": "", "kunSpeak": ""}, {"grade": "G2", "no": "2", "onCard": "いもうと", "onSpeak": "いもうと", "kunCard": "", "kunSpeak": ""}, {"grade": "G2", "no": "3", "onCard": "引力のいん", "onSpeak": "いんりょくのいん", "kunCard": "ひ‐く", "kunSpeak": "ひく"}, {"grade": "G2", "no": "4", "onCard": "雲海のうん", "onSpeak": "うんかいのうん", "kunCard": "くも", "kunSpeak": "くも"}, {"grade": "G2", "no": "5", "onCard": "どうぶつ園のえん", "onSpeak": "どうぶつえんのえん", "kunCard": "", "kunSpeak": ""}, {"grade": "G2", "no": "6", "onCard": "遠足のえん", "onSpeak": "えんそくのえん", "kunCard": "とお‐い", "kunSpeak": "とおい"}, {"grade": "G2", "no": "7", "onCard": "黄色のき", "onSpeak": "きいろのき", "kunCard": "黄金のおう", "kunSpeak": "おうごんのおう"}, {"grade": "G2", "no": "8", "onCard": "しょ夏のか", "onSpeak": "しょかのか", "kunCard": "なつ", "kunSpeak": "なつ"}, {"grade": "G2", "no": "1", "onCard": "家ぞくのか", "onSpeak": "かぞくのか", "kunCard": "いえ", "kunSpeak": "いえ"}, {"grade": "G2", "no": "2", "onCard": "教科書のか", "onSpeak": "きょうかしょのか", "kunCard": "", "kunSpeak": ""}, {"grade": "G2", "no": "3", "onCard": "歌手のか", "onSpeak": "かしゅのか", "kunCard": "うた‐う", "kunSpeak": "うたう"}, {"grade": "G2", "no": "4", "onCard": "えい画かんのが", "onSpeak": "えいがかんのが", "kunCard": "計画のかく", "kunSpeak": "けいかくのかく"}, {"grade": "G2", "no": "5", "onCard": "絵本のえ", "onSpeak": "えほんのえ", "kunCard": "絵画のかい", "kunSpeak": "かいがのかい"}, {"grade": "G2", "no": "6", "onCard": "会社のかい", "onSpeak": "かいしゃのかい", "kunCard": "人にあ‐う", "kunSpeak": "ひとにあう"}, {"grade": "G2", "no": "7", "onCard": "海外のかい", "onSpeak": "かいがいのかい", "kunCard": "うみ", "kunSpeak": "うみ"}, {"grade": "G2", "no": "8", "onCard": "回数のかい", "onSpeak": "かいすうのかい", "kunCard": "まわ‐る", "kunSpeak": "まわる"}, {"grade": "G2", "no": "1", "onCard": "外国のがい", "onSpeak": "がいこくのがい", "kunCard": "そと", "kunSpeak": "そと"}, {"grade": "G2", "no": "2", "onCard": "三角のかく", "onSpeak": "さんかくのかく", "kunCard": "かど、つの", "kunSpeak": "かど"}, {"grade": "G2", "no": "3", "onCard": "音楽のがく", "onSpeak": "おんがくのがく", "kunCard": "たの‐しい", "kunSpeak": "たのしい"}, {"grade": "G2", "no": "4", "onCard": "生活のかつ", "onSpeak": "せいかつのかつ", "kunCard": "", "kunSpeak": ""}, {"grade": "G2", "no": "5", "onCard": "時間のかん", "onSpeak": "じかんのかん", "kunCard": "あいだ", "kunSpeak": "あいだ"}, {"grade": "G2", "no": "6", "onCard": "岩石のがん", "onSpeak": "がんせきのがん", "kunCard": "いわ", "kunSpeak": "いわ"}, {"grade": "G2", "no": "7", "onCard": "だん丸のがん", "onSpeak": "だんがんのがん", "kunCard": "まる‐い", "kunSpeak": "まるい"}, {"grade": "G2", "no": "8", "onCard": "顔めんのがん", "onSpeak": "がんめんのがん", "kunCard": "かお", "kunSpeak": "かお"}, {"grade": "G2", "no": "1", "onCard": "日記のき", "onSpeak": "にっきのき", "kunCard": "名前をしる‐す", "kunSpeak": "なまえをしるす"}, {"grade": "G2", "no": "2", "onCard": "汽てきのき", "onSpeak": "きてきのき", "kunCard": "", "kunSpeak": ""}, {"grade": "G2", "no": "3", "onCard": "帰国のき", "onSpeak": "きこくのき", "kunCard": "かえ‐る", "kunSpeak": "かえる"}, {"grade": "G2", "no": "4", "onCard": "牛肉のぎゅう", "onSpeak": "ぎゅうにくのぎゅう", "kunCard": "うし", "kunSpeak": "うし"}, {"grade": "G2", "no": "5", "onCard": "金魚のぎょ", "onSpeak": "きんぎょのぎょ", "kunCard": "さかな", "kunSpeak": "さかな"}, {"grade": "G2", "no": "6", "onCard": "教室のきょう", "onSpeak": "きょうしつのきょう", "kunCard": "おし‐える", "kunSpeak": "おしえる"}, {"grade": "G2", "no": "7", "onCard": "兄弟のきょう", "onSpeak": "きょうだいのきょう", "kunCard": "あに", "kunSpeak": "あに"}, {"grade": "G2", "no": "8", "onCard": "京都のきょう", "onSpeak": "きょうとのきょう", "kunCard": "", "kunSpeak": ""}, {"grade": "G2", "no": "1", "onCard": "勉強のきょう", "onSpeak": "べんきょうのきょう", "kunCard": "つよ‐い", "kunSpeak": "つよい"}, {"grade": "G2", "no": "2", "onCard": "近じょのきん", "onSpeak": "きんじょのきん", "kunCard": "ちか‐い", "kunSpeak": "ちかい"}, {"grade": "G2", "no": "3", "onCard": "三角形のけい", "onSpeak": "さんかっけいのけい", "kunCard": "かたち", "kunSpeak": "かたち"}, {"grade": "G2", "no": "4", "onCard": "計算のけい", "onSpeak": "けいさんのけい", "kunCard": "はか‐る", "kunSpeak": "はかる"}, {"grade": "G2", "no": "5", "onCard": "はつ言のげん", "onSpeak": "はつげんのげん", "kunCard": "い‐う", "kunSpeak": "いう"}, {"grade": "G2", "no": "6", "onCard": "元気のげん", "onSpeak": "げんきのげん", "kunCard": "もと", "kunSpeak": "もと"}, {"grade": "G2", "no": "7", "onCard": "草原のげん", "onSpeak": "そうげんのげん", "kunCard": "はら", "kunSpeak": "はら"}, {"grade": "G2", "no": "8", "onCard": "中古車のこ", "onSpeak": "ちゅうこしゃのこ", "kunCard": "ふる‐い", "kunSpeak": "ふるい"}, {"grade": "G2", "no": "1", "onCard": "戸だなのと", "onSpeak": "とだなのと", "kunCard": "戸せきのこ", "kunSpeak": "こせきのこ"}, {"grade": "G2", "no": "2", "onCard": "前後のご", "onSpeak": "ぜんごのご", "kunCard": "あと、", "kunSpeak": "あと"}, {"grade": "G2", "no": "3", "onCard": "午前中のご", "onSpeak": "ごぜんちゅうのご", "kunCard": "", "kunSpeak": ""}, {"grade": "G2", "no": "4", "onCard": "国語のご", "onSpeak": "こくごのご", "kunCard": "かた‐る", "kunSpeak": "かたる"}, {"grade": "G2", "no": "5", "onCard": "りょ行のこう", "onSpeak": "りょこうのこう", "kunCard": "い‐く", "kunSpeak": "いく"}, {"grade": "G2", "no": "6", "onCard": "さい高いのこう", "onSpeak": "さいこうのこう", "kunCard": "たか‐い", "kunSpeak": "たかい"}, {"grade": "G2", "no": "7", "onCard": "広こくのこう", "onSpeak": "こうこくのこう", "kunCard": "ひろ‐い", "kunSpeak": "ひろい"}, {"grade": "G2", "no": "8", "onCard": "日光のこう", "onSpeak": "にっこうのこう", "kunCard": "ひかり", "kunSpeak": "ひかり"}, {"grade": "G2", "no": "1", "onCard": "さん考書のこう", "onSpeak": "さんこうしょのこう", "kunCard": "かんが‐える", "kunSpeak": "かんがえる"}, {"grade": "G2", "no": "2", "onCard": "しゅ人公のこう", "onSpeak": "しゅじんこうのこう", "kunCard": "", "kunSpeak": ""}, {"grade": "G2", "no": "3", "onCard": "図工のこう", "onSpeak": "ずこうのこう", "kunCard": "工ふうのく", "kunSpeak": "くふうのく"}, {"grade": "G2", "no": "4", "onCard": "交通のこう", "onSpeak": "こうつうのこう", "kunCard": "線がまじ‐わる", "kunSpeak": "せんがまじわる"}, {"grade": "G2", "no": "5", "onCard": "合計のごう", "onSpeak": "ごうけいのごう", "kunCard": "ぴたりとあ‐う", "kunSpeak": "ぴたりとあう"}, {"grade": "G2", "no": "6", "onCard": "黒ばんのこく", "onSpeak": "こくばんのこく", "kunCard": "くろ‐い", "kunSpeak": "くろい"}, {"grade": "G2", "no": "7", "onCard": "国語のこく", "onSpeak": "こくごのこく", "kunCard": "くに", "kunSpeak": "くに"}, {"grade": "G2", "no": "8", "onCard": "今週のこん", "onSpeak": "こんしゅうのこん", "kunCard": "いま", "kunSpeak": "いま"}, {"grade": "G2", "no": "1", "onCard": "細ぼうのさい", "onSpeak": "さいぼうのさい", "kunCard": "ほそ‐い", "kunSpeak": "ほそい"}, {"grade": "G2", "no": "2", "onCard": "才のうのさい", "onSpeak": "さいのうのさい", "kunCard": "", "kunSpeak": ""}, {"grade": "G2", "no": "3", "onCard": "作ひんのさく", "onSpeak": "さくひんのさく", "kunCard": "つく‐る", "kunSpeak": "つくる"}, {"grade": "G2", "no": "4", "onCard": "算数のさん", "onSpeak": "さんすうのさん", "kunCard": "", "kunSpeak": ""}, {"grade": "G2", "no": "5", "onCard": "ふ思ぎのし", "onSpeak": "ふしぎのし", "kunCard": "おも‐う", "kunSpeak": "おもう"}, {"grade": "G2", "no": "6", "onCard": "画用紙のし", "onSpeak": "がようしのし", "kunCard": "かみ", "kunSpeak": "かみ"}, {"grade": "G2", "no": "7", "onCard": "きん止するのし", "onSpeak": "きんしするのし", "kunCard": "と‐める", "kunSpeak": "とめる"}, {"grade": "G2", "no": "8", "onCard": "市やくしょのし", "onSpeak": "しやくしょのし", "kunCard": "市場のいち", "kunSpeak": "いちばのいち"}, {"grade": "G2", "no": "1", "onCard": "時間のじ", "onSpeak": "じかんのじ", "kunCard": "とき", "kunSpeak": "とき"}, {"grade": "G2", "no": "2", "onCard": "寺いんのじ", "onSpeak": "じいんのじ", "kunCard": "てら", "kunSpeak": "てら"}, {"grade": "G2", "no": "3", "onCard": "自分のじ", "onSpeak": "じぶんのじ", "kunCard": "自ぜんのし", "kunSpeak": "しぜんのし"}, {"grade": "G2", "no": "4", "onCard": "教室のしつ", "onSpeak": "きょうしつのしつ", "kunCard": "", "kunSpeak": ""}, {"grade": "G2", "no": "5", "onCard": "会社のしゃ", "onSpeak": "かいしゃのしゃ", "kunCard": "やしろ", "kunSpeak": "やしろ"}, {"grade": "G2", "no": "6", "onCard": "弱点のじゃく", "onSpeak": "じゃくてんのじゃく", "kunCard": "よわ‐い", "kunSpeak": "よわい"}, {"grade": "G2", "no": "7", "onCard": "首とのしゅ", "onSpeak": "しゅとのしゅ", "kunCard": "くび", "kunSpeak": "くび"}, {"grade": "G2", "no": "8", "onCard": "一週間のしゅう", "onSpeak": "いっしゅうかんのしゅう", "kunCard": "", "kunSpeak": ""}, {"grade": "G2", "no": "1", "onCard": "秋分の日のしゅう", "onSpeak": "しゅうぶんのひのしゅう", "kunCard": "あき", "kunSpeak": "あき"}, {"grade": "G2", "no": "2", "onCard": "春分の日のしゅん", "onSpeak": "しゅんぶんのひのしゅん", "kunCard": "はる", "kunSpeak": "はる"}, {"grade": "G2", "no": "3", "onCard": "読書のしょ", "onSpeak": "どくしょのしょ", "kunCard": "か‐く", "kunSpeak": "かく"}, {"grade": "G2", "no": "4", "onCard": "少年のしょう", "onSpeak": "しょうねんのしょう", "kunCard": "すく‐ない", "kunSpeak": "すくない"}, {"grade": "G2", "no": "5", "onCard": "出場のじょう", "onSpeak": "しゅつじょうのじょう", "kunCard": "場しょのば", "kunSpeak": "ばしょのば"}, {"grade": "G2", "no": "6", "onCard": "ちゃく食のしょく", "onSpeak": "ちゃくしょくのしょく", "kunCard": "け色のしき", "kunSpeak": "けしきのしき"}, {"grade": "G2", "no": "7", "onCard": "朝食のしょく", "onSpeak": "ちょうしょくのしょく", "kunCard": "た‐べる", "kunSpeak": "たべる"}, {"grade": "G2", "no": "8", "onCard": "りょう親のしん", "onSpeak": "りょうしんのしん", "kunCard": "おや", "kunSpeak": "おや"}, {"grade": "G2", "no": "1", "onCard": "新聞のしん", "onSpeak": "しんぶんのしん", "kunCard": "あたら‐しい", "kunSpeak": "あたらしい"}, {"grade": "G2", "no": "2", "onCard": "あん心のしん", "onSpeak": "あんしんのしん", "kunCard": "こころ", "kunSpeak": "こころ"}, {"grade": "G2", "no": "3", "onCard": "地図のず", "onSpeak": "ちずのず", "kunCard": "図書かんのと", "kunSpeak": "としょかんのと"}, {"grade": "G2", "no": "4", "onCard": "数字のすう", "onSpeak": "すうじのすう", "kunCard": "かず", "kunSpeak": "かず"}, {"grade": "G2", "no": "5", "onCard": "晴天のせい", "onSpeak": "せいてんのせい", "kunCard": "は‐れる", "kunSpeak": "はれる"}, {"grade": "G2", "no": "6", "onCard": "音声のせい", "onSpeak": "おんせいのせい", "kunCard": "こえ", "kunSpeak": "こえ"}, {"grade": "G2", "no": "7", "onCard": "西がわのにし", "onSpeak": "にしがわのにし", "kunCard": "西部のせい", "kunSpeak": "せいぶのせい"}, {"grade": "G2", "no": "8", "onCard": "星ざのせい", "onSpeak": "せいざのせい", "kunCard": "ほし", "kunSpeak": "ほし"}, {"grade": "G2", "no": "1", "onCard": "雪だるまのゆき", "onSpeak": "ゆきだるまのゆき", "kunCard": "せき雪のせつ", "kunSpeak": "せきせつのせつ"}, {"grade": "G2", "no": "2", "onCard": "大切のせつ", "onSpeak": "たいせつのせつ", "kunCard": "き‐る", "kunSpeak": "きる"}, {"grade": "G2", "no": "3", "onCard": "線ろのせん", "onSpeak": "せんろのせん", "kunCard": "", "kunSpeak": ""}, {"grade": "G2", "no": "4", "onCard": "風せんのせん", "onSpeak": "ふうせんのせん", "kunCard": "ふね", "kunSpeak": "ふね"}, {"grade": "G2", "no": "5", "onCard": "前後のぜん", "onSpeak": "ぜんごのぜん", "kunCard": "まえ", "kunSpeak": "まえ"}, {"grade": "G2", "no": "6", "onCard": "一組のくみ", "onSpeak": "ひとくみのくみ", "kunCard": "く‐む", "kunSpeak": "くむ"}, {"grade": "G2", "no": "7", "onCard": "だっ走のそう", "onSpeak": "だっそうのそう", "kunCard": "はし‐る", "kunSpeak": "はしる"}, {"grade": "G2", "no": "8", "onCard": "多数けつのた", "onSpeak": "たすうけつのた", "kunCard": "おお‐い", "kunSpeak": "おおい"}, {"grade": "G2", "no": "1", "onCard": "太ようのたい", "onSpeak": "たいようのたい", "kunCard": "ふと‐い", "kunSpeak": "ふとい"}, {"grade": "G2", "no": "2", "onCard": "体じゅうのたい", "onSpeak": "たいじゅうのたい", "kunCard": "からだ", "kunSpeak": "からだ"}, {"grade": "G2", "no": "3", "onCard": "兄弟のだい", "onSpeak": "きょうだいのだい", "kunCard": "おとうと", "kunSpeak": "おとうと"}, {"grade": "G2", "no": "4", "onCard": "台どころのだい", "onSpeak": "だいどころのだい", "kunCard": "台風のたい", "kunSpeak": "たいふうのたい"}, {"grade": "G2", "no": "5", "onCard": "谷間のたに", "onSpeak": "たにまのたに", "kunCard": "", "kunSpeak": ""}, {"grade": "G2", "no": "6", "onCard": "知しきのち", "onSpeak": "ちしきのち", "kunCard": "し‐る", "kunSpeak": "しる"}, {"grade": "G2", "no": "7", "onCard": "電池のち", "onSpeak": "でんちのち", "kunCard": "いけ", "kunSpeak": "いけ"}, {"grade": "G2", "no": "8", "onCard": "土地のち", "onSpeak": "とちのち", "kunCard": "地面のじ", "kunSpeak": "じめんのじ"}, {"grade": "G2", "no": "1", "onCard": "お茶のちゃ", "onSpeak": "おちゃのちゃ", "kunCard": "", "kunSpeak": ""}, {"grade": "G2", "no": "2", "onCard": "昼食のちゅう", "onSpeak": "ちゅうしょくのちゅう", "kunCard": "ひる", "kunSpeak": "ひる"}, {"grade": "G2", "no": "3", "onCard": "社長のちょう", "onSpeak": "しゃちょうのちょう", "kunCard": "なが‐い", "kunSpeak": "ながい"}, {"grade": "G2", "no": "4", "onCard": "白鳥のちょう", "onSpeak": "はくちょうのちょう", "kunCard": "とり", "kunSpeak": "とり"}, {"grade": "G2", "no": "5", "onCard": "朝食のちょう", "onSpeak": "ちょうしょくのちょう", "kunCard": "あさ", "kunSpeak": "あさ"}, {"grade": "G2", "no": "6", "onCard": "直線のちょく", "onSpeak": "ちょくせんのちょく", "kunCard": "なお‐す", "kunSpeak": "なおす"}, {"grade": "G2", "no": "7", "onCard": "交通のつう", "onSpeak": "こうつうのつう", "kunCard": "とお‐る", "kunSpeak": "とおる"}, {"grade": "G2", "no": "8", "onCard": "売店のてん", "onSpeak": "ばいてんのてん", "kunCard": "みせ", "kunSpeak": "みせ"}, {"grade": "G2", "no": "1", "onCard": "点数のてん", "onSpeak": "てんすうのてん", "kunCard": "", "kunSpeak": ""}, {"grade": "G2", "no": "2", "onCard": "電話のでん", "onSpeak": "でんわのでん", "kunCard": "", "kunSpeak": ""}, {"grade": "G2", "no": "3", "onCard": "読書のどく", "onSpeak": "どくしょのどく", "kunCard": "よ‐む", "kunSpeak": "よむ"}, {"grade": "G2", "no": "4", "onCard": "日本刀のとう", "onSpeak": "にほんとうのとう", "kunCard": "かたな", "kunSpeak": "かたな"}, {"grade": "G2", "no": "5", "onCard": "先頭のとう", "onSpeak": "せんとうのとう", "kunCard": "頭つうのず", "kunSpeak": "ずつうのず"}, {"grade": "G2", "no": "6", "onCard": "当番のとう", "onSpeak": "とうばんのとう", "kunCard": "あ‐たる", "kunSpeak": "あたる"}, {"grade": "G2", "no": "7", "onCard": "東京のとう", "onSpeak": "とうきょうのとう", "kunCard": "ひがし", "kunSpeak": "ひがし"}, {"grade": "G2", "no": "8", "onCard": "答あんのとう", "onSpeak": "とうあんのとう", "kunCard": "こた‐える", "kunSpeak": "こたえる"}, {"grade": "G2", "no": "1", "onCard": "だん冬のとう", "onSpeak": "だんとうのとう", "kunCard": "ふゆ", "kunSpeak": "ふゆ"}, {"grade": "G2", "no": "2", "onCard": "同時のどう", "onSpeak": "どうじのどう", "kunCard": "おな‐じ", "kunSpeak": "おなじ"}, {"grade": "G2", "no": "3", "onCard": "北海道のどう", "onSpeak": "ほっかいどうのどう", "kunCard": "みち", "kunSpeak": "みち"}, {"grade": "G2", "no": "4", "onCard": "あん内のない", "onSpeak": "あんないのない", "kunCard": "うち", "kunSpeak": "うち"}, {"grade": "G2", "no": "5", "onCard": "南きょくのなん", "onSpeak": "なんきょくのなん", "kunCard": "みなみ", "kunSpeak": "みなみ"}, {"grade": "G2", "no": "6", "onCard": "何かのなに", "onSpeak": "なにかのなに", "kunCard": "何人のなん", "kunSpeak": "なんにんのなん"}, {"grade": "G2", "no": "7", "onCard": "牛肉のにく", "onSpeak": "ぎゅうにくのにく", "kunCard": "", "kunSpeak": ""}, {"grade": "G2", "no": "8", "onCard": "馬車のば", "onSpeak": "ばしゃのば", "kunCard": "うま", "kunSpeak": "うま"}, {"grade": "G2", "no": "1", "onCard": "買いもののか‐う", "onSpeak": "かいもののかう", "kunCard": "買しゅうのばい", "kunSpeak": "ばいしゅうのばい"}, {"grade": "G2", "no": "2", "onCard": "しょう売のばい", "onSpeak": "しょうばいのばい", "kunCard": "う‐る", "kunSpeak": "うる"}, {"grade": "G2", "no": "3", "onCard": "鳥のはね", "onSpeak": "とりのはね", "kunCard": "羽子いたのは", "kunSpeak": "はごいたのは"}, {"grade": "G2", "no": "4", "onCard": "半分のはん", "onSpeak": "はんぶんのはん", "kunCard": "四月のなか‐ば", "kunSpeak": "しがつのなかば"}, {"grade": "G2", "no": "5", "onCard": "番ごうのばん", "onSpeak": "ばんごうのばん", "kunCard": "", "kunSpeak": ""}, {"grade": "G2", "no": "6", "onCard": "父母のふ", "onSpeak": "ふぼのふ", "kunCard": "ちち", "kunSpeak": "ちち"}, {"grade": "G2", "no": "7", "onCard": "風船のふう", "onSpeak": "ふうせんのふう", "kunCard": "かぜ", "kunSpeak": "かぜ"}, {"grade": "G2", "no": "8", "onCard": "半分のぶん", "onSpeak": "はんぶんのぶん", "kunCard": "15分のふん", "kunSpeak": "じゅうごふんのふん"}, {"grade": "G2", "no": "1", "onCard": "新聞のぶん", "onSpeak": "しんぶんのぶん", "kunCard": "き‐く", "kunSpeak": "きく"}, {"grade": "G2", "no": "2", "onCard": "歩道橋のほ", "onSpeak": "ほどうきょうのほ", "kunCard": "ある‐く", "kunSpeak": "あるく"}, {"grade": "G2", "no": "3", "onCard": "父母のぼ", "onSpeak": "ふぼのぼ", "kunCard": "はは", "kunSpeak": "はは"}, {"grade": "G2", "no": "4", "onCard": "正方形のほう", "onSpeak": "せいほうけいのほう", "kunCard": "かた", "kunSpeak": "かた"}, {"grade": "G2", "no": "5", "onCard": "東北のほく", "onSpeak": "とうほくのほく", "kunCard": "きた", "kunSpeak": "きた"}, {"grade": "G2", "no": "6", "onCard": "毎日のまい", "onSpeak": "まいにちのまい", "kunCard": "", "kunSpeak": ""}, {"grade": "G2", "no": "7", "onCard": "新米のまい", "onSpeak": "しんまいのまい", "kunCard": "こめ", "kunSpeak": "こめ"}, {"grade": "G2", "no": "8", "onCard": "一万円のまん", "onSpeak": "いちまんえんのまん", "kunCard": "", "kunSpeak": ""}, {"grade": "G2", "no": "1", "onCard": "麦茶のむぎ", "onSpeak": "むぎちゃのむぎ", "kunCard": "", "kunSpeak": ""}, {"grade": "G2", "no": "2", "onCard": "せつ明のめい", "onSpeak": "せつめいのめい", "kunCard": "あか‐るい", "kunSpeak": "あかるい"}, {"grade": "G2", "no": "3", "onCard": "鳥がな‐く", "onSpeak": "とりがなく", "kunCard": "ひ鳴のめい", "kunSpeak": "ひめいのめい"}, {"grade": "G2", "no": "4", "onCard": "毛ふのもう", "onSpeak": "もうふのもう", "kunCard": "かみの毛のけ", "kunSpeak": "かみのけのけ"}, {"grade": "G2", "no": "5", "onCard": "入門のもん", "onSpeak": "にゅうもんのもん", "kunCard": "", "kunSpeak": ""}, {"grade": "G2", "no": "6", "onCard": "今夜のや", "onSpeak": "こんやのや", "kunCard": "夜中のよ、よる", "kunSpeak": "よなかのよ、よる"}, {"grade": "G2", "no": "7", "onCard": "野さいのや", "onSpeak": "やさいのや", "kunCard": "野原のの", "kunSpeak": "のはらのの"}, {"grade": "G2", "no": "8", "onCard": "弓矢のや", "onSpeak": "ゆみやのや", "kunCard": "", "kunSpeak": ""}, {"grade": "G2", "no": "1", "onCard": "親友のゆう", "onSpeak": "しんゆうのゆう", "kunCard": "とも", "kunSpeak": "とも"}, {"grade": "G2", "no": "2", "onCard": "弓矢のゆみ", "onSpeak": "ゆみやのゆみ", "kunCard": "", "kunSpeak": ""}, {"grade": "G2", "no": "3", "onCard": "月曜日のよう", "onSpeak": "げつようびのよう", "kunCard": "", "kunSpeak": ""}, {"grade": "G2", "no": "4", "onCard": "用いするのよう", "onSpeak": "よういするのよう", "kunCard": "道ぐをもち‐いる", "kunSpeak": "どうぐをもちいる"}, {"grade": "G2", "no": "5", "onCard": "来年のらい", "onSpeak": "らいねんのらい", "kunCard": "く‐る", "kunSpeak": "くる"}, {"grade": "G2", "no": "6", "onCard": "里いものさと", "onSpeak": "さといものさと", "kunCard": "三千里のり", "kunSpeak": "さんぜんりのり"}, {"grade": "G2", "no": "7", "onCard": "理由のり", "onSpeak": "りゆうのり", "kunCard": "", "kunSpeak": ""}, {"grade": "G2", "no": "8", "onCard": "電話のわ", "onSpeak": "でんわのわ", "kunCard": "はなし、はな‐す", "kunSpeak": "はなし、はなす"}];

  // =========================
  // State
  // =========================
  let rows = [];        // all parsed rows (A-F only)
  let deck = [];        // filtered & shuffled rows
  let idx = -1;         // current index
  let current = null;   // current row
  let deckReady = false;

  // Selected filters
  const selectedGrades = new Set();
  const selectedNos = new Set();

  // =========================
  // Helpers: CSV parse (supports quotes)
  // =========================
  function parseCSV(text){
    // Normalize newlines
    text = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
    const out = [];
    let i = 0, field = "", row = [];
    let inQuotes = false;

    while(i < text.length){
      const c = text[i];

      if(inQuotes){
        if(c === '"'){
          if(text[i+1] === '"'){ field += '"'; i += 2; continue; }
          inQuotes = false; i++; continue;
        }else{
          field += c; i++; continue;
        }
      }else{
        if(c === '"'){ inQuotes = true; i++; continue; }
        if(c === ','){ row.push(field); field = ""; i++; continue; }
        if(c === '\n'){
          row.push(field); field = "";
          // skip empty trailing line
          if(row.length > 1 || (row.length === 1 && row[0].trim() !== "")){
            out.push(row);
          }
          row = [];
          i++; continue;
        }
        field += c; i++; continue;
      }
    }
    // last line
    if(inQuotes){
      // best effort: close quotes
      inQuotes = false;
    }
    if(field.length || row.length){
      row.push(field);
      if(row.length > 1 || (row.length === 1 && row[0].trim() !== "")){
        out.push(row);
      }
    }
    return out;
  }

  function trimOrEmpty(x){
    return (x ?? "").toString().trim();
  }

  function shuffle(a){
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }

  // =========================
  // Speech
  // =========================
  function stopSpeak(){
    try{ speechSynthesis.cancel(); }catch(e){}
  }

  function speakText(text){
    text = trimOrEmpty(text);
    if(!text) return; // silent if empty
    stopSpeak();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "ja-JP";
    speechSynthesis.speak(u);
  }

  // =========================
  // DOM
  // =========================
  const $ = (id)=>document.getElementById(id);
  const modeSel = $("modeSel");
  const showSel = $("showSel");
  const fontSize = $("fontSize");

  const gradeChecks = $("gradeChecks");
  const noChecks = $("noChecks");

  const gradeAllBtn = $("gradeAllBtn");
  const gradeNoneBtn = $("gradeNoneBtn");
  const noAllBtn = $("noAllBtn");
  const noNoneBtn = $("noNoneBtn");

  const buildBtn = $("buildBtn");
  const resetBtn = $("resetBtn");

  const nextBtn = $("nextBtn");
  const speakBtn = $("speakBtn");
  const hintBtn = $("hintBtn");
  const stopBtn = $("stopBtn");

  const displayText = $("displayText");
  const msgLine = $("msgLine");
  const statusPill = $("statusPill");
  const remainPill = $("remainPill");
  const fontPill = $("fontPill");

  function setMsg(t){ msgLine.textContent = t; }
  function setStatus(t){ statusPill.textContent = t; }
  function setRemain(){
    const remain = deckReady ? Math.max(0, deck.length - (idx+1)) : 0;
    remainPill.textContent = `残り：${remain}`;
  }

  function enableAfterLoad(){
    modeSel.disabled = false;
    showSel.disabled = false;
    fontSize.disabled = false;

    gradeAllBtn.disabled = false;
    gradeNoneBtn.disabled = false;
    noAllBtn.disabled = false;
    noNoneBtn.disabled = false;

    buildBtn.disabled = false;
    resetBtn.disabled = false;
  }

  function disablePlayButtons(){
    nextBtn.disabled = true;
    speakBtn.disabled = true;
    hintBtn.disabled = true;
    stopBtn.disabled = true;
  }

  function enablePlayButtons(){
    nextBtn.disabled = false;
    speakBtn.disabled = false;
    hintBtn.disabled = false;
    stopBtn.disabled = false;
  }

  function invalidateDeck(note){
    deckReady = false;
    deck = [];
    idx = -1;
    current = null;
    setRemain();
    disablePlayButtons();
    const hint = note ? `（${note}）` : "";
    setStatus(`未作成${hint}`);
    displayText.textContent = "山札を作ってください";
    setMsg("学年/番号/モード/表示を確認して「山札を作る」を押してください。");
  }

  // =========================
  // Build checklist UI
  // =========================
  function buildChecklist(container, values, selectedSet){
    container.innerHTML = "";
    const sorted = [...values].sort((a,b)=>{
      // numeric sort if both numeric
      const na = Number(a), nb = Number(b);
      const aNum = !Number.isNaN(na) && a.trim() !== "";
      const bNum = !Number.isNaN(nb) && b.trim() !== "";
      if(aNum && bNum) return na - nb;
      return a.localeCompare(b, "ja");
    });

    sorted.forEach(v=>{
      const id = `${container.id}_${CSS.escape(v)}`.replace(/[^a-zA-Z0-9_\-]/g, "_");
      const wrap = document.createElement("label");
      wrap.className = "chk";
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = selectedSet.has(v);
      cb.addEventListener("change", ()=>{
        if(cb.checked) selectedSet.add(v);
        else selectedSet.delete(v);
        invalidateDeck("フィルタ変更");
      });
      const sp = document.createElement("span");
      sp.textContent = v;
      wrap.appendChild(cb);
      wrap.appendChild(sp);
      container.appendChild(wrap);
    });
  }

  function setAll(container, selectedSet, on){
    const inputs = container.querySelectorAll("input[type=checkbox]");
    inputs.forEach(cb=>{
      cb.checked = on;
      const v = cb.parentElement.querySelector("span")?.textContent ?? "";
      if(on) selectedSet.add(v);
      else selectedSet.delete(v);
    });
    invalidateDeck("フィルタ変更");
  }

  // =========================
  // Display update
  // =========================
  function applyFont(){
    const v = Number(fontSize.value || 84);
    document.documentElement.style.setProperty("--fontSize", v + "px");
    fontPill.textContent = `${v}pt`;
  }

  function updateDisplay(){
    if(!current){
      displayText.textContent = deckReady ? "つぎを押してください" : "山札を作ってください";
      return;
    }
    const mode = modeSel.value; // 'on' or 'kun'
    const show = showSel.value; // 'on' or 'off'

    if(show === "off"){
      // show number only (no grade)
      displayText.textContent = current.no || "";
      return;
    }
    // show card text based on mode
    displayText.textContent = (mode === "on") ? (current.onCard || "") : (current.kunCard || "");
  }

  // =========================
  // Deck build
  // =========================
  function filteredRows(){
    const gOk = selectedGrades.size > 0;
    const nOk = selectedNos.size > 0;
    if(!gOk || !nOk) return [];
    return rows.filter(r => selectedGrades.has(r.grade) && selectedNos.has(r.no));
  }

  function buildDeck(){
    stopSpeak();
    const fr = filteredRows();
    if(fr.length === 0){
      setMsg("条件に合う札がありません。学年/番号のチェックを見直してください。");
      setStatus("0件");
      deckReady = false;
      deck = [];
      idx = -1;
      current = null;
      disablePlayButtons();
      displayText.textContent = "0件";
      setRemain();
      return;
    }
    deck = shuffle(fr.slice()); // row-unit unique
    idx = -1;
    current = null;
    deckReady = true;
    enablePlayButtons();
    setStatus(`準備OK（${deck.length}枚）`);
    setMsg("「つぎ」で札を進めます。");
    setRemain();
    updateDisplay();
  }

  function resetAll(){
    stopSpeak();
    invalidateDeck("リセット");
  }

  // =========================
  // Read / Hint behavior
  // =========================
  function readMain(){
    if(!current) return;
    const mode = modeSel.value;
    if(mode === "on"){
      const t = trimOrEmpty(current.onSpeak) || trimOrEmpty(current.onCard);
      speakText(t);
    }else{
      const t = trimOrEmpty(current.kunSpeak) || trimOrEmpty(current.kunCard);
      speakText(t);
    }
  }

  function readHint(){
    if(!current) return;
    const mode = modeSel.value;
    if(mode === "on"){
      // hint: opposite = F (kunSpeak). If empty -> silent
      const t = trimOrEmpty(current.kunSpeak);
      if(!t) return; // silent
      speakText(t);
    }else{
      // hint: opposite = D (onSpeak). If empty -> silent
      const t = trimOrEmpty(current.onSpeak);
      if(!t) return; // silent
      speakText(t);
    }
  }

  
  function initFromEmbedded(){
    stopSpeak();
    rows = EMBEDDED_ROWS.slice();

    const grades = new Set(rows.map(r=>r.grade).filter(Boolean));
    const nos = new Set(rows.map(r=>r.no).filter(Boolean));

    // Default selections: all checked
    selectedGrades.clear();
    selectedNos.clear();
    grades.forEach(v=>selectedGrades.add(v));
    nos.forEach(v=>selectedNos.add(v));

    buildChecklist(gradeChecks, grades, selectedGrades);
    buildChecklist(noChecks, nos, selectedNos);

    enableAfterLoad();
    applyFont();
    invalidateDeck("内蔵データ");
    setStatus(`準備OK（${rows.length}行）`);
    setMsg("学年/番号/モード/表示を確認して「山札を作る」を押してください。");
  }

// =========================
  // Events
  // =========================

  modeSel.addEventListener("change", ()=> invalidateDeck("モード変更"));
  showSel.addEventListener("change", ()=> updateDisplay());
  fontSize.addEventListener("input", ()=> { applyFont(); });

  gradeAllBtn.addEventListener("click", ()=> setAll(gradeChecks, selectedGrades, true));
  gradeNoneBtn.addEventListener("click", ()=> setAll(gradeChecks, selectedGrades, false));
  noAllBtn.addEventListener("click", ()=> setAll(noChecks, selectedNos, true));
  noNoneBtn.addEventListener("click", ()=> setAll(noChecks, selectedNos, false));

  buildBtn.addEventListener("click", buildDeck);
  resetBtn.addEventListener("click", resetAll);

  nextBtn.addEventListener("click", ()=>{
    if(!deckReady) return;
    stopSpeak();
    idx++;
    if(idx >= deck.length){
      idx = deck.length; // clamp
      current = null;
      updateDisplay();
      setMsg("最後まで終わりました。リセット or 山札を作り直してください。");
      setStatus("終了");
      setRemain();
      return;
    }
    current = deck[idx];
    updateDisplay();
    setRemain();
    setStatus(`出題中（${idx+1}/${deck.length}）`);
  });

  speakBtn.addEventListener("click", readMain);
  hintBtn.addEventListener("click", readHint);
  stopBtn.addEventListener("click", stopSpeak);

  // initial font
  applyFont();

  // init with embedded data
  initFromEmbedded();

  // Safety: stop when leaving
  window.addEventListener("beforeunload", ()=>{ try{ speechSynthesis.cancel(); }catch(e){} });
})();
</script>
</body>
</html>
