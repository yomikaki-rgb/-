<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç†Ÿèªã¥ãã‚Šã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ </title>
<style>
  :root{
    --bg1:#eef2ff; --bg2:#f3e8ff;
    --card:#ffffffd9;
    --ink:#111827; --sub:#4b5563;
    --primary:#4f46e5; --primarySoft:#e0e7ff;
    --ok:#16a34a; --ng:#dc2626;
    --border:#d1d5db;
    --shadow:0 10px 25px rgba(0,0,0,.08);
    --radius:18px;
    --sameTileSize: 110px;
  }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  body{
    margin:0; min-height:100vh; padding:16px;
    display:flex; justify-content:center; align-items:center;
    background:linear-gradient(135deg,var(--bg1),var(--bg2));
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Hiragino Kaku Gothic ProN","Yu Gothic","Meiryo",sans-serif;
    color:var(--ink);
  }
  .app{
    width:min(1080px,100%);
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
    position:relative;
  }
  header{
    padding:16px 18px;
    border-bottom:1px solid var(--border);
    display:flex; gap:12px; align-items:center; justify-content:space-between;
    background:linear-gradient(180deg,#ffffffcc,#ffffff99);
  }
  header h1{ margin:0; font-size:18px; letter-spacing:.02em; }
  .pill{
    font-size:12px; color:var(--sub);
    background:var(--primarySoft);
    border:1px solid #c7d2fe;
    padding:6px 10px;
    border-radius:999px;
    display:inline-flex; gap:8px; align-items:center;
    white-space:nowrap;
  }
  .wrap{ padding:16px 18px 18px; display:grid; gap:14px; }

  .grid{
    display:grid;
    grid-template-columns: 1.75fr .25fr;
    gap:14px;
  }
  @media (max-width:980px){
    .grid{ grid-template-columns:1fr; }
  }

  .card{
    background:#fff;
    border:1px solid var(--border);
    border-radius:16px;
    padding:14px;
  }
  .card h2{
    margin:0 0 10px 0;
    font-size:14px;
    color:var(--sub);
    font-weight:700;
    letter-spacing:.02em;
  }

  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .row > *{ flex:0 0 auto; }

  button{
    border:1px solid var(--border);
    background:#fff;
    color:var(--ink);
    border-radius:14px;
    padding:10px 12px;
    font-weight:700;
    cursor:pointer;
    box-shadow:0 6px 16px rgba(0,0,0,.06);
  }
  button.primary{
    background:var(--primary);
    border-color:var(--primary);
    color:#fff;
  }
  button.warn{
    background:#fff7ed;
    border-color:#fed7aa;
  }
  button:disabled{ opacity:.5; cursor:not-allowed; box-shadow:none; }
  select, input{
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px 12px;
    font-weight:700;
    background:#fff;
    color:var(--ink);
  }
  input{ width:110px; }

  .sectionTitle{
    margin:14px 0 8px 0;
    font-size:15px;
    font-weight:900;
    color:var(--ink);
  }

  .tiles{
    display:grid;
    grid-template-columns: repeat(7, minmax(0, 1fr));
    gap:10px;
  }
  @media (max-width:520px){ .tiles{ grid-template-columns: repeat(3, minmax(0, 1fr)); } }

  .tile{
    user-select:none;
    border:1px solid var(--border);
    border-radius:18px;
    background:#fff;
    padding:18px 0px;
    text-align:center;
    font-size:44px;
    font-weight:900;
    line-height:1;
    box-shadow:0 10px 22px rgba(0,0,0,.07);
    cursor:pointer;
    overflow:hidden;
  }
  .tile.bad{
    animation:shake .25s linear 1;
    outline:3px solid #fecaca;
    border-color:#fecaca;
    background:#fff1f2;
  }
  @keyframes shake{
    0%{ transform:translateX(0); }
    25%{ transform:translateX(-3px); }
    50%{ transform:translateX(3px); }
    75%{ transform:translateX(-2px); }
    100%{ transform:translateX(0); }
  }

  .msg{
    margin-top:10px;
    padding:12px 14px;
    border-radius:16px;
    font-weight:900;
    font-size:16px;
    border:1px solid var(--border);
    background:#fff;
    color:var(--sub);
  }
  .msg.ok{ border-color:#bbf7d0; background:#ecfdf5; color:#166534; }
  .msg.ng{ border-color:#fecaca; background:#fff1f2; color:#991b1b; }

  .miniInfo{
    margin-top:8px;
    padding:10px 12px;
    border-radius:14px;
    border:1px dashed var(--border);
    background:#f8fafc;
    color:var(--sub);
    font-weight:900;
    display:flex;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  #missInfo{ display:none; }

  .scoreboard{
    display:flex;
    gap:8px;
    flex-wrap:nowrap;
    align-items:stretch;
  }
  .pRow{
    flex:1 1 0;
    min-width:0;
    display:flex; gap:8px; align-items:flex-start; justify-content:space-between;
    padding:6px 10px;
    border:1px solid var(--border);
    border-radius:14px; background:#fff;
  }
  .pRow .left{
    display:flex; gap:8px; align-items:center; font-weight:900;
    min-width:0;
  }
  .pRow .left span:last-child{
    font-size:12px;
    white-space:nowrap;
  }
  .pRow .pts{
    font-weight:900; color:var(--ink);
    display:flex; gap:8px; align-items:center;
    white-space:nowrap;
    font-size:12px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .pRow .ptVal{ color:var(--ng); }
  .statusTag{
    display:block;
    margin-top:2px;
    font-size:11px;
    font-weight:900;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid #fecaca;
    background:#fff1f2;
    color:#991b1b;
    white-space:nowrap;
    flex: 1 0 100%;
    text-align:right;
  }
  .statusTag.miss{
    border-color:#fed7aa;
    background:#fff7ed;
    color:#9a3412;
  }

  .dot{ width:10px; height:10px; border-radius:999px; background:#cbd5e1; }
  .pRow.active{
    border-color:#a5b4fc;
    background:#eef2ff;
    animation:activePulse 980ms ease-in-out infinite;
  }
  .pRow.active .dot{
    background:#4f46e5;
    animation:dotPulse 980ms ease-in-out infinite;
  }
  @keyframes activePulse{
    0%{ box-shadow:0 0 0 rgba(79,70,229,.0); transform:translateY(0); }
    50%{ box-shadow:0 0 0 6px rgba(79,70,229,.14); transform:translateY(-1px); }
    100%{ box-shadow:0 0 0 rgba(79,70,229,.0); transform:translateY(0); }
  }
  @keyframes dotPulse{
    0%{ transform:scale(1); opacity:.75; }
    50%{ transform:scale(1.25); opacity:1; }
    100%{ transform:scale(1); opacity:.75; }
  }

  details{ border:1px solid var(--border); border-radius:14px; overflow:hidden; background:#fff; }
  summary{
    cursor:pointer; padding:10px 12px; font-weight:900; color:var(--sub);
    list-style:none;
  }
  summary::-webkit-details-marker{ display:none; }
  .list{ padding:0 12px 12px; display:flex; gap:8px; flex-wrap:wrap; }
  .tag{
    font-size:14px;
    font-weight:900;
    color:var(--ink);
    background:#f1f5e9;
    border:1px solid #e2e8f0;
    padding:8px 12px;
    border-radius:999px;
  }
  .muted{ color:var(--sub); }

  /* å³å´ã®è¨­å®šè¡Œï¼šæ”¹è¡Œã—ãªã„ */
  #rightSide .settingRow{
    flex-wrap:nowrap;
    align-items:center;
  }
  #rightSide .settingRow label{
    white-space:nowrap;
    flex:0 0 auto;
  }
  #rightSide .settingRow select,
  #rightSide .settingRow input{
    white-space:nowrap;
    flex:1 1 auto;
    min-width:0;
  }

  /* å¼•ã„ãŸæœ­ / é †ç•ªã‚’æ±ºã‚ã¦ä½œã‚‹ */
  .drawPickGrid{
    display:grid;
    grid-template-columns: minmax(240px, 0.70fr) minmax(0, 1.30fr);
    gap:4px;
    align-items:start;
    margin-top:6px;
  }
  .drawPickCol{ min-width:0; }
  .drawPickCol .sectionTitle{ margin-top:0; }

  .pickPanel{
    display:flex; gap:12px; align-items:center;
    flex-wrap:nowrap;
    overflow:visible;
    background:#fff; border:1px solid var(--border);
    border-radius:18px; padding:14px;
    box-shadow:0 10px 22px rgba(0,0,0,.07);
    min-width:0;
  }

  .slotWrap{ display:flex; gap:8px; align-items:center; min-width:0; }
  .slotLabel{ font-size:14px; color:var(--sub); font-weight:900; }

  .slot{
    width:var(--sameTileSize); height:var(--sameTileSize);
    border-radius:18px;
    border:1px solid var(--border);
    background:#f8fafc;
    display:grid; place-items:center;
    font-size:44px; font-weight:900;
    cursor:pointer;
    user-select:none;
    overflow:hidden;
    flex:0 0 auto;
  }
  .slot.filled{ background:#fff; }

  .eq{ font-weight:900; color:var(--sub); font-size:20px; flex:0 0 auto; }

  .wordBox{
    min-width:120px;
    padding:14px 16px;
    border-radius:18px;
    border:1px solid var(--border);
    background:#fff;
    font-weight:900;
    font-size:28px;
    text-align:center;
    flex:1 1 auto;
    white-space:nowrap;
  }

  .chip{
    border:1px solid var(--border);
    background:#fff;
    border-radius:999px;
    padding:10px 14px;
    font-weight:900;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:10px;
    box-shadow:0 6px 16px rgba(0,0,0,.06);
  }
  .chip .mini{
    width:var(--sameTileSize); height:var(--sameTileSize);
    display:grid; place-items:center;
    border-radius:18px;
    border:1px solid var(--border);
    font-size:44px;
    font-weight:900;
    background:#f8fafc;
    line-height:1;
    overflow:hidden;
  }
  .chip:disabled{ opacity:.5; cursor:not-allowed; box-shadow:none; }

  .speakBtn{
    margin:10px 12px 0;
    display:inline-flex;
    align-items:center;
    gap:8px;
    font-weight:900;
  }

  .ansSpeakWrap{
    margin-top:10px;
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }
  .ansSpeakBtn{
    display:none;
    align-items:center;
    gap:8px;
    font-weight:900;
    border-color:#c7d2fe;
    background:#eef2ff;
  }
  .ansInfo{
    display:none;
    width:100%;
    padding:12px 14px;
    border-radius:16px;
    border:1px solid #c7d2fe;
    background:#eef2ff;
    font-weight:900;
    color:#111827;
    line-height:1.6;
  }
  .ansInfo .sub{ color:var(--sub); font-weight:900; }

  ruby rt{ font-size:10px; color:var(--sub); font-weight:900; }

  .settings{ display:grid; gap:10px; margin-bottom:10px; }
  .settingRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .settingRow label{ font-weight:900; }

  .kusudamaOverlay{
    position:absolute; inset:0;
    background:rgba(17,24,39,.25);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:50;
  }
  .kusudama{
    width:min(520px,86vw);
    height:min(360px,60vh);
    position:relative;
  }
  .rope{
    position:absolute; left:50%; top:0;
    width:3px; height:120px;
    transform:translateX(-50%);
    background:rgba(255,255,255,.8);
    border-radius:999px;
  }
  .ball{
    position:absolute; left:50%; top:105px;
    width:240px; height:240px;
    transform:translateX(-50%);
    border-radius:999px;
    border:2px solid rgba(255,255,255,.8);
    background:rgba(255,255,255,.2);
    box-shadow:0 18px 40px rgba(0,0,0,.25);
    overflow:hidden;
  }
  .half{
    position:absolute; top:0; bottom:0;
    width:50%;
    background:rgba(255,255,255,.55);
    border:1px solid rgba(255,255,255,.75);
    backdrop-filter: blur(2px);
  }
  .half.left{ left:0; border-right:none; }
  .half.right{ right:0; border-left:none; }
  .knot{
    position:absolute; left:50%; top:50%;
    width:26px; height:26px;
    transform:translate(-50%,-50%);
    border-radius:10px;
    background:rgba(255,255,255,.85);
    border:1px solid rgba(255,255,255,.9);
  }
  .banner{
    position:absolute; left:50%; top:355px;
    transform:translateX(-50%);
    padding:10px 14px;
    border-radius:16px;
    background:rgba(255,255,255,.92);
    border:1px solid rgba(255,255,255,.9);
    font-weight:900;
    color:#111827;
    box-shadow:0 10px 24px rgba(0,0,0,.18);
    text-align:center;
    min-width:260px;
  }
  .streamers{
    position:absolute; left:50%; top:220px;
    width:1px; height:1px;
    transform:translateX(-50%);
    pointer-events:none;
  }
  .streamer{
    position:absolute; left:0; top:0;
    width:10px; height:140px;
    border-radius:999px;
    opacity:.95;
    transform-origin: top center;
    animation:fall 1100ms ease-out forwards;
  }
  @keyframes fall{
    0%{ transform:translate(-50%,0) rotate(var(--r)) scaleY(.2); opacity:0; }
    25%{ opacity:1; }
    100%{ transform:translate(calc(-50% + var(--x)), 190px) rotate(calc(var(--r) * 1.2)) scaleY(1); opacity:0; }
  }
  .kusudama.burst .ball .half.left{ animation:openL 520ms ease-out forwards; }
  .kusudama.burst .ball .half.right{ animation:openR 520ms ease-out forwards; }
  @keyframes openL{ to{ transform:translateX(-110px) rotate(-18deg); } }
  @keyframes openR{ to{ transform:translateX(110px) rotate(18deg); } }

  .kWrap{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:2px;
    line-height:1;
    padding:0;
    max-width:100%;
  }
  .kOn, .kKun{
    font-size:9px;
    font-weight:900;
    color:var(--sub);
    white-space:normal;
    text-align:center;
    line-height:1.05;
    word-break:break-word;
    overflow-wrap:anywhere;
    max-width:100%;
  }
  .kCore{
    font-size:44px;
    font-weight:900;
    color:var(--ink);
    line-height:1;
  }
  .slot .kOn, .slot .kKun{ font-size:8px; line-height:1.05; }
  .slot .kCore{ font-size:34px; }
  .chip .mini .kOn, .chip .mini .kKun{ font-size:8px; line-height:1.05; }
  .chip .mini .kCore{ font-size:42px; }
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <h1>ç†Ÿèªã¥ãã‚Šã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ </h1>
    <div class="pill" id="topPill">æº–å‚™ä¸­</div>
  </header>

  <div class="wrap">
    <div class="grid">
      <div class="card" id="leftPlay">

        <div class="scoreboard" id="scoreboard"></div>
        <div class="msg ok" id="winMsg" style="display:none;"></div>

        <div class="row" style="margin-bottom:12px; margin-top:12px;">
          <button class="primary" id="drawBtn">ï¼‘ã¾ã„å¼•ã</button>
          <button id="checkBtn">ã§ããŸï¼</button>
          <button id="endBtn"><ruby>ç•ª<rt>ã°ã‚“</rt></ruby>ã‚’<ruby>çµ‚<rt>ãŠ</rt></ruby>ãˆã‚‹</button>

          <button id="addFieldBtn" class="warn" style="display:none;">
            <ruby>å ´æœ­<rt>ã°ãµã </rt></ruby>ã‚’<ruby>è¿½åŠ <rt>ã¤ã„ã‹</rt></ruby>ã™ã‚‹
          </button>

          <button class="warn" id="skipNextBtn" style="display:none;">ã¤ãã¸</button>
        </div>

        <div class="sectionTitle"><ruby>å ´æœ­<rt>ã°ãµã </rt></ruby></div>
        <div class="tiles" id="field"></div>

        <div class="drawPickGrid">
          <div class="drawPickCol">
            <div class="sectionTitle"><ruby>å¼•<rt>ã²</rt></ruby>ã„ãŸ<ruby>æœ­<rt>ãµã </rt></ruby>ï¼ˆã‚¿ãƒƒãƒ—ã§â‘ â‘¡ã¸ï¼‰</div>
            <div class="row" style="gap:10px; margin-bottom:10px;">
              <button class="chip" id="drawChip" type="button" disabled>
                <span class="muted"><ruby>å¼•æœ­<rt>ã²ããµã </rt></ruby></span>
                <span class="mini" id="drawMini">â€”</span>
                <span class="muted">â†’â‘ â‘¡</span>
              </button>
            </div>
          </div>

          <div class="drawPickCol">
            <div class="sectionTitle"><ruby>é †ç•ª<rt>ã˜ã‚…ã‚“ã°ã‚“</rt></ruby>ã‚’<ruby>æ±º<rt>ã</rt></ruby>ã‚ã¦<ruby>ä½œ<rt>ã¤ã</rt></ruby>ã‚‹</div>
            <div class="pickPanel">
              <div class="slotWrap">
                <div class="slotLabel">â‘ </div>
                <div class="slot" id="slot1" title="ã‚¿ãƒƒãƒ—ã§æ¶ˆã™">â€”</div>
              </div>
              <div class="eq">â†’</div>
              <div class="slotWrap">
                <div class="slotLabel">â‘¡</div>
                <div class="slot" id="slot2" title="ã‚¿ãƒƒãƒ—ã§æ¶ˆã™">â€”</div>
              </div>
              <div class="eq">=</div>
              <div class="wordBox" id="wordBox">â€”</div>
            </div>
          </div>
        </div>

        <div class="msg" id="msg">ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã™ã¨é–‹å§‹ã—ã¾ã™ã€‚</div>

        <div class="ansSpeakWrap" id="ansSpeakWrap">
          <button class="ansSpeakBtn" id="ansSpeakBtn" type="button" aria-label="æ­£ç­”ã®èª­ã¿ã¨æ„å‘³ã‚’ã‚ˆã¿ã‚ã’">
            ğŸ”Š ã‚ˆã¿ãƒ»ã„ã¿ãƒ»ã‚Œã„ã¶ã‚“
          </button>
          <div class="ansInfo" id="ansInfo" aria-live="polite"></div>
        </div>

        <div class="miniInfo" id="missInfo">
          <div>ãƒŸã‚¹</div>
          <div id="missCount">â€”</div>
        </div>

        <details style="margin-top:12px;" open>
          <summary><ruby>ã§ããŸ</ruby>ã˜ã‚…ã<ruby>èª<rt>ã”</rt></ruby>ï¼ˆ<ruby>åŒ<rt>ãŠãª</rt></ruby>ã˜<ruby>ç†Ÿèª<rt>ã˜ã‚…ãã”</rt></ruby>ã¯1<ruby>å›<rt>ã‹ã„</rt></ruby>ã¾ã§ï¼‰</summary>
          <div class="list" id="madeList"></div>
        </details>
      </div>

      <div class="card" id="rightSide">
        <!-- URLä½œæˆ -->
        <div id="roomMaker" class="card" style="padding:12px; margin-bottom:12px;">
          <h2 style="margin:0 0 8px 0;">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ãƒªãƒ³ã‚¯ä½œæˆ</h2>

          <div class="row" style="gap:8px;">
            <input id="roomInput" placeholder="éƒ¨å±‹ç•ªå·ï¼ˆä¾‹: class1ï¼‰" style="width:160px;">
            <button id="makeRoomUrlBtn" type="button">URLä½œæˆ</button>
          </div>

          <div style="margin-top:8px; font-size:12px; font-weight:900; color:var(--sub);">
            ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ç”¨ï¼š
            <input id="urlP1" style="width:100%; margin-top:4px;">
          </div>

          <div style="margin-top:8px; font-size:12px; font-weight:900; color:var(--sub);">
            ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ç”¨ï¼š
            <input id="urlP2" style="width:100%; margin-top:4px;">
          </div>
        </div>

        <div class="settings">
          <!-- â˜…ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ãƒªãƒ³ã‚¯ä½œæˆï¼ˆã“ã“ã‹ã‚‰è¿½åŠ ï¼‰ -->
<div id="roomMaker" style="margin:8px 0; padding:10px; border:1px solid var(--border); border-radius:14px; background:#fff;">
  <div style="font-weight:900; margin-bottom:8px;">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ãƒªãƒ³ã‚¯ä½œæˆ</div>

  <div class="settingRow" style="gap:8px;">
    <label class="muted">éƒ¨å±‹</label>
    <input id="roomInput" placeholder="ä¾‹: class1" style="width:140px;">
    <button id="makeRoomUrlBtn" type="button">URLä½œæˆ</button>
  </div>

  <div style="margin-top:8px; font-size:12px; color:var(--sub); font-weight:800;">
    ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ç”¨ï¼š
    <div class="row" style="gap:6px; margin-top:4px;">
      <input id="urlP1" style="width:100%;" readonly>
      <button id="copyP1" type="button">ã‚³ãƒ”ãƒ¼</button>
    </div>

    <div style="height:6px;"></div>

    ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ç”¨ï¼š
    <div class="row" style="gap:6px; margin-top:4px;">
      <input id="urlP2" style="width:100%;" readonly>
      <button id="copyP2" type="button">ã‚³ãƒ”ãƒ¼</button>
    </div>
  </div>

  <div style="margin-top:8px; font-size:12px; color:var(--sub); font-weight:800;">
    â€» 3äºº/4äººã§éŠã¶å ´åˆï¼šURLã®æœ€å¾Œã‚’ <b>&me=3</b> / <b>&me=4</b> ã«å¤‰ãˆã¾ã™
  </div>
</div>
<!-- â˜…ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ãƒªãƒ³ã‚¯ä½œæˆï¼ˆã“ã“ã¾ã§è¿½åŠ ï¼‰ -->

          <div class="settingRow">
            <label class="muted">å‡ºé¡Œ</label>
            <select id="gradeSelect" title="å‡ºé¡Œã™ã‚‹æ¼¢å­—">
              <option value="g1">1å¹´ã®æ¼¢å­—</option>
              <option value="g2">2å¹´ã®æ¼¢å­—</option>
              <option value="g12">1ï¼Œ2å¹´ã®æ¼¢å­—</option>
              <option value="g3">3å¹´ã®æ¼¢å­—</option>
              <option value="g123">1ãƒ»2ãƒ»3å¹´ã®æ¼¢å­—</option>
            </select>
          </div>

          <div class="settingRow">
            <label class="muted">èª­ã¿è¡¨ç¤º</label>
            <select id="readingToggle" title="éŸ³èª­ã¿ãƒ»è¨“èª­ã¿ã®è¡¨ç¤º">
              <option value="on" selected>ã‚ã‚‹</option>
              <option value="off">ãªã—</option>
            </select>
          </div>

          <div class="settingRow">
            <label class="muted">äººæ•°</label>
            <select id="playerCount">
              <option value="2">2äºº</option>
              <option value="3">3äºº</option>
              <option value="4">4äºº</option>
            </select>
          </div>

          <div class="settingRow">
            <label class="muted">å‹åˆ©ãƒã‚¤ãƒ³ãƒˆ</label>
            <input id="targetPoints" type="number" min="1" step="1" value="5"/>
          </div>

          <div class="settingRow">
            <label class="muted">ãƒŸã‚¹ã§ä¼‘ã¿</label>
            <select id="missLimit" title="ã“ã®å›æ•°ã€Œãã®è¨€è‘‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€ã§1å›ä¼‘ã¿">
              <option value="2">2å›</option>
              <option value="3" selected>3å›</option>
              <option value="4">4å›</option>
              <option value="5">5å›</option>
              <option value="6">6å›</option>
              <option value="7">7å›</option>
              <option value="8">8å›</option>
            </select>
          </div>

          <div class="settingRow" style="flex-direction:column; align-items:flex-start;">
            <button class="primary" id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            <button id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
        </div>

        <details id="rules" style="margin-top:12px;">
          <summary><ruby>éŠã³æ–¹<rt>ã‚ãã³ã‹ãŸ</rt></ruby></summary>

          <div class="row" style="padding:0 12px 0;">
            <button class="speakBtn" id="speakBtn" type="button">â–¶ ã‚ˆã¿ã‚ã’</button>
            <button class="speakBtn" id="stopSpeakBtn" type="button">â–  ã¨ã‚ã‚‹</button>
          </div>

          <div id="ruleText" style="padding:10px 12px 12px; color:var(--sub); font-weight:800; line-height:1.75;">
            <div>ãƒ»<ruby>æœ€åˆ<rt>ã•ã„ã—ã‚‡</rt></ruby>ã«<ruby>å ´æœ­<rt>ã°ãµã </rt></ruby>ãŒ6<ruby>æš<rt>ã¾ã„</rt></ruby><ruby>å‡º<rt>ã§</rt></ruby>ã¾ã™ã€‚</div>
            <div>ãƒ»<ruby>è‡ªåˆ†<rt>ã˜ã¶ã‚“</rt></ruby>ã®<ruby>ç•ª<rt>ã°ã‚“</rt></ruby>ã§ã¯ã€<ruby>å¿…<rt>ã‹ãªã‚‰</rt></ruby>ãš<ruby>å±±æœ­<rt>ã‚„ã¾ãµã </rt></ruby>ã‹ã‚‰1<ruby>æš<rt>ã¾ã„</rt></ruby><ruby>å¼•<rt>ã²</rt></ruby>ãã¾ã™ï¼ˆ1<ruby>å›<rt>ã‹ã„</rt></ruby>ã ã‘ï¼‰ã€‚</div>
            <div>ãƒ»â‘ â‘¡ã®<ruby>æ <rt>ã‚ã</rt></ruby>ã«ã€<ruby>å ´æœ­<rt>ã°ãµã </rt></ruby>ã©ã†ã—ã€ã¾ãŸã¯ã€<ruby>å¼•æœ­<rt>ã²ããµã </rt></ruby>ï¼‹<ruby>å ´æœ­<rt>ã°ãµã </rt></ruby>ã‚’ã‚¿ãƒƒãƒ—ã—ã¦<ruby>å…¥<rt>ã„</rt></ruby>ã‚Œã¾ã™ã€‚</div>
            <div>ãƒ»ã§ããŸã‚‰ã€Œã§ããŸï¼ã€ã‚’ã‚¿ãƒƒãƒ—ã—ã¾ã™ã€‚<ruby>æ­£ç­”<rt>ã›ã„ã¨ã†</rt></ruby>ãªã‚‰1ãƒã‚¤ãƒ³ãƒˆã€‚</div>
            <div>ãƒ»<ruby>ä½œ<rt>ã¤ã</rt></ruby>ã‚Œãªã‹ã£ãŸã¨ãã¯ã€<ruby>å¼•<rt>ã²</rt></ruby>ã„ãŸ<ruby>æœ­<rt>ãµã </rt></ruby>ã¯<ruby>å ´æœ­<rt>ã°ãµã </rt></ruby>ã«<ruby>ä¸¦<rt>ãªã‚‰</rt></ruby>ã³ã€<ruby>å ´æœ­<rt>ã°ãµã </rt></ruby>ãŒã©ã‚“ã©ã‚“<ruby>å¢—<rt>ãµ</rt></ruby>ãˆã¾ã™ã€‚</div>
            <div>ãƒ»<ruby>å ´æœ­<rt>ã°ãµã </rt></ruby>ãŒ3<ruby>æš<rt>ã¾ã„</rt></ruby><ruby>ä»¥ä¸‹<rt>ã„ã‹</rt></ruby>ã«ãªã£ãŸã‚‰ã€ã€Œ<ruby>å ´æœ­<rt>ã°ãµã </rt></ruby>ã‚’<ruby>è¿½åŠ <rt>ã¤ã„ã‹</rt></ruby>ã™ã‚‹ã€ã®ãƒœã‚¿ãƒ³ã§<ruby>æœ­<rt>ãµã </rt></ruby>ã‚’<ruby>è¿½åŠ <rt>ã¤ã„ã‹</rt></ruby>ã§ãã¾ã™ã€‚</div>
            <div>ãƒ»<ruby>ç•ª<rt>ã°ã‚“</rt></ruby>ã‚’<ruby>çµ‚<rt>ãŠ</rt></ruby>ãˆã‚‹ã¨ãã€<ruby>æ‰‹å…ƒ<rt>ã¦ã‚‚ã¨</rt></ruby>ã«<ruby>æ®‹<rt>ã®ã“</rt></ruby>ã£ãŸ<ruby>å¼•æœ­<rt>ã²ããµã </rt></ruby>ã‚‚<ruby>å ´æœ­<rt>ã°ãµã </rt></ruby>ã¸<ruby>è¿½åŠ <rt>ã¤ã„ã‹</rt></ruby>ã•ã‚Œã¾ã™ã€‚</div>
            <div>ãƒ»<ruby>ç›®æ¨™<rt>ã‚‚ãã²ã‚‡ã†</rt></ruby>ãƒã‚¤ãƒ³ãƒˆã«<ruby>é”<rt>ãŸã£</rt></ruby>ã—ãŸ<ruby>äºº<rt>ã²ã¨</rt></ruby>ãŒ<ruby>å‹<rt>ã‹</rt></ruby>ã¡ï¼ˆ<ruby>è¨­å®š<rt>ã›ã£ã¦ã„</rt></ruby>ã§<ruby>å¤‰æ›´<rt>ã¸ã‚“ã“ã†</rt></ruby>ã§ãã¾ã™ï¼‰ã€‚</div>
            <div>ãƒ»1ã‚¿ãƒ¼ãƒ³ã§ã€Œãã®<ruby>è¨€è‘‰<rt>ã“ã¨ã°</rt></ruby>ã¯ã‚ã‚Šã¾ã›ã‚“ã€ãŒ<ruby>è¨­å®š<rt>ã›ã£ã¦ã„</rt></ruby><ruby>å›æ•°<rt>ã‹ã„ã™ã†</rt></ruby><ruby>å‡º<rt>ã§</rt></ruby>ãŸã‚‰ã€æ¬¡ã®<ruby>è‡ªåˆ†<rt>ã˜ã¶ã‚“</rt></ruby>ã®<ruby>ç•ª<rt>ã°ã‚“</rt></ruby>ã¯1<ruby>å›<rt>ã‹ã„</rt></ruby><ruby>ä¼‘<rt>ã‚„ã™</rt></ruby>ã¿ã§ã™ã€‚ã€Œã¤ãã¸ã€ã§<ruby>é€²<rt>ã™ã™</rt></ruby>ã¿ã¾ã™ã€‚</div>
          </div>
        </details>
      </div>
    </div>
  </div>

  <div class="kusudamaOverlay" id="kusudamaOverlay" aria-hidden="true">
    <div class="kusudama" id="kusudama">
      <div class="rope"></div>
      <div class="ball">
        <div class="half left"></div>
        <div class="half right"></div>
        <div class="knot"></div>
      </div>
      <div class="streamers" id="streamers"></div>
      <div class="banner" id="kusudamaBanner">ãŠã‚ã§ã¨ã†ï¼</div>
    </div>
  </div>
</div>

<!-- â˜…URLä½œæˆã¯ module ã‹ã‚‰åˆ†é›¢ï¼šã“ã“ã¯å¿…ãšå‹•ãä¿é™º -->
<script>
(() => {
  const roomInput = document.getElementById("roomInput");
  const makeRoomUrlBtn = document.getElementById("makeRoomUrlBtn");
  const urlP1 = document.getElementById("urlP1");
  const urlP2 = document.getElementById("urlP2");

  if(!makeRoomUrlBtn) return;

  makeRoomUrlBtn.addEventListener("click", () => {
    const room = (roomInput?.value || "").trim();
    if(!room){
      alert("éƒ¨å±‹ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }
    const base = location.origin + location.pathname;
    urlP1.value = `${base}?room=${encodeURIComponent(room)}&p=0`;
    urlP2.value = `${base}?room=${encodeURIComponent(room)}&p=1`;
  });
})();
</script>

<script type="module">
// ============================
// Part 2 / 3ï¼ˆã“ã®ã¾ã¾ç¶šãã«è²¼ã‚‹ï¼‰
// ============================

  // ============================
  // â˜…ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ï¼šFirebase åˆæœŸåŒ–
  // ============================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getDatabase, ref, set, update, onValue, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

  // â˜…ã‚ãªãŸã® Firebase è¨­å®šã«ç½®ãæ›ãˆ
  // ï¼ˆã™ã§ã«æŒã£ã¦ã„ã‚‹ const FIREBASE_CONFIG = {...} ã‚’è²¼ã‚Šæ›¿ãˆã‚Œã°OKï¼‰
  // â€»ã“ã“ãŒç©ºã ã¨ä½•ã‚‚å‹•ã‹ãªã„ã®ã§æ³¨æ„
  const FIREBASE_CONFIG = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
    projectId: "YOUR_PROJECT",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "000000000000",
    appId: "1:000000000000:web:xxxxxxxxxxxxxxxxxxxxxx"
  };

  const app = initializeApp(FIREBASE_CONFIG);
  const db  = getDatabase(app);

  // ============================
  // â˜…URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
  // ============================
  const qs = new URLSearchParams(location.search);
  const ROOM = (qs.get("room") || "").trim();
  const MY_P = Number(qs.get("p") || "0"); // 0 or 1ï¼ˆåŸºæœ¬2äººå¯¾æˆ¦æƒ³å®šï¼‰

  // ROOMãŒç„¡ã‘ã‚Œã°ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆéã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼‰ã¨ã—ã¦å‹•ã‹ã™
  const ONLINE = {
    enabled: !!ROOM,
    suppress: false,
    lastRev: 0
  };

  function roomRef(){ return ref(db, `rooms/${ROOM}`); }
  function stateRef(){ return ref(db, `rooms/${ROOM}/state`); }
  function metaRef(){  return ref(db, `rooms/${ROOM}/meta`); }

  // ============================
  // UIå–å¾—
  // ============================
  const topPill = document.getElementById("topPill");
  const fieldEl = document.getElementById("field");
  const msgEl   = document.getElementById("msg");
  const winMsg  = document.getElementById("winMsg");
  const madeList= document.getElementById("madeList");

  const drawBtn   = document.getElementById("drawBtn");
  const checkBtn  = document.getElementById("checkBtn");
  const endBtn    = document.getElementById("endBtn");
  const addFieldBtn = document.getElementById("addFieldBtn");
  const skipNextBtn = document.getElementById("skipNextBtn");

  const drawChip = document.getElementById("drawChip");
  const drawMini = document.getElementById("drawMini");

  const slot1 = document.getElementById("slot1");
  const slot2 = document.getElementById("slot2");
  const wordBox = document.getElementById("wordBox");

  const gradeSelect = document.getElementById("gradeSelect");
  const readingToggle = document.getElementById("readingToggle");
  /* =========================
  â˜…ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ãƒªãƒ³ã‚¯ä½œæˆï¼šURLç”Ÿæˆï¼†ã‚³ãƒ”ãƒ¼
  - è¦ç´ å–å¾—ã®ç›´å¾Œã«ç½®ãï¼ˆé–¢æ•°ã®ä¸­ã«å…¥ã‚Œãªã„ï¼‰
========================= */
const roomInput = document.getElementById("roomInput");
const makeRoomUrlBtn = document.getElementById("makeRoomUrlBtn");
const urlP1 = document.getElementById("urlP1");
const urlP2 = document.getElementById("urlP2");
const copyP1 = document.getElementById("copyP1");
const copyP2 = document.getElementById("copyP2");

function buildRoomUrl(roomId, me){
  const base = location.origin + location.pathname;
  return `${base}?room=${encodeURIComponent(roomId)}&me=${me}`;
}

function copyText(v){
  if(!v) return;
  if(navigator.clipboard?.writeText){
    navigator.clipboard.writeText(v)
      .then(()=> setMsg("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚","ok"))
      .catch(()=> fallbackCopy(v));
  }else{
    fallbackCopy(v);
  }
}

function fallbackCopy(v){
  const tmp = document.createElement("textarea");
  tmp.value = v;
  tmp.style.position = "fixed";
  tmp.style.left = "-9999px";
  document.body.appendChild(tmp);
  tmp.select();
  try{
    document.execCommand("copy");
    setMsg("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚","ok");
  }catch(e){
    setMsg("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚","ng");
  }
  document.body.removeChild(tmp);
}

if(makeRoomUrlBtn){
  makeRoomUrlBtn.addEventListener("click", ()=>{
    const id = (roomInput?.value || "").trim();
    if(!id){
      setMsg("éƒ¨å±‹ç•ªå·ã‚’å…¥ã‚Œã¦ãã ã•ã„ï¼ˆä¾‹: class1ï¼‰ã€‚","ng");
      return;
    }
    const u1 = buildRoomUrl(id, 1);
    const u2 = buildRoomUrl(id, 2);
    if(urlP1) urlP1.value = u1;
    if(urlP2) urlP2.value = u2;
    setMsg("URLã‚’ä½œæˆã—ã¾ã—ãŸã€‚ã‚³ãƒ”ãƒ¼ã—ã¦ç›¸æ‰‹ã«é€ã£ã¦ãã ã•ã„ã€‚","ok");
  });
}

if(copyP1) copyP1.addEventListener("click", ()=> copyText(urlP1?.value || ""));
if(copyP2) copyP2.addEventListener("click", ()=> copyText(urlP2?.value || ""));

  const playerCountSel = document.getElementById("playerCount");
  const targetPointsInput = document.getElementById("targetPoints");
  const missLimitSel = document.getElementById("missLimit");

  const startBtn = document.getElementById("startBtn");
  const resetBtn = document.getElementById("resetBtn");

  const scoreboard = document.getElementById("scoreboard");

  const kusudamaOverlay = document.getElementById("kusudamaOverlay");
  const kusudama = document.getElementById("kusudama");
  const streamersEl = document.getElementById("streamers");
  const kusudamaBanner = document.getElementById("kusudamaBanner");

  const missInfo = document.getElementById("missInfo");
  const missCountEl = document.getElementById("missCount");

  const speakBtn = document.getElementById("speakBtn");
  const stopSpeakBtn = document.getElementById("stopSpeakBtn");

  const ansSpeakWrap = document.getElementById("ansSpeakWrap");
  const ansSpeakBtn = document.getElementById("ansSpeakBtn");
  const ansInfo = document.getElementById("ansInfo");

  // ============================
  // çŠ¶æ…‹ï¼ˆåŒæœŸå¯¾è±¡ï¼‰
  // ============================
  let state = {
    started: false,
    settings: {
      grade: "g12",
      reading: "on",
      playerCount: 2,
      targetPoints: 5,
      missLimit: 3
    },
    turn: {
      current: 0,
      missStreak: [0,0,0,0],
      missSkip:   [0,0,0,0], // 1ãªã‚‰æ¬¡ã®è‡ªåˆ†ç•ªã¯ä¼‘ã¿
    },
    points: [0,0,0,0],
    deck: [],            // å±±æœ­ï¼ˆæœ­IDé…åˆ—ï¼‰
    field: [],           // å ´æœ­ï¼ˆæœ­IDé…åˆ—ï¼‰
    drawn: null,         // å¼•ã„ãŸæœ­ID
    slots: [null, null], // â‘ â‘¡ã«å…¥ã£ãŸæœ­ID
    made: [],            // ä½œã‚ŒãŸç†Ÿèªã®å±¥æ­´ï¼ˆæ–‡å­—åˆ—ï¼‰
    usedWords: {},       // 1å›ã¾ã§ãƒ«ãƒ¼ãƒ«ç”¨
    lastResult: null,    // { ok:boolean, word:string, reason?:string }
    winner: null,        // å‹è€…index
    kusudamaRev: 0       // ãã™ç‰ã‚¤ãƒ™ãƒ³ãƒˆç”¨
  };

  // å—ä¿¡å´ã®ãã™ç‰revï¼ˆæœªå®£è¨€ã ã¨ReferenceErrorã§moduleãŒè½ã¡ã‚‹ï¼‰
  let lastKusudamaRev = 0;

  // ============================
  // â˜…ãƒ‡ãƒ¼ã‚¿ï¼ˆæ•‘å‡ºç‰ˆï¼šæœ€å°ã‚µãƒ³ãƒ—ãƒ«ï¼‰
  // æœ¬ç•ªã®å¤§ãã„æ¼¢å­—/ç†ŸèªDBã‚’æŒã£ã¦ã„ã‚‹ãªã‚‰ã€ã“ã“ã‚’å·®ã—æ›¿ãˆã¦OK
  // ============================
  // æœ­ID â†’ è¡¨ç¤ºæƒ…å ±
  // id: {k:"æ¼¢å­—", on:"ã‚ªãƒ³", kun:"ãã‚“"}
  const TILE_DB = {
    // 1å¹´ä¾‹
    "g1_1": {k:"å±±", on:"ã‚µãƒ³", kun:"ã‚„ã¾"},
    "g1_2": {k:"å·", on:"ã‚»ãƒ³", kun:"ã‹ã‚"},
    "g1_3": {k:"æœ¨", on:"ãƒœã‚¯ ãƒ¢ã‚¯", kun:"ã"},
    "g1_4": {k:"ç”°", on:"ãƒ‡ãƒ³", kun:"ãŸ"},
    "g1_5": {k:"å£", on:"ã‚³ã‚¦ ã‚¯", kun:"ãã¡"},
    "g1_6": {k:"ç›®", on:"ãƒ¢ã‚¯", kun:"ã‚"},
    "g1_7": {k:"æ‰‹", on:"ã‚·ãƒ¥", kun:"ã¦"},
    "g1_8": {k:"è¶³", on:"ã‚½ã‚¯", kun:"ã‚ã—"},

    // 2å¹´ä¾‹
    "g2_1": {k:"æµ·", on:"ã‚«ã‚¤", kun:"ã†ã¿"},
    "g2_2": {k:"é¢¨", on:"ãƒ•ã‚¦", kun:"ã‹ãœ"},
    "g2_3": {k:"ç¤¾", on:"ã‚·ãƒ£", kun:"ã‚„ã—ã‚"},
    "g2_4": {k:"ä¼š", on:"ã‚«ã‚¤", kun:"ã‚ã†"},
    "g2_5": {k:"å›³", on:"ã‚º ãƒˆ", kun:"ã¯ã‹ã‚‹"},
    "g2_6": {k:"æ›¸", on:"ã‚·ãƒ§", kun:"ã‹ã"},
    "g2_7": {k:"æ€", on:"ã‚·", kun:"ãŠã‚‚ã†"},
    "g2_8": {k:"è¨€", on:"ã‚²ãƒ³ ã‚´ãƒ³", kun:"ã„ã†"},

    // 3å¹´ä¾‹
    "g3_1": {k:"æ¼¢", on:"ã‚«ãƒ³", kun:""},
    "g3_2": {k:"å­—", on:"ã‚¸", kun:"ã‚ã–"},
    "g3_3": {k:"æ—…", on:"ãƒªãƒ§", kun:"ãŸã³"},
    "g3_4": {k:"åŒ»", on:"ã‚¤", kun:""},
    "g3_5": {k:"è€…", on:"ã‚·ãƒ£", kun:"ã‚‚ã®"},
    "g3_6": {k:"å±€", on:"ã‚­ãƒ§ã‚¯", kun:""},
  };

  // ç†Ÿèªåˆ¤å®šï¼ˆæ•‘å‡ºç‰ˆï¼šæœ€å°ï¼‰
  // "å±±"+"å·" ã§ "å±±å·" OK ãªã©ï¼ˆé †ç•ªã¯â‘ â†’â‘¡å›ºå®šï¼‰
  const WORD_SET = new Set([
    "å±±å·","å±±ç”°","æ‰‹å£","ç›®ç‰","è¶³å…ƒ",
    "æµ·é¢¨","ç¤¾ä¼š","å›³æ›¸","æ€è€ƒ","è¨€èª",
    "æ¼¢å­—","æ—…äºº","åŒ»è€…","å±€é•·"
  ]);

  // èª­ã¿ãƒ»æ„å‘³ï¼ˆæ•‘å‡ºç‰ˆï¼šæœ€å°ï¼‰
  const WORD_INFO = {
    "å±±å·": { yomi:"ã‚µãƒ³ã‚»ãƒ³ / ã‚„ã¾ã‹ã‚", imi:"å±±ã¨å·", rei:"å±±å·ã«ãã£ã¦æ­©ãã€‚"},
    "ç¤¾ä¼š": { yomi:"ã‚·ãƒ£ã‚«ã‚¤", imi:"äººãŒé›†ã¾ã£ã¦ãã‚‰ã™ã—ãã¿", rei:"ç¤¾ä¼šã®ãƒ«ãƒ¼ãƒ«ã‚’ã¾ã‚‚ã‚‹ã€‚"},
    "æ¼¢å­—": { yomi:"ã‚«ãƒ³ã‚¸", imi:"æ—¥æœ¬èªã§ä½¿ã†æ–‡å­—ã®ä¸€ã¤", rei:"æ¼¢å­—ã‚’ãŠã¼ãˆã‚‹ã€‚"},
    "åŒ»è€…": { yomi:"ã‚¤ã‚·ãƒ£", imi:"ç—…æ°—ã‚’ã¿ã¦ãã‚Œã‚‹äºº", rei:"åŒ»è€…ã«ã¿ã¦ã‚‚ã‚‰ã†ã€‚"},
    "å›³æ›¸": { yomi:"ãƒˆã‚·ãƒ§", imi:"æœ¬ã‚„è³‡æ–™", rei:"å›³æ›¸å®¤ã§æœ¬ã‚’èª­ã‚€ã€‚"},
    "è¨€èª": { yomi:"ã‚²ãƒ³ã‚´", imi:"ã“ã¨ã°", rei:"æ—¥æœ¬èªã¯è¨€èªã®ä¸€ã¤ã€‚"},
  };

  function getTilePoolByGrade(grade){
    const ids = Object.keys(TILE_DB);
    if(grade === "g1") return ids.filter(id=>id.startsWith("g1_"));
    if(grade === "g2") return ids.filter(id=>id.startsWith("g2_"));
    if(grade === "g3") return ids.filter(id=>id.startsWith("g3_"));
    if(grade === "g12") return ids.filter(id=>id.startsWith("g1_")||id.startsWith("g2_"));
    if(grade === "g123") return ids;
    return ids;
  }

  // ============================
  // å°ç‰©
  // ============================
  function setMsg(text, kind=""){
    msgEl.className = "msg" + (kind ? ` ${kind}`:"");
    msgEl.textContent = text;
  }
  function shuffle(a){
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }
  function clampInt(v, def, min, max){
    const n = Number(v);
    if(!Number.isFinite(n)) return def;
    return Math.max(min, Math.min(max, Math.floor(n)));
  }

  function isMyTurn(){
    return state.started && (state.turn.current === MY_P);
  }
  function canOperateNow(){
    if(!ONLINE.enabled) return true;
    return isMyTurn();
  }

  function updateTopPill(){
    if(!ONLINE.enabled){
      topPill.textContent = state.started ? `ãƒ­ãƒ¼ã‚«ãƒ« / ${state.turn.current+1}ç•ª` : "ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆéƒ¨å±‹æœªæŒ‡å®šï¼‰";
      return;
    }
    topPill.textContent = `éƒ¨å±‹:${ROOM} / ã‚ãªãŸ:P${MY_P+1} / ${state.turn.current+1}ç•ª`;
  }

  function tileHTML(tid){
    const t = TILE_DB[tid];
    if(!t) return `<div class="kWrap"><div class="kCore">ï¼Ÿ</div></div>`;
    const showReading = (state.settings.reading === "on");
    const on = (t.on||"").trim();
    const kun= (t.kun||"").trim();
    return `
      <div class="kWrap">
        ${showReading ? `<div class="kOn">${escapeHTML(on)}</div>` : ``}
        <div class="kCore">${escapeHTML(t.k)}</div>
        ${showReading ? `<div class="kKun">${escapeHTML(kun)}</div>` : ``}
      </div>
    `;
  }
  function escapeHTML(s){
    return String(s||"").replace(/[&<>"']/g, c=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  // ============================
  // ç›¤é¢UI
  // ============================
  function renderScoreboard(){
    scoreboard.innerHTML = "";
    const pc = state.settings.playerCount || 2;
    for(let i=0;i<pc;i++){
      const row = document.createElement("div");
      row.className = "pRow" + (state.turn.current===i ? " active":"");
      const left = document.createElement("div");
      left.className = "left";
      left.innerHTML = `<span class="dot"></span><span>P${i+1}</span>`;

      const pts = document.createElement("div");
      pts.className = "pts";
      pts.innerHTML = `
        <span>ç‚¹</span>
        <span class="ptVal">${state.points[i]||0}</span>
      `;

      // ä¼‘ã¿è¡¨ç¤º
      const missSkip = state.turn.missSkip?.[i] ? 1 : 0;
      if(missSkip){
        const tag = document.createElement("div");
        tag.className = "statusTag miss";
        tag.textContent = "æ¬¡ã¯1å›ä¼‘ã¿";
        pts.appendChild(tag);
      }

      row.appendChild(left);
      row.appendChild(pts);
      scoreboard.appendChild(row);
    }
  }

  function renderField(){
    fieldEl.innerHTML = "";
    state.field.forEach((tid, idx)=>{
      const d = document.createElement("div");
      d.className = "tile";
      d.innerHTML = tileHTML(tid);
      d.addEventListener("click", ()=>{
        if(!state.started) return;
        if(ONLINE.enabled && !canOperateNow()) return;
        placeToSlotFromField(idx);
      });
      fieldEl.appendChild(d);
    });
  }

  function renderDrawn(){
    if(state.drawn){
      drawMini.innerHTML = tileHTML(state.drawn);
      drawChip.disabled = false;
    }else{
      drawMini.textContent = "â€”";
      drawChip.disabled = true;
    }
  }

  function renderSlots(){
    slot1.innerHTML = state.slots[0] ? tileHTML(state.slots[0]) : "â€”";
    slot2.innerHTML = state.slots[1] ? tileHTML(state.slots[1]) : "â€”";
    const w = currentWord();
    wordBox.textContent = w || "â€”";
  }

  function renderMade(){
    madeList.innerHTML = "";
    state.made.slice(-40).forEach(w=>{
      const s = document.createElement("span");
      s.className = "tag";
      s.textContent = w;
      madeList.appendChild(s);
    });
  }

  function updateWinUI(){
    if(state.winner == null){
      winMsg.style.display = "none";
      return;
    }
    winMsg.style.display = "";
    winMsg.textContent = `P${state.winner+1} ã® ã‹ã¡ï¼`;
  }

  function updateButtons(){
    const started = state.started;

    // ã‚¹ã‚¿ãƒ¼ãƒˆ/ãƒªã‚»ãƒƒãƒˆã¯P0ã ã‘
    const p0 = (MY_P === 0);
    startBtn.disabled = !p0 || started;
    resetBtn.disabled = !p0;

    drawBtn.disabled  = !started || (ONLINE.enabled && !canOperateNow()) || !!state.drawn || state.winner!=null;
    checkBtn.disabled = !started || (ONLINE.enabled && !canOperateNow()) || state.winner!=null;
    endBtn.disabled   = !started || (ONLINE.enabled && !canOperateNow()) || state.winner!=null;

    // å ´æœ­è¿½åŠ ï¼š3æšä»¥ä¸‹ã®æ™‚ã ã‘
    addFieldBtn.style.display = (started && state.field.length<=3) ? "" : "none";
    addFieldBtn.disabled = !started || (ONLINE.enabled && !canOperateNow()) || state.winner!=null;

    // 1å›ä¼‘ã¿ã®å‡¦ç†ï¼šãã®äººã¯ã€Œã¤ãã¸ã€ã ã‘æŠ¼ã›ã‚‹
    const hold = started && isMyTurn() && (state.turn.missSkip?.[MY_P] ? 1:0);
    skipNextBtn.style.display = hold ? "" : "none";
    skipNextBtn.disabled = !hold || (ONLINE.enabled && !canOperateNow());
  }

  function updateMissInfo(){
    const m = state.turn.missStreak?.[state.turn.current] ?? 0;
    const lim = state.settings.missLimit ?? 3;
    missCountEl.textContent = `${m} / ${lim}`;
    missInfo.style.display = state.started ? "" : "none";
  }

  function renderAll(){
    updateTopPill();
    renderScoreboard();
    renderField();
    renderDrawn();
    renderSlots();
    renderMade();
    updateWinUI();
    updateButtons();
    updateMissInfo();
    updateAnswerPanelFromLastResult();
  }

  // ============================
  // ç†Ÿèªãƒ­ã‚¸ãƒƒã‚¯
  // ============================
  function currentWord(){
    const a = state.slots[0];
    const b = state.slots[1];
    if(!a || !b) return "";
    const ta = TILE_DB[a], tb = TILE_DB[b];
    if(!ta || !tb) return "";
    return `${ta.k}${tb.k}`;
  }

  function placeToSlotFromField(fieldIndex){
    // â‘ ãŒç©ºãªã‚‰â‘ ã€åŸ‹ã¾ã£ã¦ãŸã‚‰â‘¡
    const tid = state.field[fieldIndex];
    if(!tid) return;

    const i = state.slots[0] ? (state.slots[1] ? -1 : 1) : 0;
    if(i === -1){
      // ä¸¡æ–¹åŸ‹ã¾ã£ã¦ã‚‹ãªã‚‰ç„¡è¦–
      return;
    }
    state.slots[i] = tid;
    // å ´æœ­ã‹ã‚‰ã¯æ¶ˆã•ãªã„ï¼ˆå…ƒã®ä»•æ§˜ã«åˆã‚ã›ã€å ´æœ­ã¯æ®‹ã™ï¼‰
    pushStateToFirebase(state);
    renderAll();
  }

  function placeDrawnToSlot(){
    if(!state.drawn) return;
    const i = state.slots[0] ? (state.slots[1] ? -1 : 1) : 0;
    if(i === -1) return;
    state.slots[i] = state.drawn;
    state.drawn = null;
    pushStateToFirebase(state);
    renderAll();
  }

  function clearSlot(idx){
    state.slots[idx] = null;
    pushStateToFirebase(state);
    renderAll();
  }

  function resolveCheck(){
    if(state.winner!=null) return;

    const w = currentWord();
    if(!w){
      setMsg("â‘ â‘¡ã«å…¥ã‚Œã¦ã‹ã‚‰ã€Œã§ããŸï¼ã€ã‚’æŠ¼ã—ã¦ã­ã€‚");
      return;
    }

    // 1å›ã¾ã§ãƒ«ãƒ¼ãƒ«
    if(state.usedWords[w]){
      state.lastResult = { ok:false, word:w, reason:"åŒã˜ç†Ÿèªã¯1å›ã¾ã§" };
      bumpMiss();
      setMsg("åŒã˜ç†Ÿèªã¯1å›ã¾ã§ã§ã™ã€‚", "ng");
      state.slots = [null,null];
      pushStateToFirebase(state);
      renderAll();
      return;
    }

    if(WORD_SET.has(w)){
      state.usedWords[w] = true;
      state.made.push(w);
      state.points[state.turn.current] = (state.points[state.turn.current]||0) + 1;
      state.lastResult = { ok:true, word:w };
      state.turn.missStreak[state.turn.current] = 0;

      setMsg("ã›ã„ã‹ã„ï¼ +1", "ok");

      // å‹åˆ©åˆ¤å®š
      const target = state.settings.targetPoints || 5;
      if(state.points[state.turn.current] >= target){
        state.winner = state.turn.current;
        fireKusudama();
      }

      // æœ­ã®å‡¦ç†ï¼šæ•‘å‡ºç‰ˆã¯ã€Œå¼•æœ­ã€ã¯æ¶ˆè²»ã€å ´æœ­ã¯æ®‹ã‚‹è¨­è¨ˆã§ç°¡ç•¥åŒ–
      state.slots = [null,null];
      pushStateToFirebase(state);
      renderAll();
      return;
    }

    // ä¸æ­£è§£
    state.lastResult = { ok:false, word:w, reason:"ãã®è¨€è‘‰ã¯ã‚ã‚Šã¾ã›ã‚“" };
    bumpMiss();
    setMsg("ãã®è¨€è‘‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚", "ng");

    // å¤–ã—ãŸã‚‰ã‚¹ãƒ­ãƒƒãƒˆã ã‘ç©ºã«ã™ã‚‹ï¼ˆç°¡ç•¥ï¼‰
    state.slots = [null,null];
    pushStateToFirebase(state);
    renderAll();
  }

  function bumpMiss(){
    const p = state.turn.current;
    state.turn.missStreak[p] = (state.turn.missStreak[p]||0) + 1;

    const lim = state.settings.missLimit || 3;
    if(state.turn.missStreak[p] >= lim){
      // æ¬¡ã®è‡ªåˆ†ã®ç•ªã¯ä¼‘ã¿
      state.turn.missStreak[p] = 0;
      state.turn.missSkip[p] = 1;
      setMsg("ãƒŸã‚¹ãŒãŸã¾ã£ãŸã®ã§ã€æ¬¡ã®è‡ªåˆ†ã®ç•ªã¯1å›ä¼‘ã¿ã§ã™ã€‚", "ng");
    }
  }

  function endTurn(){
    if(state.winner!=null) return;

    // å¼•æœ­ãŒæ®‹ã£ã¦ãŸã‚‰å ´æœ­ã¸
    if(state.drawn){
      state.field.push(state.drawn);
      state.drawn = null;
    }
    state.slots = [null,null];
    state.lastResult = null;

    nextPlayer();
    pushStateToFirebase(state);
    renderAll();
  }

  function nextPlayer(){
    const pc = state.settings.playerCount || 2;
    state.turn.current = (state.turn.current + 1) % pc;

    // ãã®äººãŒã€Œæ¬¡ã¯1å›ä¼‘ã¿ã€ãªã‚‰ã€çŠ¶æ…‹ã‚’ä¿æŒã—ãŸã¾ã¾ skipNext ã‚’è¡¨ç¤ºã•ã›ã‚‹
    // å®Ÿéš›ã®ã‚¹ã‚­ãƒƒãƒ—ã¯ã€ãã®äººãŒã€Œã¤ãã¸ã€ã‚’æŠ¼ã—ãŸã¨ãã«é€²ã‚ã‚‹
  }

  function resolveSkipNext(){
    const p = state.turn.current;
    if(!state.turn.missSkip?.[p]) return;

    // ä¼‘ã¿ã‚’æ¶ˆè²»ã—ã¦æ¬¡ã¸
    state.turn.missSkip[p] = 0;
    setMsg("1å›ä¼‘ã¿ã§ã™ã€‚æ¬¡ã®äººã¸é€²ã¿ã¾ã™ã€‚");
    nextPlayer();
    pushStateToFirebase(state);
    renderAll();
  }

  // ============================
  // åˆæœŸåŒ–ï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆ/ãƒªã‚»ãƒƒãƒˆï¼‰
  // ============================
  function buildNewGameFromSettings(){
    const grade = gradeSelect.value;
    const reading = readingToggle.value;
    const playerCount = clampInt(playerCountSel.value, 2, 2, 4);
    const targetPoints = clampInt(targetPointsInput.value, 5, 1, 999);
    const missLimit = clampInt(missLimitSel.value, 3, 2, 20);

    const pool = getTilePoolByGrade(grade);
    const deck = shuffle(pool.slice());
    const field = deck.splice(0, 6); // å ´æœ­6æš

    const base = {
      started: true,
      settings: { grade, reading, playerCount, targetPoints, missLimit },
      turn: {
        current: 0,
        missStreak: [0,0,0,0],
        missSkip:   [0,0,0,0],
      },
      points: [0,0,0,0],
      deck,
      field,
      drawn: null,
      slots: [null, null],
      made: [],
      usedWords: {},
      lastResult: null,
      winner: null,
      kusudamaRev: 0
    };
    return base;
  }

  async function hardResetGame(){
    state = {
      started:false,
      settings: { grade:"g12", reading:"on", playerCount:2, targetPoints:5, missLimit:3 },
      turn: { current:0, missStreak:[0,0,0,0], missSkip:[0,0,0,0] },
      points:[0,0,0,0],
      deck:[], field:[], drawn:null, slots:[null,null],
      made:[], usedWords:{}, lastResult:null, winner:null, kusudamaRev:0
    };
    setMsg("ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚P1ã§ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚");
    await pushStateToFirebase(state);
    renderAll();
  }

  // ============================
  // Firebase åŒæœŸ
  // ============================
  async function pushStateToFirebase(nextState){
    if(!ONLINE.enabled) return;
    if(ONLINE.suppress) return;

    const rev = Date.now();
    ONLINE.lastRev = rev;

    try{
      await update(metaRef(), { rev, updatedAt: serverTimestamp() });
      await set(stateRef(), nextState);
    }catch(e){
      console.error(e);
      setMsg("é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼šFirebaseã«é€ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚", "ng");
    }
  }

  function applyIncoming(nextState){
    ONLINE.suppress = true;
    state = nextState;
    // å—ä¿¡å´ã§è¨­å®šUIã‚‚è¿½å¾“
    gradeSelect.value = state.settings.grade || "g12";
    readingToggle.value = state.settings.reading || "on";
    playerCountSel.value = String(state.settings.playerCount || 2);
    targetPointsInput.value = String(state.settings.targetPoints || 5);
    missLimitSel.value = String(state.settings.missLimit || 3);

    renderAll();

    // ãã™ç‰revï¼ˆç›¸æ‰‹ã®å‹åˆ©æ¼”å‡ºï¼‰
    if(state.kusudamaRev && state.kusudamaRev !== lastKusudamaRev){
      lastKusudamaRev = state.kusudamaRev;
      playKusudama(`P${(state.winner??0)+1} ã® ã‹ã¡ï¼`);
    }

    ONLINE.suppress = false;
  }

  function startFirebaseListener(){
    if(!ONLINE.enabled) return;

    onValue(metaRef(), (snap)=>{
      const m = snap.val();
      if(!m || !m.rev) return;
      const rev = m.rev;
      if(rev <= ONLINE.lastRev) return;

      // stateæœ¬ä½“ã‚’å–ã‚Šã«è¡Œãï¼ˆåŒä¸€ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã§OKï¼‰
      onValue(stateRef(), (s2)=>{
        const st = s2.val();
        if(!st) return;
        applyIncoming(st);
      }, { onlyOnce:true });
    });
  }

  // ============================
  // ã‚¤ãƒ™ãƒ³ãƒˆ
  // ============================
  drawBtn.addEventListener("click", ()=>{
    if(!state.started) return;
    if(ONLINE.enabled && !canOperateNow()) return;
    if(state.winner!=null) return;

    if(state.drawn){
      setMsg("ã‚‚ã†å¼•ã„ã¦ã‚‹ã‚ˆã€‚â‘ â‘¡ã«å…¥ã‚Œã‚‹ã‹ã€ç•ªã‚’çµ‚ãˆã¦ã­ã€‚");
      return;
    }
    const tid = state.deck.shift();
    if(!tid){
      setMsg("å±±æœ­ãŒãªããªã‚Šã¾ã—ãŸã€‚", "ng");
      return;
    }
    state.drawn = tid;
    setMsg("å¼•ã„ãŸæœ­ã‚’â‘ â‘¡ã«å…¥ã‚Œã¦ã¿ã‚ˆã†ã€‚");
    pushStateToFirebase(state);
    renderAll();
  });

  drawChip.addEventListener("click", ()=>{
    if(!state.started) return;
    if(ONLINE.enabled && !canOperateNow()) return;
    placeDrawnToSlot();
  });

  slot1.addEventListener("click", ()=>{
    if(!state.started) return;
    if(ONLINE.enabled && !canOperateNow()) return;
    clearSlot(0);
  });
  slot2.addEventListener("click", ()=>{
    if(!state.started) return;
    if(ONLINE.enabled && !canOperateNow()) return;
    clearSlot(1);
  });

  checkBtn.addEventListener("click", ()=>{
    if(!state.started) return;
    if(ONLINE.enabled && !canOperateNow()) return;
    resolveCheck();
  });

  endBtn.addEventListener("click", ()=>{
    if(!state.started) return;
    if(ONLINE.enabled && !canOperateNow()) return;
    endTurn();
  });

  skipNextBtn.addEventListener("click", ()=>{
    if(!state.started) return;
    if(ONLINE.enabled && !canOperateNow()) return;
    resolveSkipNext();
  });

  addFieldBtn.addEventListener("click", ()=>{
    if(!state.started) return;
    if(ONLINE.enabled && !canOperateNow()) return;
    if(state.winner!=null) return;

    const tid = state.deck.shift();
    if(!tid){
      setMsg("å±±æœ­ãŒãªããªã‚Šã¾ã—ãŸã€‚", "ng");
      return;
    }
    state.field.push(tid);
    setMsg("å ´æœ­ã‚’1æšè¿½åŠ ã—ãŸã‚ˆã€‚");
    pushStateToFirebase(state);
    renderAll();
  });

  startBtn.addEventListener("click", ()=>{
    // P0ã ã‘
    if(MY_P !== 0){
      setMsg("ã‚¹ã‚¿ãƒ¼ãƒˆã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ï¼ˆP1ï¼‰ã ã‘ãŒæŠ¼ã›ã¾ã™ã€‚");
      return;
    }
    if(state.started){
      setMsg("ã™ã§ã«é–‹å§‹ã—ã¦ã„ã¾ã™ã€‚");
      return;
    }
    state = buildNewGameFromSettings();
    setMsg("ã‚¹ã‚¿ãƒ¼ãƒˆï¼ P1ã®ç•ªã§ã™ã€‚");
    pushStateToFirebase(state);
    renderAll();
  });

  resetBtn.addEventListener("click", ()=>{
    if(MY_P !== 0){
      setMsg("ãƒªã‚»ãƒƒãƒˆã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ï¼ˆP1ï¼‰ã ã‘ãŒæŠ¼ã›ã¾ã™ã€‚");
      return;
    }
    if(!confirm("ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿï¼ˆéƒ¨å±‹ã®çŠ¶æ…‹ã‚‚åˆæœŸåŒ–ã•ã‚Œã¾ã™ï¼‰")) return;
    hardResetGame();
  });

  // è¨­å®šã‚’å¤‰ãˆãŸã‚‰ã€Œæœªé–‹å§‹ãªã‚‰ã€state.settingsã¸åæ˜ ï¼ˆé–‹å§‹å¾Œã¯å›ºå®šï¼‰
  function syncSettingsIfNotStarted(){
    if(state.started) return;
    state.settings.grade = gradeSelect.value;
    state.settings.reading = readingToggle.value;
    state.settings.playerCount = clampInt(playerCountSel.value, 2, 2, 4);
    state.settings.targetPoints = clampInt(targetPointsInput.value, 5, 1, 999);
    state.settings.missLimit = clampInt(missLimitSel.value, 3, 2, 20);
    renderAll();
  }
  gradeSelect.addEventListener("change", syncSettingsIfNotStarted);
  readingToggle.addEventListener("change", syncSettingsIfNotStarted);
  playerCountSel.addEventListener("change", syncSettingsIfNotStarted);
  targetPointsInput.addEventListener("change", syncSettingsIfNotStarted);
  missLimitSel.addEventListener("change", syncSettingsIfNotStarted);

  // ============================
  // èª­ã¿ä¸Šã’ï¼ˆç°¡æ˜“ï¼‰
  // ============================
  function speak(text){
    try{
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "ja-JP";
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }catch(e){}
  }
  speakBtn?.addEventListener("click", ()=>{
    const t = document.getElementById("ruleText")?.innerText || "";
    if(t) speak(t);
  });
  stopSpeakBtn?.addEventListener("click", ()=>{
    try{ speechSynthesis.cancel(); }catch(e){}
  });

  function updateAnswerPanelFromLastResult(){
    if(!state.lastResult || !state.lastResult.ok){
      ansSpeakBtn.style.display = "none";
      ansInfo.style.display = "none";
      return;
    }
    const w = state.lastResult.word;
    const info = WORD_INFO[w];
    if(!info){
      ansSpeakBtn.style.display = "none";
      ansInfo.style.display = "none";
      return;
    }
    ansSpeakBtn.style.display = "inline-flex";
    ansInfo.style.display = "block";
    ansInfo.innerHTML = `
      <div><strong>${escapeHTML(w)}</strong></div>
      <div class="sub">ã‚ˆã¿ï¼š${escapeHTML(info.yomi || "â€”")}</div>
      <div class="sub">ã„ã¿ï¼š${escapeHTML(info.imi || "â€”")}</div>
      <div class="sub">ã‚Œã„ï¼š${escapeHTML(info.rei || "â€”")}</div>
    `;
    ansSpeakBtn.onclick = ()=>{
      speak(`${w}ã€‚ã‚ˆã¿ã€‚${info.yomi}ã€‚ã„ã¿ã€‚${info.imi}ã€‚ã‚Œã„ã¶ã‚“ã€‚${info.rei}`);
    };
  }

  // ============================
  // ãã™ç‰
  // ============================
  function fireKusudama(){
    // åŒæœŸç”¨revã‚’æ›´æ–°ï¼ˆå—ä¿¡å´ã§ã‚‚æ¼”å‡ºï¼‰
    state.kusudamaRev = Date.now();
    lastKusudamaRev = state.kusudamaRev;
    playKusudama(`P${(state.winner??0)+1} ã® ã‹ã¡ï¼`);
  }

  function playKusudama(text){
    kusudamaBanner.textContent = text || "ãŠã‚ã§ã¨ã†ï¼";
    kusudamaOverlay.style.display = "flex";
    kusudama.classList.remove("burst");
    void kusudama.offsetWidth;
    kusudama.classList.add("burst");

    // ç´™å¹é›ªã£ã½ã„ã‚¹ãƒˆãƒªãƒ¼ãƒãƒ¼ç”Ÿæˆ
    streamersEl.innerHTML = "";
    for(let i=0;i<26;i++){
      const s = document.createElement("div");
      s.className = "streamer";
      const r = (Math.random()*90 - 45).toFixed(1) + "deg";
      const x = (Math.random()*320 - 160).toFixed(1) + "px";
      s.style.setProperty("--r", r);
      s.style.setProperty("--x", x);
      // è‰²æŒ‡å®šã¯CSSã«ä»»ã›ãŸã„ãŒã€ç°¡æ˜“ã§ãƒ©ãƒ³ãƒ€ãƒ æ·¡è‰²
      const hue = Math.floor(Math.random()*360);
      s.style.background = `hsla(${hue},85%,65%,.95)`;
      streamersEl.appendChild(s);
    }

    // ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    const close = ()=>{
      kusudamaOverlay.style.display = "none";
      kusudamaOverlay.removeEventListener("click", close);
    };
    kusudamaOverlay.addEventListener("click", close);
  }

  // ============================
  // èµ·å‹•
  // ============================
  if(ONLINE.enabled){
    setMsg("ã‚ªãƒ³ãƒ©ã‚¤ãƒ³éƒ¨å±‹ã«å‚åŠ ã—ã¾ã—ãŸã€‚P1ãŒã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã—ã¦ã­ã€‚");
    startFirebaseListener();
  }else{
    setMsg("ãƒ­ãƒ¼ã‚«ãƒ«ã§éŠã¹ã¾ã™ï¼ˆURLä½œæˆã§ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚‚å¯ï¼‰ã€‚ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã—ã¦ã­ã€‚");
  }

  // UIåˆæœŸå€¤
  gradeSelect.value = state.settings.grade;
  readingToggle.value = state.settings.reading;
  playerCountSel.value = String(state.settings.playerCount);
  targetPointsInput.value = String(state.settings.targetPoints);
  missLimitSel.value = String(state.settings.missLimit);

  renderAll();

// ======== ã“ã“ã§ module script ã¯çµ‚ã‚ã‚Š ========

</script>

</body>
</html>
