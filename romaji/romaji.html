
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ­ãƒ¼ãƒå­—ã‚¯ã‚¤ã‚ºï¼ˆã‚ã€œã‚è¡Œï¼‰</title>
  <style>
    :root {
      --bg1:#eef2ff; --bg2:#f3e8ff; --ink:#1f2937; --ink-sub:#4b5563;
      --card:#ffffffcc; --primary:#4f46e5; --primary-weak:#e0e7ff;
      --border:#d1d5db; --ok-weak:#ecfdf5; --ok-border:#34d399;
      --accent:#f59e0b;
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    body{
      margin:0; padding:16px; min-height:100vh;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,
        'Hiragino Kaku Gothic ProN','ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN',
        'Yu Gothic UI','æ¸¸ã‚´ã‚·ãƒƒã‚¯',Meiryo,sans-serif;
      color:var(--ink); letter-spacing:.02em;
    }
    .container{ max-width:960px; margin:0 auto; }
    .row{
      display:flex; justify-content:space-between;
      align-items:center; gap:12px; flex-wrap:wrap;
    }
    h1{ font-size:clamp(22px,4vw,28px); margin:0; font-weight:800; }
    .mt-2{ margin-top:8px; }
    .mt-4{ margin-top:16px; } .mt-6{ margin-top:24px; }
    .card{
      background:var(--card); border-radius:16px;
      box-shadow:0 6px 20px #00000014; padding:18px;
    }
    .btn{
      cursor:pointer; border:1px solid var(--border);
      background:#fff; border-radius:12px;
      padding:10px 14px; font-weight:700;
      font-size:14px;
    }
    .btn.primary{
      background:var(--primary); color:#fff; border:none;
      box-shadow:0 6px 18px #4f46e52a;
    }
    .btn.block{ width:100%; }
    .btn:active{ transform:scale(0.99); }
    .btn.mode.on,
    .btn.line-mode.on{
      border-color:var(--primary); background:var(--primary-weak);
    }
    .range-row{ display:flex; align-items:center; gap:12px; }
    .range-row input[type="range"]{ width:100%; }
    .badge{ width:56px; text-align:center; font-weight:800; color:var(--ink); }
    .progress{
      height:8px; width:100%; background:#e5e7eb;
      border-radius:999px; overflow:hidden;
    }
    .bar{
      height:100%; width:0%; background:var(--primary);
      transition:width 200ms ease;
    }
    .prompt{
      display:inline-block; border:1px solid var(--border);
      background:#fff; border-radius:16px;
      font-weight:900; letter-spacing:.1em;
      padding:20px 24px; font-size:clamp(40px,8vw,64px);
    }
    .prompt.ng{ background:#fff5f5; border-color:#fecaca; }
    .grid{
      display:grid; grid-template-columns:repeat(2,1fr); gap:12px;
    }
    @media (min-width:680px){
      .grid{ grid-template-columns:repeat(5,1fr); }
    }
    .opt{
      padding:16px; font-size:28px; font-weight:800;
      border:1px solid var(--border); background:#fff;
      border-radius:14px; box-shadow:0 2px 8px #00000012;
      cursor:pointer;
    }
    .opt:active{ transform:scale(0.99); }
    .opt.reveal{
      border-color:var(--ok-border); background:var(--ok-weak);
    }
    .opt.reveal.flash{
      animation:correctGlow 600ms ease-out;
    }
    @keyframes correctGlow{
      0%{ box-shadow:0 0 0 8px rgba(16,185,129,0.35);}
      100%{ box-shadow:0 0 0 0 rgba(16,185,129,0);}
    }
    .center{ text-align:center; }
    .muted{ color:var(--ink-sub); font-size:14px; }

    /* æ¯éŸ³è‰²åˆ†ã‘ */
    .c-k { color:#000000; }
    .c-a { color:#ef4444; }
    .c-i { color:#c68a15; }
    .c-u { color:#34d399; }
    .c-e { color:#60a5fa; }
    .c-o { color:#92400e; }

    /* è¡Œï¼†è‰²ãƒ¢ãƒ¼ãƒ‰é¸æŠã®ã‚°ãƒªãƒƒãƒ‰ï¼ˆ10è¡ŒÃ—2ï¼‰ */
    .line-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px;
      margin-top:8px;
    }

    /* åˆè¨ˆå¾—ç‚¹ã‚’ç›®ç«‹ãŸã›ã‚‹ */
    .score-wrap{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .bonus-display{
      padding:4px 12px;
      border-radius:999px;
      background:linear-gradient(90deg,#fef3c7,#fffbeb);
      border:2px solid #facc15;
      font-size:15px;
      font-weight:900;
      color:#92400e;
      display:flex;
      align-items:center;
      gap:4px;
      box-shadow:0 0 0 3px rgba(250,204,21,0.35);
    }
    .bonus-display span{
      font-size:22px;
    }
    .bonus-display::before{
      content:"â˜…";
      font-size:16px;
    }
    .bonus-pop{
      animation:bonusPop 450ms ease-out;
    }
    @keyframes bonusPop{
      0%{ transform:scale(1); box-shadow:0 0 0 3px rgba(250,204,21,0.35); }
      40%{ transform:scale(1.12); box-shadow:0 0 0 6px rgba(250,204,21,0.2); }
      100%{ transform:scale(1); box-shadow:0 0 0 3px rgba(250,204,21,0.35); }
    }

    /* â˜… ã”ã»ã†ã³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ â˜… */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.45);
      display:flex;
      justify-content:center;
      align-items:center;
      z-index:50;
    }
    .overlay.hidden{ display:none; }
    .reward-card{
      width:100%;
      max-width:420px;
      background:#f9fafb;
      border-radius:20px;
      box-shadow:0 20px 40px rgba(0,0,0,.35);
      padding:18px 16px 14px;
    }
    .reward-inner{
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
      justify-content:center;
    }
    .reward-title{
      font-size:16px;
      font-weight:700;
      color:var(--ink);
      text-align:center;
    }
    .reward-sub{
      font-size:13px;
      color:var(--ink-sub);
      text-align:center;
      min-height:32px;
    }
    .reward-points{
      font-size:16px;
      text-align:center;
      min-height:22px;
    }
    .reward-points strong{
      font-size:20px;
      color:#f59e0b;
    }
    .reward-buttons{
      margin-top:6px;
      display:flex;
      justify-content:center;
      gap:8px;
      flex-wrap:wrap;
    }

    /* ã‚¹ãƒ­ãƒƒãƒˆ */
    .slot-area{
      display:flex;
      justify-content:center;
      gap:10px;
      margin:6px 0;
    }
    .slot-box{
      width:80px;
      height:100px;
      border-radius:14px;
      background:#111827;
      box-shadow:0 8px 16px rgba(0,0,0,.35) inset;
      display:flex;
      justify-content:center;
      align-items:center;
      cursor:pointer;
      position:relative;
      overflow:hidden;
      touch-action:manipulation;
    }
    .slot-num{
      font-size:44px;
      color:#f9fafb;
      font-weight:700;
      text-shadow:0 0 8px rgba(15,23,42,.8);
      transition:transform .12s ease-out, opacity .12s ease-out;
    }
    .slot-box.spinning .slot-num{
      opacity:.85;
      transform:translateY(2px);
    }
    .slot-box.stopped{
      box-shadow:0 0 0 rgba(0,0,0,0) inset;
    }

    /* ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ */
    .roulette-circle{
      width:140px; height:140px;
      border-radius:50%;
      border:6px solid var(--primary);
      display:flex;
      justify-content:center;
      align-items:center;
      position:relative;
      background:#ffffff;
      box-shadow:0 10px 20px rgba(15,23,42,.25);
      margin-top:4px;
      cursor:pointer;
    }
    .roulette-num{
      font-size:52px;
      font-weight:900;
      color:var(--primary);
    }

    /* ã‚«ãƒ¼ãƒ‰ */
    .card-row{
      display:flex;
      justify-content:center;
      gap:12px;
      margin:8px 0;
    }
    .draw-card{
      width:70px;
      height:100px;
      border-radius:12px;
      background:#111827;
      color:#f9fafb;
      display:flex;
      justify-content:center;
      align-items:center;
      font-size:30px;
      font-weight:800;
      cursor:pointer;
      position:relative;
      box-shadow:0 8px 16px rgba(0,0,0,.35);
    }
    .draw-card.revealed{
      background:#ffffff;
      color:var(--primary);
    }
    .draw-card::after{
      content:"?";
      position:absolute;
      inset:0;
      display:flex;
      justify-content:center;
      align-items:center;
      font-size:28px;
      font-weight:800;
      color:#f9fafb;
    }
    .draw-card.revealed::after{
      content:"";
    }

    /* â˜… ãã™ç‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ â˜… */
    .kusudama-card{
      width:100%;
      max-width:420px;
      background:#fff7ed;
      border-radius:24px;
      box-shadow:0 20px 40px rgba(0,0,0,.35);
      padding:22px 18px 18px;
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    .kusudama-title{
      font-size:22px;
      font-weight:900;
      color:#92400e;
      margin-bottom:8px;
    }
    .kusudama-sub{
      font-size:16px;
      color:#b45309;
      margin-bottom:10px;
    }
    .kusudama-emoji{
      font-size:32px;
      margin-bottom:6px;
    }
    .kusudama-ribbon{
      position:absolute;
      top:-10px;
      left:50%;
      transform:translateX(-50%);
      font-size:40px;
    }
    .kusudama-confetti{
      position:absolute;
      inset:0;
      pointer-events:none;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(248,113,113,0.9) 0, rgba(248,113,113,0) 40%),
        radial-gradient(circle at 80% 30%, rgba(52,211,153,0.9) 0, rgba(52,211,153,0) 40%),
        radial-gradient(circle at 30% 80%, rgba(59,130,246,0.9) 0, rgba(59,130,246,0) 40%);
      background-size:160% 160%;
      animation:confettiMove 1100ms ease-out forwards;
      opacity:0.9;
    }
    @keyframes confettiMove{
      0%{ background-position:50% -40%; opacity:0.9; }
      100%{ background-position:50% 110%; opacity:0; }
    }

  </style>
</head>
<body>

  <div class="container">
    <div class="row mt-4">
      <h1 id="titleHeading">ã‚è¡Œï¼ˆè‰²ä»˜ãï¼‰</h1>
    </div>

    <!-- è¡Œ & è‰²ã¤ã/è‰²ãªã— é¸æŠ -->
    <div id="topMenu" class="card mt-4">
      <div class="muted">ã©ã®è¡Œï¼Ÿï¼ˆè‰²ã¤ãï¼è‰²ãªã—ï¼‰</div>
      <div class="line-grid mt-2">
        <button class="btn line-mode on" data-line="a"  data-color="color">ã‚è¡Œï¼ˆè‰²ã¤ãï¼‰</button>
        <button class="btn line-mode"     data-line="a"  data-color="mono">ã‚è¡Œï¼ˆè‰²ãªã—ï¼‰</button>

        <button class="btn line-mode" data-line="ka" data-color="color">ã‹è¡Œï¼ˆè‰²ã¤ãï¼‰</button>
        <button class="btn line-mode" data-line="ka" data-color="mono">ã‹è¡Œï¼ˆè‰²ãªã—ï¼‰</button>

        <button class="btn line-mode" data-line="sa" data-color="color">ã•è¡Œï¼ˆè‰²ã¤ãï¼‰</button>
        <button class="btn line-mode" data-line="sa" data-color="mono">ã•è¡Œï¼ˆè‰²ãªã—ï¼‰</button>

        <button class="btn line-mode" data-line="ta" data-color="color">ãŸè¡Œï¼ˆè‰²ã¤ãï¼‰</button>
        <button class="btn line-mode" data-line="ta" data-color="mono">ãŸè¡Œï¼ˆè‰²ãªã—ï¼‰</button>

        <button class="btn line-mode" data-line="na" data-color="color">ãªè¡Œï¼ˆè‰²ã¤ãï¼‰</button>
        <button class="btn line-mode" data-line="na" data-color="mono">ãªè¡Œï¼ˆè‰²ãªã—ï¼‰</button>

        <button class="btn line-mode" data-line="ha" data-color="color">ã¯è¡Œï¼ˆè‰²ã¤ãï¼‰</button>
        <button class="btn line-mode" data-line="ha" data-color="mono">ã¯è¡Œï¼ˆè‰²ãªã—ï¼‰</button>

        <button class="btn line-mode" data-line="ma" data-color="color">ã¾è¡Œï¼ˆè‰²ã¤ãï¼‰</button>
        <button class="btn line-mode" data-line="ma" data-color="mono">ã¾è¡Œï¼ˆè‰²ãªã—ï¼‰</button>

        <button class="btn line-mode" data-line="ya" data-color="color">ã‚„è¡Œï¼ˆè‰²ã¤ãï¼‰</button>
        <button class="btn line-mode" data-line="ya" data-color="mono">ã‚„è¡Œï¼ˆè‰²ãªã—ï¼‰</button>

        <button class="btn line-mode" data-line="ra" data-color="color">ã‚‰è¡Œï¼ˆè‰²ã¤ãï¼‰</button>
        <button class="btn line-mode" data-line="ra" data-color="mono">ã‚‰è¡Œï¼ˆè‰²ãªã—ï¼‰</button>

        <button class="btn line-mode" data-line="wa" data-color="color">ã‚è¡Œï¼ˆè‰²ã¤ãï¼‰</button>
        <button class="btn line-mode" data-line="wa" data-color="mono">ã‚è¡Œï¼ˆè‰²ãªã—ï¼‰</button>
      </div>
    </div>

    <!-- è¨­å®šç”»é¢ -->
    <div id="setup" class="card mt-4">
      <div class="muted">å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰</div>
      <div class="row" style="gap:8px;">
        <button class="btn mode on" data-mode="mixed">ã¾ãœã‚‹ï¼ˆä¸¡æ–¹å‘ï¼‰</button>
        <button class="btn mode" data-mode="roma2hira">ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆâ†’ã²ã‚‰ãŒãª</button>
        <button class="btn mode" data-mode="hira2roma">ã²ã‚‰ãŒãªâ†’ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ</button>
      </div>

      <div class="mt-4 muted">å‡ºé¡Œæ•°ï¼ˆ10ã€œ30ï¼‰</div>
      <div class="range-row">
        <input id="totalRange" type="range" min="10" max="30" step="1" value="10">
        <div id="totalBadge" class="badge">10</div>
      </div>

      <button id="startBtn" class="btn primary block mt-4">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>

    <!-- ã‚¯ã‚¤ã‚ºç”»é¢ -->
    <div id="quiz" class="mt-4" style="display:none;">
      <div class="progress"><div id="bar" class="bar"></div></div>

      <div class="card mt-4">
        <div class="row">
          <div class="muted">
            <span id="count">1</span> / <span id="total">10</span>
          </div>
          <div class="score-wrap">
            <div class="muted">æ­£è§£: <b id="score">0</b></div>
            <div id="bonusBadge" class="bonus-display">
              åˆè¨ˆå¾—ç‚¹ <span id="bonusScore">0</span>
            </div>
          </div>
          <button id="quitBtn" class="btn" type="button">çµ‚äº†ã—ã¦ãƒˆãƒƒãƒ—ã«ã‚‚ã©ã‚‹</button>
        </div>

        <div class="center mt-6">
          <div id="prompt" class="prompt"></div>
        </div>

        <div id="opts" class="grid mt-6"></div>
      </div>
    </div>

    <!-- çµæœç”»é¢ -->
    <div id="result" class="card mt-6 center" style="display:none;">
      <div style="font-size:26px; font-weight:900;">ãŠã¤ã‹ã‚Œã•ã¾ï¼</div>
      <div class="mt-4" style="font-size:18px;">
        ã‚¹ã‚³ã‚¢ï¼š<b id="finalScore">0</b> / <span id="finalTotal">10</span>
      </div>
      <div class="mt-2" style="font-size:18px;">
        åˆè¨ˆå¾—ç‚¹ï¼š<b id="finalBonus">0</b> ç‚¹
      </div>

      <div class="row mt-6" style="justify-content:center; gap:10px; flex-wrap:wrap;">
        <button id="againBtn" class="btn primary">ã‚‚ã†ã„ã¡ã©</button>
        <button id="backBtn" class="btn">ã›ã£ã¦ã„ã«ã‚‚ã©ã‚‹</button>
        <button id="topBtn" class="btn">ãƒˆãƒƒãƒ—ã«ã‚‚ã©ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- â˜… ã”ã»ã†ã³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆã‚¹ãƒ­ãƒƒãƒˆãƒ»ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆãƒ»ã‚«ãƒ¼ãƒ‰ï¼‰â˜… -->
  <div id="rewardOverlay" class="overlay hidden">
    <div class="reward-card">
      <div class="reward-inner">
        <div id="rewardTitle" class="reward-title"></div>
        <div id="rewardSub" class="reward-sub"></div>

        <!-- ã‚¹ãƒ­ãƒƒãƒˆ -->
        <div id="rewardSlot" style="display:none; width:100%;">
          <div class="slot-area">
            <div class="slot-box stopped" data-slot="0">
              <div class="slot-num">7</div>
            </div>
            <div class="slot-box stopped" data-slot="1">
              <div class="slot-num">7</div>
            </div>
            <div class="slot-box stopped" data-slot="2">
              <div class="slot-num">7</div>
            </div>
          </div>
          <div class="reward-sub" id="slotHint"></div>
        </div>

        <!-- ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ -->
        <div id="rewardRoulette" style="display:none;">
          <div class="roulette-circle">
            <div id="rouletteNum" class="roulette-num">?</div>
          </div>
        </div>

        <!-- ã‚«ãƒ¼ãƒ‰ -->
        <div id="rewardCards" style="display:none; width:100%;">
          <div class="card-row">
            <div class="draw-card" data-card="0"></div>
            <div class="draw-card" data-card="1"></div>
            <div class="draw-card" data-card="2"></div>
          </div>
        </div>

        <div id="rewardPoints" class="reward-points"></div>

        <div class="reward-buttons">
          <button id="rewardActionBtn" class="btn primary">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- â˜… ãã™ç‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ â˜… -->
  <div id="kusudamaOverlay" class="overlay hidden">
    <div class="kusudama-card">
      <div class="kusudama-confetti"></div>
      <div class="kusudama-ribbon">ğŸŠ</div>
      <div class="kusudama-emoji">ğŸ¥³ğŸ‰</div>
      <div id="kusudamaTitle" class="kusudama-title">ãŠã‚ã§ã¨ã†ï¼</div>
      <div class="kusudama-sub">ãã™ç‰ãŒãƒ‘ãƒ¼ãƒ³ï¼ ãŸãã•ã‚“ãŒã‚“ã°ã£ãŸã­ã€‚</div>
      <button id="kusudamaCloseBtn" class="btn primary" style="margin-top:10px;">ã¤ãã¸ â–¶</button>
    </div>
  </div>

  <script>
    /* ========= è¡Œãƒ‡ãƒ¼ã‚¿ ========= */
    const LINES = {
      a: {
        key:"a",
        label:"ã‚è¡Œ",
        roma:["A","I","U","E","O"],
        hira:["ã‚","ã„","ã†","ãˆ","ãŠ"]
      },
      ka: {
        key:"ka",
        label:"ã‹è¡Œ",
        roma:["KA","KI","KU","KE","KO"],
        hira:["ã‹","ã","ã","ã‘","ã“"]
      },
      sa: {
        key:"sa",
        label:"ã•è¡Œ",
        roma:["SA","SI","SU","SE","SO"],
        hira:["ã•","ã—","ã™","ã›","ã"]
      },
      ta: {
        key:"ta",
        label:"ãŸè¡Œ",
        roma:["TA","TI","TU","TE","TO"],
        hira:["ãŸ","ã¡","ã¤","ã¦","ã¨"]
      },
      na: {
        key:"na",
        label:"ãªè¡Œ",
        roma:["NA","NI","NU","NE","NO"],
        hira:["ãª","ã«","ã¬","ã­","ã®"]
      },
      ha: {
        key:"ha",
        label:"ã¯è¡Œ",
        roma:["HA","HI","HU","HE","HO"],
        hira:["ã¯","ã²","ãµ","ã¸","ã»"]
      },
      ma: {
        key:"ma",
        label:"ã¾è¡Œ",
        roma:["MA","MI","MU","ME","MO"],
        hira:["ã¾","ã¿","ã‚€","ã‚","ã‚‚"]
      },
      ya: {
        key:"ya",
        label:"ã‚„è¡Œ",
        roma:["YA","YU","YO"],
        hira:["ã‚„","ã‚†","ã‚ˆ"]
      },
      ra: {
        key:"ra",
        label:"ã‚‰è¡Œ",
        roma:["RA","RI","RU","RE","RO"],
        hira:["ã‚‰","ã‚Š","ã‚‹","ã‚Œ","ã‚"]
      },
      wa: {
        key:"wa",
        label:"ã‚è¡Œ",
        roma:["WA","WO","NN"],
        hira:["ã‚","ã‚’","ã‚“"]
      }
    };

    let currentLineKey = "a";
    let useColor = true;

    let ROMA = [];
    let HIRA = [];
    let R2H = {};
    let H2R = {};

    function applyLine(key){
      currentLineKey = key;
      const line = LINES[key];
      ROMA = line.roma.slice();
      HIRA = line.hira.slice();
      R2H = {};
      H2R = {};
      for(let i=0;i<ROMA.length;i++){
        R2H[ROMA[i]] = HIRA[i];
        H2R[HIRA[i]] = ROMA[i];
      }
      const titleHeading = document.querySelector('#titleHeading');
      if(titleHeading){
        titleHeading.textContent =
          `${line.label}ï¼ˆ${useColor ? "è‰²ä»˜ã" : "è‰²ãªã—"}ï¼‰`;
      }
    }

    /* ========= ã‚¯ã‚¤ã‚ºéƒ¨åˆ† ========= */

    // è‰²ã¤ããƒ­ãƒ¼ãƒå­—
    function coloredRoma(roma){
      // 1æ–‡å­—ï¼ˆA,I,U,E,Oï¼‰
      if(roma.length === 1){
        const v = roma;
        let span = v;
        if(v==="A") span=`<span class="c-a">A</span>`;
        if(v==="I") span=`<span class="c-i">I</span>`;
        if(v==="U") span=`<span class="c-u">U</span>`;
        if(v==="E") span=`<span class="c-e">E</span>`;
        if(v==="O") span=`<span class="c-o">O</span>`;
        return span;
      }
      // 2æ–‡å­—ä»¥ä¸Šï¼ˆKA, YA, NN ãªã©ï¼‰
      const c = roma[0];
      const rest = roma.slice(1);
      // 2æ–‡å­—ã ã¨ä»®å®šã—ã¦ã€2æ–‡å­—ç›®ãŒæ¯éŸ³ãªã‚‰è‰²åˆ†ã‘
      const v = rest[0];
      let vPart = rest;
      if(rest.length === 1){
        if(v==="A") vPart='<span class="c-a">A</span>';
        if(v==="I") vPart='<span class="c-i">I</span>';
        if(v==="U") vPart='<span class="c-u">U</span>';
        if(v==="E") vPart='<span class="c-e">E</span>';
        if(v==="O") vPart='<span class="c-o">O</span>';
      }
      return `<span class="c-k">${c}</span>${vPart}`;
    }

    function renderRoma(roma){
      if(!useColor) return roma;
      return coloredRoma(roma);
    }

    let mode="mixed", total=10, questions=[], qIndex=0, score=0, locked=false;
    let bonusTotal = 0;
    let kusudamaMaxLevelShown = 0;

    const $=(s)=>document.querySelector(s);

    const setup=$("#setup"), quiz=$("#quiz"), result=$("#result");
    const topMenu=$("#topMenu");
    const totalRange=$("#totalRange"), totalBadge=$("#totalBadge"), startBtn=$("#startBtn");
    const bar=$("#bar"), count=$("#count"), totalSpan=$("#total"), scoreSpan=$("#score");
    const bonusSpan=$("#bonusScore"), bonusBadge=$("#bonusBadge");
    const promptBox=$("#prompt"), opts=$("#opts");
    const finalScore=$("#finalScore"), finalTotal=$("#finalTotal"), finalBonus=$("#finalBonus");
    const againBtn=$("#againBtn"), backBtn=$("#backBtn"), topBtn=$("#topBtn"), quitBtn=$("#quitBtn");

    // è¡Œï¼†è‰²ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
    document.querySelectorAll('.btn.line-mode').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.btn.line-mode').forEach(b=>b.classList.remove('on'));
        btn.classList.add('on');
        const line = btn.dataset.line;
        const color = btn.dataset.color;
        useColor = (color === "color");
        applyLine(line);
      });
    });

    // å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
    document.querySelectorAll('.btn.mode').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.btn.mode').forEach(b=>b.classList.remove('on'));
        btn.classList.add('on');
        mode=btn.dataset.mode;
      });
    });

    function shuffle(a){
      const x=a.slice();
      for(let i=x.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [x[i],x[j]]=[x[j],x[i]];
      }
      return x;
    }

    function makeQuestion(){
      let t=mode;
      if(mode==="mixed") t=Math.random()<0.5?"roma2hira":"hira2roma";

      if(t==="roma2hira"){
        const r = ROMA[Math.floor(Math.random()*ROMA.length)];
        return {
          type:"roma2hira",
          promptRoma:r,
          answer:R2H[r],
          options:shuffle(HIRA)
        };
      }else{
        const h = HIRA[Math.floor(Math.random()*HIRA.length)];
        return {
          type:"hira2roma",
          promptHira:h,
          answer:H2R[h],
          options:shuffle(ROMA)
        };
      }
    }

    function build(){
      questions=[];
      for(let i=0;i<total;i++) questions.push(makeQuestion());
      qIndex=0; score=0; locked=false; bonusTotal=0;
      kusudamaMaxLevelShown = 0;
      scoreSpan.textContent="0";
      bonusSpan.textContent="0";
    }

    totalRange.addEventListener('input', e=>{
      total=parseInt(e.target.value,10);
      totalBadge.textContent=String(total);
    });

    startBtn.addEventListener('click',()=>{
      const activeLineBtn = document.querySelector('.btn.line-mode.on');
      if(activeLineBtn){
        const line = activeLineBtn.dataset.line;
        const color = activeLineBtn.dataset.color;
        useColor = (color === "color");
        applyLine(line);
      }else{
        applyLine(currentLineKey);
      }

      build();
      totalSpan.textContent=String(total);
      topMenu.style.display='none';
      setup.style.display='none';
      result.style.display='none';
      quiz.style.display='';
      render();
    });

    function render(){
      locked=false;
      const q=questions[qIndex];
      count.textContent=String(qIndex+1);
      scoreSpan.textContent=String(score);
      bonusSpan.textContent=String(bonusTotal);
      bar.style.width=Math.round((qIndex/total)*100)+"%";

      if(q.type==="roma2hira"){
        promptBox.innerHTML = renderRoma(q.promptRoma);
      }else{
        promptBox.textContent = q.promptHira;
      }

      opts.innerHTML="";
      if(q.type==="roma2hira"){
        q.options.forEach(ch=>{
          const b=document.createElement('button');
          b.className="opt";
          b.textContent=ch;
          if(ch===q.answer) b.dataset.correct="1";
          b.onclick=()=>onChoose(ch);
          opts.appendChild(b);
        });
      }else{
        q.options.forEach(r=>{
          const b=document.createElement('button');
          b.className="opt";
          b.innerHTML=renderRoma(r);
          if(r===q.answer) b.dataset.correct="1";
          b.onclick=()=>onChoose(r);
          opts.appendChild(b);
        });
      }
    }

    function nextOrFinish(){
      if(qIndex+1>=total){
        finalScore.textContent=String(score);
        finalTotal.textContent=String(total);
        finalBonus.textContent=String(bonusTotal);
        quiz.style.display='none';
        result.style.display='';
        bar.style.width='100%';
      }else{
        qIndex++; render();
      }
    }

    function onChoose(choice){
      if(locked) return;
      const q=questions[qIndex];
      const ok = (choice===q.answer);

      if(ok){
        score++;
        scoreSpan.textContent=String(score);

        if(score > 0 && score % 5 === 0){
          locked = true;
          startReward();
        }else{
          setTimeout(nextOrFinish,120);
        }
        return;
      }

      promptBox.classList.add('ng');
      setTimeout(()=>promptBox.classList.remove('ng'),280);

      locked=true;
      const correctBtn=opts.querySelector('[data-correct]');
      if(correctBtn){
        correctBtn.classList.add('reveal','flash');
        correctBtn.addEventListener('click',()=>{
          locked=false; nextOrFinish();
        },{once:true});
      }
    }

    againBtn.onclick=()=>{
      build(); totalSpan.textContent=String(total);
      result.style.display='none'; quiz.style.display=''; render();
    };
    backBtn.onclick=()=>{
      result.style.display='none';
      quiz.style.display='none';
      topMenu.style.display='';
      setup.style.display='';
    };
    topBtn.onclick=()=>{
      result.style.display='none';
      quiz.style.display='none';
      topMenu.style.display='';
      setup.style.display='';
    };
    quitBtn.onclick=()=>{
      result.style.display='none';
      quiz.style.display='none';
      topMenu.style.display='';
      setup.style.display='';
    };

    /* ========= ã”ã»ã†ã³ä»•æ›ã‘ ========= */

    const rewardOverlay = $("#rewardOverlay");
    const rewardTitle = $("#rewardTitle");
    const rewardSub = $("#rewardSub");
    const rewardPoints = $("#rewardPoints");
    const rewardActionBtn = $("#rewardActionBtn");

    const rewardSlot = $("#rewardSlot");
    const rewardRoulette = $("#rewardRoulette");
    const rewardCards = $("#rewardCards");

    const slotBoxes = document.querySelectorAll(".slot-box");
    let slotValues = [7,7,7];
    let slotTimers = [null,null,null];
    let slotSpinning = [false,false,false];
    let slotGameRunning = false;
    const slotHint = $("#slotHint");
    const MIN_NUM = 1;
    const MAX_NUM = 7;

    function slotNextValue(v){
      let n = v + 1;
      if (n > MAX_NUM) n = MIN_NUM;
      return n;
    }
    function slotUpdateView(idx){
      const numEl = slotBoxes[idx].querySelector(".slot-num");
      numEl.textContent = slotValues[idx];
    }
    function slotStartReel(idx){
      slotSpinning[idx] = true;
      slotBoxes[idx].classList.remove("stopped");
      slotBoxes[idx].classList.add("spinning");
      slotTimers[idx] = setInterval(()=>{
        slotValues[idx] = slotNextValue(slotValues[idx]);
        slotUpdateView(idx);
      }, 360);
    }
    function slotStopReel(idx){
      if (!slotSpinning[idx]) return;
      slotSpinning[idx] = false;
      clearInterval(slotTimers[idx]);
      slotTimers[idx] = null;
      slotBoxes[idx].classList.remove("spinning");
      slotBoxes[idx].classList.add("stopped");
      if (!slotSpinning[0] && !slotSpinning[1] && !slotSpinning[2]) {
        slotFinish();
      }
    }
    function slotClearAll(){
      for (let i=0;i<3;i++){
        if (slotTimers[i]) clearInterval(slotTimers[i]);
        slotTimers[i] = null;
        slotSpinning[i] = false;
      }
    }
    function slotStartGame(){
      slotClearAll();
      slotValues = [
        Math.floor(Math.random()*(MAX_NUM - MIN_NUM + 1)) + MIN_NUM,
        Math.floor(Math.random()*(MAX_NUM - MIN_NUM + 1)) + MIN_NUM,
        Math.floor(Math.random()*(MAX_NUM - MIN_NUM + 1)) + MIN_NUM
      ];
      for (let i=0;i<3;i++){
        slotUpdateView(i);
        slotStartReel(i);
      }
      slotGameRunning = true;
      slotHint.textContent = "æ­¢ã‚ãŸã„ã¨ã“ã‚ã§ãã‚Œãã‚Œã‚¿ãƒƒãƒ—ã—ã¦ã­ã€‚";
      rewardActionBtn.disabled = true;
    }
    function slotFinish(){
      slotGameRunning = false;
      const [a,b,c] = slotValues;
      const allEqual = (a===b && b===c);
      let text = `å‡ºãŸæ•°å­—ï¼š${slotValues.join(" ãƒ» ")}`;
      let points = 0;
      if(allEqual){
        points = a + b + c;
        text += `ã€€â†’ã€€å¾—ç‚¹ <strong>${points}</strong> ç‚¹ï¼`;
      }else{
        text += "ã€€â†’ã€€ä»Šå›ã¯å¾—ç‚¹ãªã—";
      }
      rewardPoints.innerHTML = text;
      slotHint.textContent = "";
      rewardActionBtn.disabled = false;
      rewardActionBtn.textContent = "ã¤ãã¸ â–¶";
      rewardActionBtn.onclick = () => finishReward(points);
    }

    slotBoxes.forEach(el=>{
      const idx = Number(el.dataset.slot);
      el.addEventListener("click", ()=>{
        if(!slotGameRunning) return;
        if(!slotSpinning[idx]) return;
        slotStopReel(idx);
      });
    });

    // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆï¼ˆã‚¿ãƒƒãƒ—ã§æ­¢ã¾ã‚‹ï¼‰
    const rouletteNumEl = $("#rouletteNum");
    const rouletteCircle = document.querySelector(".roulette-circle");
    let rouletteTimer = null;
    let rouletteRunning = false;
    let rouletteCurrent = 1;

    function startRoulette(){
      if(rouletteRunning) return;
      rouletteRunning = true;
      rewardPoints.textContent = "";
      rewardActionBtn.disabled = false;
      rewardActionBtn.textContent = "ã‚¹ãƒˆãƒƒãƒ—";

      rouletteCurrent = Math.floor(Math.random()*10)+1;
      rouletteNumEl.textContent = rouletteCurrent;

      if(rouletteTimer) clearInterval(rouletteTimer);
      rouletteTimer = setInterval(()=>{
        rouletteCurrent++;
        if(rouletteCurrent>10) rouletteCurrent = 1;
        rouletteNumEl.textContent = rouletteCurrent;
      },140);

      const stop = ()=>{
        if(!rouletteRunning) return;
        rouletteRunning = false;
        clearInterval(rouletteTimer);
        rouletteTimer = null;
        const final = rouletteCurrent;
        rouletteNumEl.textContent = final;
        const text = `å‡ºãŸæ•°å­—ï¼š${final}ã€€â†’ã€€å¾—ç‚¹ <strong>${final}</strong> ç‚¹ï¼`;
        rewardPoints.innerHTML = text;
        rewardActionBtn.textContent = "ã¤ãã¸ â–¶";
        rewardActionBtn.onclick = () => finishReward(final);
        rouletteCircle.removeEventListener("click", stop);
      };

      rewardActionBtn.onclick = stop;
      rouletteCircle.addEventListener("click", stop);
    }

    // ã‚«ãƒ¼ãƒ‰
    const drawCards = document.querySelectorAll(".draw-card");
    let cardChosen = false;

    function setupCards(){
      cardChosen = false;
      rewardPoints.textContent = "";
      drawCards.forEach(c=>{
        c.classList.remove("revealed");
        c.textContent = "";
      });
      rewardActionBtn.disabled = true;
      rewardActionBtn.textContent = "ã¤ãã¸ â–¶";
      rewardActionBtn.onclick = ()=>{};
    }

    drawCards.forEach((c)=>{
      c.addEventListener("click", ()=>{
        if(cardChosen) return;
        cardChosen = true;
        const val = Math.floor(Math.random()*10)+1;
        c.classList.add("revealed");
        c.textContent = val;
        rewardPoints.innerHTML = `ãˆã‚‰ã‚“ã ã‚«ãƒ¼ãƒ‰ï¼š${val}ã€€â†’ã€€å¾—ç‚¹ <strong>${val}</strong> ç‚¹ï¼`;
        rewardActionBtn.disabled = false;
        rewardActionBtn.onclick = () => finishReward(val);
      });
    });

    function startReward(){
      rewardOverlay.classList.remove("hidden");
      rewardPoints.textContent = "";
      rewardTitle.textContent = "";
      rewardSub.textContent = "";
      rewardActionBtn.disabled = false;
      rewardActionBtn.textContent = "ã‚¹ã‚¿ãƒ¼ãƒˆ";

      rewardSlot.style.display = "none";
      rewardRoulette.style.display = "none";
      rewardCards.style.display = "none";

      const types = ["slot","roulette","cards"];
      const type = types[Math.floor(Math.random()*types.length)];

      if(type==="slot"){
        rewardSlot.style.display = "";
        slotClearAll();
        slotValues = [7,7,7];
        for(let i=0;i<3;i++){
          slotBoxes[i].classList.remove("spinning");
          slotBoxes[i].classList.add("stopped");
          slotUpdateView(i);
        }
        slotHint.textContent = "";
        rewardActionBtn.textContent = "ã‚¹ã‚¿ãƒ¼ãƒˆ";
        rewardActionBtn.onclick = () => slotStartGame();

      }else if(type==="roulette"){
        rewardRoulette.style.display = "";
        rouletteNumEl.textContent = "?";
        rewardActionBtn.textContent = "ã‚¹ã‚¿ãƒ¼ãƒˆ";
        rewardActionBtn.onclick = () => startRoulette();

      }else{
        rewardCards.style.display = "";
        setupCards();
      }
    }

    /* â˜… ãã™ç‰è¡¨ç¤ºé–¢é€£ â˜… */
    const kusudamaOverlay = $("#kusudamaOverlay");
    const kusudamaCloseBtn = $("#kusudamaCloseBtn");
    const kusudamaTitleEl = $("#kusudamaTitle");
    let pendingNextAfterKusudama = null;

    kusudamaCloseBtn.addEventListener("click", ()=>{
      kusudamaOverlay.classList.add("hidden");
      if(typeof pendingNextAfterKusudama === "function"){
        const fn = pendingNextAfterKusudama;
        pendingNextAfterKusudama = null;
        fn();
      }
    });

    function maybeShowKusudama(prevTotal, newTotal, after){
      const prevLevel = Math.floor(prevTotal / 30);
      const newLevel  = Math.floor(newTotal / 30);
      if(newLevel > prevLevel && newLevel > 0 && newLevel > kusudamaMaxLevelShown){
        kusudamaMaxLevelShown = newLevel;
        const levelScore = newLevel * 30;
        kusudamaTitleEl.textContent = levelScore + "ç‚¹ãŠã‚ã§ã¨ã†ï¼";

        pendingNextAfterKusudama = after;
        kusudamaOverlay.classList.remove("hidden");
      }else{
        after();
      }
    }

    function finishReward(points){
      const before = bonusTotal;
      bonusTotal += points;
      bonusSpan.textContent = String(bonusTotal);

      bonusBadge.classList.remove("bonus-pop");
      void bonusBadge.offsetWidth;
      bonusBadge.classList.add("bonus-pop");

      rewardOverlay.classList.add("hidden");
      locked = false;

      maybeShowKusudama(before, bonusTotal, nextOrFinish);
    }

    // åˆæœŸçŠ¶æ…‹: ã‚è¡Œãƒ»è‰²ã¤ã
    applyLine("a");
  </script>
</body>
</html>
