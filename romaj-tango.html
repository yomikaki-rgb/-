<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ãƒ­ãƒ¼ãƒå­—å…¥åŠ›ç·´ç¿’</title>
<style>
  :root{
    --bg1:#eef2ff; --bg2:#f3e8ff;
    --card:#ffffffd9;
    --ink:#111827; --sub:#4b5563;
    --primary:#4f46e5; --primarySoft:#e0e7ff;
    --ok:#16a34a; --ng:#dc2626;
    --border:#d1d5db;
    --shadow:0 10px 25px rgba(0,0,0,.08);
    --radius:18px;

    /* ã”ã»ã†ã³å´ã®è‰²ï¼ˆè²¼ã£ã¦ãã‚ŒãŸã‚¢ãƒ—ãƒªã¨åŒç³»ï¼‰ */
    --ok-weak:#ecfdf5; --ok-border:#34d399;
    --accent:#f59e0b;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  body{
    margin:0; min-height:100vh; padding:16px;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Hiragino Kaku Gothic ProN","ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN","Noto Sans JP",system-ui,sans-serif;
    color:var(--ink);
    background:linear-gradient(135deg,var(--bg1),var(--bg2));
  }
  .wrap{max-width:980px;margin:0 auto; display:grid; gap:14px;}
  header{display:flex; gap:10px; align-items:flex-end; justify-content:space-between;}
  h1{font-size:18px;margin:0}
  .hint{font-size:12px;color:var(--sub)}
  .card{background:var(--card); border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow);}
  .pad{padding:14px}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .spacer{flex:1}
  .btn{
    border:1px solid var(--border);
    background:#fff;
    border-radius:14px;
    padding:10px 12px;
    font-weight:800;
    cursor:pointer;
    transition:.12s transform,.12s background;
    user-select:none;
  }
  .btn:active{transform:scale(.98)}
  .btn.primary{background:var(--primary); color:#fff; border-color:transparent;}
  .btn.ghost{background:transparent;}

  .toggle{
    display:grid; gap:10px;
    grid-template-columns: repeat(9, minmax(0, 1fr));
  }
  @media (max-width:840px){ .toggle{grid-template-columns: repeat(3, minmax(0, 1fr));} }

  .chip{
    display:flex; justify-content:center; align-items:center;
    padding:12px 10px; border-radius:14px;
    border:1px solid var(--border); background:#fff;
    font-weight:900; cursor:pointer; user-select:none;
    text-align:center;
  }
  .chip.on{background:var(--primarySoft); border-color:rgba(79,70,229,.35);}

  .word{font-size:36px; font-weight:900; text-align:center;}
  .meta{
    display:flex; gap:10px; justify-content:center; flex-wrap:wrap;
    color:var(--sub); font-size:13px;
    align-items:center;
  }

  .ansField{
    min-width:min(520px, 92vw);
    padding:12px 14px;
    border-radius:14px;
    border:1px solid var(--border);
    background:#fff;
    font-size:22px;
    font-weight:900;
    letter-spacing:.04em;
    text-align:center;
    margin:0 auto;
  }

  .msg{
    text-align:center; font-weight:900;
    padding:10px 12px; border-radius:14px;
    border:1px solid var(--border);
    margin-top:10px;
  }
  .msg.ok{border-color:rgba(22,163,74,.35); background:rgba(22,163,74,.08); color:var(--ok)}
  .msg.ng{border-color:rgba(220,38,38,.35); background:rgba(220,38,38,.08); color:var(--ng)}

  .kbd{
    display:grid;
    grid-template-columns: repeat(10, minmax(0, 1fr));
    gap:10px;
    padding:14px;
  }
  @media (max-width:840px){ .kbd{grid-template-columns: repeat(5, minmax(0, 1fr));} }
  .key{
    background:#fff; border:1px solid var(--border);
    border-radius:14px;
    padding:14px 10px;
    font-size:20px; font-weight:900;
    box-shadow:0 3px 10px rgba(0,0,0,.04);
    cursor:pointer;
    user-select:none;
    text-align:center;
  }
  .key:active{transform:scale(.98)}

  /* â˜… æ¯éŸ³è‰²åˆ†ã‘ â˜… */
  .c-k { color:#000000; }
  .c-a { color:#ef4444; }
  .c-i { color:#c68a15; }      /* I ï¼šé»„ã¿ã®èŒ¶è‰² */
  .c-u { color:#34d399; }      /* U ï¼šæ˜ã‚‹ã„ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã‚°ãƒªãƒ¼ãƒ³ */
  .c-e { color:#60a5fa; }      /* E ï¼šè–„ã„ãƒ–ãƒ«ãƒ¼ */
  .c-o { color:#92400e; }

  .mono { color:#000000; }     /* è‰²ãªã—ç”¨ */

  /* ====== åˆè¨ˆå¾—ç‚¹ãƒãƒƒã‚¸ï¼ˆè²¼ã£ã¦ãã‚ŒãŸã‚¢ãƒ—ãƒªã¨åŒç³»ï¼‰ ====== */
  .bonus-display{
    padding:4px 12px;
    border-radius:999px;
    background:linear-gradient(90deg,#fef3c7,#fffbeb);
    border:2px solid #facc15;
    font-size:13px;
    font-weight:900;
    color:#92400e;
    display:flex;
    align-items:center;
    gap:6px;
    box-shadow:0 0 0 3px rgba(250,204,21,0.35);
  }
  .bonus-display span{ font-size:18px; }
  .bonus-display::before{ content:"â˜…"; font-size:14px; }
  .bonus-pop{ animation:bonusPop 450ms ease-out; }
  @keyframes bonusPop{
    0%{ transform:scale(1); box-shadow:0 0 0 3px rgba(250,204,21,0.35); }
    40%{ transform:scale(1.12); box-shadow:0 0 0 6px rgba(250,204,21,0.2); }
    100%{ transform:scale(1); box-shadow:0 0 0 3px rgba(250,204,21,0.35); }
  }

  /* ====== â˜… ã”ã»ã†ã³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆslot/roulette/cardsï¼‰â˜… ====== */
  .overlay{
    position:fixed;
    inset:0;
    background:rgba(15,23,42,0.45);
    display:flex;
    justify-content:center;
    align-items:center;
    z-index:50;
  }
  .overlay.hidden{ display:none; }
  .reward-card{
    width:100%;
    max-width:420px;
    background:#f9fafb;
    border-radius:20px;
    box-shadow:0 20px 40px rgba(0,0,0,.35);
    padding:18px 16px 14px;
  }
  .reward-inner{
    display:flex;
    flex-direction:column;
    gap:12px;
    align-items:center;
    justify-content:center;
  }
  .reward-title{
    font-size:16px;
    font-weight:700;
    color:var(--ink);
    text-align:center;
  }
  .reward-sub{
    font-size:13px;
    color:var(--sub);
    text-align:center;
    min-height:32px;
  }
  .reward-points{
    font-size:16px;
    text-align:center;
    min-height:22px;
  }
  .reward-points strong{
    font-size:20px;
    color:#f59e0b;
  }
  .reward-buttons{
    margin-top:6px;
    display:flex;
    justify-content:center;
    gap:8px;
    flex-wrap:wrap;
  }

  /* ã‚¹ãƒ­ãƒƒãƒˆ */
  .slot-area{
    display:flex;
    justify-content:center;
    gap:10px;
    margin:6px 0;
  }
  .slot-box{
    width:80px;
    height:100px;
    border-radius:14px;
    background:#111827;
    box-shadow:0 8px 16px rgba(0,0,0,.35) inset;
    display:flex;
    justify-content:center;
    align-items:center;
    cursor:pointer;
    position:relative;
    overflow:hidden;
    touch-action:manipulation;
  }
  .slot-num{
    font-size:44px;
    color:#f9fafb;
    font-weight:700;
    text-shadow:0 0 8px rgba(15,23,42,.8);
    transition:transform .12s ease-out, opacity .12s ease-out;
  }
  .slot-box.spinning .slot-num{
    opacity:.85;
    transform:translateY(2px);
  }
  .slot-box.stopped{
    box-shadow:0 0 0 rgba(0,0,0,0) inset;
  }

  /* ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ */
  .roulette-circle{
    width:140px; height:140px;
    border-radius:50%;
    border:6px solid var(--primary);
    display:flex;
    justify-content:center;
    align-items:center;
    position:relative;
    background:#ffffff;
    box-shadow:0 10px 20px rgba(15,23,42,.25);
    margin-top:4px;
    cursor:pointer;
  }
  .roulette-num{
    font-size:52px;
    font-weight:900;
    color:var(--primary);
  }

  /* ã‚«ãƒ¼ãƒ‰ */
  .card-row{
    display:flex;
    justify-content:center;
    gap:12px;
    margin:8px 0;
  }
  .draw-card{
    width:70px;
    height:100px;
    border-radius:12px;
    background:#111827;
    color:#f9fafb;
    display:flex;
    justify-content:center;
    align-items:center;
    font-size:30px;
    font-weight:800;
    cursor:pointer;
    position:relative;
    box-shadow:0 8px 16px rgba(0,0,0,.35);
  }
  .draw-card.revealed{
    background:#ffffff;
    color:var(--primary);
  }
  .draw-card::after{
    content:"?";
    position:absolute;
    inset:0;
    display:flex;
    justify-content:center;
    align-items:center;
    font-size:28px;
    font-weight:800;
    color:#f9fafb;
  }
  .draw-card.revealed::after{ content:""; }

  /* ====== â˜… ãã™ç‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ â˜… ====== */
  .kusudama-card{
    width:100%;
    max-width:420px;
    background:#fff7ed;
    border-radius:24px;
    box-shadow:0 20px 40px rgba(0,0,0,.35);
    padding:22px 18px 18px;
    text-align:center;
    position:relative;
    overflow:hidden;
  }
  .kusudama-title{
    font-size:22px;
    font-weight:900;
    color:#92400e;
    margin-bottom:8px;
  }
  .kusudama-sub{
    font-size:16px;
    color:#b45309;
    margin-bottom:10px;
  }
  .kusudama-emoji{
    font-size:32px;
    margin-bottom:6px;
  }
  .kusudama-ribbon{
    position:absolute;
    top:-10px;
    left:50%;
    transform:translateX(-50%);
    font-size:40px;
  }
  .kusudama-confetti{
    position:absolute;
    inset:0;
    pointer-events:none;
    background-image:
      radial-gradient(circle at 10% 20%, rgba(248,113,113,0.9) 0, rgba(248,113,113,0) 40%),
      radial-gradient(circle at 80% 30%, rgba(52,211,153,0.9) 0, rgba(52,211,153,0) 40%),
      radial-gradient(circle at 30% 80%, rgba(59,130,246,0.9) 0, rgba(59,130,246,0) 40%);
    background-size:160% 160%;
    animation:confettiMove 1100ms ease-out forwards;
    opacity:0.9;
  }
  @keyframes confettiMove{
    0%{ background-position:50% -40%; opacity:0.9; }
    100%{ background-position:50% 110%; opacity:0; }
  }
</style>
</head>
<body>
<div class="wrap">

  <header>
    <div><h1>ãƒ­ãƒ¼ãƒå­—å…¥åŠ›ç·´ç¿’</h1></div>
    <div class="hint" id="statTop"></div>
  </header>

  <section class="card pad" id="screenSetup">
    <div class="row" style="margin-bottom:10px">
      <div style="font-weight:900">ãƒœã‚¿ãƒ³ã‚’1ã¤é¸ã‚“ã§ã‚¹ã‚¿ãƒ¼ãƒˆ</div>
      <div class="spacer"></div>
      <button class="btn ghost" id="modeToggle">å‡ºé¡Œï¼šã‹ãªâ†’ãƒ­ãƒ¼ãƒå­—</button>
      <button class="btn ghost" id="shuffleToggle">è¡Œå†…ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼šON</button>
      <button class="btn ghost" id="colorToggle">è‰²ã‚ã‚Šï¼šOFF</button>
      <!-- â˜…è¿½åŠ ï¼šãƒ­ãƒ¼ãƒå­—ã‚’é›¢ã™ãƒ¢ãƒ¼ãƒ‰ -->
      <button class="btn ghost" id="spaceToggle">ãƒ­ãƒ¼ãƒå­—ã‚’ã¯ãªã™ï¼šOFF</button>
    </div>

    <div class="toggle" id="rowToggles"></div>

    <div class="row" style="margin-top:12px">
      <div class="spacer"></div>
      <button class="btn primary" id="startBtn" disabled>ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>
  </section>

  <section class="card pad" id="screenPlay" style="display:none">
    <div class="word" id="wordKana">â€”</div>
    <div class="meta">
      <div id="progress">0 / 0</div>
      <div>ï½œ</div>
      <div id="score">æ­£è§£ 0</div>
      <div>ï½œ</div>
      <div class="bonus-display">åˆè¨ˆå¾—ç‚¹ <span id="bonusScore">0</span></div>
      <div>ï½œ</div>
      <div id="rowNow">â€”</div>
    </div>

    <div class="ansField" id="ansField">ï¼ˆã“ã“ã«å…¥åŠ›ã•ã‚Œã¾ã™ï¼‰</div>

    <div class="row" style="justify-content:center; margin-top:12px">
      <button class="btn" id="backBtn">â† 1ã¤ã‚‚ã©ã‚‹</button>
      <button class="btn" id="clearBtn">ãœã‚“ã¶ã‘ã™</button>
      <button class="btn primary" id="checkBtn">ã§ããŸï¼</button>
      <button class="btn ghost" id="exitBtn">çµ‚äº†ã—ã¦ãƒˆãƒƒãƒ—ã«ã‚‚ã©ã‚‹</button>
    </div>

    <div id="msg" class="msg" style="display:none"></div>
  </section>

  <section class="card" id="kbdCard" style="display:none">
    <div class="kbd" id="kbd"></div>
  </section>

</div>

<!-- â˜… ã”ã»ã†ã³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆã‚¹ãƒ­ãƒƒãƒˆãƒ»ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆãƒ»ã‚«ãƒ¼ãƒ‰ï¼‰â˜… -->
<div id="rewardOverlay" class="overlay hidden">
  <div class="reward-card">
    <div class="reward-inner">
      <div id="rewardTitle" class="reward-title"></div>
      <div id="rewardSub" class="reward-sub"></div>

      <!-- ã‚¹ãƒ­ãƒƒãƒˆ -->
      <div id="rewardSlot" style="display:none; width:100%;">
        <div class="slot-area">
          <div class="slot-box stopped" data-slot="0"><div class="slot-num">7</div></div>
          <div class="slot-box stopped" data-slot="1"><div class="slot-num">7</div></div>
          <div class="slot-box stopped" data-slot="2"><div class="slot-num">7</div></div>
        </div>
        <div class="reward-sub" id="slotHint"></div>
      </div>

      <!-- ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ -->
      <div id="rewardRoulette" style="display:none;">
        <div class="roulette-circle">
          <div id="rouletteNum" class="roulette-num">?</div>
        </div>
      </div>

      <!-- ã‚«ãƒ¼ãƒ‰ -->
      <div id="rewardCards" style="display:none; width:100%;">
        <div class="card-row">
          <div class="draw-card" data-card="0"></div>
          <div class="draw-card" data-card="1"></div>
          <div class="draw-card" data-card="2"></div>
        </div>
      </div>

      <div id="rewardPoints" class="reward-points"></div>

      <div class="reward-buttons">
        <button id="rewardActionBtn" class="btn primary">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      </div>
    </div>
  </div>
</div>

<!-- â˜… ãã™ç‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ â˜… -->
<div id="kusudamaOverlay" class="overlay hidden">
  <div class="kusudama-card">
    <div class="kusudama-confetti"></div>
    <div class="kusudama-ribbon">ğŸŠ</div>
    <div class="kusudama-emoji">ğŸ¥³ğŸ‰</div>
    <div id="kusudamaTitle" class="kusudama-title">ãŠã‚ã§ã¨ã†ï¼</div>
    <div class="kusudama-sub">ãã™ç‰ãŒãƒ‘ãƒ¼ãƒ³ï¼ ãŸãã•ã‚“ãŒã‚“ã°ã£ãŸã­ã€‚</div>
    <button id="kusudamaCloseBtn" class="btn primary" style="margin-top:10px;">ã¤ãã¸ â–¶</button>
  </div>
</div>

<script>
(() => {
  // ====== æŒ‡å®šèªãƒªã‚¹ãƒˆï¼ˆç©ºç™½ãŒæ··ã˜ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€filterã§ç©ºè¦ç´ ã ã‘é™¤å»ï¼‰ ======
  const ATa_WORDS_RAW = `
ã‚ã„ã€€ã†ãˆã€€ã‚ãŠã€€ã‚ã†ã€€ã„ãˆã€€ã„ãˆã€€ã„ã†ã€€ãŠã†ã€€ãŠãŠã„ã€€ãŠãŠã†
ã‹ãã€€ã‹ã†ã€€ã‹ã“ã€€ããã€€ããã€€ã“ã“ã€€ã‹ã‹ãã€€ãã‹ãã€€ã‚ã‹ã€€ã‚ãã€€ã„ã‹ã€€ã„ã‘ã€€ãŠã‹ã€€ã‹ã„ã€€ã“ã„ã€€ã‚ã‹ã„ã‹ãã€€ã‚ãŠã„ã‹ã„ã€€ã“ã„ã€€ã‚ã„
ã•ã•ã€€ã•ã™ã€€ã—ã—ã€€ã—ãã€€ã™ã™ã€€ã™ã—ã€€ã™ãã€€ãã—ã€€ã€€ã‚ã•ã€€ã‚ã—ã€€ã‚ã™ã€€ã‚ã›ã€€ã„ã—ã€€ã„ã™ã€€ã†ã—ã€€ã‚ã•ã„ã€€ã„ã—ã„
ãŸã¤ã€€ãŸã¦ã€€ã¡ã¡ã€€ã¤ã¡ã€€ã¦ã¤ã€€ã¨ã¡ã€€ã‚ã¨ã€€ã„ãŸã€€ã„ã¨ã€€ã†ãŸã€€ãŠã¨ã€€ã„ãŸã„ã€€ã¦ã‚ã¦ã€€ã‚ãŠã„ã„ã¨ã€€ã‚ã¤ã„ã„ãŸ
  `.trim();

  const NaWa_WORDS_RAW = `
ãªã«ã€€ãªãªã€€ã¬ã®ã€€ã•ã‚“ã«ã‚“ã€€ã«ã­ã‚“ã€€ãªãªã«ã‚“ã€€ãªãªã­ã‚“ã€€ã‚ãªã€€ã‚ã«ã€€ã‚ã­ã€€ã„ã­ã€€ã†ã«ã€€ã†ã®ã€€ãŠã«ã€€ãŠã®ã€€ãŠã«ã®ã‚ãªã€€ã„ã­ã®ã­
ã¯ã¯ã€€ã²ã²ã€€ã²ãµã€€ã»ã»ã€€ã¯ã„ã€€ã¯ãˆã€€ã¸ã„ã€€ãµãˆ
ã¾ã¾ã€€ã¾ã‚ã€€ã¿ã¿ã€€ã‚ã‚‚ã€€ã‚‚ã¿ã€€ã‚‚ã‚€ã€€ã‚‚ã‚‚ã€€ã‚ã¾ã„ã€€ã‚ã¿ã€€ã‚ã‚€ã€€ã‚ã‚ã€€ã„ã¾ã€€ã„ã¿ã€€ã„ã‚‚ã€€ã†ã¾ã€€ã†ã¿ã€€ã†ã‚ã€€ã‚ã¾ã„ã‚‚ã‚‚ã€€ã‚ã„ã¾ã„
ã‚†ã‚„ã€€ã‚†ã„ã€€ã„ã‚„ã€€ã„ã‚ˆã€€ã„ã‚„ã„ã‚„ã€€ã‚ã‚„ã€€ã‚ã‚†ã€€ã‚ˆã†ã€€ã‚„ãŠã‚„ã€€ãŠã‚„ã€€ã‚ˆã†ã„
ã‚ã‚‰ã€€ã‚ã‚Šã€€ã‚ã‚‹ã€€ã†ã‚‰ã€€ã†ã‚‹ã€€ã†ã‚Šã€€ã‚‹ã‚Šã€€ã„ã‚ã€€ãŠã‚Œã€€ãŠã‚‹ã€€ã‚ã‚‰ã‚Œã€€ã‚‹ã‚Šã„ã‚ã€€ã‚Œã„ã€€ã„ã‚ã‚Šã€€ã‚Šã‚ã‚“ã€€ã‚ã„ã„ã‚ã€€ã„ã‚ã„ã‚ã€€ã‚‹ã‚“ã‚‹ã‚“
  `.trim();

  function splitWords(raw){
    return raw
      .replace(/\n/g, " ")
      .split(/[ \tã€€]+/g)
      .map(s => s.trim())
      .filter(Boolean);
  }

  // ====== è¡Œã”ã¨ã®å˜èª ======
  const WORDS_BY_ROW = {
    "ã‚è¡Œ": ["ã‚ã„","ã†ãˆ","ã‚ãŠ","ã‚ã†","ã„ãˆ","ã„ãˆ","ã„ã†","ãŠã†","ãŠãŠã„","ãŠãŠã†"],
    "ã‹è¡Œ": ["ã‹ã","ã‹ã†","ã‹ã“","ãã","ãã","ã“ã“","ã‹ã‹ã","ãã‹ã","ã‚ã‹","ã‚ã","ã„ã‹","ã„ã‘","ãŠã‹","ã‹ã„","ã“ã„","ã‚ã‹ã„ã‹ã","ã‚ãŠã„ã‹ã„","ã“ã„","ã‚ã„"],
    "ã•è¡Œ": ["ã•ã•","ã•ã™","ã—ã—","ã—ã","ã™ã™","ã™ã—","ã™ã","ãã—","ã‚ã•","ã‚ã—","ã‚ã™","ã‚ã›","ã„ã—","ã„ã™","ã†ã—","ã‚ã•ã„","ã„ã—ã„"],
    "ãŸè¡Œ": ["ãŸã¤","ãŸã¦","ã¡ã¡","ã¤ã¡","ã¦ã¤","ã¨ã¡","ã‚ã¨","ã„ãŸ","ã„ã¨","ã†ãŸ","ãŠã¨","ã„ãŸã„","ã¦ã‚ã¦","ã‚ãŠã„ã„ã¨","ã‚ã¤ã„ã„ãŸ"],
    "ãªè¡Œ": ["ãªã«","ãªãª","ã¬ã®","ã•ã‚“ã«ã‚“","ã«ã­ã‚“","ãªãªã«ã‚“","ãªãªã­ã‚“","ã‚ãª","ã‚ã«","ã‚ã­","ã„ã­","ã†ã«","ã†ã®","ãŠã«","ãŠã®","ãŠã«ã®ã‚ãª","ã„ã­ã®ã­"],
    "ã¯è¡Œ": ["ã¯ã¯","ã²ã²","ã²ãµ","ã»ã»","ã¯ã„","ã¯ãˆ","ã¸ã„","ãµãˆ"],
    "ã¾è¡Œ": ["ã¾ã¾","ã¾ã‚","ã¿ã¿","ã‚ã‚‚","ã‚‚ã¿","ã‚‚ã‚€","ã‚‚ã‚‚","ã‚ã¾ã„","ã‚ã¿","ã‚ã‚€","ã‚ã‚","ã„ã¾","ã„ã¿","ã„ã‚‚","ã†ã¾","ã†ã¿","ã†ã‚","ã‚ã¾ã„ã‚‚ã‚‚","ã‚ã„ã¾ã„"],
    "ã‚„è¡Œ": ["ã‚†ã‚„","ã‚†ã„","ã„ã‚„","ã„ã‚ˆ","ã„ã‚„ã„ã‚„","ã‚ã‚„","ã‚ã‚†","ã‚ˆã†","ã‚„ãŠã‚„","ãŠã‚„","ã‚ˆã†ã„"],
    "ã‚‰è¡Œ": ["ã‚ã‚‰","ã‚ã‚Š","ã‚ã‚‹","ã†ã‚‰","ã†ã‚‹","ã†ã‚Š","ã‚‹ã‚Š","ã„ã‚","ãŠã‚Œ","ãŠã‚‹","ã‚ã‚‰ã‚Œ","ã‚‹ã‚Šã„ã‚","ã‚Œã„","ã„ã‚ã‚Š","ã‚Šã‚ã‚“","ã‚ã„ã„ã‚","ã„ã‚ã„ã‚","ã‚‹ã‚“ã‚‹ã‚“"],

    // â˜…è¿½åŠ ãƒœã‚¿ãƒ³
    "ã‚ï½ãŸè¡Œ": splitWords(ATa_WORDS_RAW),
    "ãªï½ã‚è¡Œ": splitWords(NaWa_WORDS_RAW),
  };

  // ====== ã‹ãªâ†’ãƒ­ãƒ¼ãƒå­—ï¼ˆSI/TI/TU/HU/NNï¼‰ ======
  const KANA2ROMA = {
    "ã‚":"A","ã„":"I","ã†":"U","ãˆ":"E","ãŠ":"O",
    "ã‹":"KA","ã":"KI","ã":"KU","ã‘":"KE","ã“":"KO",
    "ã•":"SA","ã—":"SI","ã™":"SU","ã›":"SE","ã":"SO",
    "ãŸ":"TA","ã¡":"TI","ã¤":"TU","ã¦":"TE","ã¨":"TO",
    "ãª":"NA","ã«":"NI","ã¬":"NU","ã­":"NE","ã®":"NO",
    "ã¯":"HA","ã²":"HI","ãµ":"HU","ã¸":"HE","ã»":"HO",
    "ã¾":"MA","ã¿":"MI","ã‚€":"MU","ã‚":"ME","ã‚‚":"MO",
    "ã‚„":"YA","ã‚†":"YU","ã‚ˆ":"YO",
    "ã‚‰":"RA","ã‚Š":"RI","ã‚‹":"RU","ã‚Œ":"RE","ã‚":"RO",
    "ã‚":"WA","ã‚’":"WO",
    "ã‚“":"NN"
  };
  function kanaToRoma(kana){
    let out = "";
    for (const ch of kana) out += (KANA2ROMA[ch] ?? "");
    return out;
  }

  // ====== â˜…è¿½åŠ ï¼šãƒ­ãƒ¼ãƒå­—ã‚’ã€ŒTU / KU / Eã€ã®ã‚ˆã†ã«åˆ†å‰² ======
  function splitRomajiBlocks(romaji){
    const s = (romaji || "").toUpperCase();
    // 3æ–‡å­—æ‹—éŸ³ã£ã½ã„ã‚‚ã® â†’ ãã‚Œä»¥å¤–ã¯ (å­éŸ³? + æ¯éŸ³) / N
    const m = s.match(/(KYO|KYA|KYU|SHO|SHA|SHU|CHO|CHA|CHU|RYO|RYA|RYU|NYO|NYA|NYU|MYO|MYA|MYU|GYO|GYA|GYU|HYO|HYA|HYU|BYO|BYA|BYU|PYO|PYA|PYU|[BCDFGHJKLMNPQRSTVWXYZ]?[AEIOU]|NN|N)/g);
    return m ? m : [s];
  }
  function formatRomajiSpaced(romaji){
    const blocks = splitRomajiBlocks(romaji);
    return blocks.join(" ");
  }

  // ====== ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ï¼ˆãƒ­ãƒ¼ãƒå­—/ã²ã‚‰ãŒãªï¼‰ ======
  const KEY_ROWS_ROMA = [
    ["WA","RA","YA","MA","HA","NA","TA","SA","KA","A"],
    ["","RI","","MI","HI","NI","TI","SI","KI","I"],
    ["WO","RU","YU","MU","HU","NU","TU","SU","KU","U"],
    ["","RE","","ME","HE","NE","TE","SE","KE","E"],
    ["NN","RO","YO","MO","HO","NO","TO","SO","KO","O"],
  ];
  const KEY_ROWS_KANA = [
    ["ã‚","ã‚‰","ã‚„","ã¾","ã¯","ãª","ãŸ","ã•","ã‹","ã‚"],
    ["","ã‚Š","","ã¿","ã²","ã«","ã¡","ã—","ã","ã„"],
    ["ã‚’","ã‚‹","ã‚†","ã‚€","ãµ","ã¬","ã¤","ã™","ã","ã†"],
    ["","ã‚Œ","","ã‚","ã¸","ã­","ã¦","ã›","ã‘","ãˆ"],
    ["ã‚“","ã‚","ã‚ˆ","ã‚‚","ã»","ã®","ã¨","ã","ã“","ãŠ"],
  ];

  // ====== çŠ¶æ…‹ ======
  const rowNames = Object.keys(WORDS_BY_ROW);
  let selectedRow = null;
  let shuffleInRow = true;
  let colorOn = false;

  // â˜…å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰
  let quizMode = "k2r"; // "k2r" or "r2k"

  // â˜…è¿½åŠ ï¼šãƒ­ãƒ¼ãƒå­—ã‚’é›¢ã™ï¼ˆè¡¨ç¤ºã ã‘ï¼‰
  let spaceOn = false;

  let queue = [];
  let idx = 0;
  let correct = 0;
  let inputTokens = [];

  // â˜…æç¤ºæ™‚é–“ï¼šæ­£è§£ã ã‘1.2ç§’ / ä¸æ­£è§£ã¯3ç§’
  const CORRECT_DELAY_MS = 1200;
  const WRONG_DELAY_MS   = 3000;

  // â˜…5å›æ­£è§£ã”ã¨ã«ã”ã»ã†ã³
  const GIMMICK_EVERY = 5;

  // â˜…é€£æ‰“ãƒ»å¤šé‡ã‚¿ã‚¤ãƒãƒ¼é˜²æ­¢
  let checkLocked = false;

  // ====== ã”ã»ã†ã³å¾—ç‚¹ ======
  let bonusTotal = 0;
  let kusudamaMaxLevelShown = 0;
  let pendingAdvanceAfterReward = null;

  // ====== DOM ======
  const elSetup = document.getElementById("screenSetup");
  const elPlay  = document.getElementById("screenPlay");
  const elKbdCard = document.getElementById("kbdCard");

  const elRowToggles = document.getElementById("rowToggles");
  const elStartBtn = document.getElementById("startBtn");
  const elModeToggle = document.getElementById("modeToggle");
  const elShuffleToggle = document.getElementById("shuffleToggle");
  const elColorToggle = document.getElementById("colorToggle");
  const elSpaceToggle = document.getElementById("spaceToggle"); // â˜…è¿½åŠ 

  const elWord = document.getElementById("wordKana");
  const elAns = document.getElementById("ansField");
  const elMsg = document.getElementById("msg");
  const elProgress = document.getElementById("progress");
  const elScore = document.getElementById("score");
  const elStatTop = document.getElementById("statTop");
  const elRowNow = document.getElementById("rowNow");
  const elBonusScore = document.getElementById("bonusScore");
  const elBonusBadge = document.querySelector(".bonus-display");

  const elBack = document.getElementById("backBtn");
  const elClear = document.getElementById("clearBtn");
  const elCheck = document.getElementById("checkBtn");
  const elExit = document.getElementById("exitBtn");

  const elKbd = document.getElementById("kbd");

  // ====== ã”ã»ã†ã³DOM ======
  const rewardOverlay = document.getElementById("rewardOverlay");
  const rewardTitle = document.getElementById("rewardTitle");
  const rewardSub = document.getElementById("rewardSub");
  const rewardPoints = document.getElementById("rewardPoints");
  const rewardActionBtn = document.getElementById("rewardActionBtn");

  const rewardSlot = document.getElementById("rewardSlot");
  const rewardRoulette = document.getElementById("rewardRoulette");
  const rewardCards = document.getElementById("rewardCards");

  const slotBoxes = document.querySelectorAll(".slot-box");
  const slotHint = document.getElementById("slotHint");

  const rouletteNumEl = document.getElementById("rouletteNum");
  const rouletteCircle = document.querySelector(".roulette-circle");

  const drawCards = document.querySelectorAll(".draw-card");

  // ====== ãã™ç‰DOM ======
  const kusudamaOverlay = document.getElementById("kusudamaOverlay");
  const kusudamaCloseBtn = document.getElementById("kusudamaCloseBtn");
  const kusudamaTitleEl  = document.getElementById("kusudamaTitle");

  // ====== util ======
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    return arr;
  }
  function setScreen(which){
    elSetup.style.display = (which==="setup") ? "" : "none";
    elPlay.style.display  = (which==="play")  ? "" : "none";
    elKbdCard.style.display = (which==="play") ? "" : "none";
  }
  function showMsg(type, text){
    elMsg.style.display = "";
    elMsg.className = "msg " + (type === "ok" ? "ok" : "ng");
    elMsg.textContent = text;
  }
  function hideMsg(){ elMsg.style.display = "none"; }

  function renderTopStat(){
    if(!selectedRow){
      elStatTop.textContent = "ãƒœã‚¿ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„";
      return;
    }
    elStatTop.textContent = `${selectedRow}ï¼š${WORDS_BY_ROW[selectedRow].length}èª`;
  }

  // ====== è‰²è¡¨ç¤ºï¼ˆæ¯éŸ³ã ã‘è‰²ï¼‰ ======
  function vowelClass(ch){
    if(ch==="A") return "c-a";
    if(ch==="I") return "c-i";
    if(ch==="U") return "c-u";
    if(ch==="E") return "c-e";
    if(ch==="O") return "c-o";
    return "c-k";
  }

  // ãƒ­ãƒ¼ãƒå­—ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆå…¥åŠ›ç”¨ï¼šã‹ãªâ†’ãƒ­ãƒ¼ãƒå­—ã®ã¨ãã ã‘ä½¿ç”¨ï¼‰
  function renderRomaTokenHTML(token){
    if(!colorOn) return `<span class="mono">${token}</span>`;
    const parts = [];
    for(const ch of token){
      const cls = ("AEIOU".includes(ch)) ? vowelClass(ch) : "c-k";
      parts.push(`<span class="${cls}">${ch}</span>`);
    }
    return parts.join("");
  }

  // â˜…å‡ºé¡Œãƒ­ãƒ¼ãƒå­—ï¼ˆãƒ­ãƒ¼ãƒå­—â†’ã‹ãªã®ã¨ãï¼šæ¯éŸ³ã ã‘è‰²ã€å­éŸ³ã¯é»’ï¼‰
  function renderRomaWordHTML(word){
    // ã¾ãšã€Œé›¢ã™ã€è¡¨ç¤ºã‚’ä½œã‚‹ï¼ˆè‰²ãªã—ãªã‚‰ãƒ†ã‚­ã‚¹ãƒˆã§OKï¼‰
    const raw = spaceOn ? formatRomajiSpaced(word) : word;

    if(!(quizMode==="r2k" && colorOn)) return raw; // è‰²ãªã—oråˆ¥ãƒ¢ãƒ¼ãƒ‰ã¯ãã®ã¾ã¾

    // è‰²ã‚ã‚Šï¼šã‚¹ãƒšãƒ¼ã‚¹ã‚’ä¿ã¡ãªãŒã‚‰1æ–‡å­—ãšã¤è‰²ä»˜ã‘
    const parts = [];
    for(const ch of raw){
      if(ch === " "){
        parts.push("&nbsp;"); // é€£ç¶šã‚¹ãƒšãƒ¼ã‚¹ãŒæ½°ã‚Œãªã„ã‚ˆã†ã«
        continue;
      }
      const cls = ("AEIOU".includes(ch)) ? vowelClass(ch) : "c-k";
      parts.push(`<span class="${cls}">${ch}</span>`);
    }
    return parts.join("");
  }

  // ====== å…¥åŠ›æ¬„è¡¨ç¤º ======
  function updateAnswerField(){
    if(inputTokens.length === 0){
      elAns.textContent = "ï¼ˆã“ã“ã«å…¥åŠ›ã•ã‚Œã¾ã™ï¼‰";
      return;
    }

    const sep = spaceOn ? '<span class="mono">&nbsp;</span>' : '';

    // â˜…ãƒ­ãƒ¼ãƒå­—â†’ã‹ãª ã®ã¨ãã¯ã€Œè‰²ã‚ã‚Šã§ã‚‚å…¥åŠ›ã¯å…¨ã¦é»’ã€
    if(quizMode === "r2k"){
      elAns.innerHTML = inputTokens.map(t => `<span class="mono">${t}</span>`).join(sep);
      return;
    }

    // ã‹ãªâ†’ãƒ­ãƒ¼ãƒå­—ï¼ˆå¾“æ¥ã©ãŠã‚Šã€‚è¡¨ç¤ºã ã‘ã‚¹ãƒšãƒ¼ã‚¹ã‚’æŒŸã‚€ï¼‰
    elAns.innerHTML = inputTokens.map(renderRomaTokenHTML).join(sep);
  }

  function updateBonusUI(){
    elBonusScore.textContent = String(bonusTotal);
    elBonusBadge.classList.remove("bonus-pop");
    void elBonusBadge.offsetWidth;
    elBonusBadge.classList.add("bonus-pop");
  }

  // ====== Setup buttons ======
  function renderRowToggles(){
    elRowToggles.innerHTML = "";
    rowNames.forEach(name => {
      const chip = document.createElement("button");
      chip.className = "chip" + (selectedRow === name ? " on" : "");
      chip.textContent = name;
      chip.addEventListener("click", () => {
        selectedRow = (selectedRow === name) ? null : name;
        elStartBtn.disabled = !selectedRow;
        renderRowToggles();
        renderTopStat();
      });
      elRowToggles.appendChild(chip);
    });
    renderTopStat();
  }

  // å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
  function renderModeLabel(){
    elModeToggle.textContent = `å‡ºé¡Œï¼š${quizMode === "k2r" ? "ã‹ãªâ†’ãƒ­ãƒ¼ãƒå­—" : "ãƒ­ãƒ¼ãƒå­—â†’ã‹ãª"}`;
  }
  elModeToggle.addEventListener("click", () => {
    quizMode = (quizMode === "k2r") ? "r2k" : "k2r";
    renderModeLabel();
    renderKeyboard();
    inputTokens = [];
    updateAnswerField();
    hideMsg();
    // â˜…ãƒ—ãƒ¬ã‚¤ä¸­ãªã‚‰å‡ºé¡Œå†æç”»ï¼ˆãƒ­ãƒ¼ãƒå­—è¡¨ç¤ºãŒå¤‰ã‚ã‚‹ãŸã‚ï¼‰
    if(elPlay.style.display !== "none"){
      renderQuestion();
    }
  });

  elShuffleToggle.addEventListener("click", () => {
    shuffleInRow = !shuffleInRow;
    elShuffleToggle.textContent = `è¡Œå†…ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼š${shuffleInRow ? "ON" : "OFF"}`;
  });

  elColorToggle.addEventListener("click", () => {
    colorOn = !colorOn;
    elColorToggle.textContent = `è‰²ã‚ã‚Šï¼š${colorOn ? "ON" : "OFF"}`;
    renderKeyboard();
    updateAnswerField();

    // â˜…ãƒ—ãƒ¬ã‚¤ä¸­ãªã‚‰å‡ºé¡Œè¡¨ç¤ºã‚‚æ›´æ–°ï¼ˆãƒ­ãƒ¼ãƒå­—â†’ã‹ãªã§è‰²ãŒåæ˜ ã•ã‚Œã‚‹ï¼‰
    if(elPlay.style.display !== "none"){
      renderQuestion();
    }
  });

  // â˜…è¿½åŠ ï¼šãƒ­ãƒ¼ãƒå­—ã‚’é›¢ã™ ON/OFF
  elSpaceToggle.addEventListener("click", () => {
    spaceOn = !spaceOn;
    elSpaceToggle.textContent = `ãƒ­ãƒ¼ãƒå­—ã‚’ã¯ãªã™ï¼š${spaceOn ? "ON" : "OFF"}`;
    updateAnswerField();
    // â˜…ãƒ—ãƒ¬ã‚¤ä¸­ãªã‚‰å‡ºé¡Œè¡¨ç¤ºã‚‚æ›´æ–°ï¼ˆãƒ­ãƒ¼ãƒå­—â†’ã‹ãªã®æç¤ºãŒå¤‰ã‚ã‚‹ï¼‰
    if(elPlay.style.display !== "none"){
      renderQuestion();
    }
  });

  // ====== Keyboard ======
  function renderKeyboard(){
    elKbd.innerHTML = "";
    const layout = (quizMode === "k2r") ? KEY_ROWS_ROMA : KEY_ROWS_KANA;

    layout.flat().forEach(label => {
      const key = document.createElement("button");
      if(!label){
        key.disabled = true;
        key.style.visibility = "hidden";
        key.className = "key";
        key.textContent = "â€”";
      }else{
        key.className = "key";

        // â˜…ãƒ­ãƒ¼ãƒå­—â†’ã‹ãª ã®ã¨ãï¼šå…¥åŠ›ã‚­ãƒ¼ã¯è‰²ã‚ã‚Šã§ã‚‚å…¨éƒ¨é»’
        if(quizMode === "r2k"){
          key.innerHTML = `<span class="mono">${label}</span>`;
        }else{
          // ã‹ãªâ†’ãƒ­ãƒ¼ãƒå­—ï¼ˆå¾“æ¥ã©ãŠã‚Šï¼‰
          key.innerHTML = renderRomaTokenHTML(label);
        }

        key.addEventListener("click", () => {
          if(checkLocked) return;
          inputTokens.push(label);
          updateAnswerField();
          hideMsg();
        });
      }
      elKbd.appendChild(key);
    });
  }

  // ====== Game ======
  function buildQueueForSelectedRow(){
    const list = WORDS_BY_ROW[selectedRow].map(kana => ({ row:selectedRow, kana }));
    return shuffleInRow ? shuffle(list) : list;
  }

  function startGame(){
    queue = buildQueueForSelectedRow();
    idx = 0;
    correct = 0;
    bonusTotal = 0;
    kusudamaMaxLevelShown = 0;
    inputTokens = [];
    hideMsg();
    checkLocked = false;
    rewardOverlay.classList.add("hidden");
    kusudamaOverlay.classList.add("hidden");
    setScreen("play");
    elRowNow.textContent = selectedRow;
    renderQuestion();
    updateAnswerField();
    elBonusScore.textContent = "0";
  }

  function renderQuestion(){
    if(idx >= queue.length){
      setScreen("setup");
      return;
    }
    const q = queue[idx];

    if(quizMode === "k2r"){
      elWord.textContent = q.kana;
    }else{
      const rom = kanaToRoma(q.kana);
      // â˜…ãƒ­ãƒ¼ãƒå­—â†’ã‹ãªï¼šå‡ºé¡Œãƒ­ãƒ¼ãƒå­—ï¼ˆspaceOnãªã‚‰ TU KU E ã¿ãŸã„ã«é›¢ã™ï¼‰
      elWord.innerHTML = renderRomaWordHTML(rom);
    }

    elProgress.textContent = `${idx+1} / ${queue.length}`;
    elScore.textContent = `æ­£è§£ ${correct}`;
    inputTokens = [];
    updateAnswerField();
    hideMsg();
    checkLocked = false;
  }

  // ====== ã”ã»ã†ã³ä»•æ›ã‘ï¼ˆè²¼ã£ã¦ãã‚ŒãŸã‚¢ãƒ—ãƒªã®æŒ™å‹•ã‚’ç§»æ¤ï¼‰ ======
  // --- ã‚¹ãƒ­ãƒƒãƒˆ ---
  let slotValues = [7,7,7];
  let slotTimers = [null,null,null];
  let slotSpinning = [false,false,false];
  let slotGameRunning = false;
  const MIN_NUM = 1, MAX_NUM = 7;

  function slotNextValue(v){
    let n = v + 1;
    if (n > MAX_NUM) n = MIN_NUM;
    return n;
  }
  function slotUpdateView(i){
    const numEl = slotBoxes[i].querySelector(".slot-num");
    numEl.textContent = slotValues[i];
  }
  function slotStartReel(i){
    slotSpinning[i] = true;
    slotBoxes[i].classList.remove("stopped");
    slotBoxes[i].classList.add("spinning");
    slotTimers[i] = setInterval(()=>{
      slotValues[i] = slotNextValue(slotValues[i]);
      slotUpdateView(i);
    }, 360);
  }
  function slotStopReel(i){
    if (!slotSpinning[i]) return;
    slotSpinning[i] = false;
    clearInterval(slotTimers[i]);
    slotTimers[i] = null;
    slotBoxes[i].classList.remove("spinning");
    slotBoxes[i].classList.add("stopped");
    if (!slotSpinning[0] && !slotSpinning[1] && !slotSpinning[2]) {
      slotFinish();
    }
  }
  function slotClearAll(){
    for (let i=0;i<3;i++){
      if (slotTimers[i]) clearInterval(slotTimers[i]);
      slotTimers[i] = null;
      slotSpinning[i] = false;
    }
  }
  function slotStartGame(){
    slotClearAll();
    slotValues = [
      Math.floor(Math.random()*(MAX_NUM - MIN_NUM + 1)) + MIN_NUM,
      Math.floor(Math.random()*(MAX_NUM - MIN_NUM + 1)) + MIN_NUM,
      Math.floor(Math.random()*(MAX_NUM - MIN_NUM + 1)) + MIN_NUM
    ];
    for (let i=0;i<3;i++){
      slotUpdateView(i);
      slotStartReel(i);
    }
    slotGameRunning = true;
    slotHint.textContent = "æ­¢ã‚ãŸã„ã¨ã“ã‚ã§ãã‚Œãã‚Œã‚¿ãƒƒãƒ—ã—ã¦ã­ã€‚";
    rewardActionBtn.disabled = true;
  }
  function slotFinish(){
    slotGameRunning = false;
    const [a,b,c] = slotValues;
    const allEqual = (a===b && b===c);
    let text = `å‡ºãŸæ•°å­—ï¼š${slotValues.join(" ãƒ» ")}`;
    let points = 0;
    if(allEqual){
      points = a + b + c;
      text += `ã€€â†’ã€€å¾—ç‚¹ <strong>${points}</strong> ç‚¹ï¼`;
    }else{
      text += "ã€€â†’ã€€ä»Šå›ã¯å¾—ç‚¹ãªã—";
    }
    rewardPoints.innerHTML = text;
    slotHint.textContent = "";
    rewardActionBtn.disabled = false;
    rewardActionBtn.textContent = "ã¤ãã¸ â–¶";
    rewardActionBtn.onclick = () => finishReward(points);
  }

  slotBoxes.forEach(el=>{
    const i = Number(el.dataset.slot);
    el.addEventListener("click", ()=>{
      if(!slotGameRunning) return;
      if(!slotSpinning[i]) return;
      slotStopReel(i);
    });
  });

  // --- ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆï¼ˆã‚¿ãƒƒãƒ—ã§æ­¢ã¾ã‚‹ï¼‰ ---
  let rouletteTimer = null;
  let rouletteRunning = false;
  let rouletteCurrent = 1;

  function startRoulette(){
    if(rouletteRunning) return;
    rouletteRunning = true;
    rewardPoints.textContent = "";
    rewardActionBtn.disabled = false;
    rewardActionBtn.textContent = "ã‚¹ãƒˆãƒƒãƒ—";

    rouletteCurrent = Math.floor(Math.random()*10)+1;
    rouletteNumEl.textContent = rouletteCurrent;

    if(rouletteTimer) clearInterval(rouletteTimer);
    rouletteTimer = setInterval(()=>{
      rouletteCurrent++;
      if(rouletteCurrent>10) rouletteCurrent = 1;
      rouletteNumEl.textContent = rouletteCurrent;
    },140);

    const stop = ()=>{
      if(!rouletteRunning) return;
      rouletteRunning = false;
      clearInterval(rouletteTimer);
      rouletteTimer = null;
      const final = rouletteCurrent;
      rouletteNumEl.textContent = final;
      const text = `å‡ºãŸæ•°å­—ï¼š${final}ã€€â†’ã€€å¾—ç‚¹ <strong>${final}</strong> ç‚¹ï¼`;
      rewardPoints.innerHTML = text;
      rewardActionBtn.textContent = "ã¤ãã¸ â–¶";
      rewardActionBtn.onclick = () => finishReward(final);
      rouletteCircle.removeEventListener("click", stop);
    };

    rewardActionBtn.onclick = stop;
    rouletteCircle.addEventListener("click", stop);
  }

  // --- ã‚«ãƒ¼ãƒ‰ ---
  let cardChosen = false;
  function setupCards(){
    cardChosen = false;
    rewardPoints.textContent = "";
    drawCards.forEach(c=>{
      c.classList.remove("revealed");
      c.textContent = "";
    });
    rewardActionBtn.disabled = true;
    rewardActionBtn.textContent = "ã¤ãã¸ â–¶";
    rewardActionBtn.onclick = ()=>{};
  }

  drawCards.forEach(c=>{
    c.addEventListener("click", ()=>{
      if(cardChosen) return;
      cardChosen = true;
      const val = Math.floor(Math.random()*10)+1;
      c.classList.add("revealed");
      c.textContent = val;
      rewardPoints.innerHTML = `ãˆã‚‰ã‚“ã ã‚«ãƒ¼ãƒ‰ï¼š${val}ã€€â†’ã€€å¾—ç‚¹ <strong>${val}</strong> ç‚¹ï¼`;
      rewardActionBtn.disabled = false;
      rewardActionBtn.onclick = () => finishReward(val);
    });
  });

  function startReward(onDoneAdvance){
    pendingAdvanceAfterReward = onDoneAdvance;

    rewardOverlay.classList.remove("hidden");
    rewardPoints.textContent = "";
    rewardTitle.textContent = "ã”ã»ã†ã³ã‚¿ã‚¤ãƒ ï¼";
    rewardSub.textContent = "ã©ã‚ŒãŒå‡ºã‚‹ã‹ãªï¼Ÿ";

    rewardActionBtn.disabled = false;
    rewardActionBtn.textContent = "ã‚¹ã‚¿ãƒ¼ãƒˆ";

    rewardSlot.style.display = "none";
    rewardRoulette.style.display = "none";
    rewardCards.style.display = "none";

    const types = ["slot","roulette","cards"];
    const type = types[Math.floor(Math.random()*types.length)];

    // ãƒªã‚»ãƒƒãƒˆ
    rouletteRunning = false;
    if(rouletteTimer) { clearInterval(rouletteTimer); rouletteTimer = null; }
    rouletteNumEl.textContent = "?";
    slotGameRunning = false;
    slotClearAll();
    slotHint.textContent = "";

    if(type==="slot"){
      rewardSlot.style.display = "";
      slotValues = [7,7,7];
      for(let i=0;i<3;i++){
        slotBoxes[i].classList.remove("spinning");
        slotBoxes[i].classList.add("stopped");
        slotUpdateView(i);
      }
      rewardActionBtn.textContent = "ã‚¹ã‚¿ãƒ¼ãƒˆ";
      rewardActionBtn.onclick = () => slotStartGame();

    }else if(type==="roulette"){
      rewardRoulette.style.display = "";
      rewardActionBtn.textContent = "ã‚¹ã‚¿ãƒ¼ãƒˆ";
      rewardActionBtn.onclick = () => startRoulette();

    }else{
      rewardCards.style.display = "";
      setupCards();
      rewardTitle.textContent = "ã‚«ãƒ¼ãƒ‰ã‚’1ã¾ã„ãˆã‚‰ã‚“ã§ã­";
      rewardSub.textContent = "";
    }
  }

  // ãã™ç‰
  kusudamaCloseBtn.addEventListener("click", ()=>{
    kusudamaOverlay.classList.add("hidden");
    if(typeof pendingAdvanceAfterReward === "function"){
      const fn = pendingAdvanceAfterReward;
      pendingAdvanceAfterReward = null;
      fn();
    }
  });

  function maybeShowKusudama(prevTotal, newTotal, after){
    const prevLevel = Math.floor(prevTotal / 30);
    const newLevel  = Math.floor(newTotal / 30);
    if(newLevel > prevLevel && newLevel > 0 && newLevel > kusudamaMaxLevelShown){
      kusudamaMaxLevelShown = newLevel;
      const levelScore = newLevel * 30;
      kusudamaTitleEl.textContent = levelScore + "ç‚¹ãŠã‚ã§ã¨ã†ï¼";
      kusudamaOverlay.classList.remove("hidden");
    }else{
      after();
    }
  }

  function finishReward(points){
    const before = bonusTotal;
    bonusTotal += points;
    elBonusScore.textContent = String(bonusTotal);
    updateBonusUI();

    rewardOverlay.classList.add("hidden");

    maybeShowKusudama(before, bonusTotal, ()=>{
      if(typeof pendingAdvanceAfterReward === "function"){
        const fn = pendingAdvanceAfterReward;
        pendingAdvanceAfterReward = null;
        fn();
      }
    });
  }

  // ====== åˆ¤å®š ======
  function getExpectedAnswer(q){
    return (quizMode === "k2r") ? kanaToRoma(q.kana) : q.kana;
  }

  function checkAnswer(){
    if(checkLocked) return;
    checkLocked = true;

    const q = queue[idx];
    const answer = getExpectedAnswer(q);
    const typed = inputTokens.join("");

    if(typed === answer){
      correct++;
      showMsg("ok", "ã‚ˆãã§ãã¾ã—ãŸï¼");
      elScore.textContent = `æ­£è§£ ${correct}`;

      if(correct > 0 && correct % GIMMICK_EVERY === 0){
        setTimeout(() => {
          startReward(() => {
            idx++;
            renderQuestion();
          });
        }, CORRECT_DELAY_MS);
      }else{
        setTimeout(() => {
          idx++;
          renderQuestion();
        }, CORRECT_DELAY_MS);
      }

    }else{
      inputTokens = [];
      updateAnswerField();

      // â˜…ãƒ­ãƒ¼ãƒå­—æ­£è§£ã®è¡¨ç¤ºã ã‘ã€Œé›¢ã™ã€å¯¾å¿œï¼ˆåˆ¤å®šè‡ªä½“ã¯ã‚¹ãƒšãƒ¼ã‚¹ãªã—ï¼‰
      const showAns = (quizMode === "k2r" && spaceOn) ? formatRomajiSpaced(answer) : answer;

      showMsg("ng", `ãŠã—ã„ï¼ æ­£è§£ï¼š${showAns}`);

      setTimeout(() => {
        hideMsg();
        checkLocked = false;
      }, WRONG_DELAY_MS);
    }
  }

  function backspaceOneToken(){
    if(checkLocked) return;
    inputTokens.pop();
    updateAnswerField();
  }

  function exitToTop(){
    idx = 0;
    correct = 0;
    bonusTotal = 0;
    kusudamaMaxLevelShown = 0;
    inputTokens = [];
    queue = [];
    hideMsg();
    checkLocked = false;

    rewardOverlay.classList.add("hidden");
    kusudamaOverlay.classList.add("hidden");
    pendingAdvanceAfterReward = null;

    setScreen("setup");
  }

  // ====== Events ======
  elStartBtn.addEventListener("click", () => {
    if(!selectedRow){
      alert("ãƒœã‚¿ãƒ³ã‚’1ã¤é¸ã‚“ã§ãã ã•ã„ã€‚");
      return;
    }
    startGame();
  });

  elBack.addEventListener("click", () => { backspaceOneToken(); hideMsg(); });
  elClear.addEventListener("click", () => {
    if(checkLocked) return;
    inputTokens = []; updateAnswerField(); hideMsg();
  });
  elCheck.addEventListener("click", () => { checkAnswer(); });
  elExit.addEventListener("click", () => { exitToTop(); });

  window.addEventListener("keydown", (e) => {
    if(elPlay.style.display === "none") return;
    if(e.key === "Enter"){ e.preventDefault(); checkAnswer(); }
    if(e.key === "Backspace"){ e.preventDefault(); backspaceOneToken(); }
    if(e.key === "Escape"){ e.preventDefault(); exitToTop(); }
  });

  // ====== init ======
  renderRowToggles();
  renderModeLabel();

  // åˆæœŸãƒ©ãƒ™ãƒ«
  elStartBtn.disabled = true;
  elShuffleToggle.textContent = "è¡Œå†…ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼šON";
  elColorToggle.textContent = "è‰²ã‚ã‚Šï¼šOFF";
  elSpaceToggle.textContent = "ãƒ­ãƒ¼ãƒå­—ã‚’ã¯ãªã™ï¼šOFF";

  renderKeyboard();
  setScreen("setup");
})();
</script>
</body>
</html>
