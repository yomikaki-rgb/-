<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç†Ÿèªã¥ãã‚Šã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ </title>
<style>
  :root{
    --bg1:#eef2ff; --bg2:#f3e8ff;
    --card:#ffffffd9;
    --ink:#111827; --sub:#4b5563;
    --primary:#4f46e5; --primarySoft:#e0e7ff;
    --ok:#16a34a; --ng:#dc2626;
    --border:#d1d5db;
    --shadow:0 10px 25px rgba(0,0,0,.08);
    --radius:18px;

    --sameTileSize: 110px;
  }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  body{
    margin:0; min-height:100vh; padding:16px;
    display:flex; justify-content:center; align-items:center;
    background:linear-gradient(135deg,var(--bg1),var(--bg2));
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Hiragino Kaku Gothic ProN","Yu Gothic","Meiryo",sans-serif;
    color:var(--ink);
  }
  .app{
    width:min(1080px,100%);
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
    position:relative;
  }
  header{
    padding:16px 18px;
    border-bottom:1px solid var(--border);
    display:flex; gap:12px; align-items:center; justify-content:space-between;
    background:linear-gradient(180deg,#ffffffcc,#ffffff99);
  }
  header h1{ margin:0; font-size:18px; letter-spacing:.02em; }
  .pill{
    font-size:12px; color:var(--sub);
    background:var(--primarySoft);
    border:1px solid #c7d2fe;
    padding:6px 10px;
    border-radius:999px;
    display:inline-flex; gap:8px; align-items:center;
    white-space:nowrap;
  }
  .wrap{ padding:16px 18px 18px; display:grid; gap:14px; }

  .grid{
    display:grid;
    grid-template-columns: 1.75fr .25fr;
    gap:14px;
  }
  @media (max-width:980px){
    .grid{ grid-template-columns:1fr; }
  }

  .card{
    background:#fff;
    border:1px solid var(--border);
    border-radius:16px;
    padding:14px;
  }
  .card h2{
    margin:0 0 10px 0;
    font-size:14px;
    color:var(--sub);
    font-weight:700;
    letter-spacing:.02em;
  }

  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .row > *{ flex:0 0 auto; }

  button{
    border:1px solid var(--border);
    background:#fff;
    color:var(--ink);
    border-radius:14px;
    padding:10px 12px;
    font-weight:700;
    cursor:pointer;
    box-shadow:0 6px 16px rgba(0,0,0,.06);
  }
  button.primary{
    background:var(--primary);
    border-color:var(--primary);
    color:#fff;
  }
  button.warn{
    background:#fff7ed;
    border-color:#fed7aa;
  }
  button:disabled{ opacity:.5; cursor:not-allowed; box-shadow:none; }
  select, input{
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px 12px;
    font-weight:700;
    background:#fff;
    color:var(--ink);
  }
  input{ width:110px; }

  .sectionTitle{
    margin:14px 0 8px 0;
    font-size:15px;
    font-weight:900;
    color:var(--ink);
  }

  .tiles{
    display:grid;
    grid-template-columns: repeat(7, minmax(0, 1fr));
    gap:10px;
  }
  @media (max-width:520px){ .tiles{ grid-template-columns: repeat(3, minmax(0, 1fr)); } }

  .tile{
    user-select:none;
    border:1px solid var(--border);
    border-radius:18px;
    background:#fff;
    padding:18px 0px;
    text-align:center;
    font-size:44px;
    font-weight:900;
    line-height:1;
    box-shadow:0 10px 22px rgba(0,0,0,.07);
    cursor:pointer;
    overflow:hidden;
  }
  .tile.bad{
    animation:shake .25s linear 1;
    outline:3px solid #fecaca;
    border-color:#fecaca;
    background:#fff1f2;
  }
  @keyframes shake{
    0%{ transform:translateX(0); }
    25%{ transform:translateX(-3px); }
    50%{ transform:translateX(3px); }
    75%{ transform:translateX(-2px); }
    100%{ transform:translateX(0); }
  }

  .msg{
    margin-top:10px;
    padding:12px 14px;
    border-radius:16px;
    font-weight:900;
    font-size:16px;
    border:1px solid var(--border);
    background:#fff;
    color:var(--sub);
  }
  .msg.ok{ border-color:#bbf7d0; background:#ecfdf5; color:#166534; }
  .msg.ng{ border-color:#fecaca; background:#fff1f2; color:#991b1b; }

  .miniInfo{
    margin-top:8px;
    padding:10px 12px;
    border-radius:14px;
    border:1px dashed var(--border);
    background:#f8fafc;
    color:var(--sub);
    font-weight:900;
    display:flex;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  #missInfo{ display:none; }

  .scoreboard{
    display:flex;
    gap:8px;
    flex-wrap:nowrap;
    align-items:stretch;
  }
  .pRow{
    flex:1 1 0;
    min-width:0;
    display:flex; gap:8px; align-items:flex-start; justify-content:space-between;
    padding:6px 10px;
    border:1px solid var(--border);
    border-radius:14px; background:#fff;
  }
  .pRow .left{
    display:flex; gap:8px; align-items:center; font-weight:900;
    min-width:0;
  }
  .pRow .left span:last-child{
    font-size:12px;
    white-space:nowrap;
  }
  .pRow .pts{
    font-weight:900; color:var(--ink);
    display:flex; gap:8px; align-items:center;
    white-space:nowrap;
    font-size:12px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .pRow .ptVal{ color:var(--ng); }
  .statusTag{
    display:block;
    margin-top:2px;
    font-size:11px;
    font-weight:900;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid #fecaca;
    background:#fff1f2;
    color:#991b1b;
    white-space:nowrap;
    flex: 1 0 100%;
    text-align:right;
  }
  .statusTag.miss{
    border-color:#fed7aa;
    background:#fff7ed;
    color:#9a3412;
  }

  .dot{ width:10px; height:10px; border-radius:999px; background:#cbd5e1; }
  .pRow.active{
    border-color:#a5b4fc;
    background:#eef2ff;
    animation:activePulse 980ms ease-in-out infinite;
  }
  .pRow.active .dot{
    background:#4f46e5;
    animation:dotPulse 980ms ease-in-out infinite;
  }
  @keyframes activePulse{
    0%{ box-shadow:0 0 0 rgba(79,70,229,.0); transform:translateY(0); }
    50%{ box-shadow:0 0 0 6px rgba(79,70,229,.14); transform:translateY(-1px); }
    100%{ box-shadow:0 0 0 rgba(79,70,229,.0); transform:translateY(0); }
  }
  @keyframes dotPulse{
    0%{ transform:scale(1); opacity:.75; }
    50%{ transform:scale(1.25); opacity:1; }
    100%{ transform:scale(1); opacity:.75; }
  }

  details{ border:1px solid var(--border); border-radius:14px; overflow:hidden; background:#fff; }
  summary{
    cursor:pointer; padding:10px 12px; font-weight:900; color:var(--sub);
    list-style:none;
  }
  summary::-webkit-details-marker{ display:none; }
  .list{ padding:0 12px 12px; display:flex; gap:8px; flex-wrap:wrap; }
  .tag{
    font-size:14px;
    font-weight:900;
    color:var(--ink);
    background:#f1f5e9;
    border:1px solid #e2e8f0;
    padding:8px 12px;
    border-radius:999px;
  }
  .muted{ color:var(--sub); }

  /* â–¼â–¼â–¼ ã“ã“ã ã‘å¤‰æ›´ï¼šå³å´ã®è¨­å®šè¡Œã‚’æ”¹è¡Œã—ãªã„ã§1åˆ—è¡¨ç¤ºã«ã™ã‚‹ â–¼â–¼â–¼ */
  #rightSide .settingRow{
    flex-wrap:nowrap;
    align-items:center;
  }
  #rightSide .settingRow label{
    white-space:nowrap;
    flex:0 0 auto;
  }
  #rightSide .settingRow select,
  #rightSide .settingRow input{
    white-space:nowrap;
    flex:1 1 auto;
    min-width:0;
  }
  /* â–²â–²â–² ã“ã“ã ã‘å¤‰æ›´ â–²â–²â–² */

  .drawPickGrid{
    display:grid;
    grid-template-columns: minmax(240px, 0.70fr) minmax(0, 1.30fr);
    gap:4px;
    align-items:start;
    margin-top:6px;
  }
  .drawPickCol{ min-width:0; }
  .drawPickCol .sectionTitle{ margin-top:0; }

  .pickPanel{
    display:flex; gap:12px; align-items:center;
    flex-wrap:nowrap;
    overflow:visible;
    background:#fff; border:1px solid var(--border);
    border-radius:18px; padding:14px;
    box-shadow:0 10px 22px rgba(0,0,0,.07);
    min-width:0;
  }

  .slotWrap{ display:flex; gap:8px; align-items:center; min-width:0; }
  .slotLabel{ font-size:14px; color:var(--sub); font-weight:900; }

  .slot{
    width:var(--sameTileSize); height:var(--sameTileSize);
    border-radius:18px;
    border:1px solid var(--border);
    background:#f8fafc;
    display:grid; place-items:center;
    font-size:44px; font-weight:900;
    cursor:pointer;
    user-select:none;
    overflow:hidden;
    flex:0 0 auto;
  }
  .slot.filled{ background:#fff; }

  .eq{ font-weight:900; color:var(--sub); font-size:20px; flex:0 0 auto; }

  .wordBox{
    min-width:120px;
    padding:14px 16px;
    border-radius:18px;
    border:1px solid var(--border);
    background:#fff;
    font-weight:900;
    font-size:28px;
    text-align:center;
    flex:1 1 auto;
    white-space:nowrap;
  }

  .chip{
    border:1px solid var(--border);
    background:#fff;
    border-radius:999px;
    padding:10px 14px;
    font-weight:900;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:10px;
    box-shadow:0 6px 16px rgba(0,0,0,.06);
  }
  .chip .mini{
    width:var(--sameTileSize); height:var(--sameTileSize);
    display:grid; place-items:center;
    border-radius:18px;
    border:1px solid var(--border);
    font-size:44px;
    font-weight:900;
    background:#f8fafc;
    line-height:1;
    overflow:hidden;
  }
  .chip:disabled{ opacity:.5; cursor:not-allowed; box-shadow:none; }

  .speakBtn{
    margin:10px 12px 0;
    display:inline-flex;
    align-items:center;
    gap:8px;
    font-weight:900;
  }

  .ansSpeakWrap{
    margin-top:10px;
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }
  .ansSpeakBtn{
    display:none;
    align-items:center;
    gap:8px;
    font-weight:900;
    border-color:#c7d2fe;
    background:#eef2ff;
  }
  .ansInfo{
    display:none;
    width:100%;
    padding:12px 14px;
    border-radius:16px;
    border:1px solid #c7d2fe;
    background:#eef2ff;
    font-weight:900;
    color:#111827;
    line-height:1.6;
  }
  .ansInfo .sub{ color:var(--sub); font-weight:900; }

  ruby rt{ font-size:10px; color:var(--sub); font-weight:900; }

  .settings{ display:grid; gap:10px; margin-bottom:10px; }
  .settingRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .settingRow label{ font-weight:900; }
  .stack{ display:flex; flex-direction:column; gap:6px; align-items:flex-start; }

  .kusudamaOverlay{
    position:absolute; inset:0;
    background:rgba(17,24,39,.25);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:50;
  }
  .kusudama{
    width:min(520px,86vw);
    height:min(360px,60vh);
    position:relative;
  }
  .rope{
    position:absolute; left:50%; top:0;
    width:3px; height:120px;
    transform:translateX(-50%);
    background:rgba(255,255,255,.8);
    border-radius:999px;
  }
  .ball{
    position:absolute; left:50%; top:105px;
    width:240px; height:240px;
    transform:translateX(-50%);
    border-radius:999px;
    border:2px solid rgba(255,255,255,.8);
    background:rgba(255,255,255,.2);
    box-shadow:0 18px 40px rgba(0,0,0,.25);
    overflow:hidden;
  }
  .half{
    position:absolute; top:0; bottom:0;
    width:50%;
    background:rgba(255,255,255,.55);
    border:1px solid rgba(255,255,255,.75);
    backdrop-filter: blur(2px);
  }
  .half.left{ left:0; border-right:none; }
  .half.right{ right:0; border-left:none; }
  .knot{
    position:absolute; left:50%; top:50%;
    width:26px; height:26px;
    transform:translate(-50%,-50%);
    border-radius:10px;
    background:rgba(255,255,255,.85);
    border:1px solid rgba(255,255,255,.9);
  }
  .banner{
    position:absolute; left:50%; top:355px;
    transform:translateX(-50%);
    padding:10px 14px;
    border-radius:16px;
    background:rgba(255,255,255,.92);
    border:1px solid rgba(255,255,255,.9);
    font-weight:900;
    color:#111827;
    box-shadow:0 10px 24px rgba(0,0,0,.18);
    text-align:center;
    min-width:260px;
  }
  .streamers{
    position:absolute; left:50%; top:220px;
    width:1px; height:1px;
    transform:translateX(-50%);
    pointer-events:none;
  }
  .streamer{
    position:absolute; left:0; top:0;
    width:10px; height:140px;
    border-radius:999px;
    opacity:.95;
    transform-origin: top center;
    animation:fall 1100ms ease-out forwards;
  }
  @keyframes fall{
    0%{ transform:translate(-50%,0) rotate(var(--r)) scaleY(.2); opacity:0; }
    25%{ opacity:1; }
    100%{ transform:translate(calc(-50% + var(--x)), 190px) rotate(calc(var(--r) * 1.2)) scaleY(1); opacity:0; }
  }
  .kusudama.burst .ball .half.left{ animation:openL 520ms ease-out forwards; }
  .kusudama.burst .ball .half.right{ animation:openR 520ms ease-out forwards; }
  @keyframes openL{ to{ transform:translateX(-110px) rotate(-18deg); } }
  @keyframes openR{ to{ transform:translateX(110px) rotate(18deg); } }

  .kWrap{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:2px;
    line-height:1;
    padding:0;
    max-width:100%;
  }
  .kOn, .kKun{
    font-size:9px;
    font-weight:900;
    color:var(--sub);
    white-space:normal;
    text-align:center;
    line-height:1.05;
    word-break:break-word;
    overflow-wrap:anywhere;
    max-width:100%;
  }
  .kCore{
    font-size:44px;
    font-weight:900;
    color:var(--ink);
    line-height:1;
  }
  .slot .kOn, .slot .kKun{ font-size:8px; line-height:1.05; }
  .slot .kCore{ font-size:34px; }
  .chip .mini .kOn, .chip .mini .kKun{ font-size:8px; line-height:1.05; }
  .chip .mini .kCore{ font-size:42px; }

  /* â˜…ã‚ªãƒ³ãƒ©ã‚¤ãƒ³éƒ¨å±‹UIï¼ˆè¦‹ãŸç›®ã¯æ—¢å­˜ã«é¦´æŸ“ã¾ã›ã‚‹ï¼‰ */
  #roomMaker{
    margin:8px 0; padding:8px;
    border:1px solid var(--border);
    border-radius:14px;
    background:#fff;
  }
  #roomMaker .title{ font-weight:900; color:var(--ink); margin-bottom:6px; }
  #roomMaker input{ width:100%; }
  #roomMaker .small{ font-size:12px; color:var(--sub); font-weight:800; }
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <h1>ç†Ÿèªã¥ãã‚Šã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ </h1>
    <div class="pill" id="topPill">æº–å‚™ä¸­</div>
  </header>

  <div class="wrap">
    <div class="grid">
      <div class="card" id="leftPlay">

        <div class="scoreboard" id="scoreboard"></div>
        <div class="msg ok" id="winMsg" style="display:none;"></div>

        <div class="row" style="margin-bottom:12px; margin-top:12px;">
          <button class="primary" id="drawBtn">ï¼‘ã¾ã„å¼•ã</button>
          <button id="checkBtn">ã§ããŸï¼</button>
          <button id="endBtn"><ruby>ç•ª<rt>ã°ã‚“</rt></ruby>ã‚’<ruby>çµ‚<rt>ãŠ</rt></ruby>ãˆã‚‹</button>

          <button id="addFieldBtn" class="warn" style="display:none;">
            <ruby>å ´æœ­<rt>ã°ãµã </rt></ruby>ã‚’<ruby>è¿½åŠ <rt>ã¤ã„ã‹</rt></ruby>ã™ã‚‹
          </button>

          <button class="warn" id="skipNextBtn" style="display:none;">ã¤ãã¸</button>
        </div>

        <div class="sectionTitle"><ruby>å ´æœ­<rt>ã°ãµã </rt></ruby></div>
        <div class="tiles" id="field"></div>

        <div class="drawPickGrid">
          <div class="drawPickCol">
            <div class="sectionTitle"><ruby>å¼•<rt>ã²</rt></ruby>ã„ãŸ<ruby>æœ­<rt>ãµã </rt></ruby>ï¼ˆã‚¿ãƒƒãƒ—ã§â‘ â‘¡ã¸ï¼‰</div>
            <div class="row" style="gap:10px; margin-bottom:10px;">
              <button class="chip" id="drawChip" type="button" disabled>
                <span class="muted"><ruby>å¼•æœ­<rt>ã²ããµã </rt></ruby></span>
                <span class="mini" id="drawMini">â€”</span>
                <span class="muted">â†’â‘ â‘¡</span>
              </button>
            </div>
          </div>

          <div class="drawPickCol">
            <div class="sectionTitle"><ruby>é †ç•ª<rt>ã˜ã‚…ã‚“ã°ã‚“</rt></ruby>ã‚’<ruby>æ±º<rt>ã</rt></ruby>ã‚ã¦<ruby>ä½œ<rt>ã¤ã</rt></ruby>ã‚‹</div>
            <div class="pickPanel">
              <div class="slotWrap">
                <div class="slotLabel">â‘ </div>
                <div class="slot" id="slot1" title="ã‚¿ãƒƒãƒ—ã§æ¶ˆã™">â€”</div>
              </div>
              <div class="eq">â†’</div>
              <div class="slotWrap">
                <div class="slotLabel">â‘¡</div>
                <div class="slot" id="slot2" title="ã‚¿ãƒƒãƒ—ã§æ¶ˆã™">â€”</div>
              </div>
              <div class="eq">=</div>
              <div class="wordBox" id="wordBox">â€”</div>
            </div>
          </div>
        </div>

        <div class="msg" id="msg">ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã™ã¨é–‹å§‹ã—ã¾ã™ã€‚</div>

        <div class="ansSpeakWrap" id="ansSpeakWrap">
          <button class="ansSpeakBtn" id="ansSpeakBtn" type="button" aria-label="æ­£ç­”ã®èª­ã¿ã¨æ„å‘³ã‚’ã‚ˆã¿ã‚ã’">
            ğŸ”Š ã‚ˆã¿ãƒ»ã„ã¿ãƒ»ã‚Œã„ã¶ã‚“
          </button>
          <div class="ansInfo" id="ansInfo" aria-live="polite"></div>
        </div>

        <div class="miniInfo" id="missInfo">
          <div>ãƒŸã‚¹</div>
          <div id="missCount">â€”</div>
        </div>

        <details style="margin-top:12px;" open>
          <summary><ruby>ã§ããŸ</ruby>ã˜ã‚…ã<ruby>èª<rt>ã”</rt></ruby>ï¼ˆ<ruby>åŒ<rt>ãŠãª</rt></ruby>ã˜<ruby>ç†Ÿèª<rt>ã˜ã‚…ãã”</rt></ruby>ã¯1<ruby>å›<rt>ã‹ã„</rt></ruby>ã¾ã§ï¼‰</summary>
          <div class="list" id="madeList"></div>
        </details>
      </div>

      <div class="card" id="rightSide">

        <!-- â˜…å¿…é ˆï¼šéƒ¨å±‹UI -->
        <div id="roomMaker">
          <div class="title">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ãƒªãƒ³ã‚¯ä½œæˆ</div>
          <div class="row" style="gap:8px; align-items:center;">
            <input id="roomInput" placeholder="éƒ¨å±‹ç•ªå·ï¼ˆä¾‹: class1ï¼‰" style="width:160px;">
            <button id="makeRoomUrlBtn" type="button">URLä½œæˆ</button>
          </div>
          <div style="margin-top:6px;" class="small">
            ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ç”¨ï¼š
            <input id="urlP1" readonly style="width:100%;">
          </div>
          <div style="margin-top:6px;" class="small">
            ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ç”¨ï¼š
            <input id="urlP2" readonly style="width:100%;">
          </div>
        </div>

        <div class="settings">
          <div class="settingRow">
            <label class="muted">å‡ºé¡Œ</label>
            <select id="gradeSelect" title="å‡ºé¡Œã™ã‚‹æ¼¢å­—">
              <option value="g1">1å¹´ã®æ¼¢å­—</option>
              <option value="g2">2å¹´ã®æ¼¢å­—</option>
              <option value="g12">1ï¼Œ2å¹´ã®æ¼¢å­—</option>
              <option value="g3">3å¹´ã®æ¼¢å­—</option>
              <option value="g123">1ãƒ»2ãƒ»3å¹´ã®æ¼¢å­—</option>
            </select>
          </div>

          <div class="settingRow">
            <label class="muted">èª­ã¿è¡¨ç¤º</label>
            <select id="readingToggle" title="éŸ³èª­ã¿ãƒ»è¨“èª­ã¿ã®è¡¨ç¤º">
              <option value="on" selected>ã‚ã‚‹</option>
              <option value="off">ãªã—</option>
            </select>
          </div>

          <div class="settingRow">
            <label class="muted">äººæ•°</label>
            <select id="playerCount">
              <option value="2">2äºº</option>
              <option value="3">3äºº</option>
              <option value="4">4äºº</option>
            </select>
          </div>

          <div class="settingRow">
            <label class="muted">å‹åˆ©ãƒã‚¤ãƒ³ãƒˆ</label>
            <input id="targetPoints" type="number" min="1" step="1" value="5"/>
          </div>

          <div class="settingRow">
            <label class="muted">ãƒŸã‚¹ã§ä¼‘ã¿</label>
            <select id="missLimit" title="ã“ã®å›æ•°ã€Œãã®è¨€è‘‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€ã§1å›ä¼‘ã¿">
              <option value="2">2å›</option>
              <option value="3" selected>3å›</option>
              <option value="4">4å›</option>
              <option value="5">5å›</option>
              <option value="6">6å›</option>
              <option value="7">7å›</option>
              <option value="8">8å›</option>
            </select>
          </div>

          <div class="settingRow" style="flex-direction:column; align-items:flex-start;">
            <button class="primary" id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            <button id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
          
            <button id="speechEnableBtn">ğŸ”ˆ éŸ³å£°ON</button>
          </div>
        </div>

        <details id="rules" style="margin-top:12px;">
          <summary><ruby>éŠã³æ–¹<rt>ã‚ãã³ã‹ãŸ</rt></ruby></summary>

          <div class="row" style="padding:0 12px 0;">
            <button class="speakBtn" id="speakBtn" type="button">â–¶ ã‚ˆã¿ã‚ã’</button>
            <button class="speakBtn" id="stopSpeakBtn" type="button">â–  ã¨ã‚ã‚‹</button>
</div>

          <div id="ruleText" style="padding:10px 12px 12px; color:var(--sub); font-weight:800; line-height:1.75;">
            <div>ãƒ»<ruby>æœ€åˆ<rt>ã•ã„ã—ã‚‡</rt></ruby>ã«<ruby>å ´æœ­<rt>ã°ãµã </rt></ruby>ãŒ6<ruby>æš<rt>ã¾ã„</rt></ruby><ruby>å‡º<rt>ã§</rt></ruby>ã¾ã™ã€‚</div>
            <div>ãƒ»<ruby>è‡ªåˆ†<rt>ã˜ã¶ã‚“</rt></ruby>ã®<ruby>ç•ª<rt>ã°ã‚“</rt></ruby>ã§ã¯ã€<ruby>å¿…<rt>ã‹ãªã‚‰</rt></ruby>ãš<ruby>å±±æœ­<rt>ã‚„ã¾ãµã </rt></ruby>ã‹ã‚‰1<ruby>æš<rt>ã¾ã„</rt></ruby><ruby>å¼•<rt>ã²</rt></ruby>ãã¾ã™ï¼ˆ1<ruby>å›<rt>ã‹ã„</rt></ruby>ã ã‘ï¼‰ã€‚</div>
            <div>ãƒ»â‘ â‘¡ã®<ruby>æ <rt>ã‚ã</rt></ruby>ã«ã€<ruby>å ´æœ­<rt>ã°ãµã </rt></ruby>ã©ã†ã—ã€ã¾ãŸã¯ã€<ruby>å¼•æœ­<rt>ã²ããµã </rt></ruby>ï¼‹<ruby>å ´æœ­<rt>ã°ãµã </rt></ruby>ã‚’ã‚¿ãƒƒãƒ—ã—ã¦<ruby>å…¥<rt>ã„</rt></ruby>ã‚Œã¾ã™ã€‚</div>
            <div>ãƒ»ã§ããŸã‚‰ã€Œã§ããŸï¼ã€ã‚’ã‚¿ãƒƒãƒ—ã—ã¾ã™ã€‚<ruby>æ­£ç­”<rt>ã›ã„ã¨ã†</rt></ruby>ãªã‚‰1ãƒã‚¤ãƒ³ãƒˆã€‚</div>
            <div>ãƒ»<ruby>ä½œ<rt>ã¤ã</rt></ruby>ã‚Œãªã‹ã£ãŸã¨ãã¯ã€<ruby>å¼•<rt>ã²</rt></ruby>ã„ãŸ<ruby>æœ­<rt>ãµã </rt></ruby>ã¯<ruby>å ´æœ­<rt>ã°ãµã </rt></ruby>ã«<ruby>ä¸¦<rt>ãªã‚‰</rt></ruby>ã³ã€<ruby>å ´æœ­<rt>ã°ãµã </rt></ruby>ãŒã©ã‚“ã©ã‚“<ruby>å¢—<rt>ãµ</rt></ruby>ãˆã¾ã™ã€‚</div>
            <div>ãƒ»<ruby>å ´æœ­<rt>ã°ãµã </rt></ruby>ãŒ3<ruby>æš<rt>ã¾ã„</rt></ruby><ruby>ä»¥ä¸‹<rt>ã„ã‹</rt></ruby>ã«ãªã£ãŸã‚‰ã€ã€Œ<ruby>å ´æœ­<rt>ã°ãµã </rt></ruby>ã‚’<ruby>è¿½åŠ <rt>ã¤ã„ã‹</rt></ruby>ã™ã‚‹ã€ã®ãƒœã‚¿ãƒ³ã§<ruby>æœ­<rt>ãµã </rt></ruby>ã‚’<ruby>è¿½åŠ <rt>ã¤ã„ã‹</rt></ruby>ã§ãã¾ã™ã€‚</div>
            <div>ãƒ»<ruby>ç•ª<rt>ã°ã‚“</rt></ruby>ã‚’<ruby>çµ‚<rt>ãŠ</rt></ruby>ãˆã‚‹ã¨ãã€<ruby>æ‰‹å…ƒ<rt>ã¦ã‚‚ã¨</rt></ruby>ã«<ruby>æ®‹<rt>ã®ã“</rt></ruby>ã£ãŸ<ruby>å¼•æœ­<rt>ã²ããµã </rt></ruby>ã‚‚<ruby>å ´æœ­<rt>ã°ãµã </rt></ruby>ã¸<ruby>è¿½åŠ <rt>ã¤ã„ã‹</rt></ruby>ã•ã‚Œã¾ã™ã€‚</div>
            <div>ãƒ»<ruby>ç›®æ¨™<rt>ã‚‚ãã²ã‚‡ã†</rt></ruby>ãƒã‚¤ãƒ³ãƒˆã«<ruby>é”<rt>ãŸã£</rt></ruby>ã—ãŸ<ruby>äºº<rt>ã²ã¨</rt></ruby>ãŒ<ruby>å‹<rt>ã‹</rt></ruby>ã¡ï¼ˆ<ruby>è¨­å®š<rt>ã›ã£ã¦ã„</rt></ruby>ã§<ruby>å¤‰æ›´<rt>ã¸ã‚“ã“ã†</rt></ruby>ã§ãã¾ã™ï¼‰ã€‚</div>
            <div>ãƒ»1ã‚¿ãƒ¼ãƒ³ã§ã€Œãã®<ruby>è¨€è‘‰<rt>ã“ã¨ã°</rt></ruby>ã¯ã‚ã‚Šã¾ã›ã‚“ã€ãŒ<ruby>è¨­å®š<rt>ã›ã£ã¦ã„</rt></ruby><ruby>å›æ•°<rt>ã‹ã„ã™ã†</rt></ruby><ruby>å‡º<rt>ã§</rt></ruby>ãŸã‚‰ã€æ¬¡ã®<ruby>è‡ªåˆ†<rt>ã˜ã¶ã‚“</rt></ruby>ã®<ruby>ç•ª<rt>ã°ã‚“</rt></ruby>ã¯1<ruby>å›<rt>ã‹ã„</rt></ruby><ruby>ä¼‘<rt>ã‚„ã™</rt></ruby>ã¿ã§ã™ã€‚ã€Œã¤ãã¸ã€ã§<ruby>é€²<rt>ã™ã™</rt></ruby>ã¿ã¾ã™ã€‚</div>
          </div>
        </details>
      </div>
    </div>
  </div>

  <div class="kusudamaOverlay" id="kusudamaOverlay" aria-hidden="true">
    <div class="kusudama" id="kusudama">
      <div class="rope"></div>
      <div class="ball">
        <div class="half left"></div>
        <div class="half right"></div>
        <div class="knot"></div>
      </div>
      <div class="streamers" id="streamers"></div>
      <div class="banner" id="kusudamaBanner">ãŠã‚ã§ã¨ã†ï¼</div>
    </div>
  </div>
</div>

<script>
/* ============================
  ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç‰ˆï¼ˆå…ƒã‚³ãƒ¼ãƒ‰ï¼‰ã‚’ãƒ™ãƒ¼ã‚¹ã«
  ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ï¼ˆFirebase RTDBï¼‰å¯¾å¿œ
  - URL: ?room=éƒ¨å±‹å&me=1 / ?room=éƒ¨å±‹å&me=2
  - ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã¯å¾“æ¥é€šã‚Š
  - P1ã®ã¿ã‚¹ã‚¿ãƒ¼ãƒˆ/ãƒªã‚»ãƒƒãƒˆ
  - æ‰‹ç•ªä»¥å¤–ã¯æ“ä½œä¸å¯
  - çŠ¶æ…‹ã¯ä¸¸ã”ã¨åŒæœŸï¼ˆstateï¼‰
  - è¿½åŠ è¦æœ›ï¼š
    ãƒ»æ­£ç­”/ä¸æ­£ç­”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚ç›¸æ‰‹ã¸
    ãƒ»ğŸ”Š(ã‚ˆã¿ãƒ»ã„ã¿ãƒ»ã‚Œã„ã¶ã‚“)ã‚‚ç›¸æ‰‹ã¸
    ãƒ»å‹åˆ©ã®ãã™ç‰ã‚‚ç›¸æ‰‹ã¸
    ãƒ»1æšå¼•ãå‰ã¯ç•ªã‚’çµ‚ãˆã‚‰ã‚Œãªã„
============================ */

// ============================
// â˜…Firebaseè¨­å®šï¼ˆæŒ‡å®šé€šã‚ŠåŸ‹ã‚è¾¼ã¿ï¼‰
// ============================
const firebaseConfig = {
  apiKey: "AIzaSyDGyfFnmlFjJNyj8gyHcNje0SowgtTjDyU",
  authDomain: "jyukugo-battle.firebaseapp.com",
  databaseURL: "https://jyukugo-battle-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "jyukugo-battle",
  storageBucket: "jyukugo-battle.firebasestorage.app",
  messagingSenderId: "15379559721",
  appId: "1:15379559721:web:9776dfdf39b4a38a047338"
};

// ============================
// â˜…ã‚ªãƒ³ãƒ©ã‚¤ãƒ³åˆ¤å®šï¼ˆURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‰
// ============================
const QS = new URLSearchParams(location.search);
const ROOM_ID = (QS.get("room") || "").trim();
const ME_ID = Number(QS.get("me") || 0);

const ONLINE = {
  enabled: !!(ROOM_ID && (ME_ID === 1 || ME_ID === 2)),
  ready: false,
  suppress: false,
  lastRev: 0,
  isApplyingRemote: false,
  _db: null,
  _ref: null,
  _onValue: null,
  _set: null,
  _update: null,
  _push: null,
  _serverTimestamp: null,
  _onChildAdded: null
};

// ============================
// UIï¼ˆéƒ¨å±‹ãƒªãƒ³ã‚¯ä½œæˆï¼‰
// ============================
const roomInputEl = document.getElementById("roomInput");
const makeRoomUrlBtn = document.getElementById("makeRoomUrlBtn");
const urlP1El = document.getElementById("urlP1");
const urlP2El = document.getElementById("urlP2");

roomInputEl.addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){
    e.preventDefault();
    makeRoomUrlBtn.click();
  }
});

function makeRoomUrls(room){
  const base = location.origin + location.pathname;
  const r = encodeURIComponent(room);
  return {
    p1: `${base}?room=${r}&me=1`,
    p2: `${base}?room=${r}&me=2`
  };
}
makeRoomUrlBtn.addEventListener("click", ()=>{
  const room = (roomInputEl.value || "").trim();
  if(!room){
    // ä½•ã‚‚å…¥ã£ã¦ã„ãªã„ã¨ãã¯æ¡ˆå†…ã ã‘å‡ºã™
    try{ setMsg("éƒ¨å±‹ç•ªå·ã‚’å…¥åŠ›ã—ã¦ã‹ã‚‰ã€ŒURLä½œæˆã€ã‚’æŠ¼ã—ã¦ã­ã€‚","ng"); }catch(_){}
    return;
  }
  const u = makeRoomUrls(room);
  urlP1El.value = u.p1;
  urlP2El.value = u.p2;

  // ã§ããŸã“ã¨ãŒåˆ†ã‹ã‚‹ã‚ˆã†ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºã™ï¼ˆç›¸æ‰‹å´ã«ã¯é€ã‚‰ãªã„ï¼šãƒ­ãƒ¼ã‚«ãƒ«æ¡ˆå†…ï¼‰
  try{ setMsg("URLã‚’ä½œæˆã—ã¾ã—ãŸã€‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ç”¨/2ç”¨ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å…±æœ‰ã—ã¦ãã ã•ã„ã€‚","ok"); }catch(_){}

  // ã¾ãšã¯P1ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆå¤±æ•—ã—ã¦ã‚‚OKï¼‰
  try{
    urlP1El.focus();
    urlP1El.select();
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(urlP1El.value).catch(()=>{ try{ document.execCommand("copy"); }catch(_2){} });
    }else{
      try{ document.execCommand("copy"); }catch(_3){}
    }
  }catch(_){}
});

// åˆæœŸè¡¨ç¤ºï¼šURLã§å…¥ã£ã¦ã‚‹éƒ¨å±‹ãªã‚‰è¡¨ç¤º
if(ROOM_ID){
  roomInputEl.value = ROOM_ID;
  const u = makeRoomUrls(ROOM_ID);
  urlP1El.value = u.p1;
  urlP2El.value = u.p2;
}

// ============================
// å…ƒã‚³ãƒ¼ãƒ‰ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼‰
// ============================
const HAS_SPEECH = ("speechSynthesis" in window) && ("SpeechSynthesisUtterance" in window);
function safeCancelSpeech(){ if(!HAS_SPEECH) return; try{ window.speechSynthesis.cancel(); }catch(_){} }

// ============================
// â˜…SpeechSynthesis è§£æ”¾ï¼ˆé éš”èª­ã¿ä¸Šã’ãŒé³´ã‚‰ãªã„å¯¾ç­–ï¼‰
// ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒä¸€åº¦ã‚‚ç„¡ã„çŠ¶æ…‹ã€ã ã¨ speechSynthesis.speak() ã‚’ç„¡è¦–/ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
// ãã®ãŸã‚ã€æœ€åˆã®ã‚¿ãƒƒãƒ—/ã‚¯ãƒªãƒƒã‚¯ç­‰ã§ã€Œç„¡éŸ³ã®è¶…çŸ­ã„ç™ºè©±ã€ã‚’ä¸€åº¦ã ã‘å®Ÿè¡Œã—ã¦è§£æ”¾ã—ã¾ã™ã€‚
// ã¾ãŸã€è§£æ”¾å‰ã«å±Šã„ãŸé éš”èª­ã¿ä¸Šã’ã¯ã‚­ãƒ¥ãƒ¼ã«æºœã‚ã€è§£æ”¾å¾Œã«ã¾ã¨ã‚ã¦å†ç”Ÿã—ã¾ã™ã€‚
// ============================
const SPEECH_GATE = {
  unlocked: false,
  pending: [] // { text, onEnd }
};

function flushPendingSpeech(){
  if(!HAS_SPEECH) return;
  if(!SPEECH_GATE.unlocked) return;
  const list = SPEECH_GATE.pending.splice(0, SPEECH_GATE.pending.length);
  for(const item of list){
    try{ speakTextNow(item.text, item.onEnd); }catch(_){ try{ item.onEnd && item.onEnd(); }catch(__){} }
  }
}

function unlockSpeech(){
  if(!HAS_SPEECH) return;
  if(SPEECH_GATE.unlocked) return;
  try{
    // â˜…voices ã‚’ä¸€åº¦è§¦ã£ã¦ãŠãï¼ˆç’°å¢ƒã«ã‚ˆã£ã¦ã¯ã“ã‚ŒãŒç„¡ã„ã¨ speak ãŒç„¡è¦–ã•ã‚Œã‚‹ï¼‰
    try{ window.speechSynthesis.getVoices(); }catch(_){}

    // â˜…ãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚ˆã£ã¦ã€Œç„¡éŸ³ã€ã€Œç©ºæ–‡å­—ã€ã¯è§£æ”¾ã¨ã—ã¦èªã‚ã‚‰ã‚Œãªã„ã“ã¨ãŒã‚ã‚‹ãŸã‚ã€
    // æ¥µå°éŸ³é‡ã§è¶…çŸ­ã„1æ–‡å­—ã ã‘ç™ºè©±ã—ã¦è§£æ”¾ã™ã‚‹ï¼ˆã»ã¼èã“ãˆãªã„ï¼‰
    const u = new SpeechSynthesisUtterance("ã‚");
    u.lang = "ja-JP";
    u.rate = 2.0;
    u.pitch = 1.0;
    u.volume = 0.02; // ã‹ãªã‚Šå°ã•ãï¼ˆ0ã ã¨ç„¡è¦–ã•ã‚Œã‚‹ç«¯æœ«ãŒã‚ã‚‹ï¼‰
    u.onend = ()=>{};
    u.onerror = ()=>{};

    try{ window.speechSynthesis.cancel(); }catch(_){}
    window.speechSynthesis.speak(u);

    // â˜…çŸ­æ™‚é–“ã§æ­¢ã‚ã‚‹ï¼ˆå®Œå…¨ã«ç„¡éŸ³åŒ–ã§ããªã„ç«¯æœ«ã§ã‚‚ç›®ç«‹ãŸãªã„ï¼‰
    setTimeout(()=>{ try{ window.speechSynthesis.cancel(); }catch(_){} }, 160);

    SPEECH_GATE.unlocked = true;
    flushPendingSpeech();
  }catch(_){}
}

// â˜…ç«¯æœ«ã«ã‚ˆã£ã¦ã¯ã€Œã©ã“ã‹ã‚¿ãƒƒãƒ—ã€ã§ã¯ SpeechSynthesis ãŒè§£æ”¾ã•ã‚Œãšã€
// èª­ã¿ä¸Šã’ãƒœã‚¿ãƒ³ã‚’ä¸€åº¦æŠ¼ã•ãªã„ã¨é éš”èª­ã¿ä¸Šã’ãŒé³´ã‚‰ãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
// ãã®å ´åˆã€ã“ã®é–¢æ•°ã‚’ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŠ¼ã—ãŸãƒœã‚¿ãƒ³ã€ã‹ã‚‰å‘¼ã³ã€ç¢ºå®Ÿã«è§£æ”¾ã—ã¾ã™ã€‚
function unlockSpeechHard(){
  if(!HAS_SPEECH) return false;
  try{
    // voices ã‚’èª­ã¿è¾¼ã¿
    try{ window.speechSynthesis.getVoices(); }catch(_){}
    // â€œæ˜ç¤ºçš„ãƒœã‚¿ãƒ³æ“ä½œâ€ã¨ã—ã¦ã® speak ã‚’1å›é€šã™ï¼ˆçŸ­ãï¼‰
    const u = new SpeechSynthesisUtterance("ã¯ã„");
    u.lang = "ja-JP";
    u.rate = 2.0;
    u.pitch = 1.0;
    u.volume = 0.6; // ç¢ºå®Ÿæ€§å„ªå…ˆï¼ˆç„¡éŸ³/æ¥µå°ã¯ç„¡è¦–ã•ã‚Œã‚‹ç«¯æœ«ãŒã‚ã‚‹ï¼‰
    u.onend = ()=>{};
    u.onerror = ()=>{};
    try{ window.speechSynthesis.cancel(); }catch(_){}
    window.speechSynthesis.speak(u);

    // ã™ãã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ã‚‚ã€Œè§£æ”¾ã€æ‰±ã„ã«ãªã‚‹ç«¯æœ«ãŒå¤šã„
    setTimeout(()=>{ try{ window.speechSynthesis.cancel(); }catch(_){} }, 220);

    SPEECH_GATE.unlocked = true;
    flushPendingSpeech();
    return true;
  }catch(_){
    return false;
  }
}

// ============================
// â˜…åŠ¹æœéŸ³ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§ã‚‚åŒæœŸï¼‰
//   - "tap"ï¼šãƒ”ã‚³ãƒ”ã‚³ï¼ˆæ“ä½œã®åˆå›³ï¼‰
//   - "turn"ï¼šç•ªãŒå¤‰ã‚ã£ãŸåˆå›³
//   â€»ãƒ–ãƒ©ã‚¦ã‚¶ã®ä»•æ§˜ã§ã€æœ€åˆã®1å›ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§éŸ³å£°ãŒè§£æ”¾ã•ã‚Œã¾ã™
// ============================
const SFX = {
  unlocked: false,
  ctx: null,
  pending: []  // â˜…æœªè§£æ”¾ä¸­ã«æ¥ãŸåŠ¹æœéŸ³ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¸€æ™‚ä¿å­˜
};

function flushPendingSfx(){
  if(!SFX.unlocked) return;
  const list = SFX.pending.splice(0, SFX.pending.length);
  for(const kind of list){
    try{ playSfxLocal(kind); }catch(_){}
  }
}

// ============================
// â˜…SFXï¼ˆåŠ¹æœéŸ³ï¼‰ã‚²ãƒ¼ãƒˆï¼šç«¯æœ«ãŒæœªè§£æ”¾ã ã¨æœ€åˆã®éŸ³ãŒé³´ã‚‰ãªã„å¯¾ç­–
// é éš”ã‹ã‚‰å…ˆã«å±Šã„ãŸSFXã¯ã‚­ãƒ¥ãƒ¼ã«ç©ã¿ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§è§£æ”¾ã•ã‚ŒãŸå¾Œã«ã¾ã¨ã‚ã¦å†ç”Ÿã—ã¾ã™ã€‚
// ============================
const SFX_GATE = {
  unlocked: false,
  pending: [] // soundId strings
};

function flushPendingSfx(){
  if(!SFX_GATE.unlocked) return;
  const list = SFX_GATE.pending.splice(0, SFX_GATE.pending.length);
  for(const sid of list){
    try{ playSfxNow(sid); }catch(_){}
  }
}

function unlockAudio(){
  if(SFX.unlocked) return;
  try{
    const AC = window.AudioContext || window.webkitAudioContext;
    if(!AC) return;

    // â˜…ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã®ä¸­ã§ AudioContext ã‚’ä½œã‚‹ï¼ˆè‡ªå‹•å†ç”Ÿè¦åˆ¶å¯¾ç­–ï¼‰
    SFX.ctx = new AC();

    // iOSç­‰ï¼šresumeãŒå¿…è¦ãªã“ã¨ãŒã‚ã‚‹
    if(SFX.ctx.state === "suspended"){
      SFX.ctx.resume().catch(()=>{});
    }

    // â˜…ç„¡éŸ³ã§ä¸€ç¬ã ã‘é³´ã‚‰ã—ã¦ã€Œè§£æ”¾ã€ã‚’ç¢ºå®Ÿã«ã™ã‚‹ï¼ˆiOSå¯¾ç­–ï¼‰
    try{
      const ctx = SFX.ctx;
      const osc = ctx.createOscillator();
      const g = ctx.createGain();
      g.gain.value = 0.000001; // ã»ã¼ç„¡éŸ³
      osc.frequency.value = 440;
      osc.connect(g); g.connect(ctx.destination);
      const t0 = ctx.currentTime;
      osc.start(t0);
      osc.stop(t0 + 0.02);
    }catch(_){}

    SFX.unlocked = true;
    flushPendingSfx();
  }catch(_){}
  SFX_GATE.unlocked = true;
  flushPendingSfx();
}


// â˜…ã€Œä½•ã‚’è§¦ã£ã¦ã‚‚ã€è§£æ”¾ã•ã‚Œã‚‹ã‚ˆã†ã«ã€è¤‡æ•°ã‚¤ãƒ™ãƒ³ãƒˆã§æ‹¾ã†ï¼ˆselect/ãƒœã‚¿ãƒ³/ç”»é¢ã‚¿ãƒƒãƒ—å¯¾ç­–ï¼‰
const _unlockOnce = (ev)=>{
  unlockAudio();
  unlockSpeech();
  // 1å›ã§ååˆ†ãªã®ã§å…¨éƒ¨è§£é™¤
  window.removeEventListener("pointerdown", _unlockOnce, true);
  window.removeEventListener("touchstart", _unlockOnce, true);
  window.removeEventListener("touchend", _unlockOnce, true);
  window.removeEventListener("mousedown", _unlockOnce, true);
  window.removeEventListener("click", _unlockOnce, true);
  window.removeEventListener("keydown", _unlockOnce, true);
  window.removeEventListener("focusin", _unlockOnce, true);
};
window.addEventListener("pointerdown", _unlockOnce, true);
window.addEventListener("touchstart", _unlockOnce, true);
window.addEventListener("touchend", _unlockOnce, true);   // â˜…iOSå¯¾ç­–ï¼štouchstartãŒæ‹¾ãˆãªã„å ´åˆ
window.addEventListener("mousedown", _unlockOnce, true);
window.addEventListener("click", _unlockOnce, true);
window.addEventListener("keydown", _unlockOnce, true);
window.addEventListener("focusin", _unlockOnce, true);    // â˜…select/input ã‚’è§¦ã£ãŸæ™‚ã«ç¢ºå®Ÿã«æ‹¾ã†

function playBeep(freq, durationMs, gain=0.06, when=0){
  if(!SFX.unlocked || !SFX.ctx) return;
  try{
    const ctx = SFX.ctx;
    const t0 = ctx.currentTime + (when || 0);
    const osc = ctx.createOscillator();
    const g = ctx.createGain();
    osc.type = "sine";
    osc.frequency.value = freq;
    g.gain.value = 0.0001;
    osc.connect(g);
    g.connect(ctx.destination);

    // ã‚¯ãƒªãƒƒã‚¯ãƒã‚¤ã‚ºã‚’æ¸›ã‚‰ã™ãŸã‚ã«ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.linearRampToValueAtTime(gain, t0 + 0.01);
    g.gain.linearRampToValueAtTime(0.0001, t0 + (durationMs/1000));

    osc.start(t0);
    osc.stop(t0 + (durationMs/1000) + 0.02);
  }catch(_){}
}

function playSfxLocal(kind){
  // æœªè§£æ”¾ãªã‚‰é³´ã‚‰ã›ãªã„ â†’ ã„ã£ãŸã‚“ä¿å­˜ã—ã¦ã€è§£æ”¾å¾Œã«ã¾ã¨ã‚ã¦é³´ã‚‰ã™
  if(!SFX.unlocked){ SFX.pending.push(String(kind||"")); return; }

  if(kind === "tap"){
    // ãƒ”ã‚³ãƒ”ã‚³ï¼ˆçŸ­ã2å›ï¼‰
    playBeep(880, 60, 0.05, 0.00);
    playBeep(660, 70, 0.05, 0.08);
    return;
  }
  if(kind === "turn"){
    // ç•ªãŒå¤‰ã‚ã£ãŸï¼ˆå°‘ã—é•·ã‚ï¼‰
    playBeep(523.25, 120, 0.06, 0.00); // C5
    playBeep(783.99, 80, 0.05, 0.14);  // G5
    return;
  }
}

function playSfxNow(kind, sendAlso=true){
  // ãƒ­ãƒ¼ã‚«ãƒ«å†ç”Ÿ
  playSfxLocal(kind);
  // ç›¸æ‰‹ã«ã‚‚é€ã‚‹
  if(sendAlso){
    try{ sendOnlineEvent("sfx", { kind: String(kind||"") }); }catch(_){ }
  }
}

// â˜…åŠ¹æœéŸ³ï¼šæœªè§£æ”¾ãªã‚‰ã‚­ãƒ¥ãƒ¼ã«ç©ã‚€ï¼ˆæœ€åˆã®1å›ãŒé³´ã‚‰ãªã„å¯¾ç­–ï¼‰
function playSfx(soundId){
  if(!SFX_GATE.unlocked){
    SFX_GATE.pending.push(String(soundId||""));
    return;
  }
  playSfxNow(soundId);
}


const TTS_DICT = [
  ["æ¶ˆé˜²è»Š", "ã—ã‚‡ã†ã¼ã†ã—ã‚ƒ"],["çš„", "ã¦ã"],
];
function ttsNormalize(text){
  let out = String(text ?? "");
  for(const [k, v] of TTS_DICT){ out = out.split(k).join(v); }
  return out;
}

const KANJI_READINGS = {
  "éŸ³": { on:"ã‚ªãƒ³", kun:"ãŠã¨ãƒ»ã­" },
  "ä¸‹": { on:"ã‚«ãƒ»ã‚²", kun:"ã—ãŸãƒ»ã—ã‚‚ãƒ»ã•ï¼ˆã’ã‚‹ï¼‰ãƒ»ãã ï¼ˆã‚‹ï¼‰ãƒ»ãŠï¼ˆã‚Šã‚‹ï¼‰" },
  "ç«": { on:"ã‚«", kun:"ã²" },
  "å­¦": { on:"ã‚¬ã‚¯", kun:"ã¾ãªï¼ˆã¶ï¼‰" },
  "æ°—": { on:"ã‚­ãƒ»ã‚±", kun:"" },
  "é‡‘": { on:"ã‚­ãƒ³ãƒ»ã‚³ãƒ³", kun:"ã‹ã­ãƒ»ã‹ãª" },
  "ç©º": { on:"ã‚¯ã‚¦", kun:"ãã‚‰ãƒ»ã‚ï¼ˆãï¼‰ãƒ»ã‹ã‚‰" },
  "æœˆ": { on:"ã‚²ãƒ„ãƒ»ã‚¬ãƒ„", kun:"ã¤ã" },
  "è¦‹": { on:"ã‚±ãƒ³", kun:"ã¿ï¼ˆã‚‹ï¼‰" },
  "å£": { on:"ã‚³ã‚¦ãƒ»ã‚¯", kun:"ãã¡" },
  "å±±": { on:"ã‚µãƒ³", kun:"ã‚„ã¾" },
  "è»Š": { on:"ã‚·ãƒ£", kun:"ãã‚‹ã¾" },
  "æ‰‹": { on:"ã‚·ãƒ¥", kun:"ã¦" },
  "å‡º": { on:"ã‚·ãƒ¥ãƒ„", kun:"ã§ï¼ˆã‚‹ï¼‰ãƒ»ã ï¼ˆã™ï¼‰" },
  "å°": { on:"ã‚·ãƒ§ã‚¦", kun:"ã¡ã„ï¼ˆã•ã„ï¼‰ãƒ»ã“ãƒ»ãŠ" },
  "ä¸Š": { on:"ã‚¸ãƒ§ã‚¦", kun:"ã†ãˆãƒ»ã†ã‚ãƒ»ã‹ã¿ãƒ»ã‚ï¼ˆã’ã‚‹ï¼‰ãƒ»ã®ã¼ï¼ˆã‚‹ï¼‰" },
  "äºº": { on:"ã‚¸ãƒ³ãƒ»ãƒ‹ãƒ³", kun:"ã²ã¨" },
  "æ°´": { on:"ã‚¹ã‚¤", kun:"ã¿ãš" },
  "ç”Ÿ": { on:"ã‚»ã‚¤ãƒ»ã‚·ãƒ§ã‚¦", kun:"ã„ï¼ˆãã‚‹ï¼‰ãƒ»ã†ï¼ˆã‚€ï¼‰ãƒ»ã¯ï¼ˆãˆã‚‹ï¼‰ãƒ»ãªã¾" },
  "å…ˆ": { on:"ã‚»ãƒ³", kun:"ã•ã" },
  "è¶³": { on:"ã‚½ã‚¯", kun:"ã‚ã—ãƒ»ãŸï¼ˆã™ï¼‰" },
  "å¤§": { on:"ãƒ€ã‚¤ãƒ»ã‚¿ã‚¤", kun:"ãŠãŠï¼ˆãã„ï¼‰" },
  "ä¸­": { on:"ãƒãƒ¥ã‚¦ãƒ»ã‚¸ãƒ¥ã‚¦", kun:"ãªã‹" },
  "å¤©": { on:"ãƒ†ãƒ³", kun:"ã‚ã¾" },
  "æ—¥": { on:"ãƒ‹ãƒãƒ»ã‚¸ãƒ„", kun:"ã²ãƒ»ã‹" },
  "å…¥": { on:"ãƒ‹ãƒ¥ã‚¦", kun:"ã„ï¼ˆã‚Œã‚‹ï¼‰ãƒ»ã¯ã„ï¼ˆã‚‹ï¼‰" },
  "å¹´": { on:"ãƒãƒ³", kun:"ã¨ã—" },
  "æ–‡": { on:"ãƒ–ãƒ³ãƒ»ãƒ¢ãƒ³", kun:"ãµã¿" },
  "æœ¬": { on:"ãƒ›ãƒ³", kun:"ã‚‚ã¨" },
  "å": { on:"ãƒ¡ã‚¤ãƒ»ãƒŸãƒ§ã‚¦", kun:"ãª" },
  "ç›®": { on:"ãƒ¢ã‚¯", kun:"ã‚" },
  "åŠ›": { on:"ãƒªãƒ§ã‚¯ãƒ»ãƒªã‚­", kun:"ã¡ã‹ã‚‰" },

  "å®¶": { on:"ã‚«ãƒ»ã‚±", kun:"ã„ãˆãƒ»ã‚„" },
  "ä¼š": { on:"ã‚«ã‚¤", kun:"ã‚ï¼ˆã†ï¼‰" },
  "æµ·": { on:"ã‚«ã‚¤", kun:"ã†ã¿" },
  "å¤–": { on:"ã‚¬ã‚¤ãƒ»ã‚²", kun:"ãã¨ãƒ»ã»ã‹ãƒ»ã¯ãšï¼ˆã™ï¼‰" },
  "å…ƒ": { on:"ã‚²ãƒ³ãƒ»ã‚¬ãƒ³", kun:"ã‚‚ã¨" },
  "è¨€": { on:"ã‚²ãƒ³ãƒ»ã‚´ãƒ³", kun:"ã„ï¼ˆã†ï¼‰ãƒ»ã“ã¨" },
  "åŸ": { on:"ã‚²ãƒ³", kun:"ã¯ã‚‰" },
  "å¾Œ": { on:"ã‚´ãƒ»ã‚³ã‚¦", kun:"ã®ã¡ãƒ»ã†ã—ï¼ˆã‚ï¼‰ãƒ»ã‚ã¨" },
  "è¡Œ": { on:"ã‚³ã‚¦ãƒ»ã‚®ãƒ§ã‚¦", kun:"ã„ï¼ˆãï¼‰ãƒ»ãŠã“ãªï¼ˆã†ï¼‰" },
  "å›½": { on:"ã‚³ã‚¯", kun:"ãã«" },
  "ä½œ": { on:"ã‚µã‚¯ãƒ»ã‚µ", kun:"ã¤ãï¼ˆã‚‹ï¼‰" },
  "æ›¸": { on:"ã‚·ãƒ§ã‚¯", kun:"ã‹ï¼ˆãï¼‰" },
  "å ´": { on:"ã‚¸ãƒ§ã‚¦", kun:"ã°" },
  "é£Ÿ": { on:"ã‚·ãƒ§ã‚¯", kun:"ãŸï¼ˆã¹ã‚‹ï¼‰ãƒ»ãï¼ˆã†ï¼‰" },
  "å¿ƒ": { on:"ã‚·ãƒ³", kun:"ã“ã“ã‚" },
  "æ–°": { on:"ã‚·ãƒ³", kun:"ã‚ãŸã‚‰ï¼ˆã—ã„ï¼‰ãƒ»ã«ã„ãƒ»ã‚ã‚‰ï¼ˆãŸï¼‰" },
  "æ•°": { on:"ã‚¹ã‚¦", kun:"ã‹ãšãƒ»ã‹ãï¼ˆãˆã‚‹ï¼‰" },
  "å‰": { on:"ã‚¼ãƒ³", kun:"ã¾ãˆ" },
  "ä½“": { on:"ã‚¿ã‚¤ãƒ»ãƒ†ã‚¤", kun:"ã‹ã‚‰ã " },
  "åœ°": { on:"ãƒãƒ»ã‚¸", kun:"" },
  "é•·": { on:"ãƒãƒ§ã‚¦", kun:"ãªãŒï¼ˆã„ï¼‰" },
  "ç›´": { on:"ãƒãƒ§ã‚¯ãƒ»ã‚¸ã‚­", kun:"ãªãŠï¼ˆã™ï¼‰ã€ãŸã ï¼ˆã¡ã«ï¼‰" },
  "é€š": { on:"ãƒ„ã‚¦", kun:"ã¨ãŠï¼ˆã‚‹ï¼‰ãƒ»ã‹ã‚ˆï¼ˆã†ï¼‰" },
  "å½“": { on:"ãƒˆã‚¦", kun:"ã‚ï¼ˆãŸã‚‹ï¼‰" },
  "é ­": { on:"ãƒˆã‚¦ãƒ»ã‚º", kun:"ã‚ãŸã¾ãƒ»ã‹ã—ã‚‰" },
  "é“": { on:"ãƒ‰ã‚¦", kun:"ã¿ã¡" },
  "å†…": { on:"ãƒŠã‚¤", kun:"ã†ã¡" },
  "é¢¨": { on:"ãƒ•ã‚¦", kun:"ã‹ãœãƒ»ã‹ã–" },
  "åˆ†": { on:"ãƒ•ãƒ³ãƒ»ãƒ–ãƒ³ãƒ»ãƒ–", kun:"ã‚ï¼ˆã‘ã‚‹ï¼‰" },
  "æ–¹": { on:"ãƒ›ã‚¦", kun:"ã‹ãŸ" },
  "é–€": { on:"ãƒ¢ãƒ³", kun:"ã‹ã©" },
  "å¤œ": { on:"ãƒ¤", kun:"ã‚ˆã‚‹ãƒ»ã‚ˆ" },
  "é‡": { on:"ãƒ¤", kun:"ã®" },
  "ç”¨": { on:"ãƒ¨ã‚¦", kun:"ã‚‚ã¡ï¼ˆã„ã‚‹ï¼‰" },
  "æ¥": { on:"ãƒ©ã‚¤", kun:"ãï¼ˆã‚‹ï¼‰" },

  "æ‚ª": { on:"ã‚¢ã‚¯ãƒ»ã‚ª", kun:"ã‚ã‚‹ï¼ˆã„ï¼‰" },
  "æ„": { on:"ã‚¤", kun:"" },
  "é‹": { on:"ã‚¦ãƒ³", kun:"ã¯ã“ï¼ˆã¶ï¼‰" },
  "åŒ–": { on:"ã‚«ãƒ»ã‚±", kun:"ã°ï¼ˆã‘ã‚‹ï¼‰" },
  "é–‹": { on:"ã‚«ã‚¤", kun:"ã²ã‚‰ï¼ˆãï¼‰ãƒ»ã‚ï¼ˆãï¼‰" },
  "æ„Ÿ": { on:"ã‚«ãƒ³", kun:"" },
  "æœŸ": { on:"ã‚­ãƒ»ã‚´", kun:"" },
  "æ¥­": { on:"ã‚®ãƒ§ã‚¦ãƒ»ã‚´ã‚¦", kun:"ã‚ã–" },
  "å±€": { on:"ã‚­ãƒ§ã‚¯", kun:"" },
  "äº‹": { on:"ã‚¸", kun:"ã“ã¨" },
  "å®Ÿ": { on:"ã‚¸ãƒ„", kun:"ã¿ãƒ»ã¿ã®ï¼ˆã‚‹ï¼‰" },
  "æ‰€": { on:"ã‚·ãƒ§", kun:"ã¨ã“ã‚" },
  "èº«": { on:"ã‚·ãƒ³", kun:"ã¿" },
  "é€²": { on:"ã‚·ãƒ³", kun:"ã™ã™ï¼ˆã‚€ï¼‰" },
  "å…¨": { on:"ã‚¼ãƒ³", kun:"ã¾ã£ãŸï¼ˆãï¼‰ãƒ»ã™ã¹ï¼ˆã¦ï¼‰" },
  "ä»£": { on:"ãƒ€ã‚¤ãƒ»ã‚¿ã‚¤", kun:"ã‹ï¼ˆãˆã‚‹ï¼‰ãƒ»ã‚ˆãƒ»ã—ã‚" },
  "ç€": { on:"ãƒãƒ£ã‚¯", kun:"ãï¼ˆã‚‹ï¼‰ãƒ»ã¤ï¼ˆãï¼‰" },
  "å®š": { on:"ãƒ†ã‚¤ãƒ»ã‚¸ãƒ§ã‚¦", kun:"ã•ã ï¼ˆã‚ã‚‹ï¼‰" },
  "è»¢": { on:"ãƒ†ãƒ³", kun:"ã“ã‚ï¼ˆã¶ï¼‰" },
  "å‹•": { on:"ãƒ‰ã‚¦", kun:"ã†ã”ï¼ˆãï¼‰" },
  "é…": { on:"ãƒã‚¤", kun:"ãã°ï¼ˆã‚‹ï¼‰" },
  "ç™º": { on:"ãƒãƒ„ãƒ»ãƒ›ãƒ„", kun:"" },
  "ç­†": { on:"ãƒ’ãƒ„", kun:"ãµã§" },
  "å“": { on:"ãƒ’ãƒ³", kun:"ã—ãª" },
  "éƒ¨": { on:"ãƒ–", kun:"" },
  "ç‰©": { on:"ãƒ–ãƒ„ãƒ»ãƒ¢ãƒ„", kun:"ã‚‚ã®" },
  "å¹³": { on:"ãƒ˜ã‚¤ãƒ»ãƒ“ãƒ§ã‚¦", kun:"ãŸã„ï¼ˆã‚‰ï¼‰ãƒ»ã²ã‚‰" },
  "å‘½": { on:"ãƒ¡ã‚¤ãƒ»ãƒŸãƒ§ã‚¦", kun:"ã„ã®ã¡" },
  "é¢": { on:"ãƒ¡ãƒ³", kun:"ãŠã‚‚ãƒ»ãŠã‚‚ã¦ãƒ»ã¤ã‚‰" },
  "æ´‹": { on:"ãƒ¨ã‚¦", kun:"" },
  "æµ": { on:"ãƒªãƒ¥ã‚¦ãƒ»ãƒ«", kun:"ãªãŒï¼ˆã‚Œã‚‹ï¼‰" },
  "è·¯": { on:"ãƒ­", kun:"ã˜ãƒ»ã¿ã¡" },
  "å’Œ": { on:"ãƒ¯", kun:"ã‚„ã‚ï¼ˆã‚‰ãï¼‰ãƒ»ãªã”ï¼ˆã‚€ï¼‰" }
};

const KANJI_BY_GRADE = {
  g1: ["éŸ³","ä¸‹","ç«","å­¦","æ°—","é‡‘","ç©º","æœˆ","è¦‹","å£","å±±","è»Š","æ‰‹","å‡º","å°","ä¸Š","äºº","æ°´","ç”Ÿ","å…ˆ","è¶³","å¤§","ä¸­","å¤©","æ—¥","å…¥","å¹´","æ–‡","æœ¬","å","ç›®","åŠ›"],
  g2: ["å®¶","ä¼š","æµ·","å¤–","å…ƒ","è¨€","åŸ","å¾Œ","è¡Œ","å›½","ä½œ","æ›¸","å ´","é£Ÿ","å¿ƒ","æ–°","æ•°","å‰","ä½“","åœ°","é•·","ç›´","é€š","å½“","é ­","é“","å†…","é¢¨","åˆ†","æ–¹","é–€","å¤œ","é‡","ç”¨","æ¥"],
  g3: ["æ‚ª","æ„","é‹","åŒ–","é–‹","æ„Ÿ","æœŸ","æ¥­","å±€","äº‹","å®Ÿ","æ‰€","èº«","é€²","å…¨","ä»£","ç€","å®š","è»¢","å‹•","é…","ç™º","ç­†","å“","éƒ¨","ç‰©","å¹³","å‘½","é¢","æ´‹","æµ","è·¯","å’Œ"]
};
KANJI_BY_GRADE.g12 = [...KANJI_BY_GRADE.g1, ...KANJI_BY_GRADE.g2];
KANJI_BY_GRADE.g123 = [...KANJI_BY_GRADE.g1, ...KANJI_BY_GRADE.g2, ...KANJI_BY_GRADE.g3];

const JUKUGO_TSV = `
éŸ³æ„Ÿ	ãŠã‚“ã‹ã‚“	éŸ³ã®é«˜ã„ãƒ»ä½ã„ãªã©ã®ã¡ãŒã„ã‚’èãåˆ†ã‘ã‚‹åŠ›	éŸ³æ„ŸãŒã‚ˆã„äººã¯éŸ³ã®ã¡ãŒã„ã«ã™ãæ°—ã¥ãã¾ã™
éŸ³é ­	ãŠã‚“ã©	ã¿ã‚“ãªã§æ­Œã£ãŸã‚ŠãŠã©ã£ãŸã‚Šã™ã‚‹ã¨ãã®æ­Œã‚„èª¿å­	å…ˆç”ŸãŒéŸ³é ­ã‚’ã¨ã£ã¦ã¿ã‚“ãªã§æ‰‹ã‚’ãŸãŸãã¾ã—ãŸ
è¶³éŸ³	ã‚ã—ãŠã¨	äººã‚„å‹•ç‰©ãŒæ­©ã„ãŸã¨ãã«å‡ºã‚‹éŸ³	ã‚ã†ä¸‹ã§è¶³éŸ³ãŒã—ã¦ã ã‚Œã‹æ¥ãŸã¨åˆ†ã‹ã‚Šã¾ã—ãŸ
å¿ƒéŸ³	ã—ã‚“ãŠã‚“	å¿ƒãã†ãŒå‹•ãã¨ãã«å‡ºã‚‹éŸ³	ç—…é™¢ã§å¿ƒéŸ³ã‚’èã„ã¦ã‚‚ã‚‰ã„ã¾ã—ãŸ
å…¨éŸ³	ãœã‚“ãŠã‚“	éŸ³ã¨éŸ³ã®é–“ãŒã€ŒåŠéŸ³2ã¤åˆ†ã€ã‚ã„ã¦ã„ã‚‹ã“ã¨ï¼ˆéŸ³ã®é–“ã®åºƒã•ï¼‰	ãƒ”ã‚¢ãƒã§ãƒ‰ã‹ã‚‰ãƒ¬ã¯å…¨éŸ³ã§ã™ã€‚
é•·éŸ³	ã¡ã‚‡ã†ãŠã‚“	å£°ã‚„éŸ³ã‚’é•·ãã®ã°ã—ã¦å‡ºã™éŸ³	ãŠçˆ¶ã•ã‚“ã®ã€Œã¨ã†ã€ã¯é•·éŸ³ã§ã™
ç™ºéŸ³	ã¯ã¤ãŠã‚“	è¨€è‘‰ã®éŸ³ã‚’å£°ã«å‡ºã™ã“ã¨	è‹±èªã®ç™ºéŸ³ã‚’ã‚Œã‚“ã—ã‚…ã†ã—ã¾ã™
æœ¬éŸ³	ã»ã‚“ã­	å¿ƒã®ä¸­ã§æœ¬å½“ã«æ€ã£ã¦ã„ã‚‹ã“ã¨	æœ¬éŸ³ã‚’è¨€ã†ã¨ã€å®¿é¡Œã¯ã‚„ã‚ŠãŸããªã„ã§ã™ã€‚
ç‰©éŸ³	ã‚‚ã®ãŠã¨	ç‰©ãŒå‹•ã„ãŸã‚Šå½“ãŸã£ãŸã‚Šã—ã¦å‡ºã‚‹éŸ³	å¤œã«ç‰©éŸ³ãŒã—ã¦ç›®ãŒã•ã‚ã¾ã—ãŸ
å’ŒéŸ³	ã‚ãŠã‚“	ã„ãã¤ã‹ã®éŸ³ã‚’åŒæ™‚ã«é³´ã‚‰ã—ãŸéŸ³	ãƒ”ã‚¢ãƒã§å’ŒéŸ³ã‚’ã²ãã¨ãã‚Œã„ã«ã²ã³ãã¾ã™
ä¸‹éƒ¨	ã‹ã¶	å…¨ä½“ã®ä¸­ã§ä¸‹ã®ã»ã†ã®éƒ¨åˆ†	é»’æ¿ã®ä¸‹éƒ¨ã«ä»Šæ—¥ã®å®¿é¡Œã‚’æ›¸ãã¾ã—ãŸ
ä¸‹æµ	ã‹ã‚Šã‚…ã†	å·ã®æµã‚Œã§ä¸‹ã®ã»ã†ï¼ˆæµ·ã«è¿‘ã„ã»ã†ï¼‰	å·ã®ä¸‹æµã«ã¯åºƒã„å·åŸãŒã‚ã‚Šã¾ã™
ä¸‹å±±	ã’ã–ã‚“	å±±ã‹ã‚‰ä¸‹ã‚Šã‚‹ã“ã¨	æš—ããªã‚‹å‰ã«ä¸‹å±±ã—ã¾ã—ãŸ
ä¸‹è»Š	ã’ã—ã‚ƒ	æ¬¡ã®ãˆãã§é›»è»Šã‚„ãƒã‚¹ã‹ã‚‰ãŠã‚Šã‚‹ã“ã¨	æ¬¡ã®é§…ã§ä¸‹è»Šã—ã¦ãã ã•ã„
`.trim();

function buildJukugoDB(tsv){
  const db = Object.create(null);
  const lines = tsv.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  for(const line of lines){
    const parts = line.split("\t");
    if(parts.length < 2) continue;
    const k = (parts[0]||"").trim();
    const y = (parts[1]||"").trim();
    const imi = (parts[2]||"").trim();
    const rei = (parts[3]||"").trim();
    if(!k) continue;
    if(!db[k]) db[k] = { yomi: y, imi: imi, reibun: rei };
  }
  return db;
}
const JUKUGO_DB = buildJukugoDB(JUKUGO_TSV);
const ANSWER_SET = new Set(Object.keys(JUKUGO_DB));

const el = (id)=>document.getElementById(id);
const fieldEl = el("field");
const msgEl = el("msg");
const topPill = el("topPill");
const drawBtn = el("drawBtn");
const checkBtn = el("checkBtn");
const endBtn = el("endBtn");
const startBtn = el("startBtn");
const resetBtn = el("resetBtn");
const gradeSelect = el("gradeSelect");
const playerCountSel = el("playerCount");
const targetPointsInp = el("targetPoints");
const missLimitSel = el("missLimit");
const scoreboardEl = el("scoreboard");
const winMsgEl = el("winMsg");
const skipNextBtn = el("skipNextBtn");
const drawChip = el("drawChip");
const drawMini = el("drawMini");
const slot1El = el("slot1");
const slot2El = el("slot2");
const wordBox = el("wordBox");
const madeListEl = el("madeList");
const missCountEl = el("missCount");
const kusudamaOverlay = el("kusudamaOverlay");
const kusudama = el("kusudama");
const streamers = el("streamers");
const kusudamaBanner = el("kusudamaBanner");
const speakBtn = el("speakBtn");
const stopSpeakBtn = el("stopSpeakBtn");
const speechEnableBtn = el("speechEnableBtn");
const ansSpeakBtn = el("ansSpeakBtn");
const ansInfo = el("ansInfo");
const addFieldBtn = el("addFieldBtn");
const readingToggle = el("readingToggle");

if(!HAS_SPEECH){
  speakBtn.addEventListener("click", ()=> setMsg("ã“ã®ç’°å¢ƒã§ã¯éŸ³å£°èª­ã¿ä¸Šã’ãŒä½¿ãˆã¾ã›ã‚“ã€‚", "ng"));
  stopSpeakBtn.addEventListener("click", ()=> setMsg("ã“ã®ç’°å¢ƒã§ã¯éŸ³å£°èª­ã¿ä¸Šã’ãŒä½¿ãˆã¾ã›ã‚“ã€‚", "ng"));
  ansSpeakBtn.addEventListener("click", ()=> setMsg("ã“ã®ç’°å¢ƒã§ã¯éŸ³å£°èª­ã¿ä¸Šã’ãŒä½¿ãˆã¾ã›ã‚“ã€‚", "ng"));
}

// â˜…éŸ³å£°ONãƒœã‚¿ãƒ³ï¼ˆSpeechSynthesis è§£æ”¾ç”¨ï¼‰
// P2ãŒã€Œä¸€åº¦ã‚‚èª­ã¿ä¸Šã’ã‚’æŠ¼ã—ã¦ãªã„ã¨é éš”èª­ã¿ä¸Šã’ãŒé³´ã‚‰ãªã„ã€ç«¯æœ«å‘ã‘ã€‚
// 1å›æŠ¼ã™ã ã‘ã§ä»¥å¾Œã®é éš”èª­ã¿ä¸Šã’ã‚‚é³´ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
if(speechEnableBtn){
  if(!HAS_SPEECH){
    speechEnableBtn.style.display = "none";
  }else{
    speechEnableBtn.addEventListener("click", ()=>{
      unlockAudio();
      const ok = unlockSpeechHard();
      if(ok){
        speechEnableBtn.style.display = "none";
        setMsg("éŸ³å£°ã‚’æœ‰åŠ¹ã«ã—ã¾ã—ãŸã€‚ä»¥å¾Œã€ç›¸æ‰‹ã®èª­ã¿ä¸Šã’ã‚‚èã“ãˆã¾ã™ã€‚","ok");
      }else{
        setMsg("éŸ³å£°ã‚’æœ‰åŠ¹ã«ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆç«¯æœ«ã®éŸ³å£°è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰ã€‚","ng");
      }
    });
  }
}

// ============ çŠ¶æ…‹ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒç­‰ï¼‰===========
let started = false;
let deck = [];
let field = [];
let players = [];
let current = 0;
let targetPoints = 5;
let missLimit = 3;

let drewThisTurn = false;
let drawnKanji = null;
let missThisTurn = 0;

let slot1 = null;
let slot2 = null;
let made = new Set();

let lastCorrectWord = null;
let speakingAnswerUtterance = null;
let speakingRuleUtterance = null;

let holdAdvance = false;

let showReadings = true;

// ============================
// â˜…ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼šæ“ä½œå¯å¦ï¼ˆæ‰‹ç•ªåˆ¶ï¼‰
// ============================
function canOperateNow(){
  if(!ONLINE.enabled) return true;        // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã¯å¾“æ¥é€šã‚Š
  if(!started) return false;
  return (ME_ID === (current + 1));       // currentã¯0-based
}

// ============================
// ä¾¿åˆ©é–¢æ•°
// ============================
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function setMsgLocal(text, kind=""){
  msgEl.classList.remove("ok","ng");
  if(kind) msgEl.classList.add(kind);
  msgEl.textContent = text;
}
// â˜…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ç›¸æ‰‹ã«ã‚‚è¡¨ç¤ºï¼ˆã‚¤ãƒ™ãƒ³ãƒˆï¼‰
function setMsg(text, kind=""){
  setMsgLocal(text, kind);
  if(ONLINE.enabled) sendOnlineEvent("msg", { text, kind });
}
function setTopPill(text){ topPill.textContent = text; }

function clearAnswerSpeakUI(){
  ansSpeakBtn.style.display = "none";
  ansInfo.style.display = "none";
  ansInfo.innerHTML = "";
  lastCorrectWord = null;
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (c)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}
function formatReadingLines(s){
  const t = String(s || "").trim();
  if(!t) return "";
  const parts = t.split("ãƒ»").map(x=>x.trim()).filter(Boolean);
  if(parts.length <= 1) return escapeHtml(t);
  return parts.map(escapeHtml).join("ãƒ»<br>");
}
function kanjiHtml(k){
  if(!showReadings) return escapeHtml(k);
  const r = KANJI_READINGS[k] || { on:"", kun:"" };
  const on = r.on ? formatReadingLines(r.on) : "";
  const kun = r.kun ? formatReadingLines(r.kun) : "";
  return (
    `<div class="kWrap">` +
      `<div class="kOn">${on}</div>` +
      `<div class="kCore">${escapeHtml(k)}</div>` +
      `<div class="kKun">${kun}</div>` +
    `</div>`
  );
}

function renderField(){
  fieldEl.innerHTML = "";
  field.forEach((k, idx)=>{
    const d = document.createElement("div");
    d.className = "tile";
    d.innerHTML = kanjiHtml(k);
    d.dataset.idx = String(idx);
    d.addEventListener("click", ()=> onPickField(idx));
    fieldEl.appendChild(d);
  });
}
function renderSlots(){
  if(slot1){ slot1El.innerHTML = kanjiHtml(slot1.value); }
  else{ slot1El.textContent = "â€”"; }
  if(slot2){ slot2El.innerHTML = kanjiHtml(slot2.value); }
  else{ slot2El.textContent = "â€”"; }
  slot1El.classList.toggle("filled", !!slot1);
  slot2El.classList.toggle("filled", !!slot2);
  wordBox.textContent = (slot1 && slot2) ? (slot1.value + slot2.value) : "â€”";
}
function renderDraw(){
  if(drawnKanji){ drawMini.innerHTML = kanjiHtml(drawnKanji); }
  else{ drawMini.textContent = "â€”"; }
  drawChip.disabled = !drawnKanji;
}
function renderMade(){
  madeListEl.innerHTML = "";
  [...made].forEach(w=>{
    const s = document.createElement("span");
    s.className = "tag";
    s.textContent = w;
    madeListEl.appendChild(s);
  });
}
function renderMiss(){ missCountEl.textContent = started ? `${missThisTurn} / ${missLimit}` : "â€”"; }

function renderScoreboard(){
  scoreboardEl.innerHTML = "";
  players.forEach((p, idx)=>{
    const row = document.createElement("div");
    row.className = "pRow" + (idx===current ? " active":"");
    const left = document.createElement("div");
    left.className = "left";
    const dot = document.createElement("span");
    dot.className = "dot";
    const name = document.createElement("span");
    name.textContent = `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${idx+1}`;
    left.appendChild(dot);
    left.appendChild(name);

    const pts = document.createElement("div");
    pts.className = "pts";

    const pt = document.createElement("span");
    pt.className = "ptVal";
    pt.textContent = `${p.points} pt`;
    pts.appendChild(pt);

    if(started && idx === current){
      const st = document.createElement("span");
      if(p.skipNext){
        st.className = "statusTag";
        st.textContent = "æ¬¡ä¼‘ã¿";
      }else{
        st.className = "statusTag miss";
        st.textContent = `ãƒŸã‚¹ ${missThisTurn} / ${missLimit}`;
      }
      pts.appendChild(st);
    }else if(p.skipNext){
      const st = document.createElement("span");
      st.className = "statusTag";
      st.textContent = "æ¬¡ä¼‘ã¿";
      pts.appendChild(st);
    }

    row.appendChild(left);
    row.appendChild(pts);
    scoreboardEl.appendChild(row);
  });
}

function updateTurnUI(){
  const online = ONLINE.enabled;

  if(!started){
    drawBtn.disabled = true;
    checkBtn.disabled = true;
    endBtn.disabled = true;
    skipNextBtn.style.display = "none";
    addFieldBtn.style.display = "none";
    addFieldBtn.disabled = true;

    // â˜…ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼šP1ã®ã¿ã‚¹ã‚¿ãƒ¼ãƒˆ/ãƒªã‚»ãƒƒãƒˆ
    if(online){
      startBtn.disabled = (ME_ID !== 1);
      resetBtn.disabled = (ME_ID !== 1);
    }else{
      startBtn.disabled = false;
      resetBtn.disabled = false;
    }
    return;
  }

  const p = players[current];
  setTopPill(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${current+1}ã®ç•ª`);

  // â˜…ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼šæ‰‹ç•ªä»¥å¤–ã¯æ“ä½œä¸å¯
  const myTurn = canOperateNow();

  if(holdAdvance){
    drawBtn.disabled = true;
    checkBtn.disabled = true;
    endBtn.disabled = true;
    skipNextBtn.style.display = "inline-flex";
    addFieldBtn.style.display = "none";
    addFieldBtn.disabled = true;

    if(online && !myTurn){
      skipNextBtn.disabled = true;
    }else{
      skipNextBtn.disabled = false;
    }

    renderScoreboard();
    renderMiss();
    renderSlots();
    renderDraw();
    return;
  }

  if(p.skipNext){
    drawBtn.disabled = true;
    checkBtn.disabled = true;
    endBtn.disabled = true;
    skipNextBtn.style.display = "inline-flex";
    skipNextBtn.disabled = (online && !myTurn);
  }else{
    skipNextBtn.style.display = "none";
    drawBtn.disabled = drewThisTurn || (online && !myTurn);
    checkBtn.disabled = (!drewThisTurn) || (online && !myTurn);

    // â˜…è¦æœ›ï¼š1æšå¼•ãå‰ã¯ç•ªã‚’çµ‚ãˆã‚‰ã‚Œãªã„
    endBtn.disabled = (!drewThisTurn) || (online && !myTurn);
  }

  if(field.length <= 3 && started){
    addFieldBtn.style.display = "inline-flex";
    addFieldBtn.disabled = (players[current]?.skipNext) ? true : (online && !myTurn);
  }else{
    addFieldBtn.style.display = "none";
    addFieldBtn.disabled = true;
  }

  // â˜…ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼šP1ã®ã¿ãƒªã‚»ãƒƒãƒˆ
  if(online){
    resetBtn.disabled = (ME_ID !== 1);
  }else{
    resetBtn.disabled = false;
  }

  renderScoreboard();
  renderMiss();
  renderSlots();
  renderDraw();
}

function firstEmptySlot(){ if(!slot1) return 1; if(!slot2) return 2; return 0; }
function putToSlot(obj){
  const n = firstEmptySlot();
  if(n===0) return;
  if(n===1) slot1 = obj;
  if(n===2) slot2 = obj;
  renderSlots();
  updateTurnUI();
  pushStateIfOnline();
}
function clearSlot(n){
  if(n===1) slot1 = null;
  if(n===2) slot2 = null;
  renderSlots();
  updateTurnUI();
  pushStateIfOnline();
}
slot1El.addEventListener("click", ()=>{
  if(ONLINE.enabled && !canOperateNow()) return;
  clearSlot(1);
});
slot2El.addEventListener("click", ()=>{
  if(ONLINE.enabled && !canOperateNow()) return;
  clearSlot(2);
});

function onPickField(idx){
  if(!started) return;
  if(ONLINE.enabled && !canOperateNow()) return;

  const p = players[current];
  if(p.skipNext) return;
  if(holdAdvance) return;

  if(!drewThisTurn){
    setMsg("å…ˆã«ã€Œï¼‘ã¾ã„å¼•ãã€ã‚’æŠ¼ã—ã¦ã­ã€‚","ng");
    return;
  }
  const already = (slot1?.src==="field" && slot1.index===idx) || (slot2?.src==="field" && slot2.index===idx);
  if(already) return;
  putToSlot({ src:"field", value: field[idx], index: idx });
}
drawChip.addEventListener("click", ()=>{
  if(!started) return;
  if(ONLINE.enabled && !canOperateNow()) return;

  const p = players[current];
  if(p.skipNext) return;
  if(holdAdvance) return;

  if(!drewThisTurn){
    setMsg("å…ˆã«ã€Œï¼‘ã¾ã„å¼•ãã€ã‚’æŠ¼ã—ã¦ã­ã€‚","ng");
    return;
  }
  if(!drawnKanji) return;

  const already = (slot1?.src==="draw") || (slot2?.src==="draw");
  if(already) return;

  putToSlot({ src:"draw", value: drawnKanji });
});

function buildDeckForGrade(gradeKey){
  const pool = KANJI_BY_GRADE[gradeKey] || KANJI_BY_GRADE.g1;
  const d = [...pool];
  return shuffle(d);
}

function burstKusudama(winnerIndex){
  kusudamaOverlay.style.display = "flex";
  kusudama.classList.remove("burst");
  streamers.innerHTML = "";
  kusudamaBanner.textContent = `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${winnerIndex+1}ã®å‹ã¡ï¼`;

  requestAnimationFrame(()=>{
    kusudama.classList.add("burst");
    for(let i=0;i<18;i++){
      const s = document.createElement("div");
      s.className = "streamer";
      const r = (Math.random()*120 - 60).toFixed(1) + "deg";
      const x = (Math.random()*340 - 170).toFixed(1) + "px";
      s.style.setProperty("--r", r);
      s.style.setProperty("--x", x);
      streamers.appendChild(s);
    }
    setTimeout(()=>{ kusudamaOverlay.style.display="none"; }, 1400);
  });
}

let cachedVoices = [];
function refreshVoices(){
  if(!HAS_SPEECH) return;
  try{ cachedVoices = window.speechSynthesis.getVoices() || []; }catch(_){ cachedVoices = []; }
}
refreshVoices();
if(HAS_SPEECH){ window.speechSynthesis.onvoiceschanged = refreshVoices; }
function pickJaVoice(){
  if(!HAS_SPEECH) return null;
  const voices = cachedVoices.length ? cachedVoices : (window.speechSynthesis.getVoices?.() || []);
  return voices.find(v => /ja|JP/i.test(v.lang)) || voices[0] || null;
}
function speakTextNow(text, onEnd){
  if(!HAS_SPEECH){ onEnd && onEnd(); return null; }
  try{
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(ttsNormalize(text));
    const v = pickJaVoice();
    if(v) u.voice = v;
    u.lang = "ja-JP";
    u.rate = 1.0;
    u.pitch = 1.0;
    u.onend = ()=>{ onEnd && onEnd(); };
    u.onerror = ()=>{ onEnd && onEnd(); };
    window.speechSynthesis.speak(u);
    return u;
  }catch(e){
    onEnd && onEnd();
    return null;
  }
}

// â˜…é éš”èª­ã¿ä¸Šã’ï¼šè§£æ”¾å‰ã¯ã‚­ãƒ¥ãƒ¼ã«ç©ã‚€ï¼ˆP2ãŒã¾ã ä¸€åº¦ã‚‚èª­ã¿ä¸Šã’ã¦ãªã„ã¨é³´ã‚‰ãªã„å•é¡Œã®å¯¾ç­–ï¼‰
function speakText(text, onEnd){
  if(!HAS_SPEECH){ onEnd && onEnd(); return null; }
  if(!SPEECH_GATE.unlocked){
    SPEECH_GATE.pending.push({ text: String(text||""), onEnd });
    return null;
  }
  return speakTextNow(text, onEnd);
}

speakBtn.addEventListener("click", ()=>{
  unlockSpeech();
  if(!HAS_SPEECH){ setMsg("ã“ã®ç’°å¢ƒã§ã¯éŸ³å£°èª­ã¿ä¸Šã’ãŒä½¿ãˆã¾ã›ã‚“ã€‚","ng"); return; }
  const text = [
  "æœ€åˆã« ã°ãµã  ãŒ6æšå‡ºã¾ã™ã€‚",
  "è‡ªåˆ†ã® ã°ã‚“ ã§ã¯ã€å¿…ãš ã‚„ã¾ãµã  ã‹ã‚‰1æšå¼•ãã¾ã™ã€‚1å›ã ã‘ã€‚",
  "ï¼‘ã€ï¼’ã®ã‚ãã«ã€ã°ãµã  ã©ã†ã—ã€ã¾ãŸã¯ ã²ããµã  ã¨ ã°ãµã  ã‚’ã€ã‚¿ãƒƒãƒ—ã—ã¦ã„ã‚Œã¾ã™ã€‚",
  "ã§ããŸã‚‰ã€ã§ããŸï¼ ã‚’ã‚¿ãƒƒãƒ—ã—ã¾ã™ã€‚æ­£ç­”ãªã‚‰1ãƒã‚¤ãƒ³ãƒˆã€‚",
  "ä½œã‚Œãªã‹ã£ãŸã¨ãã¯ã€å¼•ã„ãŸ ãµã  ã¯ ã°ãµã  ã«ä¸¦ã³ã€ã°ãµã  ãŒã©ã‚“ã©ã‚“å¢—ãˆã¾ã™ã€‚",
  "ã°ãµã  ãŒ3æšä»¥ä¸‹ã«ãªã£ãŸã‚‰ã€ã°ãµã  ã‚’è¿½åŠ ã™ã‚‹ ã®ãƒœã‚¿ãƒ³ã§ã€ãµã  ã‚’è¿½åŠ ã§ãã¾ã™ã€‚",
  "ã°ã‚“ ã‚’çµ‚ãˆã‚‹ã¨ãã€æ‰‹å…ƒã«æ®‹ã£ãŸ ã²ããµã  ã‚‚ ã°ãµã  ã¸è¿½åŠ ã•ã‚Œã¾ã™ã€‚",
  "ç›®æ¨™ãƒã‚¤ãƒ³ãƒˆã«é”ã—ãŸäººãŒå‹ã¡ã€‚è¨­å®šã§å¤‰æ›´ã§ãã¾ã™ã€‚",
  "1ã‚¿ãƒ¼ãƒ³ã§ã€ãã®è¨€è‘‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€ãŒè¨­å®šå›æ•°å‡ºãŸã‚‰ã€æ¬¡ã®è‡ªåˆ†ã® ã°ã‚“ ã¯1å›ä¼‘ã¿ã§ã™ã€‚ã¤ãã¸ã€ã§é€²ã¿ã¾ã™ã€‚"
].join(" ");
  speakingRuleUtterance = speakText(text);
});
stopSpeakBtn.addEventListener("click", ()=>{
  if(!HAS_SPEECH){ setMsg("ã“ã®ç’°å¢ƒã§ã¯éŸ³å£°èª­ã¿ä¸Šã’ãŒä½¿ãˆã¾ã›ã‚“ã€‚","ng"); return; }
  safeCancelSpeech();
  speakingRuleUtterance = null;
});

// â˜…ğŸ”Šï¼šæŠ¼ã—ãŸã‚‰ç›¸æ‰‹ã«ã‚‚æµã™ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆï¼‰
ansSpeakBtn.addEventListener("click", ()=>{
  unlockSpeech();
  if(!lastCorrectWord) return;
  const info = JUKUGO_DB[lastCorrectWord];
  if(!info) return;

  ansInfo.innerHTML =
    `<div>ã€${escapeHtml(lastCorrectWord)}ã€‘</div>` +
    `<div class="sub">ã‚ˆã¿ï¼š${escapeHtml(info.yomi || "")}</div>` +
    `<div class="sub">ã„ã¿ï¼š${escapeHtml(info.imi || "")}</div>` +
    `<div class="sub">ã‚Œã„ã¶ã‚“ï¼š${escapeHtml(info.reibun || "")}</div>`;
  ansInfo.style.display = "block";

  const word = lastCorrectWord;
  const yomi = info.yomi || "";
  const reibunRaw = info.reibun || "";
  const reibunSpeak = (reibunRaw && word && yomi) ? (reibunRaw.split(word).join(yomi)) : reibunRaw;

  const speakStr = `ã‚ˆã¿ã€${yomi}ã€‚ã„ã¿ã€${info.imi || ""}ã€‚ã‚Œã„ã¶ã‚“ã€${reibunSpeak}`;
  speakingAnswerUtterance = speakText(speakStr, ()=>{
    ansInfo.style.display = "none";
    ansInfo.innerHTML = "";
    speakingAnswerUtterance = null;
  });

  if(ONLINE.enabled){
    sendOnlineEvent("speakAnswer", {
      word,
      info: { yomi: info.yomi || "", imi: info.imi || "", reibun: info.reibun || "" }
    });
  }
});

function resetTurnState(){
  drewThisTurn = false;
  drawnKanji = null;
  missThisTurn = 0;
  slot1 = null;
  slot2 = null;
  clearAnswerSpeakUI();
  renderSlots();
  renderDraw();
  renderMiss();
}

function nextPlayer(){
  holdAdvance = false;
  current = (current + 1) % players.length;
  resetTurnState();
  renderScoreboard();
  updateTurnUI();

  const p = players[current];
  if(p.skipNext) setMsg(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${current+1}ã¯ä¼‘ã¿ã§ã™ã€‚ã€Œã¤ãã¸ã€ã§é€²ã‚ã¾ã™ã€‚`);
  else setMsg(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${current+1}ã®ç•ªã§ã™ã€‚ã€Œï¼‘ã¾ã„å¼•ãã€ã‹ã‚‰å§‹ã‚ã¾ã™ã€‚`);
  playSfx("turn", true);
  pushStateIfOnline(true);
}

function checkWin(){
  const winner = players.findIndex(p => p.points >= targetPoints);
  if(winner >= 0){
    winMsgEl.style.display = "block";
    winMsgEl.textContent = `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${winner+1}ã®å‹ã¡ï¼`;
    drawBtn.disabled = true;
    checkBtn.disabled = true;
    endBtn.disabled = true;
    skipNextBtn.style.display = "none";
    addFieldBtn.style.display = "none";
    burstKusudama(winner);

    // â˜…ç›¸æ‰‹ã«ã‚‚ã‚¯ã‚¹ç‰
    if(ONLINE.enabled) sendOnlineEvent("kusudama", { winnerIndex: winner });

    started = false;
    setTopPill("çµ‚äº†");
    pushStateIfOnline();
    return true;
  }
  return false;
}

function endTurnHoldAdvance(){
  if(drawnKanji){ field.push(drawnKanji); drawnKanji = null; }
  slot1 = null; slot2 = null;
  renderField();
  renderSlots();
  renderDraw();
  holdAdvance = true;
  updateTurnUI();
  pushStateIfOnline();
}

drawBtn.addEventListener("click", ()=>{
  if(!started) return;
  if(ONLINE.enabled && !canOperateNow()) return;

  const p = players[current];
  if(p.skipNext) return;
  if(drewThisTurn) return;
  if(holdAdvance) return;

  if(deck.length === 0){
    setMsg("å±±æœ­ãŒãªããªã‚Šã¾ã—ãŸã€‚ã‚‚ã†å¼•ã‘ã¾ã›ã‚“ï¼ˆãƒªã‚»ãƒƒãƒˆã—ã¦ã­ï¼‰ã€‚","ng");
    return;
  }
  drawnKanji = deck.pop();
  drewThisTurn = true;
  renderDraw();
  updateTurnUI();
  setMsg("å¼•ã„ãŸæœ­ã‚’â‘ â‘¡ã«å…¥ã‚Œã¦ã€ç†Ÿèªã‚’ä½œã£ã¦ã­ã€‚");
  pushStateIfOnline();
});

checkBtn.addEventListener("click", ()=>{
  if(!started) return;
  if(ONLINE.enabled && !canOperateNow()) return;

  const p = players[current];
  if(p.skipNext) return;
  if(holdAdvance) return;

  if(!drewThisTurn){
    setMsg("å…ˆã«ã€Œï¼‘ã¾ã„å¼•ãã€ã‚’æŠ¼ã—ã¦ã­ã€‚","ng");
    return;
  }
  if(!slot1 || !slot2){
    setMsg("â‘ â‘¡ã‚’ã†ã‚ã¦ã‹ã‚‰ã€Œã§ããŸï¼ã€ã‚’æŠ¼ã—ã¦ã­ã€‚","ng");
    return;
  }

  const word = slot1.value + slot2.value;

  if(!ANSWER_SET.has(word)){
    missThisTurn++;
    renderMiss();
    flashBadTiles();

    if(missThisTurn >= missLimit){
      p.skipNext = true;
      playSfx("tap", true);
    setMsg("ãã®è¨€è‘‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãƒŸã‚¹ãŒãŸã¾ã£ãŸã®ã§ã€æ¬¡ã®è‡ªåˆ†ã®ç•ªã¯ä¼‘ã¿ã§ã™ã€‚","ng");
      renderScoreboard();
      endTurnHoldAdvance();
      return;
    }
    playSfx("tap", true);
    setMsg("ãã®è¨€è‘‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚","ng");
    renderScoreboard();
    pushStateIfOnline();
    return;
  }

  if(made.has(word)){
    setMsg("ãã®ç†Ÿèªã¯ã€ã‚‚ã†ã§ãã¦ã„ã¾ã™ï¼ˆåŒã˜ç†Ÿèªã¯1å›ã¾ã§ï¼‰ã€‚","ng");
    return;
  }

  made.add(word);
  p.points += 1;
  renderMade();
  renderScoreboard();

  playSfx("tap", true);
  setMsg("æ­£ç­”ï¼ 1ãƒã‚¤ãƒ³ãƒˆï¼ ğŸ”Šã§ ã‚ˆã¿ãƒ»ã„ã¿ãƒ»ã‚Œã„ã¶ã‚“ ã‚’èã‘ã¾ã™ã€‚ã¤ã¥ã‘ã¦ä½œã‚Œã¾ã™ã€‚","ok");

  lastCorrectWord = word;
  ansSpeakBtn.style.display = "inline-flex";

  consumeUsedTiles();

  if(checkWin()) return;

  updateTurnUI();
  pushStateIfOnline();
});

function consumeUsedTiles(){
  const usedFieldIdx = [];
  if(slot1?.src==="field") usedFieldIdx.push(slot1.index);
  if(slot2?.src==="field") usedFieldIdx.push(slot2.index);

  usedFieldIdx.sort((a,b)=>b-a).forEach(i=>{
    if(typeof i==="number" && i>=0 && i<field.length) field.splice(i,1);
  });

  if(slot1?.src==="draw" || slot2?.src==="draw"){ drawnKanji = null; }

  slot1 = null; slot2 = null;
  renderField();
  renderSlots();
  renderDraw();
}

function endTurn(force=false){
  if(drawnKanji){ field.push(drawnKanji); drawnKanji = null; }
  slot1 = null; slot2 = null;
  renderField();
  renderSlots();
  renderDraw();
  if(force) setTimeout(()=> nextPlayer(), 250);
  else nextPlayer();
}

endBtn.addEventListener("click", ()=>{
  if(!started) return;
  if(ONLINE.enabled && !canOperateNow()) return;

  const p = players[current];
  if(p.skipNext) return;
  if(holdAdvance) return;

  // â˜…è¦æœ›ï¼š1æšå¼•ãå‰ã¯çµ‚ãˆã‚‰ã‚Œãªã„
  if(!drewThisTurn){
    setMsg("å…ˆã«ã€Œï¼‘ã¾ã„å¼•ãã€ã‚’æŠ¼ã—ã¦ã­ã€‚","ng");
    return;
  }
  playSfx("tap", true);
  endTurn(false);
});

skipNextBtn.addEventListener("click", ()=>{
  if(!started) return;
  if(ONLINE.enabled && !canOperateNow()) return;

  if(holdAdvance){
    holdAdvance = false;
    setMsg("ã€Œã¤ãã¸ã€ã‚’æŠ¼ã—ã¾ã—ãŸã€‚æ¬¡ã®äººã¸é€²ã¿ã¾ã™ã€‚");
    setTimeout(()=> nextPlayer(), 250);
    pushStateIfOnline();
    return;
  }

  const p = players[current];
  if(!p.skipNext) return;
  p.skipNext = false;
  renderScoreboard();
  setMsg(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${current+1}ã®ä¼‘ã¿ãŒçµ‚ã‚ã‚Šã¾ã—ãŸã€‚æ¬¡ã®äººã¸é€²ã¿ã¾ã™ã€‚`);
  setTimeout(()=> nextPlayer(), 250);
  pushStateIfOnline();
});

addFieldBtn.addEventListener("click", ()=>{
  if(!started) return;
  if(ONLINE.enabled && !canOperateNow()) return;

  const p = players[current];
  if(p.skipNext) return;
  if(holdAdvance) return;

  if(deck.length === 0){
    setMsg("å±±æœ­ãŒãªããªã‚Šã¾ã—ãŸã€‚å ´æœ­ã‚’è¿½åŠ ã§ãã¾ã›ã‚“ã€‚","ng");
    return;
  }
  const n = Math.min(3, deck.length);
  for(let i=0;i<n;i++){ field.push(deck.pop()); }
  renderField();
  updateTurnUI();
  setMsg(`å ´æœ­ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆ${n}æšï¼‰ã€‚`);
  pushStateIfOnline();
});

// ============================
// â˜…ã‚¹ã‚¿ãƒ¼ãƒˆ/ãƒªã‚»ãƒƒãƒˆï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã¯P1ã®ã¿ï¼‰
// ============================
startBtn.addEventListener("click", ()=>{
  if(ONLINE.enabled && ME_ID !== 1) return;

  const pc = Number(playerCountSel.value);
  targetPoints = Math.max(1, Number(targetPointsInp.value)||5);
  missLimit = Number(missLimitSel.value)||3;

  players = Array.from({length:pc}, ()=>({ points:0, skipNext:false }));
  current = 0;
  holdAdvance = false;

  made = new Set();
  renderMade();

  deck = buildDeckForGrade(gradeSelect.value);
  field = deck.splice(0,6);
  renderField();

  resetTurnState();
  started = true;
  winMsgEl.style.display = "none";
  setTopPill("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®ç•ª");
  setMsg("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®ç•ªã§ã™ã€‚ã€Œï¼‘ã¾ã„å¼•ãã€ã‹ã‚‰å§‹ã‚ã¾ã™ã€‚");
  renderScoreboard();
  updateTurnUI();

  pushStateIfOnline(true);
});

resetBtn.addEventListener("click", ()=>{
  if(ONLINE.enabled && ME_ID !== 1) return;

  safeCancelSpeech();
  started = false;
  deck = [];
  field = [];
  players = [];
  current = 0;
  made = new Set();
  slot1 = null; slot2 = null;
  drewThisTurn = false;
  drawnKanji = null;
  missThisTurn = 0;
  holdAdvance = false;
  winMsgEl.style.display = "none";
  setTopPill("æº–å‚™ä¸­");
  setMsg("ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã™ã¨é–‹å§‹ã—ã¾ã™ã€‚");
  clearAnswerSpeakUI();
  renderField();
  renderSlots();
  renderDraw();
  renderMade();
  renderMiss();
  renderScoreboard();
  updateTurnUI();

  pushStateIfOnline(true);
});

function flashBadTiles(){
  const badIdx = [];
  if(slot1?.src==="field") badIdx.push(slot1.index);
  if(slot2?.src==="field") badIdx.push(slot2.index);
  badIdx.forEach(i=>{
    const t = fieldEl.querySelector(`.tile[data-idx="${i}"]`);
    if(!t) return;
    t.classList.add("bad");
    setTimeout(()=>t.classList.remove("bad"), 260);
  });
}

readingToggle.addEventListener("change", ()=>{
  showReadings = (readingToggle.value === "on");
  renderField();
  renderSlots();
  renderDraw();
  pushStateIfOnline();
});

showReadings = (readingToggle.value === "on");
updateTurnUI();
renderSlots();
renderDraw();
renderMiss();

// ============================
// â˜…ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼šçŠ¶æ…‹åŒæœŸï¼ˆstateï¼‰
// ============================
function makeStateSnapshot(){
  return {
    started,
    deck: [...deck],
    field: [...field],
    players: players.map(p=>({ points: p.points, skipNext: !!p.skipNext })),
    current,
    targetPoints,
    missLimit,
    drewThisTurn,
    drawnKanji: drawnKanji || null,
    missThisTurn,
    slot1: slot1 ? { src: slot1.src, value: slot1.value, index: (slot1.index ?? null) } : null,
    slot2: slot2 ? { src: slot2.src, value: slot2.value, index: (slot2.index ?? null) } : null,
    made: [...made],
    holdAdvance: !!holdAdvance,
    showReadings: !!showReadings,
    settings: {
      grade: gradeSelect.value,
      playerCount: Number(playerCountSel.value),
      targetPointsInput: Number(targetPointsInp.value),
      missLimitValue: Number(missLimitSel.value),
      readingToggle: readingToggle.value
    }
  };
}

function applyStateSnapshot(st){
  if(!st || typeof st !== "object") return;

  // UIè¨­å®šå€¤ã‚‚æƒãˆã‚‹ï¼ˆé–‹å§‹å‰ã«ã‚ºãƒ¬ãªã„ãŸã‚ï¼‰
  if(st.settings){
    if(typeof st.settings.grade === "string") gradeSelect.value = st.settings.grade;
    if(st.settings.playerCount != null) playerCountSel.value = String(st.settings.playerCount);
    if(st.settings.targetPointsInput != null) targetPointsInp.value = String(st.settings.targetPointsInput);
    if(st.settings.missLimitValue != null) missLimitSel.value = String(st.settings.missLimitValue);
    if(typeof st.settings.readingToggle === "string") readingToggle.value = st.settings.readingToggle;
  }

  started = !!st.started;
  deck = Array.isArray(st.deck) ? [...st.deck] : [];
  field = Array.isArray(st.field) ? [...st.field] : [];
  players = Array.isArray(st.players) ? st.players.map(p=>({ points: Number(p.points)||0, skipNext: !!p.skipNext })) : [];
  current = Number(st.current)||0;
  targetPoints = Math.max(1, Number(st.targetPoints)||5);
  missLimit = Number(st.missLimit)||3;
  drewThisTurn = !!st.drewThisTurn;
  drawnKanji = (st.drawnKanji==null) ? null : String(st.drawnKanji);
  missThisTurn = Number(st.missThisTurn)||0;
  slot1 = st.slot1 ? { src: st.slot1.src, value: st.slot1.value, index: (st.slot1.index ?? null) } : null;
  slot2 = st.slot2 ? { src: st.slot2.src, value: st.slot2.value, index: (st.slot2.index ?? null) } : null;
  made = new Set(Array.isArray(st.made) ? st.made : []);
  holdAdvance = !!st.holdAdvance;

  if(typeof st.showReadings === "boolean") showReadings = st.showReadings;

  // è¡¨ç¤ºæ›´æ–°
  renderField();
  renderSlots();
  renderDraw();
  renderMade();
  renderMiss();
  renderScoreboard();

  if(!started){
    setTopPill("æº–å‚™ä¸­");
  }else{
    setTopPill(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${current+1}ã®ç•ª`);
  }
  updateTurnUI();
}

function statePath(){
  return `rooms/${ROOM_ID}/state`;
}
function metaPath(){
  return `rooms/${ROOM_ID}/meta`;
}

async function pushStateIfOnline(force=false){
  if(!ONLINE.enabled) return;
  if(!ONLINE.ready) return;
  if(ONLINE.suppress) return;
  if(ONLINE.isApplyingRemote) return;

  // æ‰‹ç•ªè€… or P1ã®start/resetã®ã¿é€ã‚‹é‹ç”¨
  // ï¼ˆãŸã ã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚¤ãƒ™ãƒ³ãƒˆã§åˆ¥é€ï¼‰
  // â˜…æ³¨æ„ï¼šã‚¿ãƒ¼ãƒ³ã‚’é€²ã‚ãŸç›´å¾Œã¯ current ãŒç›¸æ‰‹ç•ªã«ãªã‚‹ãŸã‚ã€force=true ã®ã¨ãã¯ä¾‹å¤–çš„ã«é€ä¿¡ã‚’è¨±å¯ã™ã‚‹
  if(!force){
    if(started && !canOperateNow()) return;
    if(!started && ME_ID !== 1) return;
  }else{
    // force=trueï¼šç›´å‰ã¾ã§æ‰‹ç•ªã ã£ãŸå´ãŒã€Œã‚¿ãƒ¼ãƒ³é€²è¡Œå¾Œã®çŠ¶æ…‹ã€ã‚’é€ã‚‹ãŸã‚ã®æ•‘æ¸ˆ
    if(!(ME_ID === 1 || ME_ID === 2)) return;
  }

  const rev = Date.now();
  ONLINE.lastRev = rev;

  try{
    const st = makeStateSnapshot();
    await ONLINE._update(ONLINE._ref(ONLINE._db, metaPath()), { rev, updatedAt: ONLINE._serverTimestamp() });
    await ONLINE._set(ONLINE._ref(ONLINE._db, statePath()), st);
  }catch(_){
    // å¤±æ•—æ™‚ã¯é»™ã£ã¦ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç¶™ç¶š
  }
}

// ============================
// â˜…ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼šã‚¤ãƒ™ãƒ³ãƒˆé€å—ä¿¡ï¼ˆmsg / speak / kusudamaï¼‰
// ============================
function eventsPath(){
  return `rooms/${ROOM_ID}/events`;
}
let _eventsInited = false;
let _eventsStartAt = Date.now();
let _seenEventKeys = new Set();

function sendOnlineEvent(type, payload){
  if(!ONLINE.enabled) return;
  if(!ONLINE.ready) return;
  try{
    const ev = { type, payload: payload || {}, from: ME_ID||0, ts: Date.now() };
    const p = ONLINE._push(ONLINE._ref(ONLINE._db, eventsPath()));
    ONLINE._set(p, ev);
  }catch(_){}
}

function initOnlineEvents(){
  if(_eventsInited) return;
  if(!ONLINE.enabled) return;
  if(!ONLINE.ready) return;

  _eventsInited = true;
  try{
    ONLINE._onChildAdded(ONLINE._ref(ONLINE._db, eventsPath()), (snap)=>{
      const key = snap.key;
      const ev = snap.val();
      if(!ev || !key) return;
      if(_seenEventKeys.has(key)) return;
      _seenEventKeys.add(key);
      // â˜…ç«¯æœ«ã®æ™‚è¨ˆã‚ºãƒ¬ã§ã‚¤ãƒ™ãƒ³ãƒˆãŒæ¨ã¦ã‚‰ã‚Œã‚‹ã®ã‚’é˜²ãï¼ˆtsãƒ•ã‚£ãƒ«ã‚¿ç„¡ã—ï¼‰
      if(ev.from === ME_ID) return;
      handleOnlineEvent(ev);
    });
  }catch(_){}
}

function handleOnlineEvent(ev){
  const t = ev.type;
  const p = ev.payload || {};

  if(t === "msg"){
    setMsgLocal(p.text || "", p.kind || "");
    return;
  }
  if(t === "speakAnswer"){
    const word = String(p.word || "");
    const info = p.info || null;
    if(!word || !info) return;

    ansInfo.innerHTML =
      `<div>ã€${escapeHtml(word)}ã€‘</div>` +
      `<div class="sub">ã‚ˆã¿ï¼š${escapeHtml(info.yomi || "")}</div>` +
      `<div class="sub">ã„ã¿ï¼š${escapeHtml(info.imi || "")}</div>` +
      `<div class="sub">ã‚Œã„ã¶ã‚“ï¼š${escapeHtml(info.reibun || "")}</div>`;
    ansInfo.style.display = "block";
    ansSpeakBtn.style.display = "inline-flex";
    lastCorrectWord = word;

    const yomi = info.yomi || "";
    const reibunRaw = info.reibun || "";
    const reibunSpeak = (reibunRaw && word && yomi) ? (reibunRaw.split(word).join(yomi)) : reibunRaw;
    const speakStr = `ã‚ˆã¿ã€${yomi}ã€‚ã„ã¿ã€${info.imi || ""}ã€‚ã‚Œã„ã¶ã‚“ã€${reibunSpeak}`;

    speakingAnswerUtterance = speakText(speakStr, ()=>{
      ansInfo.style.display = "none";
      ansInfo.innerHTML = "";
      speakingAnswerUtterance = null;
    });
    return;
  }
  if(t === "kusudama"){
    const winner = Number(p.winnerIndex);
    if(Number.isFinite(winner) && winner >= 0){
      burstKusudama(winner);
    }
    return;
  }
  if(t === "sfx"){
    const kind = String(p.kind || "");
    if(!kind) return;
    // å—ä¿¡å´ã¯é€ä¿¡ã—è¿”ã•ãªã„
    playSfx(kind, false);
    return;
  }

}

// ============================
// â˜…ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼šFirebaseã®ãƒ­ãƒ¼ãƒ‰ï¼ˆå¤±æ•—ã—ãŸã‚‰ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç¶™ç¶šï¼‰
// ============================
async function initOnlineIfNeeded(){
  if(!ONLINE.enabled) return;

  try{
    const appMod = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js");
    const dbMod = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js");

    const app = appMod.initializeApp(firebaseConfig);
    const db = dbMod.getDatabase(app);

    ONLINE._db = db;
    ONLINE._ref = dbMod.ref;
    ONLINE._onValue = dbMod.onValue;
    ONLINE._set = dbMod.set;
    ONLINE._update = dbMod.update;
    ONLINE._push = dbMod.push;
    ONLINE._serverTimestamp = dbMod.serverTimestamp;
    ONLINE._onChildAdded = dbMod.onChildAdded;

    ONLINE.ready = true;

    // stateå—ä¿¡ï¼šå¸¸æ™‚è¿½å¾“
    ONLINE._onValue(ONLINE._ref(db, statePath()), (snap)=>{
      const st = snap.val();
      if(!st) return;

      // ãƒªãƒ¢ãƒ¼ãƒˆé©ç”¨ä¸­ã¯ push ã‚’æŠ‘åˆ¶
      ONLINE.isApplyingRemote = true;
      try{
        applyStateSnapshot(st);
      }finally{
        ONLINE.isApplyingRemote = false;
      }
    });

    initOnlineEvents();

    // UIåˆ¶ç´„
    if(ME_ID !== 1){
      startBtn.disabled = true;
      resetBtn.disabled = true;
    }

    setMsgLocal(`ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ï¼šéƒ¨å±‹ã€Œ${ROOM_ID}ã€  ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${ME_ID}`, "ok");

  }catch(e){
    // FirebaseãŒèª­ã¿è¾¼ã‚ãªã„ï¼ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã¨ã—ã¦å‹•ã‹ã™
    ONLINE.enabled = false;
    ONLINE.ready = false;
    setMsgLocal("ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§å‹•ä½œã—ã¾ã™ï¼‰ã€‚", "ng");
    updateTurnUI();
  }
}

// èµ·å‹•
initOnlineIfNeeded();
</script>
</body>
</html>