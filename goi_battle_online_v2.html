<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>語いクイズ</title>
  <style>
    :root {
      --bg1:#eef2ff;
      --bg2:#f3e8ff;
      --card:#ffffffcc;
      --ink:#111827;
      --ink-sub:#4b5563;
      --primary:#4f46e5;
      --primary-soft:#e0e7ff;
      --correct:#16a34a;
      --wrong:#dc2626;
      --border:#d1d5db;
    }
    * {
      box-sizing:border-box;
      -webkit-tap-highlight-color:transparent;
    }
    body {
      margin:0;
      min-height:100vh;
      padding:16px;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",
        "Hiragino Kaku Gothic ProN","ヒラギノ角ゴ ProN","Yu Gothic","メイリオ",sans-serif;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .app {
      width:100%;
      max-width:700px;
      background:var(--card);
      border-radius:18px;
      padding:20px 18px 18px;
      box-shadow:0 20px 40px rgba(15,23,42,0.25);
    }
    .app-title {
      font-size:1.4rem;
      font-weight:700;
      text-align:center;
      margin-bottom:8px;
      color:var(--ink);
    }
    .status-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:0.9rem;
      color:var(--ink-sub);
      margin-bottom:10px;
    }
    .progress-bar {
      width:100%;
      height:8px;
      background:#e5e7eb;
      border-radius:999px;
      overflow:hidden;
      margin-bottom:16px;
    }
    .progress-fill {
      height:100%;
      width:0%;
      background:var(--primary);
      transition:width 0.25s ease-out;
    }
    .card {
      background:white;
      border-radius:16px;
      border:1px solid var(--border);
      padding:16px;
    }
    .question-text {
      font-size:1.15rem;
      line-height:1.6;
      margin-bottom:14px;
      color:var(--ink);
    }
    .hint {
      font-size:0.85rem;
      color:var(--ink-sub);
      margin-bottom:10px;
    }
    .choices {
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-bottom:10px;
    }
    .choice-btn {
      border:1px solid var(--border);
      border-radius:999px;
      padding:8px 14px;
      font-size:1rem;
      text-align:left;
      background:#f9fafb;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      transition:transform 0.05s ease, box-shadow 0.05s ease, background 0.15s;
    }
    .choice-btn span.label { flex:1; }
    .choice-btn span.mark {
      font-size:0.8rem;
      opacity:0.7;
    }
    .choice-btn:active {
      transform:scale(0.98);
      box-shadow:0 2px 4px rgba(15,23,42,0.12);
    }
    .choice-btn.disabled {
      cursor:default;
      opacity:0.85;
    }
    .choice-btn.correct {
      border-color:var(--correct);
      background:#ecfdf3;
      color:var(--correct);
      font-weight:600;
    }
    .choice-btn.wrong {
      border-color:var(--wrong);
      background:#fef2f2;
      color:var(--wrong);
      font-weight:600;
    }
    .feedback {
      min-height:1.6em;
      font-size:0.95rem;
      margin-top:4px;
    }
    .feedback.correct { color:var(--correct); }
    .feedback.wrong { color:var(--wrong); }

    .nav-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:12px;
      gap:8px;
    }
    .score-text {
      font-size:0.9rem;
      color:var(--ink-sub);
    }
    .next-btn {
      border:none;
      border-radius:999px;
      background:var(--primary);
      color:white;
      font-size:0.95rem;
      font-weight:600;
      padding:8px 18px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
      box-shadow:0 6px 14px rgba(79,70,229,0.35);
      transition:transform 0.05s ease, box-shadow 0.05s ease, opacity 0.15s;
      white-space:nowrap;
    }
    .next-btn:active {
      transform:translateY(1px);
      box-shadow:0 3px 8px rgba(79,70,229,0.4);
    }
    .next-btn.disabled {
      opacity:0.4;
      cursor:default;
      box-shadow:none;
      transform:none;
    }

    .roulette {
      margin-top:14px;
      text-align:center;
    }
    .roulette-label {
      font-size:0.9rem;
      color:var(--ink-sub);
      margin-bottom:4px;
    }
    .roulette-wheel {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:72px;
      height:72px;
      border-radius:999px;
      border:2px solid var(--primary);
      font-size:1.4rem;
      font-weight:700;
      background:#ffffff;
      box-shadow:0 6px 14px rgba(79,70,229,0.25);
      cursor:pointer;
    }
    .roulette-wheel.disabled {
      opacity:0.4;
      cursor:default;
    }

    .card-container {
      margin-top:8px;
      display:none;
      justify-content:center;
      gap:10px;
    }
    .card-option {
      width:60px;
      height:80px;
      border-radius:10px;
      border:2px solid var(--primary);
      background:linear-gradient(135deg,#e5e7eb,#d1d5db);
      box-shadow:0 4px 8px rgba(15,23,42,0.15);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.3rem;
      font-weight:700;
      cursor:pointer;
      transition:transform 0.1s ease, box-shadow 0.1s ease, background 0.15s, border-color 0.15s;
    }
    .card-option:active {
      transform:translateY(1px);
      box-shadow:0 2px 4px rgba(15,23,42,0.2);
    }
    .card-option.disabled {
      opacity:0.6;
      cursor:default;
      box-shadow:none;
    }
    .card-option.selected {
      background:#ffffff;
      border-color:var(--correct);
    }

    .result {
      text-align:center;
      margin-top:8px;
      font-size:1rem;
    }
    .restart-btn {
      margin-top:10px;
      border-radius:999px;
      border:1px solid var(--primary);
      background:white;
      color:var(--primary);
      font-weight:600;
      font-size:0.95rem;
      padding:8px 16px;
      cursor:pointer;
    }

    ruby rt {
      font-size:0.6em;
    }

    @media (max-width:480px) {
      .app { padding:16px 12px 14px; }
      .question-text { font-size:1.05rem; }
      .choice-btn { padding:8px 10px; font-size:0.95rem; }
      .roulette-wheel { width:64px; height:64px; font-size:1.2rem; }
      .card-option {
        width:52px;
        height:72px;
        font-size:1.1rem;
      }
    }
  
    /* --- Online panel (added) --- */
    .shell{
      width:100%;
      max-width:980px;
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:center;
    }
    .online-panel{
      width:260px;
      background:var(--card);
      border-radius:18px;
      padding:14px 12px;
      box-shadow:0 20px 40px rgba(15,23,42,0.18);
      border:1px solid rgba(209,213,219,0.9);
    }
    .online-panel h3{
      margin:0 0 8px;
      font-size:0.95rem;
      color:var(--ink);
      text-align:left;
    }
    .online-panel .row{
      display:flex;
      gap:6px;
      margin-bottom:8px;
      align-items:center;
    }
    .online-panel input[type="text"]{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:0.9rem;
      background:#fff;
    }
    .online-panel button{
      border:none;
      border-radius:10px;
      background:var(--primary);
      color:#fff;
      font-weight:700;
      padding:8px 10px;
      cursor:pointer;
      white-space:nowrap;
      box-shadow:0 6px 14px rgba(79,70,229,0.25);
    }
    .online-panel button:active{ transform:translateY(1px); }
    .online-panel .label{
      font-size:0.8rem;
      color:var(--ink-sub);
      margin:6px 0 4px;
    }
    .online-panel .small{
      font-size:0.78rem;
      color:var(--ink-sub);
      line-height:1.35;
      margin-top:8px;
    }
    @media (max-width:820px){
      body{ align-items:flex-start; }
      .shell{ flex-direction:column; align-items:center; }
      .online-panel{ width:100%; max-width:700px; }
    }

  </style>
</head>
<body>
  <div class="shell">
  <div class="app">
    <div class="app-title">語いクイズ</div>

    <div class="status-row">
      <div>もんだい <span id="qNumber">1</span> / <span id="qTotal">0</span></div>
    </div>

    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>

    <div class="card">
      <div class="question-text" id="questionText"></div>
      <div class="hint" id="questionHint"></div>

      <div class="choices" id="choicesContainer"></div>

      <div class="feedback" id="feedback"></div>

      <div class="nav-row">
        <div class="score-text" id="scoreText">せいかい：0 もん</div>
        <button class="next-btn disabled" id="nextBtn" type="button">
          こたえを えらんでね
        </button>
      </div>
    </div>

    <div class="roulette">
      <div class="roulette-label">せいかいしたら しかけが でるよ</div>
      <div class="roulette-wheel disabled" id="rouletteWheel">？</div>
      <div class="card-container" id="cardContainer"></div>
    </div>

    <div class="result" id="resultArea"></div>
  </div>

  <aside class="online-panel" aria-label="オンライン設定">
    <h3>オンライン対戦</h3>
    <div class="label">部屋番号</div>
    <div class="row">
      <input id="roomInput" type="text" placeholder="部屋番号（例: class1）" />
      <button id="makeRoomUrlBtn" type="button">URL作成</button>
    </div>
    <div class="label">P1用URL</div>
    <input id="urlP1" type="text" readonly />
    <div class="label">P2用URL</div>
    <input id="urlP2" type="text" readonly />

    <div class="label">プレイヤー</div>
    <div class="small" id="mePlayer">-</div>
    <div class="label">ターン</div>
    <div class="small" id="turnPlayer">-</div>
    <div style="display:flex; gap:8px; margin-top:8px;">
      <button id="startBtn" type="button" style="flex:1;">スタート</button>
      <button id="resetBtn" type="button" style="flex:1; background:#6b7280; box-shadow:0 6px 14px rgba(107,114,128,0.25);">リセット</button>
    </div>
    <div class="small" id="onlineStatus">オフライン</div>
  </aside>
</div>

  <script type="module">
// 📚 ルビ入り語いクイズ（①〜㊺）※見出し語は問題文の冒頭に出さない
const questions = [
      {
        // ① 高熱
        text: `<ruby>朝<rt>あさ</rt></ruby>から<ruby>体<rt>からだ</rt></ruby>がとてもあつく、<ruby>頭<rt>あたま</rt></ruby>がぼーっとして<ruby>立<rt>た</rt></ruby>ち<ruby>上<rt>あ</rt></ruby>がるのもつらい<ruby>状態<rt>じょうたい</rt></ruby>です。<ruby>体温計<rt>たいおんけい</rt></ruby>で<ruby>測<rt>はか</rt></ruby>ると、38<ruby>度<rt>ど</rt></ruby>をこえていました。この<ruby>体<rt>からだ</rt></ruby>のようすを<ruby>何<rt>なん</rt></ruby>というでしょう。`,
        choices: [
          `<ruby>発汗<rt>はっかん</rt></ruby>`,
          `<ruby>高熱<rt>こうねつ</rt></ruby>`,
          `<ruby>冷<rt>ひ</rt></ruby>え`
        ],
        correctIndex: 1
      },
      {
        // ② 都道府県
        text: `<ruby>日本<rt>にほん</rt></ruby>の<ruby>地図<rt>ちず</rt></ruby>を<ruby>見<rt>み</rt></ruby>ると、<ruby>全国<rt>ぜんこく</rt></ruby>がいくつもの<ruby>区切<rt>くぎ</rt></ruby>られた<ruby>場所<rt>ばしょ</rt></ruby>に<ruby>分<rt>わ</rt></ruby>かれています。<ruby>群馬<rt>ぐんま</rt></ruby>や<ruby>奈良<rt>なら</rt></ruby>のように、<ruby>日本<rt>にほん</rt></ruby>の<ruby>中<rt>なか</rt></ruby>の<ruby>大<rt>おお</rt></ruby>きな<ruby>地域<rt>ちいき</rt></ruby>の<ruby>区分<rt>くぶん</rt></ruby>を<ruby>何<rt>なん</rt></ruby>というでしょう。`,
        choices: [
          `<ruby>市町村<rt>しちょうそん</rt></ruby>`,
          `<ruby>地方<rt>ちほう</rt></ruby>`,
          `<ruby>都道府県<rt>とどうふけん</rt></ruby>`
        ],
        correctIndex: 2
      },
      {
        // ③ 児童生徒
        text: `<ruby>小学校<rt>しょうがっこう</rt></ruby>や<ruby>中学校<rt>ちゅうがっこう</rt></ruby>で、<ruby>毎日<rt>まいにち</rt></ruby><ruby>勉強<rt>べんきょう</rt></ruby>や<ruby>生活<rt>せいかつ</rt></ruby>をしている<ruby>子<rt>こ</rt></ruby>どもたちをまとめて<ruby>表<rt>あらわ</rt></ruby>すとき、どの<ruby>言<rt>い</rt></ruby>い<ruby>方<rt>かた</rt></ruby>がいちばん<ruby>合<rt>あ</rt></ruby>っているでしょう。`,
        choices: [
          `<ruby>学年<rt>がくねん</rt></ruby>`,
          `<ruby>児童生徒<rt>じどうせいと</rt></ruby>`,
          `<ruby>先生方<rt>せんせいがた</rt></ruby>`
        ],
        correctIndex: 1
      },
      {
        // ④ 関係
        text: `クラスの<ruby>友<rt>とも</rt></ruby>だちと、けんかをしたり<ruby>仲<rt>なか</rt></ruby>よくしたりしながら、つながりをもって<ruby>生活<rt>せいかつ</rt></ruby>しています。<ruby>人<rt>ひと</rt></ruby>と<ruby>人<rt>ひと</rt></ruby>とのつながりを<ruby>表<rt>あらわ</rt></ruby>す<ruby>言葉<rt>ことば</rt></ruby>はどれでしょう。`,
        choices: [
          `<ruby>友達<rt>ともだち</rt></ruby>`,
          `<ruby>関係<rt>かんけい</rt></ruby>`,
          `<ruby>会話<rt>かいわ</rt></ruby>`
        ],
        correctIndex: 1
      },
      {
        // ⑤ 漢字辞典
        text: `<ruby>知<rt>し</rt></ruby>らない<ruby>漢字<rt>かんじ</rt></ruby>の<ruby>読<rt>よ</rt></ruby>み<ruby>方<rt>かた</rt></ruby>や<ruby>意味<rt>いみ</rt></ruby>、<ruby>画数<rt>かくすう</rt></ruby>などを<ruby>調<rt>しら</rt></ruby>べたいときに<ruby>使<rt>つか</rt></ruby>う<ruby>本<rt>ほん</rt></ruby>はどれでしょう。`,
        choices: [
          `<ruby>図鑑<rt>ずかん</rt></ruby>`,
          `<ruby>漢字辞典<rt>かんじじてん</rt></ruby>`,
          `<ruby>物語集<rt>ものがたりしゅう</rt></ruby>`
        ],
        correctIndex: 1
      },
      {
        // ⑥ 国語辞典
        text: `ある<ruby>言葉<rt>ことば</rt></ruby>の<ruby>意味<rt>いみ</rt></ruby>や<ruby>使<rt>つか</rt></ruby>い<ruby>方<rt>かた</rt></ruby>をくわしく<ruby>調<rt>しら</rt></ruby>べたいときに<ruby>使<rt>つか</rt></ruby>う、<ruby>本<rt>ほん</rt></ruby>の<ruby>種類<rt>しゅるい</rt></ruby>はどれでしょう。`,
        choices: [
          `<ruby>国語辞典<rt>こくごじてん</rt></ruby>`,
          `<ruby>地図帳<rt>ちずちょう</rt></ruby>`,
          `<ruby>問題集<rt>もんだいしゅう</rt></ruby>`
        ],
        correctIndex: 0
      },
      {
        // ⑦ 成人式
        text: `20<ruby>歳<rt>さい</rt></ruby>になる<ruby>人<rt>ひと</rt></ruby>たちが<ruby>集<rt>あつ</rt></ruby>まって、<ruby>大人<rt>おとな</rt></ruby>になったお<ruby>祝<rt>いわ</rt></ruby>いをする<ruby>行事<rt>ぎょうじ</rt></ruby>があります。この<ruby>行事<rt>ぎょうじ</rt></ruby>を<ruby>何<rt>なん</rt></ruby>というでしょう。`,
        choices: [
          `<ruby>文化祭<rt>ぶんかさい</rt></ruby>`,
          `<ruby>卒業式<rt>そつぎょうしき</rt></ruby>`,
          `<ruby>成人式<rt>せいじんしき</rt></ruby>`
        ],
        correctIndex: 2
      },
      {
        // ⑧ 訓練
        text: `<ruby>火事<rt>かじ</rt></ruby>や<ruby>地震<rt>じしん</rt></ruby>にそなえて、<ruby>学校<rt>がっこう</rt></ruby>でにげる<ruby>練習<rt>れんしゅう</rt></ruby>をくり<ruby>返<rt>かえ</rt></ruby>し<ruby>行<rt>おこな</rt></ruby>います。このように、<ruby>本番<rt>ほんばん</rt></ruby>にそなえて<ruby>練習<rt>れんしゅう</rt></ruby>することを<ruby>何<rt>なん</rt></ruby>というでしょう。`,
        choices: [
          `<ruby>訓練<rt>くんれん</rt></ruby>`,
          `<ruby>試合<rt>しあい</rt></ruby>`,
          `<ruby>発表<rt>はっぴょう</rt></ruby>`
        ],
        correctIndex: 0
      },
      {
        // ⑨ 人類
        text: `<ruby>大昔<rt>おおむかし</rt></ruby>から<ruby>現在<rt>げんざい</rt></ruby>まで、<ruby>地球<rt>ちきゅう</rt></ruby>で<ruby>生<rt>い</rt></ruby>きてきたすべての<ruby>人間<rt>にんげん</rt></ruby>の<ruby>仲間<rt>なかま</rt></ruby>をまとめて<ruby>表<rt>あらわ</rt></ruby>す<ruby>言葉<rt>ことば</rt></ruby>はどれでしょう。`,
        choices: [
          `<ruby>生物<rt>せいぶつ</rt></ruby>`,
          `<ruby>人類<rt>じんるい</rt></ruby>`,
          `<ruby>動物<rt>どうぶつ</rt></ruby>`
        ],
        correctIndex: 1
      },
      {
        // ⑩ 順番
        text: `ならんで<ruby>歩<rt>ある</rt></ruby>くときに、<ruby>前<rt>まえ</rt></ruby>の<ruby>人<rt>ひと</rt></ruby>の<ruby>次<rt>つぎ</rt></ruby>に<ruby>自分<rt>じぶん</rt></ruby>が<ruby>入<rt>はい</rt></ruby>るなど、<ruby>決<rt>き</rt></ruby>められたならび<ruby>方<rt>かた</rt></ruby>があります。このならびの<ruby>決<rt>き</rt></ruby>まりを<ruby>何<rt>なん</rt></ruby>というでしょう。`,
        choices: [
          `<ruby>列<rt>れつ</rt></ruby>`,
          `<ruby>順番<rt>じゅんばん</rt></ruby>`,
          `<ruby>方向<rt>ほうこう</rt></ruby>`
        ],
        correctIndex: 1
      },
      {
        // ⑪ 愛情
        text: `<ruby>家族<rt>かぞく</rt></ruby>が<ruby>病気<rt>びょうき</rt></ruby>のときに<ruby>心配<rt>しんぱい</rt></ruby>して<ruby>世話<rt>せわ</rt></ruby>をしたり、<ruby>相手<rt>あいて</rt></ruby>のことを<ruby>思<rt>おも</rt></ruby>って<ruby>行動<rt>こうどう</rt></ruby>したりする<ruby>気持<rt>きも</rt></ruby>ちを<ruby>表<rt>あらわ</rt></ruby>す<ruby>言葉<rt>ことば</rt></ruby>はどれでしょう。`,
        choices: [
          `<ruby>表情<rt>ひょうじょう</rt></ruby>`,
          `<ruby>愛情<rt>あいじょう</rt></ruby>`,
          `<ruby>感心<rt>かんしん</rt></ruby>`
        ],
        correctIndex: 1
      },
      {
        // ⑫ 昨年
        text: `<ruby>今年<rt>ことし</rt></ruby>の<ruby>前<rt>まえ</rt></ruby>の<ruby>年<rt>とし</rt></ruby>のことを<ruby>話<rt>はな</rt></ruby>すときに<ruby>使<rt>つか</rt></ruby>う<ruby>言葉<rt>ことば</rt></ruby>はどれでしょう。`,
        choices: [
          `<ruby>先月<rt>せんげつ</rt></ruby>`,
          `<ruby>昨年<rt>さくねん</rt></ruby>`,
          `<ruby>明日<rt>あした</rt></ruby>`
        ],
        correctIndex: 1
      },
      {
        // ⑬ 城下町
        text: `<ruby>昔<rt>むかし</rt></ruby>、お<ruby>城<rt>しろ</rt></ruby>のまわりには、<ruby>家<rt>いえ</rt></ruby>や<ruby>店<rt>みせ</rt></ruby>が<ruby>集<rt>あつ</rt></ruby>まってつくられた<ruby>町<rt>まち</rt></ruby>がありました。こうした<ruby>町<rt>まち</rt></ruby>の<ruby>呼<rt>よ</rt></ruby>び<ruby>方<rt>かた</rt></ruby>としていちばん<ruby>合<rt>あ</rt></ruby>っているものはどれでしょう。`,
        choices: [
          `<ruby>農村<rt>のうそん</rt></ruby>`,
          `<ruby>城下町<rt>じょうかまち</rt></ruby>`,
          `<ruby>港町<rt>みなとまち</rt></ruby>`
        ],
        correctIndex: 1
      },
      {
        // ⑭ 伝説
        text: `<ruby>昔<rt>むかし</rt></ruby>から<ruby>語<rt>かた</rt></ruby>りつがれてきたふしぎな<ruby>話<rt>はなし</rt></ruby>で、<ruby>本当<rt>ほんとう</rt></ruby>かどうか<ruby>分<rt>わ</rt></ruby>からない<ruby>物語<rt>ものがたり</rt></ruby>のような<ruby>話<rt>はなし</rt></ruby>を<ruby>何<rt>なん</rt></ruby>というでしょう。`,
        choices: [
          `<ruby>記録<rt>きろく</rt></ruby>`,
          `<ruby>伝説<rt>でんせつ</rt></ruby>`,
          `<ruby>事実<rt>じじつ</rt></ruby>`
        ],
        correctIndex: 1
      },
      {
        // ⑮ 説明
        text: `<ruby>分<rt>わ</rt></ruby>からないことを、<ruby>相手<rt>あいて</rt></ruby>に<ruby>分<rt>わ</rt></ruby>かるように<ruby>言葉<rt>ことば</rt></ruby>で<ruby>伝<rt>つた</rt></ruby>えることを<ruby>何<rt>なん</rt></ruby>というでしょう。`,
        choices: [
          `<ruby>説明<rt>せつめい</rt></ruby>`,
          `<ruby>相談<rt>そうだん</rt></ruby>`,
          `<ruby>指示<rt>しじ</rt></ruby>`
        ],
        correctIndex: 0
      },
      {
        // ⑯ 好物
        text: `その<ruby>人<rt>ひと</rt></ruby>がとくに<ruby>好<rt>す</rt></ruby>きで、<ruby>進<rt>すす</rt></ruby>んで<ruby>食<rt>た</rt></ruby>べたがる<ruby>食<rt>た</rt></ruby>べ<ruby>物<rt>もの</rt></ruby>のことを<ruby>何<rt>なん</rt></ruby>というでしょう。`,
        choices: [
          `<ruby>名物<rt>めいぶつ</rt></ruby>`,
          `<ruby>好物<rt>こうぶつ</rt></ruby>`,
          `<ruby>食品<rt>しょくひん</rt></ruby>`
        ],
        correctIndex: 1
      },
      {
        // ⑰ 印刷
        text: `<ruby>紙<rt>かみ</rt></ruby>に<ruby>文字<rt>もじ</rt></ruby>や<ruby>絵<rt>え</rt></ruby>を、<ruby>機械<rt>きかい</rt></ruby>を<ruby>使<rt>つか</rt></ruby>ってたくさんおなじようにうつし<ruby>取<rt>と</rt></ruby>る<ruby>作業<rt>さぎょう</rt></ruby>を<ruby>何<rt>なん</rt></ruby>というでしょう。`,
        choices: [
          `<ruby>文書<rt>ぶんしょ</rt></ruby>`,
          `<ruby>印刷<rt>いんさつ</rt></ruby>`,
          `<ruby>作成<rt>さくせい</rt></ruby>`
        ],
        correctIndex: 1
      },
      {
        // ⑱ 要求
        text: `してほしいことや、のぞんでいることを<ruby>相手<rt>あいて</rt></ruby>に<ruby>強<rt>つよ</rt></ruby>く<ruby>伝<rt>つた</rt></ruby>えるときの<ruby>言<rt>い</rt></ruby>い<ruby>方<rt>かた</rt></ruby>として<ruby>合<rt>あ</rt></ruby>っているものはどれでしょう。`,
        choices: [
          `<ruby>感想<rt>かんそう</rt></ruby>`,
          `<ruby>要求<rt>ようきゅう</rt></ruby>`,
          `<ruby>反省<rt>はんせい</rt></ruby>`
        ],
        correctIndex: 1
      },
      {
        // ⑲ 目的
        text: `<ruby>遠足<rt>えんそく</rt></ruby>に<ruby>行<rt>い</rt></ruby>く<ruby>理由<rt>りゆう</rt></ruby>が「みんなで<ruby>自然<rt>しぜん</rt></ruby>を<ruby>学<rt>まな</rt></ruby>ぶため」のように、<ruby>行動<rt>こうどう</rt></ruby>をするもとになるねらいのことを<ruby>何<rt>なん</rt></ruby>というでしょう。`,
        choices: [
          `<ruby>予定<rt>よてい</rt></ruby>`,
          `<ruby>理由<rt>りゆう</rt></ruby>`,
          `<ruby>目的<rt>もくてき</rt></ruby>`
        ],
        correctIndex: 2
      },
      {
        // ⑳ 必要
        text: `なくてはならないものや、どうしてもいるものを<ruby>表<rt>あらわ</rt></ruby>す<ruby>言葉<rt>ことば</rt></ruby>はどれでしょう。`,
        choices: [
          `<ruby>便利<rt>べんり</rt></ruby>`,
          `<ruby>大切<rt>たいせつ</rt></ruby>`,
          `<ruby>必要<rt>ひつよう</rt></ruby>`
        ],
        correctIndex: 2
      },
      {
        // ㉑ 最初
        text: `かけっこでスタートの<ruby>合図<rt>あいず</rt></ruby>が<ruby>鳴<rt>な</rt></ruby>ったとき、いちばん<ruby>先<rt>さき</rt></ruby>に<ruby>走<rt>はし</rt></ruby>り<ruby>出<rt>だ</rt></ruby>す<ruby>位置<rt>いち</rt></ruby>や、いちばんはじめのことを<ruby>表<rt>あらわ</rt></ruby>す<ruby>言葉<rt>ことば</rt></ruby>はどれでしょう。`,
        choices: [
          `<ruby>途中<rt>とちゅう</rt></ruby>`,
          `<ruby>最初<rt>さいしょ</rt></ruby>`,
          `<ruby>最後<rt>さいご</rt></ruby>`
        ],
        correctIndex: 1
      },
      {
        // ㉒ 案内
        text: `<ruby>駅<rt>えき</rt></ruby>で<ruby>道<rt>みち</rt></ruby>が<ruby>分<rt>わ</rt></ruby>からない<ruby>人<rt>ひと</rt></ruby>に、<ruby>行<rt>い</rt></ruby>き<ruby>先<rt>さき</rt></ruby>までの<ruby>道<rt>みち</rt></ruby>をおしえてあげるような<ruby>行動<rt>こうどう</rt></ruby>を<ruby>何<rt>なん</rt></ruby>というでしょう。`,
        choices: [
          `<ruby>案内<rt>あんない</rt></ruby>`,
          `<ruby>提出<rt>ていしゅつ</rt></ruby>`,
          `<ruby>指導<rt>しどう</rt></ruby>`
        ],
        correctIndex: 0
      },
      {
        // ㉓ 商店街
        text: `<ruby>野菜屋<rt>やさいや</rt></ruby>さんやおかし<ruby>屋<rt>や</rt></ruby>さん、<ruby>文房具店<rt>ぶんぼうぐてん</rt></ruby>など、たくさんの<ruby>店<rt>みせ</rt></ruby>が<ruby>道<rt>みち</rt></ruby>の<ruby>両側<rt>りょうがわ</rt></ruby>にならんでいる<ruby>場所<rt>ばしょ</rt></ruby>があります。このような<ruby>場所<rt>ばしょ</rt></ruby>を<ruby>何<rt>なん</rt></ruby>というでしょう。`,
        choices: [
          `<ruby>住宅地<rt>じゅうたくち</rt></ruby>`,
          `<ruby>商店街<rt>しょうてんがい</rt></ruby>`,
          `<ruby>工業地<rt>こうぎょうち</rt></ruby>`
        ],
        correctIndex: 1
      },
      {
        // ㉔ 試験
        text: `<ruby>学<rt>まな</rt></ruby>んだことがどれくらい<ruby>身<rt>み</rt></ruby>についているかをたしかめるために、<ruby>学校<rt>がっこう</rt></ruby>で<ruby>問題<rt>もんだい</rt></ruby>を<ruby>解<rt>と</rt></ruby>く<ruby>時間<rt>じかん</rt></ruby>があります。このようなとりくみを<ruby>何<rt>なん</rt></ruby>というでしょう。`,
        choices: [
          `<ruby>練習<rt>れんしゅう</rt></ruby>`,
          `<ruby>発表<rt>はっぴょう</rt></ruby>`,
          `<ruby>試験<rt>しけん</rt></ruby>`
        ],
        correctIndex: 2
      },
      {
        // ㉕ 選挙
        text: `クラスの<ruby>代表<rt>だいひょう</rt></ruby>や<ruby>市<rt>し</rt></ruby>のリーダーなどを<ruby>決<rt>き</rt></ruby>めるとき、みんなが<ruby>投票<rt>とうひょう</rt></ruby>して<ruby>選<rt>えら</rt></ruby>ぶ<ruby>方法<rt>ほうほう</rt></ruby>があります。この<ruby>決<rt>き</rt></ruby>め<ruby>方<rt>かた</rt></ruby>を<ruby>何<rt>なん</rt></ruby>というでしょう。`,
        choices: [
          `<ruby>相談<rt>そうだん</rt></ruby>`,
          `<ruby>選挙<rt>せんきょ</rt></ruby>`,
          `<ruby>指名<rt>しめい</rt></ruby>`
        ],
        correctIndex: 1
      },
      {
        // ㉖ 観客
        text: `サッカーやコンサートで、プレーや<ruby>演奏<rt>えんそう</rt></ruby>を<ruby>見<rt>み</rt></ruby>ておうえんしている<ruby>人<rt>ひと</rt></ruby>たちをまとめて<ruby>何<rt>なん</rt></ruby>というでしょう。`,
        choices: [
          `<ruby>出場者<rt>しゅつじょうしゃ</rt></ruby>`,
          `<ruby>係員<rt>かかりいん</rt></ruby>`,
          `<ruby>観客<rt>かんきゃく</rt></ruby>`
        ],
        correctIndex: 2
      },
      {
        // ㉗ 静電気
        text: `ドアノブにさわったときに「パチッ」として、<ruby>指<rt>ゆび</rt></ruby>がしびれることがあります。このときに<ruby>起<rt>お</rt></ruby>きている<ruby>現象<rt>げんしょう</rt></ruby>を<ruby>何<rt>なん</rt></ruby>というでしょう。`,
        choices: [
          `<ruby>電流<rt>でんりゅう</rt></ruby>`,
          `<ruby>静電気<rt>せいでんき</rt></ruby>`,
          `<ruby>磁力<rt>じりょく</rt></ruby>`
        ],
        correctIndex: 1
      },
      {
        // ㉘ 国旗
        text: `オリンピックなどで、その<ruby>国<rt>くに</rt></ruby>を<ruby>表<rt>あらわ</rt></ruby>すためにかかげられている<ruby>旗<rt>はた</rt></ruby>があります。この<ruby>旗<rt>はた</rt></ruby>を<ruby>何<rt>なん</rt></ruby>というでしょう。`,
        choices: [
          `<ruby>名札<rt>なふだ</rt></ruby>`,
          `<ruby>政治<rt>せいじ</rt></ruby>`,
          `<ruby>国旗<rt>こっき</rt></ruby>`
        ],
        correctIndex: 2
      },
      {
        // ㉙ 材料
        text: `カレーをつくるときの<ruby>肉<rt>にく</rt></ruby>や<ruby>野菜<rt>やさい</rt></ruby>のように、<ruby>料理<rt>りょうり</rt></ruby>や<ruby>工作<rt>こうさく</rt></ruby>のもとになるものを<ruby>何<rt>なん</rt></ruby>というでしょう。`,
        choices: [
          `<ruby>道具<rt>どうぐ</rt></ruby>`,
          `<ruby>材料<rt>ざいりょう</rt></ruby>`,
          `<ruby>作品<rt>さくひん</rt></ruby>`
        ],
        correctIndex: 1
      },
      {
        // ㉚ 群馬県
        text: `<ruby>草津温泉<rt>くさつおんせん</rt></ruby>があり、<ruby>関東地方<rt>かんとうちほう</rt></ruby>の<ruby>内陸<rt>ないりく</rt></ruby>に<ruby>位置<rt>いち</rt></ruby>する<ruby>県<rt>けん</rt></ruby>の<ruby>名前<rt>なまえ</rt></ruby>はどれでしょう。`,
        choices: [
          `<ruby>栃木県<rt>とちぎけん</rt></ruby>`,
          `<ruby>群馬県<rt>ぐんまけん</rt></ruby>`,
          `<ruby>長野県<rt>ながのけん</rt></ruby>`
        ],
        correctIndex: 1
      },
      {
        // ㉛ 奈良県
        text: `<ruby>大仏<rt>だいぶつ</rt></ruby>があり、しかが<ruby>公園<rt>こうえん</rt></ruby>を<ruby>歩<rt>ある</rt></ruby>いていることで<ruby>知<rt>し</rt></ruby>られている<ruby>県<rt>けん</rt></ruby>はどれでしょう。`,
        choices: [
          `<ruby>京都府<rt>きょうとふ</rt></ruby>`,
          `<ruby>奈良県<rt>ならけん</rt></ruby>`,
          `<ruby>三重県<rt>みえけん</rt></ruby>`
        ],
        correctIndex: 1
      },
      {
        // ㉜ 豊富
        text: `<ruby>食<rt>た</rt></ruby>べ<ruby>物<rt>もの</rt></ruby>の<ruby>種類<rt>しゅるい</rt></ruby>が<ruby>多<rt>おお</rt></ruby>く、<ruby>選<rt>えら</rt></ruby>べるものがたくさんあるとき、そのようすを<ruby>表<rt>あらわ</rt></ruby>す<ruby>言葉<rt>ことば</rt></ruby>はどれでしょう。`,
        choices: [
          `<ruby>不足<rt>ふそく</rt></ruby>`,
          `<ruby>豊富<rt>ほうふ</rt></ruby>`,
          `<ruby>単調<rt>たんちょう</rt></ruby>`
        ],
        correctIndex: 1
      },
      {
        // ㉞ 岐阜県
        text: `<ruby>木曽川<rt>きそがわ</rt></ruby>や<ruby>長良川<rt>ながらがわ</rt></ruby>がながれ、<ruby>内陸<rt>ないりく</rt></ruby>に<ruby>位置<rt>いち</rt></ruby>する<ruby>中部地方<rt>ちゅうぶちほう</rt></ruby>の<ruby>県<rt>けん</rt></ruby>はどれでしょう。`,
        choices: [
          `<ruby>岐阜県<rt>ぎふけん</rt></ruby>`,
          `<ruby>愛知県<rt>あいちけん</rt></ruby>`,
          `<ruby>三重県<rt>みえけん</rt></ruby>`
        ],
        correctIndex: 0
      },
      {
        // ㉟ 季節風
        text: `<ruby>冬<rt>ふゆ</rt></ruby>になると<ruby>日本海側<rt>にほんかいがわ</rt></ruby>に<ruby>冷<rt>つめ</rt></ruby>たいかぜがふき、<ruby>雪<rt>ゆき</rt></ruby>が<ruby>多<rt>おお</rt></ruby>くふります。このように、<ruby>季節<rt>きせつ</rt></ruby>ごとにふく<ruby>向<rt>む</rt></ruby>きが<ruby>変<rt>か</rt></ruby>わるかぜを<ruby>何<rt>なん</rt></ruby>というでしょう。`,
        choices: [
          `<ruby>台風<rt>たいふう</rt></ruby>`,
          `<ruby>季節風<rt>きせつふう</rt></ruby>`,
          `<ruby>つむじ風<rt>つむじかぜ</rt></ruby>`
        ],
        correctIndex: 1
      },
      {
        // ㊱ 季節
        text: `<ruby>一年<rt>いちねん</rt></ruby>の<ruby>中<rt>なか</rt></ruby>で、<ruby>春<rt>はる</rt></ruby>・<ruby>夏<rt>なつ</rt></ruby>・<ruby>秋<rt>あき</rt></ruby>・<ruby>冬<rt>ふゆ</rt></ruby>のように、<ruby>気温<rt>きおん</rt></ruby>や<ruby>自然<rt>しぜん</rt></ruby>のようすが<ruby>変<rt>か</rt></ruby>わっていくまとまりを<ruby>何<rt>なん</rt></ruby>というでしょう。`,
        choices: [
          `<ruby>天候<rt>てんこう</rt></ruby>`,
          `<ruby>月日<rt>つきひ</rt></ruby>`,
          `<ruby>季節<rt>きせつ</rt></ruby>`
        ],
        correctIndex: 2
      },
      {
        // ㊲ 特別
        text: `いつもとはちがって、とくに<ruby>大切<rt>たいせつ</rt></ruby>にされたり、めずらしかったりするようすを<ruby>表<rt>あらわ</rt></ruby>す<ruby>言葉<rt>ことば</rt></ruby>はどれでしょう。`,
        choices: [
          `<ruby>普通<rt>ふつう</rt></ruby>`,
          `<ruby>特別<rt>とくべつ</rt></ruby>`,
          `<ruby>同様<rt>どうよう</rt></ruby>`
        ],
        correctIndex: 1
      },
      {
        // ㊳ 郡部
        text: `<ruby>市<rt>し</rt></ruby>のように<ruby>人<rt>ひと</rt></ruby>が<ruby>多<rt>おお</rt></ruby>く<ruby>集<rt>あつ</rt></ruby>まっている<ruby>地域<rt>ちいき</rt></ruby>ではなく、<ruby>町<rt>まち</rt></ruby>や<ruby>村<rt>むら</rt></ruby>が<ruby>集<rt>あつ</rt></ruby>まっている<ruby>地域<rt>ちいき</rt></ruby>をまとめて<ruby>何<rt>なん</rt></ruby>というでしょう。`,
        choices: [
          `<ruby>市街地<rt>しがいち</rt></ruby>`,
          `<ruby>郡部<rt>ぐんぶ</rt></ruby>`,
          `<ruby>工業地<rt>こうぎょうち</rt></ruby>`
        ],
        correctIndex: 1
      },
      {
        // ㊴ 戦争
        text: `<ruby>国<rt>くに</rt></ruby>どうしや<ruby>大<rt>おお</rt></ruby>きな<ruby>集団<rt>しゅうだん</rt></ruby>どうしが、<ruby>武器<rt>ぶき</rt></ruby>を<ruby>使<rt>つか</rt></ruby>ってあらそうとても<ruby>大<rt>おお</rt></ruby>きなあらそいを<ruby>何<rt>なん</rt></ruby>というでしょう。`,
        choices: [
          `<ruby>競争<rt>きょうそう</rt></ruby>`,
          `<ruby>試合<rt>しあい</rt></ruby>`,
          `<ruby>戦争<rt>せんそう</rt></ruby>`
        ],
        correctIndex: 2
      },
      {
        // ㊵ 戦争（重複）
        text: `<ruby>昔<rt>むかし</rt></ruby>の<ruby>日本<rt>にほん</rt></ruby>や<ruby>世界<rt>せかい</rt></ruby>の<ruby>歴史<rt>れきし</rt></ruby>で、たくさんの<ruby>人<rt>ひと</rt></ruby>がたたかいにまきこまれ、<ruby>町<rt>まち</rt></ruby>やくらしが<ruby>大<rt>おお</rt></ruby>きく<ruby>変<rt>か</rt></ruby>わった<ruby>出来事<rt>できごと</rt></ruby>を<ruby>何<rt>なん</rt></ruby>というでしょう。`,
        choices: [
          `<ruby>革命<rt>かくめい</rt></ruby>`,
          `<ruby>災害<rt>さいがい</rt></ruby>`,
          `<ruby>戦争<rt>せんそう</rt></ruby>`
        ],
        correctIndex: 2
      },
      {
        // ㊶ 最初（重複）
        text: `ながい<ruby>行列<rt>ぎょうれつ</rt></ruby>の<ruby>中<rt>なか</rt></ruby>で、いちばん<ruby>前<rt>まえ</rt></ruby>に<ruby>立<rt>た</rt></ruby>つ<ruby>位置<rt>いち</rt></ruby>や、ものごとがはじまるいちばんはじめの<ruby>部分<rt>ぶぶん</rt></ruby>を<ruby>何<rt>なん</rt></ruby>というでしょう。`,
        choices: [
          `<ruby>最後<rt>さいご</rt></ruby>`,
          `<ruby>中央<rt>ちゅうおう</rt></ruby>`,
          `<ruby>最初<rt>さいしょ</rt></ruby>`
        ],
        correctIndex: 2
      },
      {
        // ㊷ 学校給食
        text: `<ruby>学校<rt>がっこう</rt></ruby>で、ひるにみんなでおなじ<ruby>献立<rt>こんだて</rt></ruby>を<ruby>食<rt>た</rt></ruby>べる<ruby>食事<rt>しょくじ</rt></ruby>のことを<ruby>何<rt>なん</rt></ruby>というでしょう。`,
        choices: [
          `お<ruby>弁当<rt>べんとう</rt></ruby>`,
          `<ruby>学校給食<rt>がっこうきゅうしょく</rt></ruby>`,
          `<ruby>外食<rt>がいしょく</rt></ruby>`
        ],
        correctIndex: 1
      },
      {
        // ㊸ 飛行機
        text: `<ruby>空港<rt>くうこう</rt></ruby>を<ruby>出発<rt>しゅっぱつ</rt></ruby>して、<ruby>空<rt>そら</rt></ruby>の<ruby>上<rt>うえ</rt></ruby>をながいきょり<ruby>移動<rt>いどう</rt></ruby>し、<ruby>人<rt>ひと</rt></ruby>や<ruby>荷物<rt>にもつ</rt></ruby>をはこぶ<ruby>大<rt>おお</rt></ruby>きなのりものはどれでしょう。`,
        choices: [
          `<ruby>新幹線<rt>しんかんせん</rt></ruby>`,
          `<ruby>飛行機<rt>ひこうき</rt></ruby>`,
          `フェリー`
        ],
        correctIndex: 1
      },
      {
        // ㊹ 包帯
        text: `けがをしたときに、<ruby>血<rt>ち</rt></ruby>をとめたり、<ruby>傷口<rt>きずぐち</rt></ruby>をまもったりするために<ruby>体<rt>からだ</rt></ruby>にまく<ruby>白<rt>しろ</rt></ruby>い<ruby>布<rt>ぬの</rt></ruby>を<ruby>何<rt>なん</rt></ruby>というでしょう。`,
        choices: [
          `<ruby>絆創膏<rt>ばんそうこう</rt></ruby>`,
          `<ruby>包帯<rt>ほうたい</rt></ruby>`,
          `テープ`
        ],
        correctIndex: 1
      },
      {
        // ㊺ 熱帯
        text: `<ruby>一年中<rt>いちねんじゅう</rt></ruby>あたたかく、<ruby>雨<rt>あめ</rt></ruby>が<ruby>多<rt>おお</rt></ruby>く、ジャングルが<ruby>広<rt>ひろ</rt></ruby>がるような<ruby>地域<rt>ちいき</rt></ruby>の<ruby>気候帯<rt>きこうたい</rt></ruby>を<ruby>何<rt>なん</rt></ruby>というでしょう。`,
        choices: [
          `<ruby>砂漠<rt>さばく</rt></ruby>`,
          `<ruby>森林<rt>しんりん</rt></ruby>`,
          `<ruby>熱帯<rt>ねったい</rt></ruby>`
        ],
        correctIndex: 2
      }
    ];

// ============================
// Online Sync (Firebase RTDB)
// - URL params: ?room=ROOM&me=1|2
// - Fallback to offline on any init failure
// ============================

const firebaseConfig = {
  apiKey: "AIzaSyBtKWi2tXanWuDf_Du5C9tr5ZwOAfNBRIs",
  authDomain: "goi-battle-g3.firebaseapp.com",
  projectId: "goi-battle-g3",
  storageBucket: "goi-battle-g3.firebasestorage.app",
  messagingSenderId: "1052102588017",
  appId: "1:1052102588017:web:e8a09649466f4504f08dd0",
  measurementId: "G-Y7TQVZ2R2V"
};

const ONLINE = {
  enabled: false,
  room: "",
  me: 0,
  db: null,
  refs: { room: null, state: null, meta: null },
  lastRev: 0,
  suppress: false,
  // Firebase funcs (filled after init)
  ref: null, onValue: null, get: null, set: null, update: null, serverTimestamp: null
};

// --- DOM ---
const qTextEl = document.getElementById("questionText");
const qHintEl = document.getElementById("questionHint");
const choicesEl = document.getElementById("choicesContainer");
const feedbackEl = document.getElementById("feedback");
const qNumberEl = document.getElementById("qNumber");
const qTotalEl = document.getElementById("qTotal");
const progressFillEl = document.getElementById("progressFill");
const scoreTextEl = document.getElementById("scoreText");
const nextBtn = document.getElementById("nextBtn");
const resultArea = document.getElementById("resultArea");
const rouletteWheelEl = document.getElementById("rouletteWheel");
const gimmickLabelEl = document.querySelector(".roulette-label");
const cardContainerEl = document.getElementById("cardContainer");

const roomInput = document.getElementById("roomInput");
const makeRoomUrlBtn = document.getElementById("makeRoomUrlBtn");
const urlP1 = document.getElementById("urlP1");
const urlP2 = document.getElementById("urlP2");
const onlineStatus = document.getElementById("onlineStatus");

const mePlayerEl = document.getElementById("mePlayer");
const turnPlayerEl = document.getElementById("turnPlayer");
const startBtn = document.getElementById("startBtn");
const resetBtn = document.getElementById("resetBtn");


// --- helpers ---

// --- turn beep ---
let prevTurnPlayer = null;
let audioCtx = null;
function playTurnBeep(){
  try{
    audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
    const t0 = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "sine";
    o.frequency.value = 880;
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(0.12, t0 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.18);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(t0);
    o.stop(t0 + 0.2);
  }catch(e){}
}

function clampInt(n, min, max){
  const x = Number(n);
  if(!Number.isFinite(x)) return min;
  return Math.max(min, Math.min(max, Math.trunc(x)));
}
function shuffle(array){
  const arr = array.slice();
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}
function nowRev(){ return Date.now(); }

function parseParams(){
  const sp = new URLSearchParams(location.search);
  const room = (sp.get("room") || "").trim();
  const me = clampInt(sp.get("me"), 0, 2);
  return { room, me };
}
function setOnlineStatusText(text){ if(onlineStatus) onlineStatus.textContent = text; }
function buildUrls(room){
  const base = location.origin + location.pathname;
  const r = encodeURIComponent(room);
  return {
    p1: `${base}?room=${r}&me=1`,
    p2: `${base}?room=${r}&me=2`
  };
}

if(makeRoomUrlBtn){
  makeRoomUrlBtn.addEventListener("click", ()=>{
    const room = (roomInput?.value || "").trim();
    if(!room) return;
    const u = buildUrls(room);
    if(urlP1) urlP1.value = u.p1;
    if(urlP2) urlP2.value = u.p2;
  });
}


// --- start / reset (P1 only in online) ---
if(startBtn){
  startBtn.addEventListener("click", ()=>{
    if(!canOperate("start")) return;
    applyAndSync((s)=>{
      if(s.started) return s;
      const ns = defaultState();
      ns.started = true;
      ns.turnPlayer = 1;
      return ns;
    }, "start");
  });
}
if(resetBtn){
  resetBtn.addEventListener("click", ()=>{
    if(!canOperate("reset")) return;
    applyAndSync(()=> {
      const ns = defaultState();
      ns.started = true;
      ns.turnPlayer = 1;
      return ns;
    }, "reset");
  });
}

// --- Game State ---
const GIMMICK_TYPES = ["roulette","dice","treasure","card"];

function defaultGimmick(){
  return {
    type: null, enabled: false, spinning: false,
    rouletteValue: 1, diceValue: 1, treasureValue: null,
    cardNums: [], cardSelected: null, cardSelectedValue: null, cardRevealed: false
  };
}

function defaultState(){
  const order = shuffle([...Array(questions.length)].map((_,i)=>i));
  const choiceOrder = shuffle([0,1,2]);
  const firstQ = questions[order[0]];
  const correctBtn = choiceOrder.indexOf(firstQ.correctIndex);
  return {
    ver: 1, started: true,
    quizOrder: order, currentIndex: 0, score: 0,
    answeredCurrent: false,
    choiceOrder, currentCorrectButton: correctBtn,
    selectedButton: null, lastWasCorrect: null, feedbackText: "",
    turnPlayer: 1,
    gimmick: defaultGimmick(),
    meta: { rev: nowRev(), by: 1 }
  };
}

let STATE = defaultState();

function canOperate(actionKind){
  if(!ONLINE.enabled) return true;
  if(actionKind === "reset" || actionKind === "start") return ONLINE.me === 1;
  return ONLINE.me === STATE.turnPlayer;
}

// --- local spin animation (no network spam) ---
let localSpinTimer = null;
function stopLocalSpinTimer(){ if(localSpinTimer){ clearInterval(localSpinTimer); localSpinTimer=null; } }

function resetGimmickUI(){
  stopLocalSpinTimer();
  if(rouletteWheelEl){
    rouletteWheelEl.textContent = "？";
    rouletteWheelEl.classList.add("disabled");
    rouletteWheelEl.style.display = "inline-flex";
  }
  if(cardContainerEl){ cardContainerEl.innerHTML = ""; cardContainerEl.style.display = "none"; }
  if(gimmickLabelEl){ gimmickLabelEl.textContent = "せいかいしたら しかけが でるよ"; }
}

function renderGimmickFromState(){
  stopLocalSpinTimer();
  const g = STATE.gimmick || {};
  if(!g.type){ resetGimmickUI(); return; }

  if(g.type === "card"){
    if(rouletteWheelEl){ rouletteWheelEl.classList.add("disabled"); rouletteWheelEl.style.display = "none"; }
    if(gimmickLabelEl){
      gimmickLabelEl.textContent = g.cardRevealed ? `えらんだ すうじ：${g.cardSelectedValue}` : "カードを 1まい えらぼう！ 🎴";
    }
    if(cardContainerEl){
      cardContainerEl.style.display = "flex";
      cardContainerEl.innerHTML = "";
      (g.cardNums || []).forEach((num, idx)=>{
        const card = document.createElement("div");
        card.className = "card-option";
        card.textContent = (g.cardRevealed && g.cardSelected === idx) ? String(num) : "？";
        if(!g.enabled || g.cardRevealed) card.classList.add("disabled");
        if(g.cardRevealed && g.cardSelected === idx) card.classList.add("selected");
        card.addEventListener("click", ()=> onPickCard(idx));
        cardContainerEl.appendChild(card);
      });
    }
    return;
  }

  if(cardContainerEl){ cardContainerEl.innerHTML = ""; cardContainerEl.style.display = "none"; }
  if(rouletteWheelEl){ rouletteWheelEl.style.display = "inline-flex"; }

  if(g.type === "roulette"){
    if(gimmickLabelEl) gimmickLabelEl.textContent = "ルーレットを まわそう！ 🎯";
    if(rouletteWheelEl){
      rouletteWheelEl.classList.toggle("disabled", !g.enabled);
      rouletteWheelEl.textContent = g.spinning ? String(g.rouletteValue || 1) : (g.enabled ? "▶" : String(g.rouletteValue || 1));
    }
    if(g.spinning && rouletteWheelEl){
      let v = g.rouletteValue || 1;
      localSpinTimer = setInterval(()=>{ v++; if(v>10) v=1; rouletteWheelEl.textContent = String(v); }, 80);
    }
    return;
  }
  if(g.type === "dice"){
    if(gimmickLabelEl) gimmickLabelEl.textContent = "サイコロを ふろう！ 🎲";
    if(rouletteWheelEl){
      rouletteWheelEl.classList.toggle("disabled", !g.enabled);
      rouletteWheelEl.textContent = g.spinning ? ("🎲 " + (g.diceValue || 1)) : (g.enabled ? "🎲" : ("🎲 " + (g.diceValue || 1)));
    }
    if(g.spinning && rouletteWheelEl){
      localSpinTimer = setInterval(()=>{ const v = Math.floor(Math.random()*6)+1; rouletteWheelEl.textContent = "🎲 " + v; }, 80);
    }
    return;
  }
  if(g.type === "treasure"){
    if(gimmickLabelEl) gimmickLabelEl.textContent = "たからばこを あけてみよう！ 📦";
    if(rouletteWheelEl){
      rouletteWheelEl.classList.toggle("disabled", !g.enabled);
      rouletteWheelEl.textContent = g.treasureValue ? ("📦 → " + g.treasureValue) : "📦";
    }
    return;
  }
}

function updateProgress(){
  const total = STATE.quizOrder?.length || questions.length;
  const percent = (STATE.currentIndex / total) * 100;
  if(progressFillEl) progressFillEl.style.width = percent + "%";
}

function renderFromState(){
  // player labels & button availability
  if(mePlayerEl){
    mePlayerEl.textContent = ONLINE.enabled ? `プレイヤー${ONLINE.me}` : "オフライン";
  }
  if(turnPlayerEl){
    turnPlayerEl.textContent = `プレイヤー${STATE.turnPlayer || 1}`;
  }
  if(startBtn){
    if(canOperate("start")) startBtn.classList.remove("disabled");
    else startBtn.classList.add("disabled");
  }
  if(resetBtn){
    if(canOperate("reset")) resetBtn.classList.remove("disabled");
    else resetBtn.classList.add("disabled");
  }

  // turn change beep
  if(prevTurnPlayer !== null && (STATE.turnPlayer || 1) !== prevTurnPlayer){
    playTurnBeep();
  }
  prevTurnPlayer = (STATE.turnPlayer || 1);

  // waiting (before start)
  if(ONLINE.enabled && STATE.started === false){
    const total = STATE.quizOrder?.length || questions.length;
    if(qTotalEl) qTotalEl.textContent = String(total);
    if(qNumberEl) qNumberEl.textContent = "1";
    if(progressFillEl) progressFillEl.style.width = "0%";
    if(qTextEl) qTextEl.textContent = "スタートを押してください。";
    if(qHintEl) qHintEl.textContent = "";
    if(scoreTextEl) scoreTextEl.textContent = "せいかい：0 もん";
    if(feedbackEl){ feedbackEl.textContent = ""; feedbackEl.className = "feedback"; }
    if(choicesEl) choicesEl.innerHTML = "";
    if(nextBtn){ nextBtn.textContent = "こたえを えらんでね"; nextBtn.classList.add("disabled"); }
    resetGimmickUI();
    if(resultArea) resultArea.innerHTML = "";
    return;
  }
  const total = STATE.quizOrder?.length || questions.length;
  if(qTotalEl) qTotalEl.textContent = String(total);
  const qIdx = STATE.quizOrder[STATE.currentIndex];
  const q = questions[qIdx];

  if(qNumberEl) qNumberEl.textContent = String(STATE.currentIndex + 1);
  updateProgress();
  if(qTextEl) qTextEl.innerHTML = q.text;
  if(qHintEl) qHintEl.textContent = q.hint || "";
  if(scoreTextEl) scoreTextEl.textContent = `せいかい：${STATE.score} もん`;

  if(feedbackEl){
    feedbackEl.textContent = STATE.feedbackText || "";
    feedbackEl.className = "feedback" + (STATE.lastWasCorrect === true ? " correct" : (STATE.lastWasCorrect === false ? " wrong" : ""));
  }

  // choices
  if(choicesEl){
    choicesEl.innerHTML = "";
    const order = STATE.choiceOrder || [0,1,2];
    order.forEach((choiceIdx, buttonIdx)=>{
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "choice-btn";

      const labelSpan = document.createElement("span");
      labelSpan.className = "label";
      labelSpan.innerHTML = q.choices[choiceIdx];

      const markSpan = document.createElement("span");
      markSpan.className = "mark";
      markSpan.textContent = String.fromCharCode(65 + buttonIdx);

      btn.appendChild(labelSpan);
      btn.appendChild(markSpan);
      btn.addEventListener("click", ()=> onChoose(buttonIdx));
      choicesEl.appendChild(btn);
    });

    const buttons = Array.from(choicesEl.getElementsByClassName("choice-btn"));
    if(STATE.answeredCurrent){
      buttons.forEach(b=> b.classList.add("disabled"));
      const sel = STATE.selectedButton;
      if(sel !== null && sel !== undefined && buttons[sel]){
        buttons[sel].classList.add(STATE.lastWasCorrect ? "correct" : "wrong");
      }
      if(!STATE.lastWasCorrect){
        const cb = STATE.currentCorrectButton;
        if(cb !== null && cb !== undefined && buttons[cb]) buttons[cb].classList.add("correct");
      }
    }
  }

  // next button
  if(nextBtn){
    const isLast = STATE.currentIndex === total - 1;
    nextBtn.textContent = isLast ? "さいごの けっか を みる" : "えらんだら つぎへ ➜";
    if(!STATE.answeredCurrent) nextBtn.classList.add("disabled");
    else nextBtn.classList.remove("disabled");
  }

  // gimmick
  if(STATE.answeredCurrent && STATE.lastWasCorrect){ renderGimmickFromState(); }
  else resetGimmickUI();

  // result area (kept same UI wording)
  if(resultArea){
    resultArea.innerHTML = "";
    if(STATE.currentIndex === total - 1 && STATE.answeredCurrent){
      const percent = Math.round((STATE.score / total) * 100);
      let message = "";
      if(percent === 100) message = "💮 すばらしい！ ぜんぶ 正解です。ごいりょく ばっちり！";
      else if(percent >= 70) message = "✨ よくできました！ あとすこしで まんてんです。";
      else if(percent >= 50) message = "◯ がんばりました。 もういちど チャレンジしてみよう。";
      else message = "📘 これから どんどん ごいを ふやしていこう。";

      resultArea.innerHTML = `けっか：${STATE.score} / ${total} もん <br>${message}`;
      const restart = document.createElement("button");
      restart.type = "button";
      restart.textContent = "もういちど チャレンジ";
      restart.className = "restart-btn";
      restart.addEventListener("click", ()=> onRestart());
      resultArea.appendChild(restart);
    }
  }

  // turn gating
  if(ONLINE.enabled){
    const myTurn = (ONLINE.me === STATE.turnPlayer);
    const lock = !myTurn;
    const btns = Array.from(choicesEl?.getElementsByClassName("choice-btn") || []);
    btns.forEach(b=>{
      if(lock) b.classList.add("disabled");
      else if(!STATE.answeredCurrent) b.classList.remove("disabled");
    });
    if(nextBtn){
      if(lock) nextBtn.classList.add("disabled");
      else if(STATE.answeredCurrent) nextBtn.classList.remove("disabled");
    }
    if(rouletteWheelEl && lock) rouletteWheelEl.classList.add("disabled");
    // restart button gating is handled in onRestart()
  }
}

function setState(next, by){
  STATE = next;
  STATE.meta = { rev: nowRev(), by: by || (ONLINE.enabled ? ONLINE.me : 1) };
  renderFromState();
}

async function pushState(){
  if(!ONLINE.enabled) return;
  if(ONLINE.suppress) return;
  if(!ONLINE.refs.state || !ONLINE.refs.meta) return;
  const rev = STATE.meta?.rev || nowRev();
  ONLINE.lastRev = Math.max(ONLINE.lastRev, rev);
  try{
    await ONLINE.update(ONLINE.refs.meta, { rev, updatedAt: ONLINE.serverTimestamp() });
    await ONLINE.set(ONLINE.refs.state, STATE);
  }catch(e){
    ONLINE.enabled = false;
    setOnlineStatusText("オフライン");
  }
}

async function applyAndSync(updater, actionKind){
  if(!canOperate(actionKind)) return;
  const by = ONLINE.enabled ? ONLINE.me : 1;
  ONLINE.suppress = true;
  try{
    const next = updater(structuredClone(STATE));
    ONLINE.suppress = false;
    setState(next, by);
    await pushState();
  }catch(e){
    ONLINE.suppress = false;
  }
}

function prepareNextQuestion(s){
  const qIdx = s.quizOrder[s.currentIndex];
  const q = questions[qIdx];
  s.choiceOrder = shuffle([0,1,2]);
  s.currentCorrectButton = s.choiceOrder.indexOf(q.correctIndex);
  s.answeredCurrent = false;
  s.selectedButton = null;
  s.lastWasCorrect = null;
  s.feedbackText = "";
  s.gimmick = defaultGimmick();
  return s;
}

function onChoose(buttonIndex){
  applyAndSync((s)=>{
    if(s.answeredCurrent) return s;
    s.answeredCurrent = true;
    s.selectedButton = buttonIndex;
    const correct = (buttonIndex === s.currentCorrectButton);
    s.lastWasCorrect = correct;
    if(correct){
      s.score += 1;
      s.feedbackText = "⭕ 正解！";
      const t = GIMMICK_TYPES[Math.floor(Math.random()*GIMMICK_TYPES.length)];
      s.gimmick.type = t;
      if(t === "card"){
        const nums = [];
        while(nums.length < 3){
          const n = Math.floor(Math.random()*10)+1;
          if(!nums.includes(n)) nums.push(n);
        }
        s.gimmick.cardNums = nums;
        s.gimmick.enabled = true;
      }else{
        s.gimmick.enabled = true;
        s.gimmick.spinning = false;
      }
    }else{
      s.feedbackText = "❌ ざんねん。";
      s.gimmick = defaultGimmick();
    }
    return s;
  }, "answer");
}

function onNext(){
  applyAndSync((s)=>{
    if(!s.answeredCurrent) return s;
    const total = s.quizOrder.length;
    if(s.currentIndex < total - 1){
      s.currentIndex += 1;
      s.turnPlayer = (s.turnPlayer === 1 ? 2 : 1);
      s = prepareNextQuestion(s);
    }
    return s;
  }, "next");
}

function onRestart(){
  applyAndSync((_s)=>{
    const ns = defaultState();
    ns.turnPlayer = 1;
    return ns;
  }, "reset");
}

function onRouletteClick(){
  applyAndSync((s)=>{
    const g = s.gimmick;
    if(!g || !g.type) return s;
    if(!g.enabled && !g.spinning) return s;
    if(g.type === "treasure"){
      if(!g.treasureValue){
        g.treasureValue = Math.floor(Math.random()*10)+1;
        g.enabled = false;
        g.spinning = false;
      }
      return s;
    }
    if(!g.spinning){
      g.spinning = true;
      g.enabled = true;
      return s;
    }else{
      g.spinning = false;
      g.enabled = false;
      if(g.type === "roulette") g.rouletteValue = Math.floor(Math.random()*10)+1;
      if(g.type === "dice") g.diceValue = Math.floor(Math.random()*6)+1;
      return s;
    }
  }, "gimmick");
}

function onPickCard(idx){
  applyAndSync((s)=>{
    const g = s.gimmick;
    if(!g || g.type !== "card") return s;
    if(!g.enabled || g.cardRevealed) return s;
    g.cardSelected = idx;
    g.cardSelectedValue = (g.cardNums || [])[idx] ?? null;
    g.cardRevealed = true;
    g.enabled = false;
    return s;
  }, "gimmick");
}

if(nextBtn){
  nextBtn.addEventListener("click", ()=>{
    if(nextBtn.classList.contains("disabled")) return;
    if(ONLINE.enabled && !canOperate("next")) return;
    onNext();
  });
}
if(rouletteWheelEl){
  rouletteWheelEl.addEventListener("click", ()=>{
    if(ONLINE.enabled && !canOperate("gimmick")) return;
    onRouletteClick();
  });
}

async function initOnlineIfPossible(){
  const params = parseParams();
  if(roomInput) roomInput.value = params.room || "";
  if(params.room){
    const u = buildUrls(params.room);
    if(urlP1) urlP1.value = u.p1;
    if(urlP2) urlP2.value = u.p2;
  }
  if(!params.room || !(params.me === 1 || params.me === 2)){
    ONLINE.enabled = false;
    setOnlineStatusText("オフライン");
    return;
  }
  try{
    const appMod = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js");
    const dbMod  = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js");
    const app = appMod.initializeApp(firebaseConfig);
    const db = dbMod.getDatabase(app);

    ONLINE.enabled = true;
    ONLINE.room = params.room;
    ONLINE.me = params.me;
    ONLINE.db = db;
    ONLINE.ref = dbMod.ref;
    ONLINE.onValue = dbMod.onValue;
    ONLINE.get = dbMod.get;
    ONLINE.set = dbMod.set;
    ONLINE.update = dbMod.update;
    ONLINE.serverTimestamp = dbMod.serverTimestamp;

    ONLINE.refs.room = ONLINE.ref(db, `rooms/${ONLINE.room}`);
    ONLINE.refs.state = ONLINE.ref(db, `rooms/${ONLINE.room}/state`);
    ONLINE.refs.meta  = ONLINE.ref(db, `rooms/${ONLINE.room}/meta`);

    setOnlineStatusText(`オンライン：room=${ONLINE.room} / me=${ONLINE.me}`);

    const snap = await ONLINE.get(ONLINE.refs.state);
    if(!snap.exists()){
      // まだ部屋に状態が無い場合：P1が「スタート」を押すまで待機
      if(ONLINE.me === 1 || ONLINE.me === 2){
        const ns = defaultState();
        ns.started = false;
        ns.feedbackText = "";
        ns.turnPlayer = 1;
        STATE = ns;
        renderFromState();
      }
    }else{
      const remote = snap.val();
      if(remote?.meta?.rev) ONLINE.lastRev = remote.meta.rev;
      STATE = remote || STATE;
      renderFromState();
    }

    ONLINE.onValue(ONLINE.refs.state, (snapshot)=>{
      const remote = snapshot.val();
      if(!remote) return;
      const rev = remote?.meta?.rev || 0;
      if(rev <= ONLINE.lastRev) return;
      ONLINE.lastRev = rev;
      ONLINE.suppress = true;
      try{ STATE = remote; renderFromState(); }
      finally{ ONLINE.suppress = false; }
    });
  }catch(e){
    ONLINE.enabled = false;
    setOnlineStatusText("オフライン");
  }
}

// start
renderFromState();
initOnlineIfPossible();
  </script>
</body>
</html>
