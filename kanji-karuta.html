<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ã‚«ãƒ«ã‚¿èª­ã¿æœ­ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼†èª­ã¿ä¸Šã’</title>
<style>
  :root{
    --bg:#f6f7fb;
    --card:#ffffff;
    --ink:#111827;
    --sub:#6b7280;
    --border:#e5e7eb;
    --primary:#2563eb;
    --danger:#dc2626;
    --ok:#16a34a;
    --shadow:0 10px 24px rgba(0,0,0,.08);
    --radius:16px;
    --gap:12px;
  }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family: "UD Digi Kyokasho NK-R","UD Digi Kyokasho N-R","UD Digi Kyokasho NP-R",
                 "UD Digi Kyokasho NK","UD Digi Kyokasho N","UD Digi Kyokasho NP",
                 "Noto Sans JP",system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Yu Gothic","Meiryo",sans-serif;
  }
  .wrap{
    max-width: 1060px; margin: 0 auto; padding: 14px;
    padding-bottom: calc(14px + env(safe-area-inset-bottom));
  }
  h1{ font-size:18px; margin: 6px 0 12px; }
  .grid{ display:grid; gap:var(--gap); grid-template-columns: 1fr; }
  @media (min-width: 900px){
    .grid{ grid-template-columns: 420px 1fr; align-items:start; }
  }
  .card{
    background:var(--card); border:1px solid var(--border);
    border-radius:var(--radius); box-shadow:var(--shadow);
    padding:12px;
  }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .muted{ color:var(--sub); font-size:12px; }
  .sep{ height:1px; background:var(--border); margin:10px 0; }
  label{ font-size:13px; color:var(--sub); }
  input[type="file"]{ width:100%; }
  select, input[type="number"]{
    width:100%; padding:10px 12px;
    border:1px solid var(--border); border-radius:12px;
    font-size:14px; background:#fff;
  }
  .btn{
    appearance:none; border:0; border-radius:14px;
    padding:10px 14px; font-size:14px;
    background:var(--primary); color:#fff; font-weight:800;
    box-shadow: 0 6px 16px rgba(37,99,235,.25);
    cursor:pointer;
  }
  .btn:active{ transform: translateY(1px); }
  .btn.secondary{
    background:#fff; color:var(--ink);
    border:1px solid var(--border); box-shadow:none;
    font-weight:800;
  }
  .btn.ok{ background:var(--ok); box-shadow: 0 6px 16px rgba(22,163,74,.18); }
  .btn.danger{ background:var(--danger); box-shadow: 0 6px 16px rgba(220,38,38,.18); }
  .btn:disabled{ opacity:.45; cursor:not-allowed; transform:none; }
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    border:1px solid var(--border); border-radius:999px;
    padding: 6px 10px; background:#fff;
    font-size:12px; color:var(--sub);
  }
  .tog{
    display:flex; align-items:center; gap:8px;
    padding:8px 10px; border:1px solid var(--border);
    border-radius:12px; background:#fff;
  }
  .tog input{ width:22px; height:22px; }
  .checkgrid{
    display:grid; grid-template-columns: 1fr 1fr;
    gap:8px;
  }
  @media (min-width: 520px){
    .checkgrid{ grid-template-columns: 1fr 1fr 1fr; }
  }
  .chip{
    display:flex; align-items:center; gap:8px;
    border:1px solid var(--border);
    padding:8px 10px; border-radius:12px;
    background:#fff;
    user-select:none;
  }
  .chip input{ width:18px; height:18px; }
  .cardTitle{
    font-size:13px; color:var(--sub);
    display:flex; justify-content:space-between; gap:10px;
    align-items:center;
  }
  .bigArea{ display:flex; flex-direction:column; gap:12px; }
  .readout{
    border:2px dashed var(--border);
    border-radius: 18px;
    padding: 18px;
    min-height: 180px;
    display:flex; justify-content:center; align-items:center;
    text-align:center;
    font-size: 56px; line-height:1.2;
    background: #fff;
    user-select:none;
  }
  @media (max-width: 520px){
    .readout{ font-size: 44px; min-height: 160px; }
  }
  .hiddenText{ color:#9ca3af; letter-spacing:.06em; }
  .msg{
    font-size:13px; padding:10px 12px;
    border-radius:12px; border:1px solid var(--border);
    background:#fff;
  }
  .msg.ok{ border-color:#bbf7d0; background:#f0fdf4; }
  .msg.warn{ border-color:#fed7aa; background:#fff7ed; }
  .msg.err{ border-color:#fecaca; background:#fef2f2; }
  .sliders{ display:grid; grid-template-columns: 1fr; gap:8px; }
  .sliderRow{
    display:grid; grid-template-columns: 74px 1fr 56px;
    gap:10px; align-items:center;
  }
  input[type="range"]{ width:100%; }
</style>
</head>
<body>
  <div class="wrap">
    <h1>ã‚«ãƒ«ã‚¿èª­ã¿æœ­ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼†èª­ã¿ä¸Šã’ï¼ˆCSVå¯¾å¿œï¼‰</h1>

    <div class="grid">
      <!-- å·¦ï¼šè¨­å®š -->
      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:flex-end;">
          <div>
            <div class="muted">1) CSVã‚’èª­ã¿è¾¼ã‚€</div>
            <div style="font-weight:900;">ãƒ‡ãƒ¼ã‚¿è¨­å®š</div>
          </div>
          <div class="pill" id="summaryPill">æœªèª­è¾¼</div>
        </div>

        <div style="margin-top:10px;">
          <input id="csvFile" type="file" accept=".csv,text/csv" />
          <div class="muted" style="margin-top:6px;">
            å…ˆé ­åˆ—ãŒã€Œç•ªå·ã€ã€ä»¥é™ãŒèª­ã¿æœ­åˆ—ï¼ˆè¤‡æ•°OKï¼‰ã€‚1è¡Œç›®ãŒè¦‹å‡ºã—ã§ã‚‚OKã€‚<br>
            â˜…èª­ã¿ä¸Šã’ã¯ã€Œé¸ã‚“ã åˆ—ã®å³éš£ï¼ˆ+1åˆ—ï¼‰ã€ã‚’å„ªå…ˆã—ã¾ã™ï¼ˆBâ†’Cã€Câ†’Dã€Eâ†’Fâ€¦ï¼‰ã€‚
          </div>
        </div>

        <div class="sep"></div>

        <div>
          <label>2) ç•ªå·ã‚’è¤‡æ•°é¸ã¶ï¼ˆãƒã‚§ãƒƒã‚¯ï¼‰</label>
          <div class="muted" style="margin:4px 0 8px;">â€»è¤‡æ•°é¸ã‚“ã ç•ªå·ã®æœ­ã‚’ã¾ã¨ã‚ã¦é‡è¤‡ãªã—ã§ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¾ã™ã€‚</div>
          <div id="numChecks" class="checkgrid">
            <div class="muted">ï¼ˆCSVèª­è¾¼å¾Œã«è¡¨ç¤ºï¼‰</div>
          </div>
          <div class="row" style="margin-top:10px;">
            <button class="btn secondary" id="numAllBtn" disabled>ç•ªå· å…¨éƒ¨ON</button>
            <button class="btn secondary" id="numNoneBtn" disabled>ç•ªå· å…¨éƒ¨OFF</button>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row" style="gap:12px;">
          <div style="flex:1 1 180px;">
            <label>èª­ã¿æœ­ã®è¡¨ç¤º</label>
            <div class="tog">
              <input id="showToggle" type="checkbox" checked />
              <div style="font-weight:800;">è¡¨ç¤ºã™ã‚‹</div>
            </div>
          </div>

          <div style="flex:1 1 220px;">
            <label>ãƒ’ãƒ³ãƒˆï¼ˆã©ã®åˆ—ã‚’èª­ã¿ä¸Šã’ã‚‹ï¼Ÿï¼‰</label>
            <select id="hintSelect" disabled>
              <option value="">ï¼ˆCSVèª­è¾¼å¾Œã«é¸ã¹ã¾ã™ï¼‰</option>
            </select>
            <div class="muted" style="margin-top:4px;">
              ãƒ’ãƒ³ãƒˆã¯ã€Œä»Šå‡ºã¦ã„ã‚‹æœ­ã€ã«å¯¾ã—ã¦ã€é¸ã‚“ã åˆ—ã®å†…å®¹ã‚’èª­ã¿ä¸Šã’ã¾ã™ã€‚
            </div>
          </div>
        </div>

        <div class="sep"></div>

        <div>
          <label>3) å‡ºé¡Œã«ä½¿ã†èª­ã¿æœ­åˆ—ã‚’é¸ã¶</label>
          <div class="muted" style="margin:4px 0 8px;">
            â€»ã€Œç•ªå·ã€ä»¥å¤–ã®åˆ—åãŒãƒã‚§ãƒƒã‚¯ã¨ã—ã¦ä¸¦ã³ã¾ã™ï¼ˆåˆ—ãŒå¢—ãˆã¦ã‚‚è‡ªå‹•ã§å‡ºã¾ã™ï¼‰ã€‚
          </div>
          <div id="colChecks" class="checkgrid">
            <div class="muted">ï¼ˆCSVèª­è¾¼å¾Œã«è¡¨ç¤ºï¼‰</div>
          </div>
          <div class="row" style="margin-top:10px;">
            <button class="btn secondary" id="selectAllBtn" disabled>åˆ— å…¨éƒ¨ON</button>
            <button class="btn secondary" id="selectNoneBtn" disabled>åˆ— å…¨éƒ¨OFF</button>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <button class="btn" id="buildDeckBtn" disabled>å±±æœ­ã‚’ä½œã‚‹ï¼ˆé‡è¤‡ãªã—ï¼‰</button>
          <button class="btn secondary" id="resetBtn" disabled>ãƒªã‚»ãƒƒãƒˆï¼ˆå†ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼‰</button>
        </div>

        <div style="margin-top:10px;" id="statusBox" class="msg">CSVã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚</div>

        <div class="sep"></div>

        <div>
          <div class="muted" style="font-weight:800; margin-bottom:6px;">éŸ³å£°è¨­å®šï¼ˆä»»æ„ï¼‰</div>
          <div class="sliders">
            <div class="sliderRow">
              <div class="muted">é€Ÿåº¦</div>
              <input id="rate" type="range" min="0.6" max="1.4" step="0.05" value="1.0">
              <div class="muted" id="rateVal">1.00</div>
            </div>
            <div class="sliderRow">
              <div class="muted">é«˜ã•</div>
              <input id="pitch" type="range" min="0.7" max="1.3" step="0.05" value="1.0">
              <div class="muted" id="pitchVal">1.00</div>
            </div>
            <div class="sliderRow">
              <div class="muted">éŸ³é‡</div>
              <input id="vol" type="range" min="0" max="1" step="0.05" value="1.0">
              <div class="muted" id="volVal">1.00</div>
            </div>
          </div>
          <div class="muted" style="margin-top:6px;">
            iPad/Safariã¯ã€Œæœ€åˆã®èª­ã¿ä¸Šã’ã¯ãƒœã‚¿ãƒ³æ“ä½œãŒå¿…è¦ã€ãªã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
          </div>
        </div>
      </div>

      <!-- å³ï¼šå‡ºé¡Œ -->
      <div class="card bigArea">
        <div class="cardTitle">
          <div>
            <span style="font-weight:900;">èª­ã¿æœ­</span>
            <span class="muted">ï¼ˆç•ªå·ãƒ»åˆ—ã‚’é¸ã‚“ã§ã€Œå±±æœ­ã‚’ä½œã‚‹ã€â†’ã€Œã¤ãã€ï¼‰</span>
          </div>
          <div class="pill" id="remainPill">æ®‹ã‚Šï¼š-</div>
        </div>

        <div class="readout" id="readout">
          <span class="hiddenText">ï¼ˆã¾ã æœ­ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰</span>
        </div>

        <div class="row" style="justify-content:center; gap:12px;">
          <button class="btn ok" id="nextBtn" disabled>ã¤ãï¼ˆé‡è¤‡ãªã—ï¼‰</button>
          <button class="btn" id="speakBtn" disabled>éŸ³å£°ğŸ”Š</button>
          <button class="btn secondary" id="hintBtn" disabled>ãƒ’ãƒ³ãƒˆ</button>
          <button class="btn secondary" id="stopBtn" disabled>åœæ­¢</button>
        </div>

        <div id="logBox" class="msg" style="display:none;"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  // =========================
  // çŠ¶æ…‹
  // =========================
  let rows = [];               // data rows only (string[][])
  let header = null;           // header row (string[]) or null
  const numberColIndex = 0;

  let numberList = [];         // unique numbers
  let selectedNumbers = [];    // selected numbers (string[])
  let readingColIndices = [];  // selected display columns (index)

  // deck item: { key, displayText, rowIdx, colIdx, speakText }
  let deck = [];
  let currentCard = null;
  let usedLog = [];

  // =========================
  // DOM
  // =========================
  const csvFile = document.getElementById("csvFile");

  const numChecks = document.getElementById("numChecks");
  const numAllBtn = document.getElementById("numAllBtn");
  const numNoneBtn = document.getElementById("numNoneBtn");

  const colChecks = document.getElementById("colChecks");
  const selectAllBtn = document.getElementById("selectAllBtn");
  const selectNoneBtn = document.getElementById("selectNoneBtn");

  const buildDeckBtn = document.getElementById("buildDeckBtn");
  const resetBtn = document.getElementById("resetBtn");
  const nextBtn = document.getElementById("nextBtn");
  const speakBtn = document.getElementById("speakBtn");
  const hintBtn = document.getElementById("hintBtn");
  const stopBtn = document.getElementById("stopBtn");

  const hintSelect = document.getElementById("hintSelect");
  const showToggle = document.getElementById("showToggle");
  const readout = document.getElementById("readout");
  const statusBox = document.getElementById("statusBox");
  const remainPill = document.getElementById("remainPill");
  const summaryPill = document.getElementById("summaryPill");
  const logBox = document.getElementById("logBox");

  const rate = document.getElementById("rate");
  const pitch = document.getElementById("pitch");
  const vol = document.getElementById("vol");
  const rateVal = document.getElementById("rateVal");
  const pitchVal = document.getElementById("pitchVal");
  const volVal = document.getElementById("volVal");

  // =========================
  // UI helpers
  // =========================
  function setMsg(text, kind=""){
    statusBox.className = "msg" + (kind ? " " + kind : "");
    statusBox.textContent = text;
  }

  function setReadout(){
    readout.innerHTML = "";
    if(!currentCard){
      const sp = document.createElement("span");
      sp.className = "hiddenText";
      sp.textContent = "ï¼ˆã¾ã æœ­ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰";
      readout.appendChild(sp);
      return;
    }
    if(showToggle.checked){
      readout.textContent = currentCard.displayText;
    }else{
      const sp = document.createElement("span");
      sp.className = "hiddenText";
      sp.textContent = "ï¼ˆã²ã¿ã¤ï¼‰";
      readout.appendChild(sp);
    }
  }

  function setRemain(){
    remainPill.textContent = `æ®‹ã‚Šï¼š${deck.length}`;
  }

  function updateLogBox(){
    if(usedLog.length === 0){
      logBox.style.display = "none";
      return;
    }
    logBox.style.display = "block";
    const last = usedLog[usedLog.length-1];
    logBox.textContent = `å‡ºã—ãŸæœ­ï¼š${usedLog.length}æšï¼ˆæœ€æ–°ï¼š${last.displayText}ï¼‰`;
  }

  function updateSummaryPill(){
    if(rows.length === 0){
      summaryPill.textContent = "æœªèª­è¾¼";
      return;
    }
    summaryPill.textContent = `è¡Œ:${rows.length} / åˆ—:${maxColCount()} / ç•ªå·:${numberList.length}`;
  }

  function updateButtons(){
    const hasData = rows.length > 0;
    const hasNums = selectedNumbers.length > 0;
    const hasCols = readingColIndices.length > 0;

    buildDeckBtn.disabled = !(hasData && hasNums && hasCols);
    resetBtn.disabled = !(hasData && hasNums && hasCols);

    nextBtn.disabled = !(deck.length > 0);
    speakBtn.disabled = !(!!currentCard);
    hintBtn.disabled = !(!!currentCard) || !hintSelect.value;

    stopBtn.disabled = !speechSynthesis.speaking;

    selectAllBtn.disabled = !hasData;
    selectNoneBtn.disabled = !hasData;
    numAllBtn.disabled = !hasData;
    numNoneBtn.disabled = !hasData;

    hintSelect.disabled = !hasData;
  }

  // =========================
  // CSV utils
  // =========================
  function isNumericLike(x){
    if(x == null) return false;
    const t = String(x).trim();
    if(!t) return false;
    return /^-?\d+(\.\d+)?$/.test(t);
  }

  function parseCSV(text){
    const out = [];
    let row = [];
    let field = "";
    let i = 0;
    let inQuotes = false;

    text = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n");

    while(i < text.length){
      const c = text[i];

      if(inQuotes){
        if(c === '"'){
          if(text[i+1] === '"'){
            field += '"';
            i += 2;
            continue;
          }else{
            inQuotes = false;
            i++;
            continue;
          }
        }else{
          field += c;
          i++;
          continue;
        }
      }else{
        if(c === '"'){
          inQuotes = true;
          i++;
          continue;
        }
        if(c === ","){
          row.push(field);
          field = "";
          i++;
          continue;
        }
        if(c === "\n"){
          row.push(field);
          out.push(row);
          row = [];
          field = "";
          i++;
          continue;
        }
        field += c;
        i++;
      }
    }
    row.push(field);
    if(!(row.length === 1 && row[0] === "")){
      out.push(row);
    }
    return out;
  }

  async function decodeFile(file){
    const ab = await file.arrayBuffer();

    const tryDecode = (enc) => {
      try{
        const dec = new TextDecoder(enc);
        return dec.decode(ab);
      }catch(e){
        return null;
      }
    };

    let t = tryDecode("utf-8");
    if(t == null) throw new Error("decode failed");

    const repl = (t.match(/\uFFFD/g) || []).length;
    if(repl >= 5){
      const sj = tryDecode("shift_jis");
      if(sj && (sj.match(/\uFFFD/g) || []).length < repl){
        t = sj;
      }
    }
    return t;
  }

  function maxColCount(){
    let m = 0;
    for(const r of rows) m = Math.max(m, r.length);
    if(header) m = Math.max(m, header.length);
    return m;
  }

  function indexToColLetter(i){
    let n = i + 1;
    let s = "";
    while(n > 0){
      const r = (n - 1) % 26;
      s = String.fromCharCode(65 + r) + s;
      n = Math.floor((n - 1) / 26);
    }
    return s;
  }

  function getColumnName(idx){
    if(header && header[idx] && header[idx].trim()) return header[idx].trim();
    return `åˆ—${indexToColLetter(idx)}`;
  }

  function getNonNumberColumns(){
    const colCount = maxColCount();
    const out = [];
    for(let c=0;c<colCount;c++){
      if(c === numberColIndex) continue;
      out.push({ idx:c, name:getColumnName(c) });
    }
    return out;
  }

  // =========================
  // Build check UIs
  // =========================
  function rebuildNumberChecks(){
    numChecks.innerHTML = "";
    if(numberList.length === 0){
      numChecks.innerHTML = `<div class="muted">ç•ªå·ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>`;
      return;
    }

    // default: all selected
    selectedNumbers = numberList.slice();

    for(const n of numberList){
      const lab = document.createElement("label");
      lab.className = "chip";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = true;
      cb.dataset.num = n;

      const sp = document.createElement("div");
      sp.textContent = n;
      sp.style.fontWeight = "900";
      sp.style.fontSize = "14px";

      cb.addEventListener("change", () => {
        selectedNumbers = Array.from(numChecks.querySelectorAll('input[type="checkbox"]'))
          .filter(x => x.checked)
          .map(x => x.dataset.num);

        clearDeckWithNotice("ç•ªå·ã®é¸æŠã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚å¿…è¦ãªã‚‰ã€Œå±±æœ­ã‚’ä½œã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
      });

      lab.appendChild(cb);
      lab.appendChild(sp);
      numChecks.appendChild(lab);
    }
  }

  function rebuildColumnChecks(){
    colChecks.innerHTML = "";
    const cols = getNonNumberColumns();
    if(cols.length === 0){
      colChecks.innerHTML = `<div class="muted">èª­ã¿æœ­åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆç•ªå·åˆ—ã—ã‹ãªã„ï¼Ÿï¼‰</div>`;
      return;
    }

    // default: all selected
    readingColIndices = cols.map(c => c.idx);

    for(const {idx, name} of cols){
      const lab = document.createElement("label");
      lab.className = "chip";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = true;
      cb.dataset.colIndex = String(idx);

      const sp = document.createElement("div");
      sp.textContent = name;
      sp.style.fontWeight = "800";
      sp.style.fontSize = "13px";

      cb.addEventListener("change", () => {
        readingColIndices = Array.from(colChecks.querySelectorAll('input[type="checkbox"]'))
          .filter(x => x.checked)
          .map(x => Number(x.dataset.colIndex));

        clearDeckWithNotice("åˆ—ã®é¸æŠã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚å¿…è¦ãªã‚‰ã€Œå±±æœ­ã‚’ä½œã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
      });

      lab.appendChild(cb);
      lab.appendChild(sp);
      colChecks.appendChild(lab);
    }
  }

  function rebuildHintSelect(){
    hintSelect.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "ï¼ˆãƒ’ãƒ³ãƒˆåˆ—ã‚’é¸ã‚“ã§ãã ã•ã„ï¼‰";
    hintSelect.appendChild(opt0);

    const cols = getNonNumberColumns();
    for(const {idx, name} of cols){
      const opt = document.createElement("option");
      opt.value = String(idx);
      opt.textContent = name;
      hintSelect.appendChild(opt);
    }
  }

  function clearDeckWithNotice(msg){
    deck = [];
    usedLog = [];
    currentCard = null;
    setReadout();
    setRemain();
    updateLogBox();
    setMsg(msg, "warn");
    updateButtons();
  }

  // =========================
  // Deck / draw logic
  // =========================
  function shuffle(arr){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }

  function buildDeck(){
    if(selectedNumbers.length === 0){
      setMsg("ç•ªå·ã‚’1ã¤ä»¥ä¸Šé¸ã‚“ã§ãã ã•ã„ã€‚", "warn");
      return;
    }
    if(readingColIndices.length === 0){
      setMsg("å‡ºé¡Œã«ä½¿ã†èª­ã¿æœ­åˆ—ãŒ1ã¤ã‚‚é¸ã°ã‚Œã¦ã„ã¾ã›ã‚“ã€‚", "warn");
      return;
    }

    // é‡è¤‡ãªã—ï¼ˆåŒã˜è¡¨ç¤ºæœ­ã¯2å›å‡ºã•ãªã„ï¼‰ï¼šdisplayTextã§ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–
    const seen = new Set();
    const cards = [];
    const selSet = new Set(selectedNumbers);

    for(let ri=0; ri<rows.length; ri++){
      const r = rows[ri];
      const num = (r[numberColIndex] ?? "").toString().trim();
      if(!selSet.has(num)) continue;

      for(const ci of readingColIndices){
        const displayText = (r[ci] ?? "").toString().trim();
        if(!displayText) continue;

        if(seen.has(displayText)) continue;
        seen.add(displayText);

        // â˜…èª­ã¿ä¸Šã’ã¯ã€Œå³éš£ï¼ˆ+1åˆ—ï¼‰ã€ã‚’å„ªå…ˆï¼ˆBâ†’Cã€Câ†’Dâ€¦ï¼‰ã€‚ç„¡ã‘ã‚Œã°è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆã€‚
        const speakTextRaw = (r[ci+1] ?? "").toString().trim();
        const speakText = speakTextRaw || displayText;

        cards.push({
          key: displayText,
          displayText,
          rowIdx: ri,
          colIdx: ci,
          speakText
        });
      }
    }

    if(cards.length === 0){
      clearDeckWithNotice("é¸æŠã—ãŸç•ªå·ãƒ»åˆ—ã«èª­ã¿æœ­ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }

    deck = shuffle(cards);
    usedLog = [];
    currentCard = null;

    setReadout();
    setRemain();
    updateLogBox();
    setMsg(`å±±æœ­ã‚’ä½œã‚Šã¾ã—ãŸï¼ˆ${cards.length}æš / é‡è¤‡ãªã—ï¼‰ã€‚ã€Œã¤ãã€ã§é–‹å§‹ã§ãã¾ã™ã€‚`, "ok");
    updateButtons();
    updateSummaryPill();
  }

  function drawNext(){
    if(deck.length === 0){
      currentCard = null;
      setReadout();
      setRemain();
      setMsg("å±±æœ­ãŒ0ã§ã™ã€‚é‡è¤‡ãªã—ã§çµ‚äº†ã—ã¾ã—ãŸã€‚ã€Œãƒªã‚»ãƒƒãƒˆã€ã§å†ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã§ãã¾ã™ã€‚", "warn");
      updateButtons();
      return;
    }
    currentCard = deck.shift();
    usedLog.push(currentCard);
    setReadout();
    setRemain();
    updateLogBox();
    setMsg("OKï¼ˆåŒã˜æœ­ã¯2å›å‡ºã¾ã›ã‚“ï¼‰", "ok");
    updateButtons();
  }

  // =========================
  // Speech
  // =========================
  function pickJapaneseVoice(){
    const voices = speechSynthesis.getVoices?.() || [];
    let v = voices.find(x => (x.lang || "").toLowerCase().startsWith("ja"));
    if(v) return v;
    v = voices.find(x => /japan/i.test(x.name || ""));
    return v || null;
  }

  function speak(text){
    if(!text) return;
    try{
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.rate = Number(rate.value);
      u.pitch = Number(pitch.value);
      u.volume = Number(vol.value);

      const v = pickJapaneseVoice();
      if(v) u.voice = v;

      u.onend = () => updateButtons();
      u.onerror = () => updateButtons();
      speechSynthesis.speak(u);
      updateButtons();
    }catch(e){
      setMsg("ã“ã®ç«¯æœ«ã§ã¯èª­ã¿ä¸Šã’ãŒä½¿ãˆãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚", "err");
    }
  }

  function stopSpeaking(){
    try{ speechSynthesis.cancel(); }catch(e){}
    updateButtons();
  }

  function speakMain(){
    if(!currentCard) return;
    speak(currentCard.speakText);
  }

  function speakHint(){
    if(!currentCard) return;
    const hintIdx = Number(hintSelect.value);
    if(Number.isNaN(hintIdx)) return;

    const r = rows[currentCard.rowIdx] || [];
    const t = (r[hintIdx] ?? "").toString().trim();
    if(!t){
      setMsg("ãƒ’ãƒ³ãƒˆåˆ—ã®å†…å®¹ãŒç©ºã§ã—ãŸã€‚åˆ—ã®é¸æŠã‚’å¤‰ãˆã‚‹ã‹ã€CSVã®è©²å½“ã‚»ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", "warn");
      return;
    }
    speak(t);
  }

  // =========================
  // Load CSV
  // =========================
  async function handleFile(file){
    setMsg("èª­ã¿è¾¼ã¿ä¸­â€¦", "warn");

    let text;
    try{
      text = await decodeFile(file);
    }catch(e){
      setMsg("CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚UTF-8ã¾ãŸã¯Shift-JISã§ä¿å­˜ã—ã¦ã¿ã¦ãã ã•ã„ã€‚", "err");
      return;
    }

    let parsed = parseCSV(text);
    parsed = parsed.map(r => r.map(c => (c ?? "").toString().trim()));
    parsed = parsed.filter(r => r.some(c => c && c.trim() !== ""));

    if(parsed.length === 0){
      setMsg("CSVãŒç©ºã§ã—ãŸã€‚", "err");
      return;
    }

    const first = parsed[0];
    const firstNumCell = (first[numberColIndex] ?? "").toString().trim();
    const hasHeader = !isNumericLike(firstNumCell);
    header = hasHeader ? first : null;

    rows = hasHeader ? parsed.slice(1) : parsed;
    rows = rows.filter(r => isNumericLike((r[numberColIndex] ?? "").toString().trim()));

    if(rows.length === 0){
      setMsg("ç•ªå·åˆ—ï¼ˆå…ˆé ­åˆ—ï¼‰ã«æ•°å­—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚Aåˆ—ãŒç•ªå·ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚", "err");
      header = null;
      return;
    }

    const s = new Set();
    for(const r of rows){
      const n = (r[numberColIndex] ?? "").toString().trim();
      if(n) s.add(n);
    }
    numberList = Array.from(s).sort((a,b) => {
      const na = Number(a), nb = Number(b);
      if(!Number.isNaN(na) && !Number.isNaN(nb)) return na-nb;
      return a.localeCompare(b, "ja");
    });

    rebuildNumberChecks();
    rebuildColumnChecks();
    rebuildHintSelect();

    // reset play state
    clearDeckWithNotice("èª­ã¿è¾¼ã¿å®Œäº†ã€‚ç•ªå·ãƒ»åˆ—ã‚’é¸ã‚“ã§ã€Œå±±æœ­ã‚’ä½œã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
    setMsg(`èª­ã¿è¾¼ã¿å®Œäº†ï¼šç•ªå·${numberList.length}ç¨®é¡ã€ãƒ‡ãƒ¼ã‚¿è¡Œ${rows.length}è¡Œã€åˆ—${maxColCount()}åˆ—ã€‚`, "ok");

    updateSummaryPill();
    updateButtons();
  }

  // =========================
  // Events
  // =========================
  csvFile.addEventListener("change", async (e) => {
    const f = e.target.files?.[0];
    if(!f) return;
    await handleFile(f);
  });

  showToggle.addEventListener("change", setReadout);

  buildDeckBtn.addEventListener("click", buildDeck);
  resetBtn.addEventListener("click", buildDeck);

  nextBtn.addEventListener("click", drawNext);
  speakBtn.addEventListener("click", speakMain);

  hintSelect.addEventListener("change", () => {
    updateButtons();
    if(hintSelect.value){
      setMsg("ãƒ’ãƒ³ãƒˆåˆ—ã‚’é¸ã³ã¾ã—ãŸã€‚æœ­ãŒå‡ºã¦ã„ã‚‹ã¨ãã«ã€Œãƒ’ãƒ³ãƒˆã€ã§èª­ã¿ä¸Šã’ã¾ã™ã€‚", "ok");
    }
  });

  hintBtn.addEventListener("click", speakHint);
  stopBtn.addEventListener("click", stopSpeaking);

  // number all/none
  numAllBtn.addEventListener("click", () => {
    const cbs = numChecks.querySelectorAll('input[type="checkbox"]');
    cbs.forEach(cb => cb.checked = true);
    selectedNumbers = Array.from(cbs).map(x => x.dataset.num);
    clearDeckWithNotice("ç•ªå·ã‚’å…¨éƒ¨ONã«ã—ã¾ã—ãŸã€‚å¿…è¦ãªã‚‰ã€Œå±±æœ­ã‚’ä½œã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
  });
  numNoneBtn.addEventListener("click", () => {
    const cbs = numChecks.querySelectorAll('input[type="checkbox"]');
    cbs.forEach(cb => cb.checked = false);
    selectedNumbers = [];
    clearDeckWithNotice("ç•ªå·ã‚’å…¨éƒ¨OFFã«ã—ã¾ã—ãŸï¼ˆæœ€ä½1ã¤é¸ã‚“ã§ãã ã•ã„ï¼‰ã€‚");
  });

  // column all/none
  selectAllBtn.addEventListener("click", () => {
    const cbs = colChecks.querySelectorAll('input[type="checkbox"]');
    cbs.forEach(cb => cb.checked = true);
    readingColIndices = Array.from(cbs).map(x => Number(x.dataset.colIndex));
    clearDeckWithNotice("åˆ—ã‚’å…¨éƒ¨ONã«ã—ã¾ã—ãŸã€‚å¿…è¦ãªã‚‰ã€Œå±±æœ­ã‚’ä½œã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
  });
  selectNoneBtn.addEventListener("click", () => {
    const cbs = colChecks.querySelectorAll('input[type="checkbox"]');
    cbs.forEach(cb => cb.checked = false);
    readingColIndices = [];
    clearDeckWithNotice("åˆ—ã‚’å…¨éƒ¨OFFã«ã—ã¾ã—ãŸï¼ˆæœ€ä½1ã¤é¸ã‚“ã§ãã ã•ã„ï¼‰ã€‚");
  });

  function refreshSliderVals(){
    rateVal.textContent = Number(rate.value).toFixed(2);
    pitchVal.textContent = Number(pitch.value).toFixed(2);
    volVal.textContent = Number(vol.value).toFixed(2);
  }
  [rate,pitch,vol].forEach(el => el.addEventListener("input", refreshSliderVals));
  refreshSliderVals();

  // initial
  setRemain();
  setReadout();
  updateButtons();
})();
</script>
</body>
</html>
